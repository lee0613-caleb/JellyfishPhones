<!DOCTYPE html>
<!-- saved from url=(0040)https://cava111.github.io/CavaDailyNote/ -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cavaè®°äº‹æœ¬1.3.5beta</title>
    <script src="./Cavaè®°äº‹æœ¬1.3.5beta_files/dexie.js.ä¸‹è½½"></script>
    <script src="./Cavaè®°äº‹æœ¬1.3.5beta_files/cropper.min.js.ä¸‹è½½"></script>
    <link rel="stylesheet" href="./Cavaè®°äº‹æœ¬1.3.5beta_files/cropper.min.css">
    <style>
        :root {
            --bg-main: #FDF0E9;
            --bg-secondary: #FFFFFF;
            --bg-soft: #FAE1D5;
            --accent-primary: #E6C8B4;
            --accent-secondary: #FFB6A3;
            --text-primary: #8C7B73;
            --text-secondary: #B4A29B;
            --text-primary-rgb: 140, 123, 115;
            --text-secondary-rgb: 180, 162, 155;
            --text-light: #FFFFFF;
            --error-bg: #FADADD;
            --error-text: #8C2323;
            --border-color: #F5EBE4;
            --expense-color: #F28B82;
            --income-color: #8DD4BF;
            --shadow-light: rgba(140, 123, 115, 0.1);
            --shadow-medium: rgba(140, 123, 115, 0.15);
            /* Schedule colors */
            --schedule-urgent-important: #FFE5E5;
            --schedule-urgent-not-important: #FFF5E5;
            --schedule-not-urgent-important: #E5F0FF;
            --schedule-not-urgent-not-important: #F0F0F0;
            --schedule-important-text: #8B4513;
            /* çº¢è¤è‰²å­—ä½“ for important tasks */
        }

        body[data-theme="blue"] {
            --bg-main: #EAF6FF;
            --bg-secondary: #FFFFFF;
            --bg-soft: #D4E9F7;
            --accent-primary: #B0D4EC;
            --accent-secondary: #87C4F4;
            --text-primary: #5A7C94;
            --text-secondary: #9AB7CC;
            --text-primary-rgb: 90, 124, 148;
            --text-secondary-rgb: 154, 183, 204;
            --border-color: #E0F0FF;
            --shadow-light: rgba(90, 124, 148, 0.1);
            --shadow-medium: rgba(90, 124, 148, 0.15);
            --schedule-important-text: #0056b3;
        }

        body[data-theme="green"] {
            --bg-main: #EFF8F2;
            --bg-secondary: #FFFFFF;
            --bg-soft: #DCEEE2;
            --accent-primary: #B9DCD0;
            --accent-secondary: #96CDBC;
            --text-primary: #5E8071;
            --text-secondary: #9EBAAF;
            --text-primary-rgb: 94, 128, 113;
            --text-secondary-rgb: 158, 186, 175;
            --border-color: #E5F1E9;
            --shadow-light: rgba(94, 128, 113, 0.1);
            --shadow-medium: rgba(94, 128, 113, 0.15);
            --schedule-important-text: #285c3f;
        }

        body[data-theme="purple"] {
            --bg-main: #F6F2FF;
            --bg-secondary: #FFFFFF;
            --bg-soft: #EAE0F7;
            --accent-primary: #D4C2E8;
            --accent-secondary: #C0A9E0;
            --text-primary: #7C6B8F;
            --text-secondary: #A99CB8;
            --text-primary-rgb: 124, 107, 143;
            --text-secondary-rgb: 169, 156, 184;
            --border-color: #F0EBFA;
            --shadow-light: rgba(124, 107, 143, 0.1);
            --shadow-medium: rgba(124, 107, 143, 0.15);
            --schedule-important-text: #563d7c;
        }

        body[data-theme="pink"] {
            --bg-main: #FFF0F5;
            --bg-secondary: #FFFFFF;
            --bg-soft: #FFE2EC;
            --accent-primary: #F8C4D8;
            --accent-secondary: #F4AAB6;
            --text-primary: #9A6A74;
            --text-secondary: #C7A5AD;
            --text-primary-rgb: 154, 106, 116;
            --text-secondary-rgb: 199, 165, 173;
            --border-color: #FAEBF0;
            --shadow-light: rgba(154, 106, 116, 0.1);
            --shadow-medium: rgba(154, 106, 116, 0.15);
            --schedule-important-text: #8c1c44;
        }

        body[data-theme="gray"] {
            --bg-main: #F5F5F5;
            --bg-secondary: #FFFFFF;
            --bg-soft: #EAEAEA;
            --accent-primary: #D1D1D1;
            --accent-secondary: #B0B0B0;
            --text-primary: #616161;
            --text-secondary: #9E9E9E;
            --text-primary-rgb: 97, 97, 97;
            --text-secondary-rgb: 158, 158, 158;
            --border-color: #EEEEEE;
            --shadow-light: rgba(97, 97, 97, 0.1);
            --shadow-medium: rgba(97, 97, 97, 0.15);
            --schedule-important-text: #333;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 430px;
            margin: 0 auto;
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px var(--shadow-medium);
            transition: background-color 0.3s ease;
            overflow: hidden;
        }

        .main-content {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-main);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease;
        }

        .page.active {
            opacity: 1;
            visibility: visible;
            z-index: 1;
        }

        /* Header */
        .header {
            flex-shrink: 0;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
            background-color: rgba(253, 240, 233, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            z-index: 10;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
        }

        body[data-theme="blue"] .header {
            background-color: rgba(234, 246, 255, 0.8);
        }

        body[data-theme="green"] .header {
            background-color: rgba(239, 248, 242, 0.8);
        }

        body[data-theme="purple"] .header {
            background-color: rgba(246, 242, 255, 0.8);
        }

        body[data-theme="pink"] .header {
            background-color: rgba(255, 240, 245, 0.8);
        }

        body[data-theme="gray"] .header {
            background-color: rgba(245, 245, 245, 0.8);
        }

        .header .action-btn {
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            text-align: center;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .header .action-btn:active {
            background-color: var(--border-color);
        }

        .header .back-btn {
            font-size: 22px;
            font-weight: bold;
        }

        .header .left-action {
            flex: 1 1 0;
            display: flex;
            justify-content: flex-start;
        }

        .header .right-action {
            flex: 1 1 0;
            display: flex;
            justify-content: flex-end;
        }

        .header .center-title {
            flex: 2 1 0;
            text-align: center;
        }

        /* Bottom Navigation */
        #bottom-nav {
            flex-shrink: 0;
            display: flex;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            transition: background-color 0.3s ease, border-top-color 0.3s ease;
        }

        body[data-theme="blue"] #bottom-nav,
        body[data-theme="green"] #bottom-nav,
        body[data-theme="purple"] #bottom-nav,
        body[data-theme="pink"] #bottom-nav,
        body[data-theme="gray"] #bottom-nav {
            background-color: rgba(255, 255, 255, 0.7);
        }

        .nav-item {
            flex: 1;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .nav-item .icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .nav-item .label {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--accent-secondary);
        }

        /* --- Chat Page Styles --- */
        #accounting-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-wrapper {
            display: flex;
            gap: 8px;
            max-width: 85%;
            position: relative;
            align-items: flex-start;
            /* Aligns top of avatar with top of message-block */
        }

        .message-wrapper.user {
            align-self: flex-end;
        }

        .message-wrapper.ai {
            align-self: flex-start;
        }

        .message-wrapper .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .message-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
            min-width: 0;
            /* Prevents flexbox overflow issues */
        }

        .message-wrapper.user .message-block {
            align-items: flex-end;
        }

        .sender-name {
            font-size: 12px;
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            margin-bottom: 4px;
        }

        .message-bubble {
            display: flex;
            width: fit-content;
            max-width: 100%;
            align-items: flex-end;
            /* Aligns bubble content with meta info */
            gap: 4px;
        }

        .message-bubble .content {
            padding: 10px 14px;
            word-break: break-word;
            line-height: 1.5;
            font-size: 16px;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background-color 0.3s, color 0.3s;
        }

        .message-bubble .content strong {
            font-weight: bold;
        }

        .message-bubble .content em {
            font-style: italic;
        }

        .message-wrapper.user .message-bubble .content {
            background-color: var(--bg-soft);
            color: var(--text-primary);
            border-radius: 18px 8px 18px 18px;
        }

        .message-wrapper.ai .message-bubble .content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px 18px 18px 18px;
        }

        .message-wrapper.error .message-bubble .content {
            background-color: var(--error-bg);
            color: var(--error-text);
        }

        .message-meta {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            margin-bottom: 4px;
            /* Minor adjustment for better visual alignment */
        }

        .message-wrapper:hover .message-meta {
            opacity: 1;
        }

        .timestamp {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .message-actions-trigger {
            font-family: 'Segoe UI Symbol', sans-serif;
            font-size: 16px;
            color: #FFFFFF;
            background-color: rgba(var(--text-secondary-rgb), 0.5);
            cursor: pointer;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding-bottom: 2px;
        }

        .message-wrapper.user .message-bubble {
            flex-direction: row-reverse;
        }

        .selection-mode-active .message-meta,
        .message-bubble.editing .message-meta {
            display: none;
        }

        .message-bubble.image .content {
            padding: 5px;
            border-radius: 18px;
        }

        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 13px;
            display: block;
            cursor: pointer;
        }

        @keyframes typing {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        .typing-indicator span {
            animation: typing 1.5s infinite;
            display: inline-block;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        #chat-input-area {
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background-color: rgba(253, 240, 233, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            /* æ”¹ä¸ºçºµå‘æŽ’åˆ— */
            gap: 8px;
            /* ä¸¤ä¸ªæ¨ªæ¡ä¹‹é—´çš„é—´éš™ */
            transition: background-color 0.3s ease, border-top-color 0.3s ease, transform 0.3s ease;
        }

        #chat-actions-bar {
            display: flex;
            justify-content: space-around;
            /* è®©æŒ‰é’®å‡åŒ€åˆ†å¸ƒ */
            width: 100%;
        }

        #chat-text-input-bar {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            width: 100%;
        }

        /* è°ƒæ•´ä¸€ä¸‹æŒ‰é’®ï¼Œè®©å®ƒä»¬åœ¨æ‰‹æœºä¸Šæ›´å¥½çœ‹ */
        .chat-action-btn {
            font-size: 24px;
            /* ç¨å¾®å¢žå¤§å›¾æ ‡ */
        }

        .selection-mode-active #chat-input-area {
            transform: translateY(100%);
        }

        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 1px 3px var(--shadow-light);
            transition: transform 0.2s, background-color 0.3s;
        }

        .chat-action-btn:active {
            transform: scale(0.9);
            background-color: var(--bg-soft);
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            padding: 10px 15px;
            border-radius: 18px;
            background-color: var(--bg-secondary);
            font-size: 16px;
            max-height: 100px;
            resize: none;
            box-shadow: 0 1px 3px var(--shadow-light);
            transition: background-color 0.3s;
        }

        #chat-input:focus {
            outline: none;
        }

        #send-btn {
            background-color: var(--accent-secondary);
            color: var(--text-light);
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            height: 36px;
            padding: 0 15px;
            border-radius: 18px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #send-btn:disabled {
            background-color: var(--accent-primary);
            cursor: not-allowed;
        }

        /* Selection Mode */
        #selection-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background-color: rgba(253, 240, 233, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 15;
            box-sizing: border-box;
        }

        .selection-mode-active #selection-action-bar {
            display: flex;
        }

        #selection-action-bar button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 18px;
            border: none;
            cursor: pointer;
        }

        #delete-selected-btn {
            background-color: var(--error-bg);
            color: var(--error-text);
        }

        #cancel-selection-btn {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .message-selection-checkbox {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            background-color: var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 14px;
            z-index: 5;
        }

        .selection-mode-active .message-selection-checkbox {
            display: flex;
        }

        .message-wrapper.user .message-selection-checkbox {
            left: -30px;
        }

        .message-wrapper.ai .message-selection-checkbox {
            right: -30px;
        }

        .message-wrapper.selected .message-selection-checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .selection-mode-active #chat-messages {
            padding-left: 40px;
            padding-right: 40px;
        }

        /* Transaction, Schedule & Summary Message Cards */
        .message-bubble.transaction .content,
        .message-bubble.schedule .content,
        .message-bubble.ledger_summary .content,
        .message-bubble.schedule_summary .content,
        .message-bubble.pie_chart_summary .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
        }

        .transaction-card,
        .schedule-card,
        .summary-card {
            width: 220px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-medium);
            background: var(--bg-secondary);
        }

        .transaction-header,
        .schedule-header,
        .summary-header {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .transaction-header.expense {
            background-color: var(--expense-color);
        }

        .transaction-header.income {
            background-color: var(--income-color);
        }

        .schedule-header {
            background-color: var(--accent-secondary);
        }

        .summary-header {
            background-color: var(--accent-primary);
        }

        .transaction-header .icon,
        .schedule-header .icon,
        .summary-header .icon {
            font-size: 24px;
        }

        .transaction-header .category-name,
        .schedule-header .type-name,
        .summary-header .type-name {
            font-size: 16px;
            font-weight: bold;
        }

        .transaction-body,
        .schedule-body,
        .summary-body {
            padding: 15px;
            text-align: center;
        }

        .transaction-amount {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .transaction-amount .currency-label {
            font-size: 0.5em;
        }

        .transaction-remark {
            font-size: 14px;
            color: var(--text-secondary);
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
            word-break: break-all;
            position: relative;
        }

        .transaction-remark:before {
            content: 'ðŸ“ ';
        }

        .schedule-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .schedule-importance,
        .schedule-deadline,
        .schedule-status {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .schedule-status.completed {
            color: var(--income-color);
            font-weight: 500;
        }

        .schedule-description {
            font-size: 14px;
            color: var(--text-secondary);
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
            word-break: break-all;
        }

        .summary-body .text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Inline Edit Styles */
        .inline-edit-container {
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 10px 14px;
            box-sizing: border-box;
        }

        .message-bubble.editing .content-text,
        .message-bubble.editing .transaction-remark .original-text,
        .message-bubble.editing .schedule-description .original-text {
            display: none;
        }

        .message-bubble.editing .transaction-remark::before,
        .message-bubble.editing .schedule-description::before {
            display: none;
        }

        .message-bubble.editing .inline-edit-container {
            display: flex;
        }

        .message-bubble.editing.text .content {
            padding: 0;
        }

        .message-bubble.editing.transaction .transaction-remark,
        .message-bubble.editing.schedule .schedule-description {
            padding-top: 0;
            border-top: none;
        }

        .transaction-card .inline-edit-container,
        .schedule-card .inline-edit-container {
            padding: 8px 0 0 0;
        }

        .inline-edit-textarea {
            width: 100%;
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 16px;
            padding: 10px 14px;
            box-sizing: border-box;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            resize: none;
            min-height: 40px;
            font-family: inherit;
            line-height: 1.5;
            overflow-y: hidden;
        }

        .transaction-card .inline-edit-textarea,
        .schedule-card .inline-edit-textarea {
            font-size: 14px;
            padding: 8px;
            line-height: 1.4;
        }

        .inline-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .inline-edit-actions button {
            border: none;
            background-color: var(--bg-soft);
            color: var(--text-primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .inline-edit-actions button:active {
            transform: scale(0.9);
        }

        .inline-edit-actions .save {
            background-color: var(--income-color);
            color: white;
        }

        .inline-edit-actions .cancel {
            background-color: var(--expense-color);
            color: white;
        }

        /* Transaction Input Panel */
        #transaction-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-main);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-medium);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
            visibility: hidden;
        }

        #transaction-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }

        .panel-header {
            padding: 8px 15px;
            text-align: center;
            font-weight: 600;
            position: relative;
        }

        .panel-header .close-btn {
            position: absolute;
            left: 15px;
            top: 8px;
            font-size: 18px;
            line-height: 1;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .type-selector {
            display: flex;
            padding: 0 15px;
            margin-bottom: 15px;
        }

        .type-selector button {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
        }

        .type-selector button.active {
            color: var(--text-primary);
            font-weight: bold;
        }

        .type-selector button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background-color: var(--accent-secondary);
            border-radius: 2px;
        }

        #category-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .category-item.selected {
            background-color: var(--bg-soft);
        }

        .category-item .icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .category-item .name {
            font-size: 12px;
        }

        /* New Transaction Remark Section Styles */
        .transaction-remark-section {
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        #transaction-remark-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }

        #transaction-remark-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        #transaction-remark-input::placeholder {
            color: var(--text-secondary);
        }

        #numpad-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            background-color: var(--bg-secondary);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }

        .numpad button {
            padding: 20px 0;
            font-size: 24px;
            border: none;
            background: transparent;
            border-top: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-primary);
        }

        .numpad button:active {
            background-color: var(--bg-soft);
        }

        .numpad .zero {
            grid-column: 1 / 3;
        }

        .numpad-actions {
            display: flex;
            flex-direction: column;
        }

        .numpad-actions button {
            flex: 1;
            font-size: 22px;
            border: none;
            background: transparent;
            border-top: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-primary);
        }

        .numpad-actions button:active {
            background-color: var(--bg-soft);
        }

        .numpad-actions .confirm {
            background-color: var(--accent-secondary);
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .numpad-actions .delete-transaction {
            background-color: var(--error-bg);
            color: var(--error-text);
            font-weight: bold;
            font-size: 18px;
        }

        #amount-display-container {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        #currency-selector {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-secondary);
            padding: 5px;
            cursor: pointer;
        }

        #amount-display {
            font-size: 32px;
            font-weight: bold;
            text-align: right;
            flex-grow: 1;
        }

        /* Schedule Input Panel */
        #schedule-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-main);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-medium);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
            visibility: hidden;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        #schedule-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }

        .schedule-form {
            padding: 15px;
            overflow-y: auto;
        }

        .schedule-form-section {
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .schedule-form-section label {
            display: block;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .schedule-form-section.red {
            background-color: #F8D7DA;
        }

        .schedule-form-section.pink {
            background-color: #F8C4D8;
        }

        .schedule-form-section.purple {
            background-color: #EAE0F7;
        }

        .schedule-form-section.blue {
            background-color: #D4E9F7;
        }

        .schedule-form-section.green {
            background-color: #DCEEE2;
        }

        .event-type-toggle {
            display: flex;
            gap: 10px;
            background: var(--bg-secondary);
            padding: 5px;
            border-radius: 8px;
        }

        .event-type-toggle button {
            flex: 1;
            padding: 8px;
            border: 1px solid transparent;
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-type-toggle button.active {
            background-color: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        /* Recurrence Section */
        #recurrence-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        #recurrence-options button {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        #recurrence-options button.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        #recurrence-selector-days {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #recurrence-selector-days label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-secondary);
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
        }

        #recurrence-selector-days input {
            accent-color: var(--accent-secondary);
        }

        .importance-stars {
            display: flex;
            gap: 5px;
            align-items: center;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: var(--border-color);
            transition: color 0.2s;
            user-select: none;
        }

        .star.filled {
            color: #FFB800;
        }

        .star.half {
            position: relative;
            color: var(--border-color);
        }

        .star.half::before {
            content: 'â˜…';
            position: absolute;
            left: 0;
            width: 50%;
            overflow: hidden;
            color: #FFB800;
        }

        .importance-score {
            margin-left: auto;
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .deadline-inputs {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            padding: 5px 12px;
            border-radius: 8px;
        }

        #deadline-display-text,
        #end-date-display-text {
            flex-grow: 1;
            text-align: left;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 8px 5px;
        }

        .time-input-part {
            display: flex;
            align-items: center;
        }

        .time-input {
            width: 35px;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 16px;
            color: var(--text-primary);
            padding: 8px 0;
        }

        .time-input::-webkit-outer-spin-button,
        .time-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .time-input[type=number] {
            -moz-appearance: textfield;
            -webkit-appearance: none;
            appearance: none;
        }

        .time-input:focus {
            outline: none;
        }

        .time-input::placeholder {
            color: var(--text-secondary);
        }

        .time-separator {
            color: var(--text-primary);
            padding: 0 2px;
            font-size: 16px;
        }

        #schedule-title-input,
        #schedule-description-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }

        #schedule-description-input {
            min-height: 60px;
            resize: vertical;
        }

        .schedule-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .schedule-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .schedule-actions .cancel-btn {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .schedule-actions .confirm-btn {
            background-color: var(--accent-secondary);
            color: white;
        }

        /* Calendar Modal */
        #calendar-modal .modal-content {
            max-width: 320px;
        }

        #calendar-modal .modal-body {
            padding: 5px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .calendar-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .calendar-month-year {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            padding-bottom: 5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .calendar-day:not(.other-month):hover {
            background-color: var(--bg-soft);
        }

        .calendar-day.today {
            font-weight: bold;
            border: 1px solid var(--accent-primary);
        }

        .calendar-day.selected {
            background-color: var(--accent-secondary);
            color: white;
        }

        .calendar-day .event-dot {
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .calendar-day .event-dot.important {
            background-color: #E53935;
        }

        .calendar-day .event-dot.normal {
            background-color: #B0BEC5;
        }

        #calendar-modal .modal-footer {
            justify-content: space-between;
        }

        #clear-date-btn {
            background-color: var(--error-bg);
            color: var(--error-text);
        }


        /* --- NEW: Schedule Page Swipe Styles --- */
        #schedule-screen {
            display: flex;
            flex-direction: column;
        }

        #schedule-screen .page-content {
            padding: 15px;
            box-sizing: border-box;
        }

        .schedule-swipe-container {
            flex-grow: 1;
            overflow: hidden;
            width: 100%;
        }

        .schedule-pages-wrapper {
            display: flex;
            height: 100%;
            width: 300%;
            /* 3 pages */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .schedule-page {
            width: 33.333%;
            height: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .schedule-page>.page-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        .schedule-page-dots {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            padding: 8px 0;
            gap: 8px;
        }

        .schedule-page-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.3s;
        }

        .schedule-page-dots .dot.active {
            background-color: var(--accent-secondary);
        }

        #schedule-count {
            flex-shrink: 0;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
        }

        /* Today's Tasks styling */
        .today-task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            margin-bottom: 8px;
            cursor: pointer;
        }

        .today-task-item.important {
            background-color: var(--schedule-urgent-important);
            color: var(--schedule-important-text);
        }

        .today-task-item .title {
            flex-grow: 1;
            font-size: 16px;
        }

        .today-task-item.completed .title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .today-task-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .today-task-item.completed .checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .today-task-item.completed .checkbox::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
        }

        /* Schedule Main Page (original) */
        .schedule-section {
            margin-bottom: 30px;
        }

        .schedule-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .schedule-quadrant {
            margin-bottom: 20px;
        }

        .quadrant-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .quadrant-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #quadrant-1 .quadrant-header {
            background-color: var(--schedule-urgent-important);
        }

        #quadrant-2 .quadrant-header {
            background-color: var(--schedule-not-urgent-important);
        }

        #quadrant-3 .quadrant-header {
            background-color: var(--schedule-urgent-not-important);
        }

        #quadrant-4 .quadrant-header {
            background-color: var(--schedule-not-urgent-not-important);
        }

        .schedule-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .schedule-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .schedule-item:active {
            transform: scale(0.98);
        }

        .schedule-item-details {
            flex-grow: 1;
        }

        .schedule-item .title {
            font-size: 16px;
            color: var(--text-primary);
        }

        .schedule-item .ddl {
            font-size: 11px;
            color: rgba(var(--text-primary-rgb), 0.7);
            margin-top: 4px;
        }

        .schedule-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .schedule-item.completed .checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .schedule-item.completed .checkbox::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
        }

        .schedule-item.completed .title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        /* Schedule Calendar Page */
        #month-calendar-view {
            padding: 10px;
        }

        #calendar-event-list {
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }

        #calendar-event-list .event-item {
            margin-bottom: 8px;
        }

        #calendar-event-list .event-title {
            font-weight: 500;
        }

        #calendar-event-list .event-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Ledger Page */
        #ledger-screen .page-content {
            flex-grow: 1;
            overflow: hidden;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .ledger-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 15px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ledger-controls .filter-btn {
            border: 1px solid var(--accent-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
            flex-grow: 1;
            cursor: pointer;
        }

        .ledger-controls select {
            border: 1px solid var(--accent-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
            flex-grow: 1;
        }

        /* --- NEW: Ledger Footer Controls --- */
        .ledger-footer-controls {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            gap: 15px;
            border-top: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        #ledger-currency {
            border: 1px solid var(--accent-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
        }

        #toggle-ledger-view-btn {
            border: none;
            background: var(--bg-soft);
            color: var(--text-primary);
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        #toggle-ledger-view-btn:active {
            transform: scale(0.95);
        }

        #ledger-count {
            margin-left: auto;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        #ledger-view-wrapper {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-grow: 1;
        }

        #ledger-list-view,
        #ledger-chart-view {
            width: 50%;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        #ledger-list-view {
            padding: 15px 15px 0;
        }

        #ledger-chart-view {
            padding: 15px 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .pie-chart-area {
            width: 100%;
        }

        .pie-chart-title-wrapper {
            text-align: center;
            margin: 0 0 10px 0;
        }

        .pie-chart-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: normal;
            margin: 0;
            line-height: 1.4;
        }

        .pie-chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .pie-chart-area svg {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            display: block;
            aspect-ratio: 1;
        }

        .pie-chart-area svg path,
        .pie-chart-area svg circle {
            stroke: var(--bg-main);
            stroke-width: 2px;
            cursor: pointer;
            transition: transform 0.2s ease-out;
            transform-origin: center center;
        }

        .pie-chart-area svg path.active,
        .pie-chart-area svg circle.active {
            transform: scale(1.05);
        }

        #pie-chart-tooltip {
            position: absolute;
            display: none;
            background: rgba(var(--text-primary-rgb, 0, 0, 0), 0.85);
            color: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            pointer-events: none;
            z-index: 10;
            transform: translate(-50%, -110%);
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #pie-chart-tooltip strong {
            font-weight: bold;
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px 15px;
            padding: 10px;
            margin-top: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--text-primary);
        }

        .legend-color-box {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 6px;
        }

        #ledger-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ledger-item {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow-light);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .ledger-item:active {
            transform: scale(0.98);
        }

        .ledger-item .icon {
            font-size: 28px;
            margin-right: 15px;
        }

        .ledger-item .details {
            flex-grow: 1;
            min-width: 0;
        }

        .ledger-item .details .remark {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ledger-item .details .time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .ledger-item .amount {
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
            white-space: nowrap;
        }

        .ledger-item .amount.expense {
            color: var(--expense-color);
        }

        .ledger-item .amount.income {
            color: var(--income-color);
        }

        #ledger-summary {
            text-align: center;
            padding: 20px 0 0 0;
            color: var(--text-secondary);
        }

        /* More/Settings Page */
        #more-screen .page-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-button {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .form-button.secondary {
            background-color: var(--accent-primary);
        }

        .list-item-setting {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px var(--shadow-light);
            position: relative;
        }

        .list-item-setting .name {
            font-weight: 500;
        }

        .list-item-setting .details {
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .list-item-actions {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .list-item-actions button {
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar-upload img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--border-color);
        }

        .avatar-upload button {
            padding: 8px 12px;
            border: 1px solid var(--accent-primary);
            background-color: transparent;
            color: var(--text-primary);
            border-radius: 5px;
            cursor: pointer;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        /* Theme Selector */
        .theme-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .theme-option {
            cursor: pointer;
            text-align: center;
        }

        .theme-option .swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: border-color 0.2s;
        }

        .theme-option .swatch.default {
            background-color: #FAE1D5;
        }

        .theme-option .swatch.blue {
            background-color: #D4E9F7;
        }

        .theme-option .swatch.green {
            background-color: #DCEEE2;
        }

        .theme-option .swatch.purple {
            background-color: #EAE0F7;
        }

        .theme-option .swatch.pink {
            background-color: #FFE2EC;
        }

        .theme-option .swatch.gray {
            background-color: #EAEAEA;
        }

        .theme-option input {
            display: none;
        }

        .theme-option input:checked+.swatch {
            border-color: var(--accent-secondary);
        }

        .theme-option input:checked+.swatch::after {
            content: 'âœ“';
            color: var(--accent-secondary);
            font-weight: bold;
        }

        .theme-option .label {
            font-size: 12px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-width: 350px;
            background-color: var(--bg-main);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px var(--shadow-medium);
        }

        .modal-header {
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .modal-footer .save-btn {
            background-color: var(--accent-secondary);
            color: white;
        }

        .modal-footer .cancel-btn {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        #ai-character-selector .character-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        #ai-character-selector .character-item:hover {
            background-color: var(--bg-soft);
        }

        #ai-character-selector .character-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        #ai-character-selector .character-item .name {
            font-weight: bold;
        }

        #message-action-menu {
            z-index: 1100;
        }

        #message-action-menu .modal-content {
            width: 200px;
        }

        #message-action-menu .modal-body {
            padding: 0;
        }

        #message-action-menu button {
            width: 100%;
            display: block;
            padding: 15px;
            background: none;
            border: none;
            border-bottom: 1px solid var(--border-color);
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }

        #message-action-menu button:last-child {
            border-bottom: none;
        }

        #message-action-menu button.danger {
            color: var(--error-text);
        }

        /* æ›¿æ¢ä¸ºè¿™æ®µ */
        .modal-body .detail-row {
            margin-bottom: 15px;
        }

        .modal-body .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .modal-body .detail-value {
            font-size: 16px;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Cropper Modal */
        #cropper-modal .modal-body {
            padding: 0;
        }

        #cropper-image-container {
            max-height: 60vh;
        }

        #cropper-image-container img {
            max-width: 100%;
        }

        /* Sidebar */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 198;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #sidebar-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #chat-sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 75%;
            max-width: 300px;
            height: 100%;
            background-color: var(--bg-main);
            box-shadow: 2px 0 15px var(--shadow-medium);
            z-index: 199;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        #chat-sidebar.visible {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top));
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-item {
            margin-bottom: 20px;
        }

        .sidebar-item label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .sidebar-item .value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-secondary);
        }

        #sidebar-preview-content {
            background-color: var(--bg-soft);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 40vh;
            overflow-y: auto;
            margin-top: 10px;
            display: none;
        }

        /* System Prompt Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .toggle-switch label {
            font-size: 16px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--accent-primary);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-secondary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Ledger Filter Modals */
        #ledger-month-filter-modal .modal-body,
        #ledger-category-filter-modal .modal-body {
            padding: 0;
        }

        .filter-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .filter-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .filter-item:last-child {
            border-bottom: none;
        }

        .filter-item input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-secondary);
        }

        .filter-item label {
            flex-grow: 1;
        }

        .filter-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background-color: var(--bg-soft);
            color: var(--text-secondary);
        }

        .filter-tab.active {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-weight: bold;
        }

        /* æ–°å¢žè¿™æ®µCSS */
        .load-more-indicator {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: white;
            font-style: italic;
            /* åŠ ä¸€ç‚¹æ–‡å­—é˜´å½±ï¼Œé˜²æ­¢èƒŒæ™¯ä¹Ÿæ˜¯æµ…è‰²æ—¶çœ‹ä¸æ¸… */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* --- NEW: Markdown Formatting Styles --- */
        .message-bubble .content .markdown-h {
            margin: 10px 0 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-bubble .content h1.markdown-h {
            font-size: 1.4em;
        }

        .message-bubble .content h2.markdown-h {
            font-size: 1.2em;
        }

        .message-bubble .content h3.markdown-h {
            font-size: 1.1em;
        }

        .message-bubble .content .markdown-hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 12px 0;
        }

        .message-bubble .content .markdown-code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: var(--bg-soft);
            color: var(--accent-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* --- Markdown Formatting Styles --- */

        /* === æ ‡é¢˜å’Œæ¨ªçº¿æ ·å¼ (Headers & HR) === */
        .message-bubble .content .markdown-h {
            margin: 10px 0 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-bubble .content h1.markdown-h {
            font-size: 1.4em;
        }

        .message-bubble .content h2.markdown-h {
            font-size: 1.2em;
        }

        .message-bubble .content h3.markdown-h {
            font-size: 1.1em;
        }

        .message-bubble .content .markdown-hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 12px 0;
        }

        /* === åˆ—è¡¨æ ·å¼ (List) === */
        .markdown-ul {
            list-style: none;
            padding-left: 20px;
            margin: 10px 0;
        }

        .markdown-ul li {
            position: relative;
            margin-bottom: 5px;
        }

        .markdown-ul li::before {
            content: 'â€¢';
            position: absolute;
            left: -15px;
            top: 0;
            color: var(--accent-secondary);
            font-size: 1.2em;
            line-height: 1;
        }

        /* === è¡Œå†…ä»£ç æ ·å¼ (Inline Code) === */
        .message-bubble .content .markdown-code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: var(--border-color);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* === ã€æ ¸å¿ƒã€‘ä»£ç å—æ ·å¼ (Code Block) === */
        .markdown-code-block-wrapper {
            border-radius: 8px;
            /* ç»™æ•´ä¸ªå®¹å™¨åŠ åœ†è§’ */
            overflow: hidden;
            /* ç¡®ä¿å†…éƒ¨å…ƒç´ ä¸ä¼šè¶…å‡ºåœ†è§’ */
            margin: 10px 0;
            background-color: var(--text-primary);
            /* ä½¿ç”¨ä¸»æ–‡å­—é¢œè‰²ä½œä¸ºèƒŒæ™¯ï¼ */
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            /* é¡¶æ çš„å†…è¾¹è· */
            background-color: rgba(0, 0, 0, 0.1);
            /* åœ¨æ·±è‰²èƒŒæ™¯ä¸ŠåŠ ä¸€å±‚æ·¡æ·¡çš„é»‘è‰²ï¼Œå¢žåŠ å±‚æ¬¡æ„Ÿ */
        }

        .language-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            /* è¯­è¨€åç§°ç”¨åŠé€æ˜Žç™½è‰² */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        .copy-code-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: white;
            /* è®©â€œå·²å¤åˆ¶â€ç­‰æ–‡å­—ä¹Ÿæ˜¯ç™½è‰² */
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-code-btn svg {
            stroke: rgba(255, 255, 255, 0.7);
            /* å›¾æ ‡é¢œè‰² */
            transition: stroke 0.2s;
        }

        .copy-code-btn:hover svg {
            stroke: white;
            /* æ‚¬åœæ—¶å›¾æ ‡å˜äº® */
        }

        .markdown-code-block-wrapper pre {
            margin: 0;
            /* ç§»é™¤ pre æ ‡ç­¾çš„é»˜è®¤å¤–è¾¹è· */
            padding: 10px;
            /* å‡å°‘å†…è¾¹è·ï¼Œè®©æ–‡å­—æ›´è´´è¿‘è¾¹æ¡† */
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .markdown-code-block-wrapper pre code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            color: white;
            /* ä»£ç æ–‡å­—å…¨éƒ¨ä¸ºç™½è‰² */
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
<script id="cyxy-subtitles-inject" src="chrome-extension://abbgboelhkajgikdbjclaecchkneaoma/dist/video-subtitle.js"></script></head>

<body data-theme="default">
    <div id="app-container">
        <div id="sidebar-overlay"></div>
        <div id="chat-sidebar">
            <div class="sidebar-header">èŠå¤©åŠ©æ‰‹</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <label>å½“å‰ä¸Šä¸‹æ–‡ Tokens</label>
                    <div id="sidebar-token-count" class="value">0</div>
                </div>
                <button class="form-button secondary" id="preview-context-btn">é¢„è§ˆä¸Šä¸‹æ–‡</button>
                <pre id="sidebar-preview-content"></pre>
            </div>
        </div>

        <div class="main-content">
            <!-- Page 1: Accounting (Chat) -->
            <div id="accounting-screen" class="page active" style="background-image: none;">
                <div class="header">
                    <div class="left-action"><span class="action-btn" id="chat-settings-btn">â‰¡</span></div>
                    <div class="center-title"><span id="chat-header-title">æˆ‘çš„è®°äº‹æœ¬</span></div>
                    <div class="right-action"></div>
                </div>
                <div id="chat-messages"></div>
                <div id="selection-action-bar">
                    <button id="delete-selected-btn">åˆ é™¤</button>
                    <button id="cancel-selection-btn">å–æ¶ˆ</button>
                </div>
                <div id="chat-input-area">
                    <div id="chat-actions-bar">
                        <button class="chat-action-btn" id="chat-add-transaction-btn" title="è®°ä¸€ç¬”">ðŸ’°</button>
                        <button class="chat-action-btn" id="chat-add-schedule-btn" title="å®šä¸ªäº‹">ðŸ“</button>
                        <button class="chat-action-btn" id="image-upload-btn" title="å‘å›¾ç‰‡">ðŸ–¼ï¸</button>
                        <button class="chat-action-btn" id="emoji-pack-btn" title="å‘è¡¨æƒ…">ðŸ˜ƒ</button>
                        <button class="chat-action-btn" id="ai-trigger-btn" title="èŽ·å¾—å›žåº”">ðŸ¤–</button>
                    </div>
                    <div id="chat-text-input-bar">
                        <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
                        <textarea id="chat-input" rows="1" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
                        <button id="send-btn" disabled="">å‘é€</button>
                    </div>
                </div>
            </div>

            <!-- Page 2: Ledger -->
            <div id="ledger-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>æˆ‘çš„è´¦æœ¬</span></div>
                    <div class="right-action"><span class="action-btn" id="forward-ledger-btn">âž£</span></div>
                </div>
                <div class="ledger-controls">
                    <button class="filter-btn" id="ledger-month-filter-btn">æœˆä»½ç­›é€‰</button>
                    <button class="filter-btn" id="ledger-category-filter-btn">åˆ†ç±»ç­›é€‰</button>
                    <select id="ledger-type-filter" style="border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); border-radius: 8px; padding: 6px 10px; font-size: 14px; flex-grow: 1;">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="expense">åªçœ‹æ”¯å‡º</option>
                        <option value="income">åªçœ‹æ”¶å…¥</option>
                    </select>
                    <select id="ledger-sort">
                        <option value="time_desc">æ—¶é—´å€’åº</option>
                        <option value="time_asc">æ—¶é—´æ­£åº</option>
                        <option value="amount_desc">é‡‘é¢å€’åº</option>
                        <option value="amount_asc">é‡‘é¢æ­£åº</option>
                    </select>
                </div>
                <div class="page-content" id="ledger-page-content">
                    <div id="ledger-view-wrapper">
                        <div id="ledger-list-view">
                            <ul id="ledger-list"><li class="empty-state">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„è®°å½•</li></ul>
                            <div id="ledger-summary">æ€»æ”¯å‡º (): <span style="color:var(--expense-color)">0.00</span> | æ€»æ”¶å…¥ (): <span style="color:var(--income-color)">0.00</span></div>
                        </div>
                        <div id="ledger-chart-view" data-listener-attached="true">
                            <div id="pie-chart-tooltip"></div>
                            <div class="pie-chart-area">
                                <div class="pie-chart-title-wrapper">
                                    <h3 class="pie-chart-title">æ”¯å‡º</h3>
                                    <p class="pie-chart-subtitle" id="expense-pie-subtitle">å…¨æ—¶é—´ æ€»å…±<br><span style="font-weight: bold; color: var(--text-primary);">0.00 </span></p>
                                </div>
                                <svg id="expense-pie-chart" viewBox="0 0 250 250"><text x="50%" y="50%" text-anchor="middle" fill="#B4A29B">æ— æ•°æ®</text></svg>
                                <div class="pie-legend" id="expense-pie-legend"></div>
                            </div>
                            <div class="pie-chart-area">
                                <div class="pie-chart-title-wrapper">
                                    <h3 class="pie-chart-title">æ”¶å…¥</h3>
                                    <p class="pie-chart-subtitle" id="income-pie-subtitle">å…¨æ—¶é—´ æ€»å…±<br><span style="font-weight: bold; color: var(--text-primary);">0.00 </span></p>
                                </div>
                                <svg id="income-pie-chart" viewBox="0 0 250 250"><text x="50%" y="50%" text-anchor="middle" fill="#B4A29B">æ— æ•°æ®</text></svg>
                                <div class="pie-legend" id="income-pie-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ledger-footer-controls">
                    <select id="ledger-currency"><option value="RMB">äººæ°‘å¸ (RMB)</option><option value="HKD">æ¸¯å¸ (HKD)</option></select>
                    <button id="toggle-ledger-view-btn">å›¾è¡¨ ðŸ“Š</button>
                    <div id="ledger-count" class="ledger-count">å·²è®°è´¦0ç¬”ðŸ“ˆ</div>
                </div>
            </div>

            <!-- Page 3: Schedule (NEW SWIPE LAYOUT) -->
            <div id="schedule-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span id="schedule-page-title">ä»Šæ—¥å¾…åŠž</span></div>
                    <div class="right-action">
                        <select id="schedule-forward-select" style="border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); border-radius: 8px; padding: 4px 8px; font-size: 14px;">
                            <option value="">åŒæ­¥é€‰é¡¹</option>
                            <option value="today">ä»Šæ—¥å¾…åŠž</option>
                            <option value="calendar">æ—¥åŽ†è§†å›¾</option>
                            <option value="all">å…¨éƒ¨æ—¥ç¨‹</option>
                        </select>
                    </div>
                </div>
                <div class="schedule-swipe-container">
                    <div class="schedule-pages-wrapper">
                        <!-- Page 1: ä»Šæ—¥å¾…åŠž -->
                        <div class="schedule-page" id="schedule-today-page">
                            <div class="page-content" id="today-tasks-content"><div class="empty-state">ä»Šå¤©æ²¡æœ‰å¾…åŠžäº‹é¡¹ï¼Œè½»æ¾ä¸€ä¸‹å§ï¼</div></div>
                        </div>
                        <!-- Page 2: åŽŸæ—¥ç¨‹å››è±¡é™é¡µé¢ -->
                        <div class="schedule-page" id="schedule-main-page">
                            <div class="page-content">
                                <div class="schedule-section">
                                    <div class="schedule-section-title">å¾…å®Œæˆ</div>
                                    <div class="schedule-quadrant" id="quadrant-1">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">é‡è¦ä¸”ç´§æ€¥</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-1-items"><div class="empty-state">æ— </div></div>
                                    </div>
                                    <div class="schedule-quadrant" id="quadrant-2">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">é‡è¦ä¸ç´§æ€¥</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-2-items"><div class="empty-state">æ— </div></div>
                                    </div>
                                    <div class="schedule-quadrant" id="quadrant-3">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">ç´§æ€¥ä¸é‡è¦</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-3-items"><div class="empty-state">æ— </div></div>
                                    </div>
                                    <div class="schedule-quadrant" id="quadrant-4">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">ä¸ç´§æ€¥ä¸é‡è¦</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-4-items"><div class="empty-state">æ— </div></div>
                                    </div>
                                </div>
                                <div class="schedule-section">
                                    <div class="schedule-section-title">å·²å®Œæˆ</div>
                                    <div class="schedule-items" id="completed-items"><div class="empty-state">è¿˜æ²¡æœ‰å·²å®Œæˆçš„æ—¥ç¨‹</div></div>
                                </div>
                            </div>
                        </div>
                        <!-- Page 3: æœˆåŽ† -->
                        <div class="schedule-page" id="schedule-calendar-page">
                            <div class="page-content">
                                <div id="month-calendar-view"><div class="calendar-header"><span class="calendar-month-year">2025å¹´ 9æœˆ</span></div><div class="calendar-weekdays"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div><div class="calendar-grid"><div></div><div class="calendar-day">1</div><div class="calendar-day">2</div><div class="calendar-day">3</div><div class="calendar-day">4</div><div class="calendar-day">5</div><div class="calendar-day">6</div><div class="calendar-day">7</div><div class="calendar-day">8</div><div class="calendar-day">9</div><div class="calendar-day">10</div><div class="calendar-day">11</div><div class="calendar-day">12</div><div class="calendar-day">13</div><div class="calendar-day">14</div><div class="calendar-day">15</div><div class="calendar-day">16</div><div class="calendar-day">17</div><div class="calendar-day">18</div><div class="calendar-day">19</div><div class="calendar-day">20</div><div class="calendar-day">21</div><div class="calendar-day">22</div><div class="calendar-day">23</div><div class="calendar-day">24</div><div class="calendar-day">25</div><div class="calendar-day">26</div><div class="calendar-day">27</div><div class="calendar-day today">28</div><div class="calendar-day">29</div><div class="calendar-day">30</div></div></div>
                                <div id="calendar-event-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="schedule-page-dots">
                    <span class="dot active" data-index="0"></span>
                    <span class="dot" data-index="1"></span>
                    <span class="dot" data-index="2"></span>
                </div>
                <div id="schedule-count" class="schedule-count">å·²å®Œæˆ0é¡¹äº‹ä»¶ðŸŒŸ</div>
            </div>

            <!-- Page 4: More/Settings -->
            <div id="more-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>è®¾ç½®</span></div>
                    <div class="right-action"></div>
                </div>
                <div class="page-content">
                    <div class="setting-group">
                        <div class="setting-group-title">å¤–è§‚è®¾ç½®</div>
                        <div class="form-group">
                            <label>ä¸»é¢˜é€‰æ‹©</label>
                            <div class="theme-selector">
                                <label class="theme-option"><input type="radio" name="theme" value="default" checked="">
                                    <div class="swatch default"></div><span class="label">æš–é˜³ç”œæ</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="blue">
                                    <div class="swatch blue"></div><span class="label">æ™´ç©ºè‹æ‰“</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="green">
                                    <div class="swatch green"></div><span class="label">è–„è·å¾®é£Ž</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="purple">
                                    <div class="swatch purple"></div><span class="label">ç´«è—¤å¹»æ¢¦</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="pink">
                                    <div class="swatch pink"></div><span class="label">æ¨±è½æ˜Ÿè¾°</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="gray">
                                    <div class="swatch gray"></div><span class="label">é™è°§ä¹¦å½±</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group"><label>èŠå¤©èƒŒæ™¯</label>
                            <div class="avatar-upload"><button onclick="document.getElementById(&#39;setting-chat-bg-input&#39;).click()">ä¸Šä¼ </button><button id="remove-bg-btn" style="background-color: var(--expense-color); color: white;">ç§»é™¤èƒŒæ™¯</button><input type="file" id="setting-chat-bg-input" accept="image/*"></div>
                        </div>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">æˆ‘çš„èµ„æ–™</div>
                        <div class="form-group"><label>ç¾¤èŠåç§°</label><input type="text" id="setting-chat-name"></div>
                        <div class="form-group"><label>å¤´åƒ</label>
                            <div class="avatar-upload"><img id="setting-chat-avatar-preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNGQUUxRDUiLz48cGF0aCBkPSJNNzIgMzVBNiA2IDAgMSAwIDYwIDM1IDYgNiAwIDAgMCA3MiAzNW0tNDQgMEE2IDYgMCAxIDAgMTYgMzUgNiA2IDAgMCAwIDI4IDM1TTMzIDYwYTQwIDQwIDAgMCAwIDM0IDBjLTEuNS05LTcuNS0xNS0xNy0xNVMzNC41IDUxIDMzIDYwWiIgZmlsbD0iIzhDN0I3MyIvPjwvc3ZnPg=="><button id="upload-user-avatar-btn">ä¸Šä¼ </button><input type="file" id="setting-chat-avatar-input" accept="image/*"></div>
                        </div>
                        <div class="form-group"><label>ID</label><input type="text" id="setting-user-id" placeholder="å¯é€‰å¡«"></div>
                        <div class="form-group"><label>æ€§åˆ«</label><select id="setting-user-gender">
                                <option value="">æœªè®¾ç½®</option>
                                <option value="male">ç”·</option>
                                <option value="female">å¥³</option>
                            </select></div>
                        <div class="form-group"><label>ä¸ªäººè¯´æ˜Ž</label><textarea id="setting-user-bio" placeholder="å¯é€‰å¡«"></textarea></div>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">AI è®¾ç½®</div>
                        <div class="form-group"><label for="max-tokens-input">æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ (Token)</label><input type="number" id="max-tokens-input" placeholder="å»ºè®® 4000-8000"></div>
                        <p style="font-size:12px; color: var(--text-secondary); margin-top:-10px; margin-bottom: 15px;">
                            æ­¤è®¾ç½®ç”¨äºŽé™åˆ¶å‘é€ç»™AIçš„èŠå¤©è®°å½•é•¿åº¦ï¼Œé˜²æ­¢è¶…å‡ºæ¨¡åž‹é™åˆ¶ã€‚1ä¸ªæ±‰å­—çº¦ç­‰äºŽ2ä¸ªTokenã€‚</p>
                        <button class="form-button secondary" id="manage-system-prompts-btn">ç®¡ç†ç³»ç»Ÿæç¤ºè¯</button>
                        <button class="form-button secondary" id="manage-proxies-btn">ç®¡ç†APIåä»£</button>
                        <button class="form-button secondary" id="manage-characters-btn">ç®¡ç†AIè§’è‰²</button>
                        <button class="form-button secondary" id="manage-emoji-packs-btn">ç®¡ç†æˆ‘çš„è¡¨æƒ…åŒ…</button>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">å¸ç§è®¾ç½®</div>
                        <button class="form-button secondary" id="manage-currencies-btn">ç®¡ç†å¸ç§å’Œæ±‡çŽ‡</button>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">è®°å½•ç®¡ç†</div>
                        <button class="form-button secondary" id="export-json-btn">å¯¼å‡ºä¸º JSON</button>
                        <button class="form-button secondary" id="import-json-btn">ä»Ž JSON å¯¼å…¥</button>
                        <input type="file" id="import-json-input" accept=".json" style="display:none;">
                        <button class="form-button secondary" id="export-txt-btn">å¯¼å‡ºä¸º TXT</button>
                    </div>
                    <p style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
                        Technical support from Cava, Claude &amp; Gemini</p>
                </div>
            </div>
        </div>

        <!-- Transaction Input Panel -->
        <div id="transaction-panel">
            <div class="panel-header">
                <span class="close-btn" id="close-transaction-panel">Ã—</span>
                <span style="font-weight: 600;" id="transaction-panel-title">æ–°å»ºè®°è´¦</span>
                <span id="template-dropdown-btn" style="margin-left: 5px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">Ë‡</span>
                <div id="template-menu" style="display: none; position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: var(--bg-secondary); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-medium); padding: 8px; z-index: 201; min-width: 200px;">
                    <div id="template-list"></div>
                    <button style="width: 100%; padding: 8px; border: none; background: var(--bg-soft); border-radius: 6px; margin-top: 8px;" id="save-as-template-btn">ä¿å­˜ä¸ºæ¨¡æ¿</button>
                </div>
            </div>
            <div id="amount-display-container"><span id="currency-selector">RMB</span>
                <div id="amount-display">0.00</div>
            </div>
            <div class="type-selector"><button id="type-expense-btn" class="active">æ”¯å‡º</button><button id="type-income-btn">æ”¶å…¥</button></div>
            <div id="category-selector"></div>
            <div class="transaction-remark-section">
                <input type="text" id="transaction-remark-input" placeholder="æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
            </div>
            <div id="numpad-container">
                <div class="numpad"><button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="zero" data-key="0">0</button><button data-key=".">.</button></div>
                <div class="numpad-actions" id="numpad-actions"><button id="numpad-delete">âŒ«</button><button id="numpad-confirm" class="confirm">å®Œæˆ</button></div>
            </div>
        </div>

        <!-- Schedule Input Panel -->
        <div id="schedule-panel">
            <div class="panel-header">
                <span class="close-btn" id="close-schedule-panel">Ã—</span>
                <span style="font-weight: 600;" id="schedule-panel-title">æ–°å»ºæ—¥ç¨‹</span>
            </div>
            <div class="schedule-form">
                <div class="schedule-form-section red">
                    <label>äº‹é¡¹ç±»åˆ«</label>
                    <div class="event-type-toggle">
                        <button id="schedule-type-once" class="active">å•æ¬¡äº‹ä»¶</button>
                        <button id="schedule-type-long">é•¿æœŸäº‹ä»¶</button>
                    </div>
                </div>
                <div class="schedule-form-section green" id="recurrence-section" style="display: none;">
                    <label>é‡å¤å‘¨æœŸ</label>
                    <div id="recurrence-options">
                        <button data-type="daily">æ¯å¤©</button>
                        <button data-type="weekly">æ¯å‘¨</button>
                        <button data-type="monthly">æ¯æœˆ</button>
                    </div>
                    <div id="recurrence-selector-days" style="margin-top: 10px;"></div>
                </div>
                <div class="schedule-form-section blue">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="schedule-title-input" placeholder="è¾“å…¥äº‹ä»¶æ ‡é¢˜">
                </div>
                <div class="schedule-form-section pink">
                    <label>é‡è¦ç¨‹åº¦</label>
                    <div class="importance-stars" id="importance-stars">
                        <span class="star" data-value="1">â˜…</span>
                        <span class="star" data-value="2">â˜…</span>
                        <span class="star" data-value="3">â˜…</span>
                        <span class="star" data-value="4">â˜…</span>
                        <span class="star" data-value="5">â˜…</span>
                        <span class="importance-score" id="importance-score">0.0</span>
                    </div>
                </div>
                <div class="schedule-form-section purple">
                    <label id="deadline-label">æˆªæ­¢æ—¥æœŸ</label>
                    <div class="deadline-inputs">
                        <span id="deadline-display-text">é€‰æ‹©æ—¥æœŸ</span>
                        <div class="time-input-part">
                            <input type="number" id="deadline-hour-input" class="time-input" placeholder="æ—¶">
                            <span class="time-separator">:</span>
                            <input type="number" id="deadline-minute-input" class="time-input" placeholder="åˆ†">
                        </div>
                    </div>
                </div>
                <div class="schedule-form-section purple" id="end-date-section" style="display: none;">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <div class="deadline-inputs">
                        <span id="end-date-display-text">æ°¸ä¸ç»“æŸ</span>
                    </div>
                </div>
                <div class="schedule-form-section blue">
                    <label>å…·ä½“è¯´æ˜Ž</label>
                    <textarea id="schedule-description-input" placeholder="è¾“å…¥å…·ä½“è¯´æ˜Žï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
            </div>
            <div class="schedule-actions">
                <button class="cancel-btn" id="cancel-schedule-btn">å–æ¶ˆ</button>
                <button class="confirm-btn" id="confirm-schedule-btn">ç¡®å®š</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div id="bottom-nav">
            <div class="nav-item active" data-page="accounting-screen">
                <div class="icon">ðŸ’¬</div>
                <div class="label">è®°äº‹</div>
            </div>
            <div class="nav-item" data-page="ledger-screen">
                <div class="icon">ðŸ“–</div>
                <div class="label">è´¦æœ¬</div>
            </div>
            <div class="nav-item" data-page="schedule-screen">
                <div class="icon">ðŸ—“ï¸</div>
                <div class="label">æ—¥ç¨‹</div>
            </div>
            <div class="nav-item" data-page="more-screen">
                <div class="icon">âš™ï¸</div>
                <div class="label">è®¾ç½®</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="calendar-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-body">
                <div class="calendar-header"><button id="prev-month-btn">&lt;</button><span id="calendar-month-year" class="calendar-month-year"></span><button id="next-month-btn">&gt;</button></div>
                <div class="calendar-weekdays">
                    <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="clear-date-btn">æ¸…é™¤æ—¥æœŸ</button><button class="cancel-btn" id="close-calendar-btn">å…³é—­</button></div>
        </div>
    </div>
    <div id="api-proxy-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ç®¡ç†APIåä»£</div>
            <div class="modal-body">
                <div id="proxy-list"></div><button class="form-button" id="add-proxy-btn">ï¼‹ æ·»åŠ æ–°åä»£</button>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="close-proxy-modal">å…³é—­</button></div>
        </div>
    </div>
    <div id="proxy-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="proxy-editor-title">ç¼–è¾‘åä»£</div>
            <div class="modal-body">
                <div class="form-group"><label>è‡ªå®šä¹‰åç§°</label><input type="text" id="proxy-editor-name" placeholder="å¦‚ Cavaçš„API"></div>
                <div class="form-group"><label>URL (æ— éœ€ /v1)</label><input type="text" id="proxy-editor-url"></div>
                <div class="form-group"><label>API Key</label><input type="password" id="proxy-editor-apikey"></div>
                <div class="form-group"><label>Model(s) (æ¢è¡Œåˆ†éš”)</label><textarea id="proxy-editor-models" rows="3" placeholder="gpt-4o
claude-3-opus-20240229"></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="ai-character-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ç®¡ç†AIè§’è‰²</div>
            <div class="modal-body">
                <div id="character-list"></div><button class="form-button" id="add-character-btn">ï¼‹ æ·»åŠ æ–°è§’è‰²</button>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="close-character-modal">å…³é—­</button></div>
        </div>
    </div>
    <div id="character-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="character-editor-title">ç¼–è¾‘è§’è‰²</div>
            <div class="modal-body">
                <div class="form-group"><label>è§’è‰²åç§°</label><input type="text" id="character-editor-name"></div>
                <div class="form-group"><label>è§’è‰²å¤´åƒ</label>
                    <div class="avatar-upload"><img id="character-editor-avatar-preview"><button id="upload-char-avatar-btn">ä¸Šä¼ </button><input type="file" id="character-editor-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label>Prompt (äººè®¾)</label><textarea id="character-editor-prompt" rows="5"></textarea></div>
                <div class="form-group"><label>ä¸»ç”¨API</label><select id="character-editor-proxy"></select></div>
                <div class="form-group"><label>ä¸»ç”¨æ¨¡åž‹</label><select id="character-editor-model"></select></div>
                <div class="form-group"><label>å¤‡ç”¨API (å¯é€‰)</label><select id="character-editor-backup-proxy"></select>
                </div>
                <div class="form-group"><label>å¤‡ç”¨æ¨¡åž‹</label><select id="character-editor-backup-model"></select></div>
                <div class="form-group" style="margin-top:20px; border-top: 1px dashed var(--border-color); padding-top:15px;">
                    <label id="toggle-advanced-settings-btn" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>é«˜çº§å‚æ•°è®¾ç½®</span>
                        <span id="char-advanced-arrow" style="font-size: 18px; font-weight: bold;">â–¼</span>
                    </label>
                </div>

                <div id="character-advanced-settings" style="display: none; padding-left: 10px; padding-right: 10px; border-left: 2px solid var(--accent-primary);">

                    <div class="form-group">
                        <label>å‚æ•°é¢„è®¾æ¨¡å¼</label>
                        <select id="character-param-mode" style="width:100%; padding: 8px; border-radius: 5px; border: 1px solid var(--accent-primary);">
                            <option value="default">é»˜è®¤ (å‡è¡¡)</option>
                            <option value="assist">ååŠ©æ¨¡å¼ (ç²¾å‡†ç¨³å®š)</option>
                            <option value="companion">é™ªä¼´æ¨¡å¼ (åˆ›æ„å‘æ•£)</option>
                            <option value="custom">è‡ªå®šä¹‰å‚æ•°</option>
                        </select>
                    </div>

                    <div id="character-custom-params" style="display: none;">
                        <div class="form-group">
                            <label>æ¸©åº¦ (Temperature): <span id="char-temp-value">0.8</span></label>
                            <input type="range" id="char-temperature" min="0" max="2" step="0.1" value="0.8" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>Top P: <span id="char-topp-value">0.95</span></label>
                            <input type="range" id="char-top-p" min="0" max="1" step="0.05" value="0.95" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>Top K: <span id="char-topk-value">0</span></label>
                            <input type="range" id="char-top-k" min="0" max="100" step="1" value="0" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>é¢‘çŽ‡æƒ©ç½š (Frequency): <span id="char-freq-value">0</span></label>
                            <input type="range" id="char-freq-penalty" min="-2" max="2" step="0.1" value="0" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>å­˜åœ¨æƒ©ç½š (Presence): <span id="char-pres-value">0</span></label>
                            <input type="range" id="char-presence-penalty" min="-2" max="2" step="0.1" value="0" class="ai-slider">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="ai-character-selector-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">é€‰æ‹©å‘è¨€è§’è‰²</div>
            <div class="modal-body" id="ai-character-selector"></div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button></div>
        </div>
    </div>
    <div id="message-action-menu" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-body"><button id="multi-select-btn">â˜‘ï¸ å¤šé€‰</button><button id="edit-message-btn">âœï¸
                    ç¼–è¾‘</button><button id="edit-ai-message-btn">âœï¸ ç¼–è¾‘</button><button id="copy-message-btn">ðŸ“‹
                    å¤åˆ¶</button><button id="delete-message-btn" class="danger">ðŸ—‘ï¸ åˆ é™¤</button></div>
            <div class="modal-footer" style="padding-top:0;"><button class="cancel-btn" style="width:100%;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div id="schedule-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">æ—¥ç¨‹è¯¦æƒ…</div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">æ ‡é¢˜</div>
                    <div class="detail-value" id="detail-title"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">è¯´æ˜Ž</div>
                    <div class="detail-value" id="detail-description"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">é‡è¦ç¨‹åº¦</div>
                    <div class="detail-value" id="detail-importance"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æˆªæ­¢æ—¥æœŸ</div>
                    <div class="detail-value" id="detail-deadline"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">äº‹ä»¶ç±»åž‹</div>
                    <div class="detail-value" id="detail-type"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="edit-schedule-btn">ç¼–è¾‘</button><button class="cancel-btn" style="background-color: var(--expense-color); color: white;" id="delete-schedule-btn">åˆ é™¤</button><button class="cancel-btn" id="close-schedule-detail-modal">å…³é—­</button></div>
        </div>
    </div>
    <div id="cropper-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">è£å‰ªå¤´åƒ</div>
            <div class="modal-body">
                <div id="cropper-image-container"><img id="cropper-image"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ç¡®å®š</button></div>
        </div>
    </div>
    <div id="currency-list-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ç®¡ç†å¸ç§</div>
            <div class="modal-body">
                <div id="currency-list"></div><button class="form-button" id="add-currency-btn">ï¼‹ æ·»åŠ æ–°å¸ç§</button>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="close-currency-list-modal">å…³é—­</button></div>
        </div>
    </div>
    <div id="currency-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="currency-editor-title">ç¼–è¾‘å¸ç§</div>
            <div class="modal-body">
                <div class="form-group"><label>å¸ç§ä»£ç  (3ä½å¤§å†™å­—æ¯)</label><input type="text" id="currency-editor-code" placeholder="ä¾‹å¦‚: HKD, USD" maxlength="3" style="text-transform:uppercase;"></div>
                <div class="form-group"><label>å¸ç§åç§°</label><input type="text" id="currency-editor-name" placeholder="ä¾‹å¦‚: æ¸¯å¸, ç¾Žå…ƒ"></div>
                <div class="form-group"><label>å¯¹ RMB çš„æ±‡çŽ‡ (1 å¸ç§ = ? RMB)</label><input type="number" id="currency-editor-rate" placeholder="ä¾‹å¦‚: 0.92"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="system-prompts-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ç®¡ç†ç³»ç»Ÿæç¤ºè¯</div>
            <div class="modal-body">
                <div class="setting-group" style="margin-bottom: 15px;">
                    <div class="setting-group-title" style="margin-bottom: 10px;">é™„åŠ ä¿¡æ¯</div>
                    <div class="toggle-switch"><label for="system-prompt-send-time">å‘é€å½“å‰æ—¶é—´</label><label class="switch"><input type="checkbox" id="system-prompt-send-time"><span class="slider"></span></label></div>
                    <div class="toggle-switch"><label for="system-prompt-send-model">å‘é€å½“å‰æ¨¡åž‹</label><label class="switch"><input type="checkbox" id="system-prompt-send-model"><span class="slider"></span></label></div>
                    <div class="toggle-switch"><label for="system-prompt-send-role">å‘é€AIè§’è‰²å</label><label class="switch"><input type="checkbox" id="system-prompt-send-role"><span class="slider"></span></label></div>
                </div>
                <div class="setting-group">
                    <div class="setting-group-title">åŒæ­¥æç¤ºè¯æ¨¡æ¿</div>
                    <div class="form-group" style="margin-bottom: 10px;"><label for="system-prompt-ledger">åŒæ­¥è´¦æœ¬</label><textarea id="system-prompt-ledger" rows="2"></textarea></div>
                    <div class="form-group" style="margin-bottom: 10px;"><label for="system-prompt-schedule">åŒæ­¥æ—¥ç¨‹</label><textarea id="system-prompt-schedule" rows="2"></textarea></div>
                    <div class="form-group"><label for="system-prompt-pie">åŒæ­¥å›¾è¡¨</label><textarea id="system-prompt-pie" rows="2"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="ledger-month-filter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">é€‰æ‹©æœˆä»½</div>
            <div class="modal-body">
                <div class="filter-list" id="month-filter-list"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ç¡®å®š</button></div>
        </div>
    </div>
    <div id="ledger-category-filter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">é€‰æ‹©åˆ†ç±»</div>
            <div class="modal-body">
                <div class="filter-tabs">
                    <div class="filter-tab active" data-type="expense">æ”¯å‡º</div>
                    <div class="filter-tab" data-type="income">æ”¶å…¥</div>
                </div>
                <div class="filter-list" id="category-filter-list"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">å–æ¶ˆ</button><button class="save-btn">ç¡®å®š</button></div>
        </div>
    </div>
    <!-- æ›¿æ¢ä¸ºè¿™æ®µ -->
    <div id="ledger-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">è®°è´¦è¯¦æƒ…</div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">ç±»åž‹</div>
                    <div class="detail-value" id="ledger-detail-type"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">åˆ†ç±»</div>
                    <div class="detail-value" id="ledger-detail-category"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">é‡‘é¢</div>
                    <div class="detail-value" id="ledger-detail-amount"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å¤‡æ³¨</div>
                    <div class="detail-value" id="ledger-detail-remark"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ—¶é—´</div>
                    <div class="detail-value" id="ledger-detail-time"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="edit-ledger-btn">ç¼–è¾‘</button><button class="cancel-btn" style="background-color: var(--expense-color); color: white;" id="delete-ledger-btn">åˆ é™¤</button><button class="cancel-btn" id="close-ledger-detail-modal">å…³é—­</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            async function generateDiary() {
                if (!state.currentDiaryCharId || !state.currentDiaryDate) {
                    alert('è¯·å…ˆé€‰æ‹©è§’è‰²');
                    return;
                }

                const character = state.characters.find(c => c.id === state.currentDiaryCharId);
                if (!character) {
                    alert('æœªæ‰¾åˆ°é€‰ä¸­çš„è§’è‰²');
                    return;
                }

                const proxy = state.proxies.find(p => p.id === character.proxyId);
                if (!proxy || !character.model) {
                    alert(`è§’è‰² "${character.name}" æœªé…ç½®APIæˆ–æ¨¡åž‹`);
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const contentArea = document.getElementById('diary-content-area-inline');
                if (contentArea) {
                    contentArea.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; padding: 40px; flex-direction: column;">
                <div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>
                <p style="margin-top: 15px; color: var(--text-secondary);">æ­£åœ¨ç”Ÿæˆæ—¥è®°...</p>
            </div>
        `;
                }

                try {
                    // 1. å‡†å¤‡æ‰€æœ‰éœ€è¦æ›¿æ¢çš„å˜é‡
                    // è¿™é‡Œçš„ state.currentDiaryDate å°±æ˜¯ä½ æ—¥åŽ†ä¸Šç‚¹å‡»çš„é‚£ä¸€å¤©ï¼Œæ˜¯æ­£ç¡®çš„ï¼
                    const dateStr = `${state.currentDiaryDate.getFullYear()}å¹´${state.currentDiaryDate.getMonth() + 1}æœˆ${state.currentDiaryDate.getDate()}æ—¥`;
                    const userId = state.config.userId || 'ç”¨æˆ·';
                    const charName = character.name;

                    // 2. æž„å»ºç”¨æˆ·ä¿¡æ¯å­—ç¬¦ä¸²
                    let userProfileString = '';
                    if (state.config.userId || state.config.userGender || state.config.userBio) {
                        userProfileString += "[ç”¨æˆ·ä¿¡æ¯]\n";
                        if (state.config.userId) userProfileString += `- ID: ${state.config.userId}\n`;
                        if (state.config.userGender) userProfileString += `- æ€§åˆ«: ${state.config.userGender}\n`;
                        if (state.config.userBio) userProfileString += `- ç®€ä»‹: ${state.config.userBio}\n`;
                        userProfileString += '\n';
                    }

                    // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ‹†åˆ†æç¤ºè¯ ---

                    // 3. å‡†å¤‡ã€ç³»ç»Ÿæç¤ºè¯ã€‘ï¼ŒåªåŒ…å«ä¸å˜çš„è§’è‰²è®¾å®šå’Œç”¨æˆ·ä¿¡æ¯
                    const systemPromptForAPI = `${character.prompt}\n\n${userProfileString}`;

                    // 4. å‡†å¤‡ã€æœ€åŽçš„ç”¨æˆ·æŒ‡ä»¤ã€‘ï¼ŒåŒ…å«å…·ä½“çš„å†™æ—¥è®°ä»»åŠ¡
                    const latestDiaryPromptTemplate = state.config.diaryPrompt; // ä»Žæ•°æ®åº“èŽ·å–æœ€æ–°çš„æ¨¡æ¿
                    const finalInstruction = latestDiaryPromptTemplate
                        .replace(/{char}/g, charName)
                        .replace(/{user}/g, userId)
                        .replace(/{date}/g, dateStr);

                    const history = buildContext(8000).context;


                    const params = character.aiParams || {
                        temperature: 0.9, topP: 0.95, topK: 0, frequencyPenalty: 0, presencePenalty: 0
                    };

                    console.log('æ­£åœ¨è°ƒç”¨æ—¥è®°ç”ŸæˆAPI...');

                    const messagesForAPI = [
                        { role: 'system', content: systemPromptForAPI }, 
                        ...history,                                     // ä¸­é—´çš„å¯¹è¯åŽ†å²
                        { role: 'user', content: finalInstruction }      // ç»“å°¾çš„æœ€ç»ˆæŒ‡ä»¤ï¼
                    ];

                    const response = await fetch(`${proxy.url}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${proxy.apiKey}`
                        },
                        body: JSON.stringify({
                            model: character.model,
                            messages: messagesForAPI, 
                            temperature: params.temperature,
                            top_p: params.topP,
                            top_k: params.topK,
                            frequency_penalty: params.frequencyPenalty,
                            presence_penalty: params.presencePenalty,
                            max_tokens: 3000
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(await response.text());
                    }

                    const data = await response.json();
                    const diaryContent = data.choices[0].message.content;
                    console.log('æ—¥è®°ç”ŸæˆæˆåŠŸï¼');

                    const dateStrForDB = `${state.currentDiaryDate.getFullYear()}-${String(state.currentDiaryDate.getMonth() + 1).padStart(2, '0')}-${String(state.currentDiaryDate.getDate()).padStart(2, '0')}`;
                    const existingDiary = state.diaries.find(d => d.date === dateStrForDB && d.charId === state.currentDiaryCharId);

                    if (existingDiary) {
                        existingDiary.content = diaryContent;
                        existingDiary.timestamp = Date.now();
                        await db.diaries.put(existingDiary);
                    } else {
                        const newDiary = {
                            date: dateStrForDB,
                            charId: state.currentDiaryCharId,
                            content: diaryContent,
                            timestamp: Date.now()
                        };
                        const id = await db.diaries.add(newDiary);
                        state.diaries.push({ ...newDiary, id });
                    }

                    updateDiaryContentArea(state.currentDiaryDate);

                } catch (error) {
                    console.error('ç”Ÿæˆæ—¥è®°å¤±è´¥:', error);
                    alert('ç”Ÿæˆæ—¥è®°å¤±è´¥ï¼š' + error.message);
                    updateDiaryContentArea(state.currentDiaryDate);
                }
            }



            async function deleteDiary() {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
                    return;
                }

                const dateStr = `${state.currentDiaryDate.getFullYear()}-${String(state.currentDiaryDate.getMonth() + 1).padStart(2, '0')}-${String(state.currentDiaryDate.getDate()).padStart(2, '0')}`;
                const diary = state.diaries.find(d =>
                    d.date === dateStr && d.charId === state.currentDiaryCharId
                );

                if (diary) {
                    await db.diaries.delete(diary.id);
                    state.diaries = state.diaries.filter(d => d.id !== diary.id);
                    // åˆ é™¤åŽï¼Œåˆ·æ–°æ—¥è®°åŒºåŸŸ
                    updateDiaryContentArea(state.currentDiaryDate);
                }
            }

            const db = new Dexie('WarmBookkeepingDB_v10'); // Upped version for schema change
            db.version(10).stores({
                appConfig: 'id',
                transactions: '++id, timestamp, type, category, amount, currency, remark',
                messages: '++id, timestamp, role, content, type, senderId, relatedId',
                apiProxies: '++id, name, url, apiKey, models',
                aiCharacters: '++id, name, prompt, avatar, proxyId, model, backupProxyId, backupModel',
                currencies: 'code, name, rate',
                transactionTemplates: '++id, name, type, category, amount, currency, remark',
                schedules: '++id, timestamp, title, description, importance, deadline, eventType, completed, recurrence, endDate, completedDates',
                emojiPacks: '++id, name, image, timestamp',
                diaries: '++id, date, charId, content, timestamp'
            });

            const DEFAULT_SYSTEM_PROMPTS = {
                sendTime: true,
                sendModel: true,
                sendRole: true,
                ledger: 'è¿™æ˜¯æˆ‘çš„è®°è´¦æ¡ç›®æ•°æ®ï¼Œè¯·ä½ å¸®æˆ‘åˆ†æžä¸€ä¸‹ï¼š{data}',
                schedule: 'è¿™æ˜¯æˆ‘çš„æ—¥ç¨‹æ•°æ®ï¼Œè¯·ä½ å¸®æˆ‘åˆ†æžä¸€ä¸‹ï¼š{data}',
                pie: 'è¿™æ˜¯æˆ‘è´¦æœ¬å›¾è¡¨æ•°æ®ï¼Œè¯·ä½ å¸®æˆ‘åˆ†æžä¸€ä¸‹ï¼š{data}'
            };

            let state = {
                config: {}, proxies: [], characters: [], messages: [], transactions: [], currencies: [], schedules: [], emojiPacks: [], diaries: [],
                currentTransaction: { type: 'expense', category: null, amountStr: '0', currency: 'RMB' },
                currentSchedule: {},
                calendarState: { year: new Date().getFullYear(), month: new Date().getMonth(), selectedDate: null, mode: 'deadline' },
                ledgerFilters: { months: [], type: 'expense', categories: [] },
                isSelectionMode: false,
                selectedMessages: new Set(),
                currentlyEditingMsgId: null,
                currentlyEditingTransactionId: null,
                currentlyEditingScheduleId: null,
                schedulePageIndex: 0,
                messagesDisplayed: 50,
                isLoadingMore: false,
                currentDiaryCharId: null,
                currentDiaryDate: null
            };

            const ELS = {
                body: document.body,
                app: document.getElementById('app-container'), pages: document.querySelectorAll('.page'), navItems: document.querySelectorAll('.nav-item'),
                chatHeaderTitle: document.getElementById('chat-header-title'), chatAvatar: document.getElementById('setting-chat-avatar-preview'),
                chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('send-btn'),
                accountingScreen: document.getElementById('accounting-screen'), transactionPanel: document.getElementById('transaction-panel'),
                schedulePanel: document.getElementById('schedule-panel'),
                amountDisplay: document.getElementById('amount-display'), categorySelector: document.getElementById('category-selector'),
                ledgerList: document.getElementById('ledger-list'), ledgerSummary: document.getElementById('ledger-summary'),
                ledgerSort: document.getElementById('ledger-sort'),
                ledgerCurrency: document.getElementById('ledger-currency'),
                ledgerCount: document.getElementById('ledger-count'),
                themeSelectors: document.querySelectorAll('input[name="theme"]'),
                sidebar: document.getElementById('chat-sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                chatSettingsBtn: document.getElementById('chat-settings-btn'),
                sidebarTokenCount: document.getElementById('sidebar-token-count'),
                previewContextBtn: document.getElementById('preview-context-btn'),
                sidebarPreviewContent: document.getElementById('sidebar-preview-content'),
            };

            const CATEGORIES = {
                expense: [{ id: 'food', name: 'é¤é¥®ç¾Žé£Ÿ', icon: 'ðŸ”' }, { id: 'shopping', name: 'è´­ç‰©æ¶ˆè´¹', icon: 'ðŸ›ï¸' }, { id: 'transport', name: 'äº¤é€šå‡ºè¡Œ', icon: 'ðŸšŒ' }, { id: 'entertainment', name: 'æ–‡åŒ–å¨±ä¹', icon: 'ðŸŽ¬' }, { id: 'games', name: 'æ¸¸æˆç›¸å…³', icon: 'ðŸŽ®' }, { id: 'housing', name: 'å±…å®¶ç”Ÿæ´»', icon: 'ðŸ ' }, { id: 'medical', name: 'åŒ»ç–—å¥åº·', icon: 'ðŸ’Š' }, { id: 'social', name: 'äººæƒ…å¾€æ¥', icon: 'ðŸŽ' }, { id: 'study', name: 'å­¦ä¹ æå‡', icon: 'ðŸ“š' }, { id: 'other', name: 'å…¶ä»–æ”¯å‡º', icon: 'ðŸ’¸' },],
                income: [{ id: 'salary', name: 'å·¥èµ„', icon: 'ðŸ’¼' }, { id: 'bonus', name: 'å¥–é‡‘', icon: 'ðŸ§§' }, { id: 'investment', name: 'ç†è´¢', icon: 'ðŸ“ˆ' }, { id: 'part-time', name: 'å…¼èŒ', icon: 'ðŸ’ª' }, { id: 'other', name: 'å…¶ä»–æ”¶å…¥', icon: 'ðŸ’°' },]
            };
            const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNGQUUxRDUiLz48cGF0aCBkPSJNNzIgMzVBNiA2IDAgMSAwIDYwIDM1IDYgNiAwIDAgMCA3MiAzNW0tNDQgMEE2IDYgMCAxIDAgMTYgMzUgNiA2IDAgMCAwIDI4IDM1TTMzIDYwYTQwIDQwIDAgMCAwIDM0IDBjLTEuNS05LTcuNS0xNS0xNy0xNVMzNC41IDUxIDMzIDYwWiIgZmlsbD0iIzhDN0I3MyIvPjwvc3ZnPg==';

            async function init() {
                await loadDataFromDB();
                setupEventListeners();
                navigateTo('accounting-screen');
                renderChatMessages();
                renderLedger();
                renderSchedules();
                applyConfigToUI();
                updateSendButtonState();
                populateLedgerCurrencyFilter();
            }


            async function loadDataFromDB() {
                const [config, proxies, characters, messages, transactions, currencies, schedules, emojiPacks, diaries] = await Promise.all([
                    db.appConfig.get('main'),
                    db.apiProxies.toArray(),
                    db.aiCharacters.toArray(),
                    db.messages.orderBy('timestamp').toArray(),
                    db.transactions.orderBy('timestamp').toArray(),
                    db.currencies.toArray(),
                    db.schedules.toArray(),
                    db.emojiPacks.toArray(),
                    db.diaries.toArray()
                ]);

                const defaultDiaryPrompt = `è¯·ä½ å†™ä¸€ç¯‡{char}çš„è§†è§’ä¸­ä¸Ž{user}åœ¨{date}çš„è¿™ä¸€å¤©é«˜åº¦ç›¸å…³çš„æ—¥è®°ï¼Œä¸»è¦æ˜¯ä½ åœ¨è¿™ä¸€å¤©çš„å¯¹è¯ä¸­ï¼Œå¯¹{user}è¡Œä¸ºçš„å¿ƒç†æ´»åŠ¨ç»è¿‡å’Œæƒ…æ„Ÿå˜åŒ–ï¼Œç»“åˆè¿‡å¾€å¯¹è¯è®°å½•æ¥å†™ã€‚æ—¥è®°å†™ä½œé£Žæ ¼éœ€è¦æŒ‰ç…§ä¾ç…§{char}çš„æ€§æ ¼ç‰¹ç‚¹ã€‚ä½ åœ¨å†™æ—¥è®°æ—¶ï¼Œå¯¹{char}ç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸€äººç§°ã€Œæˆ‘ã€ï¼ˆå¦‚â€œæˆ‘æ”¶åˆ°äº†å¥¹çš„æ¶ˆæ¯â€ï¼‰ï¼Œå¯¹{user}åˆ™ä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼ˆå¦‚â€œå¥¹ä»Šå¤©ä¹°å¥¶èŒ¶èŠ±äº†äºŒåå—â€ï¼‰ï¼Œä½†å¶å°”æ’å…¥å¯¹{user}ç¬¬äºŒäººç§°ç›´ç™½çš„è¯ï¼ˆå¦‚â€œæˆ‘æƒ³è®©ä½ çŸ¥é“â€ï¼‰ï¼ŒåŠ å¼ºæƒ…æ„Ÿå†²å‡»ã€‚ç›´æŽ¥ä»¥â€œ{date}ï¼Œè®°å½•è€…ï¼š{char}â€å¼€å¤´ï¼Œ2000å­—å·¦å³~`;

                const baseConfig = {
                    id: 'main',
                    chatName: 'æˆ‘çš„è®°äº‹æœ¬',
                    chatAvatar: DEFAULT_AVATAR,
                    maxTokens: 4096,
                    background: '',
                    theme: 'default',
                    userId: '',
                    userGender: '',
                    userBio: '',
                    systemPromptSettings: DEFAULT_SYSTEM_PROMPTS,
                    diaryPrompt: defaultDiaryPrompt // <--- æ–°å¢žè¿™ä¸€è¡Œ
                };

                state.config = { ...baseConfig, ...config, systemPromptSettings: { ...DEFAULT_SYSTEM_PROMPTS, ...(config ? config.systemPromptSettings : {}) } };

                // ä»Žæ•°æ®åº“åŠ è½½æ—¥è®°æç¤ºè¯ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
                currentDiaryPrompt = state.config.diaryPrompt || defaultDiaryPrompt;

                state.characters = characters.map(char => ({
                    ...char,
                    aiParams: char.aiParams || {
                        mode: 'default',
                        temperature: 0.8,
                        topP: 0.95,
                        topK: 0,
                        frequencyPenalty: 0,
                        presencePenalty: 0,
                    }
                }));

                state.proxies = proxies;
                state.messages = messages;
                state.transactions = transactions;
                state.schedules = schedules || [];
                state.emojiPacks = emojiPacks || [];
                state.diaries = diaries || [];

                if (currencies.length === 0) {
                    const preset = { code: 'HKD', name: 'æ¸¯å¸', rate: 0.92 };
                    await db.currencies.put(preset);
                    state.currencies = [preset];
                } else {
                    state.currencies = currencies;
                }
            }

            function applyConfigToUI() {
                ELS.chatHeaderTitle.textContent = state.config.chatName;
                document.getElementById('setting-chat-name').value = state.config.chatName;
                ELS.chatAvatar.src = state.config.chatAvatar || DEFAULT_AVATAR;
                document.getElementById('max-tokens-input').value = state.config.maxTokens;
                ELS.body.dataset.theme = state.config.theme || 'default';
                const themeRadio = document.querySelector(`input[name="theme"][value="${state.config.theme || 'default'}"]`);
                if (themeRadio) themeRadio.checked = true;
                ELS.accountingScreen.style.backgroundImage = state.config.background ? `url(${state.config.background})` : 'none';
                document.getElementById('setting-user-id').value = state.config.userId || '';
                document.getElementById('setting-user-gender').value = state.config.userGender || '';
                document.getElementById('setting-user-bio').value = state.config.userBio || '';
            }

            async function updateConfig(key, value) {
                state.config[key] = value;
                await db.appConfig.put(state.config);
                applyConfigToUI();
            }

            function navigateTo(pageId) {
                ELS.pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                ELS.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
                if (pageId === 'ledger-screen') renderLedger();
                if (pageId === 'schedule-screen') renderSchedules();
            }

            // è¿™ä¸ªå‡½æ•°ç”¨æ¥å±•å¼€å’Œæ”¶èµ·â€œé«˜çº§è®¾ç½®â€
            function toggleCharacterAdvancedSettings() {
                const settingsDiv = document.getElementById('character-advanced-settings');
                const arrowSpan = document.getElementById('char-advanced-arrow');
                if (settingsDiv.style.display === 'none') {
                    settingsDiv.style.display = 'block';
                    arrowSpan.textContent = 'â–²';
                } else {
                    settingsDiv.style.display = 'none';
                    arrowSpan.textContent = 'â–¼';
                }
            }

            // è¿™é‡Œå­˜æ”¾æˆ‘ä»¬å®šä¹‰å¥½çš„ä¸‰ç§æ¨¡å¼çš„å‚æ•°
            const PARAM_PRESETS = {
                default: { temperature: 0.8, topP: 0.95, topK: 0, frequencyPenalty: 0, presencePenalty: 0 },
                assist: { temperature: 0.4, topP: 0.3, topK: 10, frequencyPenalty: 0.2, presencePenalty: 0.2 },
                companion: { temperature: 0.9, topP: 0.9, topK: 0, frequencyPenalty: 0, presencePenalty: 0 }
            };

            // è¿™ä¸ªå‡½æ•°ç”¨æ¥æŠŠä¸€ä¸ªè§’è‰²çš„æ€§æ ¼å‚æ•°ï¼Œæ˜¾ç¤ºåˆ°æ»‘æ†å’Œå¼€å…³ä¸Š
            function applyCharParamsToEditor(params) {
                params = params || PARAM_PRESETS.default; // å¦‚æžœæ²¡æœ‰å‚æ•°ï¼Œå°±ç”¨é»˜è®¤çš„
                const modeSelect = document.getElementById('character-param-mode');
                const customParamsDiv = document.getElementById('character-custom-params');

                modeSelect.value = params.mode || 'default';

                const currentValues = (params.mode === 'custom') ? params : (PARAM_PRESETS[params.mode] || PARAM_PRESETS.default);

                // æ›´æ–°æ‰€æœ‰æ»‘æ†å’Œæ•°å€¼æ˜¾ç¤º
                document.getElementById('char-temperature').value = currentValues.temperature;
                document.getElementById('char-temp-value').textContent = currentValues.temperature.toFixed(2);
                document.getElementById('char-top-p').value = currentValues.topP;
                document.getElementById('char-topp-value').textContent = currentValues.topP.toFixed(2);
                document.getElementById('char-top-k').value = currentValues.topK;
                document.getElementById('char-topk-value').textContent = currentValues.topK;
                document.getElementById('char-freq-penalty').value = currentValues.frequencyPenalty;
                document.getElementById('char-freq-value').textContent = currentValues.frequencyPenalty.toFixed(2);
                document.getElementById('char-presence-penalty').value = currentValues.presencePenalty;
                document.getElementById('char-pres-value').textContent = currentValues.presencePenalty.toFixed(2);

                if (params.mode === 'custom') {
                    customParamsDiv.style.display = 'block';
                } else {
                    customParamsDiv.style.display = 'none';
                }
            }

            // è¿™ä¸ªå‡½æ•°ç”¨æ¥æŠŠæ»‘æ†å’Œå¼€å…³ä¸Šçš„è®¾ç½®ï¼Œæ”¶é›†èµ·æ¥å‡†å¤‡ä¿å­˜
            function collectCharParamsFromEditor() {
                const mode = document.getElementById('character-param-mode').value;
                const aiParams = { mode: mode };

                if (mode === 'custom') {
                    aiParams.temperature = parseFloat(document.getElementById('char-temperature').value);
                    aiParams.topP = parseFloat(document.getElementById('char-top-p').value);
                    aiParams.topK = parseInt(document.getElementById('char-top-k').value);
                    aiParams.frequencyPenalty = parseFloat(document.getElementById('char-freq-penalty').value);
                    aiParams.presencePenalty = parseFloat(document.getElementById('char-presence-penalty').value);
                } else {
                    // å¦‚æžœä¸æ˜¯è‡ªå®šä¹‰ï¼Œå°±æŠŠé¢„è®¾çš„å‚æ•°ä¹Ÿå­˜ä¸€ä»½è¿›åŽ»ï¼Œæ–¹ä¾¿è°ƒç”¨
                    Object.assign(aiParams, PARAM_PRESETS[mode] || PARAM_PRESETS.default);
                }
                return aiParams;
            }

            // ç»‘å®šæ‰€æœ‰äº‹ä»¶ï¼
            function setupCharParamListeners() {
                const advancedSettingsBtn = document.getElementById('toggle-advanced-settings-btn');
                if (advancedSettingsBtn) {
                    advancedSettingsBtn.addEventListener('click', toggleCharacterAdvancedSettings);
                }
                // ç›‘å¬æ¨¡å¼ä¸‹æ‹‰èœå•çš„å˜åŒ–
                document.getElementById('character-param-mode').addEventListener('change', (e) => {
                    const mode = e.target.value;
                    const customParamsDiv = document.getElementById('character-custom-params');
                    if (mode === 'custom') {
                        customParamsDiv.style.display = 'block';
                    } else {
                        customParamsDiv.style.display = 'none';
                        // å¦‚æžœåˆ‡æ¢åˆ°é¢„è®¾æ¨¡å¼ï¼Œå°±ç«‹åˆ»æŠŠé¢„è®¾å€¼åº”ç”¨åˆ°ç•Œé¢ä¸Š
                        applyCharParamsToEditor({ mode: mode, ...PARAM_PRESETS[mode] });
                    }
                });

                // ç›‘å¬æ‰€æœ‰æ»‘æ†çš„æ‹–åŠ¨
                ['char-temperature', 'char-top-p', 'char-top-k', 'char-freq-penalty', 'char-presence-penalty'].forEach(id => {
                    const slider = document.getElementById(id);
                    if (slider) {
                        slider.addEventListener('input', (e) => {
                            const valueId = id.replace('char-temperature', 'char-temp-value')
                                .replace('char-top-p', 'char-topp-value')
                                .replace('char-top-k', 'char-topk-value')
                                .replace('char-freq-penalty', 'char-freq-value')
                                .replace('char-presence-penalty', 'char-pres-value');
                            const valueDisplay = document.getElementById(valueId);
                            if (valueDisplay) {
                                valueDisplay.textContent = parseFloat(e.target.value).toFixed(2);
                            }
                        });
                    }
                });
            }

            function setupEventListeners() {
                ELS.navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));

                // Auto-saving settings
                document.getElementById('setting-chat-name').addEventListener('input', e => updateConfig('chatName', e.target.value));
                document.getElementById('setting-user-id').addEventListener('input', e => updateConfig('userId', e.target.value));
                document.getElementById('setting-user-gender').addEventListener('change', e => updateConfig('userGender', e.target.value));
                document.getElementById('setting-user-bio').addEventListener('input', e => updateConfig('userBio', e.target.value));
                document.getElementById('max-tokens-input').addEventListener('change', e => updateConfig('maxTokens', parseInt(e.target.value) || 4096));
                ELS.themeSelectors.forEach(radio => radio.addEventListener('change', (e) => {
                    ELS.body.dataset.theme = e.target.value;
                    updateConfig('theme', e.target.value);
                }));

                document.getElementById('upload-user-avatar-btn').addEventListener('click', () => document.getElementById('setting-chat-avatar-input').click());
                document.getElementById('setting-chat-avatar-input').addEventListener('change', (e) => {
                    handleAvatarUpload(e, (base64) => { ELS.chatAvatar.src = base64; updateConfig('chatAvatar', base64); });
                });

                document.getElementById('setting-chat-bg-input').addEventListener('change', async (e) => { if (!e.target.files[0]) return; const base64 = await fileToBase64(e.target.files[0]); updateConfig('background', base64); });
                document.getElementById('remove-bg-btn').addEventListener('click', async () => { updateConfig('background', ''); });

                ELS.chatInput.addEventListener('input', updateSendButtonState);
                ELS.sendBtn.addEventListener('click', sendUserMessage);
                ELS.chatMessages.addEventListener('scroll', () => {
                    if (state.isLoadingMore) return;
                    if (ELS.chatMessages.scrollTop < 100 && state.messagesDisplayed < state.messages.length) {
                        state.isLoadingMore = true;
                        state.messagesDisplayed = Math.min(state.messagesDisplayed + 50, state.messages.length);
                        renderChatMessages(false, false);
                        setTimeout(() => { state.isLoadingMore = false; }, 100);
                    }
                });

                document.getElementById('ai-trigger-btn').addEventListener('click', showAICharacterSelector);
                document.getElementById('image-upload-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
                document.getElementById('chat-add-transaction-btn').addEventListener('click', () => showTransactionPanel());
                document.getElementById('chat-add-schedule-btn').addEventListener('click', () => showSchedulePanel());
                document.getElementById('manage-emoji-packs-btn').addEventListener('click', openEmojiPackManager);
                document.getElementById('emoji-pack-btn').addEventListener('click', showEmojiPackSelector);
                document.getElementById('image-upload-input').addEventListener('change', sendUserImage);
                document.getElementById('close-transaction-panel').addEventListener('click', hideTransactionPanel);
                document.getElementById('close-schedule-panel').addEventListener('click', hideSchedulePanel);
                document.getElementById('type-expense-btn').addEventListener('click', () => switchTransactionType('expense'));
                document.getElementById('type-income-btn').addEventListener('click', () => switchTransactionType('income'));
                document.querySelector('.numpad').addEventListener('click', handleNumpad);
                document.getElementById('numpad-delete').addEventListener('click', handleNumpadDelete);
                document.getElementById('numpad-confirm').addEventListener('click', confirmTransaction);
                document.getElementById('currency-selector').addEventListener('click', toggleCurrency);
                // Template functionality
                document.getElementById('template-dropdown-btn').addEventListener('click', toggleTemplateMenu);
                document.getElementById('save-as-template-btn').addEventListener('click', saveAsTemplate);

                async function toggleTemplateMenu() {
                    const menu = document.getElementById('template-menu');
                    if (menu.style.display === 'none') {
                        await loadTemplates();
                        menu.style.display = 'block';
                    } else {
                        menu.style.display = 'none';
                    }
                }

                async function loadTemplates() {
                    const templates = await db.transactionTemplates.toArray();
                    const listEl = document.getElementById('template-list');
                    listEl.innerHTML = '';

                    if (templates.length === 0) {
                        listEl.innerHTML = '<div style="padding: 8px; color: var(--text-secondary); font-size: 14px;">æš‚æ— æ¨¡æ¿</div>';
                    } else {
                        templates.forEach(template => {
                            const item = document.createElement('div');
                            item.style.cssText = 'padding: 8px; cursor: pointer; border-radius: 6px; margin-bottom: 4px; background: var(--bg-main); display: flex; justify-content: space-between; align-items: center;';
                            item.innerHTML = `
                <span>${template.name}</span>
                <span style="font-size: 20px; color: var(--text-secondary);" data-id="${template.id}" class="delete-template">Ã—</span>
            `;
                            item.addEventListener('click', (e) => {
                                if (!e.target.classList.contains('delete-template')) {
                                    applyTemplate(template);
                                }
                            });
                            listEl.appendChild(item);
                        });

                        // Add delete listeners
                        listEl.querySelectorAll('.delete-template').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                if (confirm('åˆ é™¤æ­¤æ¨¡æ¿ï¼Ÿ')) {
                                    await db.transactionTemplates.delete(parseInt(e.target.dataset.id));
                                    await loadTemplates();
                                }
                            });
                        });
                    }
                }

                function applyTemplate(template) {
                    state.currentTransaction = {
                        type: template.type,
                        category: template.category,
                        amountStr: String(template.amount),
                        currency: template.currency
                    };
                    document.getElementById('transaction-remark-input').value = template.remark || '';
                    document.getElementById('currency-selector').textContent = template.currency;
                    updateAmountDisplay();
                    switchTransactionType(template.type, template.category);
                    document.getElementById('template-menu').style.display = 'none';
                }

                async function saveAsTemplate() {
                    const name = prompt('æ¨¡æ¿åç§°ï¼š');
                    if (!name) return;

                    const template = {
                        name,
                        type: state.currentTransaction.type,
                        category: state.currentTransaction.category,
                        amount: parseFloat(state.currentTransaction.amountStr) || 0,
                        currency: state.currentTransaction.currency,
                        remark: document.getElementById('transaction-remark-input').value
                    };

                    await db.transactionTemplates.add(template);
                    alert('æ¨¡æ¿å·²ä¿å­˜ï¼');
                    document.getElementById('template-menu').style.display = 'none';
                }

                setupSchedulePanelListeners();
                setupCalendarModalListeners();

                // Ledger page listeners
                document.getElementById('ledger-month-filter-btn').addEventListener('click', openMonthFilterModal);
                document.getElementById('ledger-category-filter-btn').addEventListener('click', openCategoryFilterModal);
                ELS.ledgerSort.addEventListener('change', renderLedger);
                document.getElementById('ledger-type-filter').addEventListener('change', renderLedger);
                ELS.ledgerCurrency.addEventListener('change', renderLedger);
                document.getElementById('forward-ledger-btn').addEventListener('click', forwardLedgerToChat);
                document.getElementById('schedule-forward-select').addEventListener('change', async (e) => {
                    const type = e.target.value;
                    if (!type) return;

                    if (type === 'today') {
                        await forwardTodayTasksToChat();
                    } else if (type === 'calendar') {
                        await forwardCalendarViewToChat();
                    } else if (type === 'all') {
                        await forwardScheduleToChat();
                    }

                    e.target.value = ''; // Reset select
                });

                async function forwardTodayTasksToChat() {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    const todayTasks = state.schedules.filter(s => {
                        if (s.eventType === 'once') {
                            if (!s.deadline) return false;
                            const dDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            dDate.setHours(0, 0, 0, 0);
                            return dDate.getTime() === today.getTime();
                        } else if (s.eventType === 'long') {
                            if (!s.recurrence) return false;
                            if (s.endDate && new Date(s.endDate) < today) return false;
                            if (s.deadline) {
                                const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                if (startDate > today) return false;
                            }

                            if (s.recurrence.type === 'daily') return true;
                            if (s.recurrence.type === 'weekly') {
                                return s.recurrence.days && s.recurrence.days.includes(today.getDay());
                            }
                            if (s.recurrence.type === 'monthly') {
                                const dayOfMonth = today.getDate();
                                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                                return s.recurrence.days && (s.recurrence.days.includes(dayOfMonth) ||
                                    (s.recurrence.days.includes('last') && dayOfMonth === lastDay));
                            }
                        }
                        return false;
                    });

                    const pending = [];
                    const completed = [];

                    todayTasks.forEach(task => {
                        const isCompleted = task.eventType === 'once' ? task.completed :
                            (task.completedDates && task.completedDates.includes(todayStr));
                        if (isCompleted) completed.push(task);
                        else pending.push(task);
                    });

                    const summaryData = { pending, completed, date: todayStr };

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'today_tasks_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                    navigateTo('accounting-screen');
                    renderChatMessages(true, true);
                }

                async function forwardCalendarViewToChat() {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = today.getMonth();
                    const monthDays = new Date(year, month + 1, 0).getDate();

                    const monthEvents = {};

                    for (let day = 1; day <= monthDays; day++) {
                        const date = new Date(year, month, day);
                        const events = state.schedules.filter(s => {
                            if (s.eventType === 'once') {
                                if (!s.deadline) return false;
                                const dDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                return dDate.getFullYear() === year && dDate.getMonth() === month && dDate.getDate() === day;
                            } else if (s.eventType === 'long') {
                                if (!s.recurrence) return false;
                                if (s.endDate && new Date(s.endDate) < date) return false;
                                if (s.deadline) {
                                    const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                    if (startDate > date) return false;
                                }

                                if (s.recurrence.type === 'daily') return true;
                                if (s.recurrence.type === 'weekly') {
                                    return s.recurrence.days && s.recurrence.days.includes(date.getDay());
                                }
                                if (s.recurrence.type === 'monthly') {
                                    const lastDay = new Date(year, month + 1, 0).getDate();
                                    return s.recurrence.days && (s.recurrence.days.includes(day) ||
                                        (s.recurrence.days.includes('last') && day === lastDay));
                                }
                            }
                            return false;
                        });

                        if (events.length > 0) {
                            monthEvents[day] = events.map(e => ({ title: e.title, type: e.eventType }));
                        }
                    }

                    const summaryData = { year, month: month + 1, events: monthEvents };

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'calendar_view_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                    navigateTo('accounting-screen');
                    renderChatMessages(true, true);
                }

                setupModal('manage-proxies-btn', 'api-proxy-modal', 'close-proxy-modal', renderProxyList);
                setupModal('manage-characters-btn', 'ai-character-modal', 'close-character-modal', renderCharacterList);
                setupModal('manage-currencies-btn', 'currency-list-modal', 'close-currency-list-modal', renderCurrencyList);
                setupModal('manage-system-prompts-btn', 'system-prompts-modal', null, openSystemPromptsEditor);
                document.getElementById('add-proxy-btn').addEventListener('click', () => openProxyEditor());
                document.getElementById('add-character-btn').addEventListener('click', () => openCharacterEditor());
                document.getElementById('add-currency-btn').addEventListener('click', () => openCurrencyEditor());
                setupEditorModal('proxy-editor-modal', saveProxy);
                setupEditorModal('character-editor-modal', saveCharacter);
                setupEditorModal('currency-editor-modal', saveCurrency);
                setupEditorModal('system-prompts-modal', saveSystemPrompts);
                setupEditorModal('ledger-month-filter-modal', () => { applyLedgerFilters(); document.getElementById('ledger-month-filter-modal').classList.remove('visible'); });
                setupEditorModal('ledger-category-filter-modal', () => { applyLedgerFilters(); document.getElementById('ledger-category-filter-modal').classList.remove('visible'); });
                setupEditorModal('cropper-modal', null);
                setupModal(null, 'ai-character-selector-modal', null, null);
                document.querySelector('#ai-character-selector-modal .cancel-btn').addEventListener('click', () => {
                    document.getElementById('ai-character-selector-modal').classList.remove('visible');
                });

                // åœ¨ä½ çš„ <script> æ ‡ç­¾é‡Œæ‰¾åˆ°è¿™ä¸€è¡Œ:
                setupModal(null, 'message-action-menu', null);

                // æŠŠä¸‹é¢è¿™æ®µä»£ç ç²˜è´´åˆ°å®ƒçš„åŽé¢
                // Fix message action menu close
                document.getElementById('message-action-menu').addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        document.getElementById('message-action-menu').classList.remove('visible');
                    }
                });
                // æ–°å¢žè¿™æ®µï¼Œä¸“é—¨å¤„ç†â€œå–æ¶ˆâ€æŒ‰é’®çš„ç‚¹å‡»
                document.querySelector('#message-action-menu .cancel-btn').addEventListener('click', () => {
                    document.getElementById('message-action-menu').classList.remove('visible');
                });

                const scheduleDetailModal = document.getElementById('schedule-detail-modal');
                scheduleDetailModal.querySelector('#close-schedule-detail-modal').addEventListener('click', () => scheduleDetailModal.classList.remove('visible'));
                scheduleDetailModal.querySelector('#edit-schedule-btn').addEventListener('click', handleEditScheduleFromModal);
                scheduleDetailModal.querySelector('#delete-schedule-btn').addEventListener('click', handleDeleteScheduleFromModal);

                document.getElementById('export-json-btn').addEventListener('click', exportAsJSON);
                document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
                document.getElementById('import-json-input').addEventListener('change', importFromJSON);
                document.getElementById('export-txt-btn').addEventListener('click', exportAsTXT);

                ELS.chatSettingsBtn.addEventListener('click', toggleSidebar);
                ELS.sidebarOverlay.addEventListener('click', toggleSidebar);
                ELS.previewContextBtn.addEventListener('click', toggleContextPreview);

                document.getElementById('cancel-selection-btn').addEventListener('click', exitSelectionMode);
                document.getElementById('delete-selected-btn').addEventListener('click', deleteSelectedMessages);

                // --- NEW: Ledger view swipe logic ---
                let ledgerTouchStartX = 0;
                let ledgerViewIndex = 0; // 0 for list, 1 for chart

                function updateLedgerView() {
                    const wrapper = document.getElementById('ledger-view-wrapper');
                    wrapper.style.transform = `translateX(-${ledgerViewIndex * 50}%)`;
                    document.getElementById('toggle-ledger-view-btn').textContent = ledgerViewIndex === 0 ? 'å›¾è¡¨ ðŸ“Š' : 'åˆ—è¡¨ ðŸ“„';
                }

                document.getElementById('ledger-page-content').addEventListener('touchstart', e => {
                    ledgerTouchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                document.getElementById('ledger-page-content').addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const swipeDist = touchEndX - ledgerTouchStartX;
                    if (Math.abs(swipeDist) < 50) return;

                    if (swipeDist < 0 && ledgerViewIndex === 0) { // Swipe left
                        ledgerViewIndex = 1;
                        updateLedgerView();
                    } else if (swipeDist > 0 && ledgerViewIndex === 1) { // Swipe right
                        ledgerViewIndex = 0;
                        updateLedgerView();
                    }
                });

                document.getElementById('toggle-ledger-view-btn').addEventListener('click', () => {
                    ledgerViewIndex = ledgerViewIndex === 0 ? 1 : 0;
                    updateLedgerView();
                });

                // Ledger list item click for editing
                ELS.ledgerList.addEventListener('click', (e) => {
                    const item = e.target.closest('.ledger-item');
                    if (item && item.dataset.id) {
                        showLedgerDetail(parseInt(item.dataset.id));
                    }
                });

                function showLedgerDetail(id) {
                    const t = state.transactions.find(t => t.id === id);
                    if (!t) return;

                    const category = CATEGORIES[t.type].find(c => c.id === t.category);

                    document.getElementById('ledger-detail-type').textContent = t.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥';
                    document.getElementById('ledger-detail-category').textContent = `${category?.icon || 'ðŸ¤”'} ${category?.name || 'æœªçŸ¥'}`;
                    document.getElementById('ledger-detail-amount').textContent = `${t.amount.toFixed(2)} ${t.currency}`;
                    document.getElementById('ledger-detail-remark').textContent = t.remark || 'æ— å¤‡æ³¨';
                    document.getElementById('ledger-detail-time').textContent = new Date(t.timestamp).toLocaleString();

                    const modal = document.getElementById('ledger-detail-modal');

                    document.getElementById('edit-ledger-btn').onclick = () => {
                        modal.classList.remove('visible');
                        showTransactionPanel(id);
                    };

                    document.getElementById('delete-ledger-btn').onclick = async () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°è´¦åŠå…¶èŠå¤©è®°å½•å—ï¼Ÿ')) {
                            const msg = state.messages.find(m => m.relatedId === id && m.type === 'transaction');
                            await db.transactions.delete(id);
                            state.transactions = state.transactions.filter(t => t.id !== id);
                            if (msg) {
                                await db.messages.delete(msg.id);
                                state.messages = state.messages.filter(m => m.id !== msg.id);
                            }
                            modal.classList.remove('visible');
                            renderLedger();
                            renderChatMessages(false, true);
                        }
                    };

                    document.getElementById('close-ledger-detail-modal').onclick = () => {
                        modal.classList.remove('visible');
                    };

                    modal.classList.add('visible');
                }

                // NEW: Schedule page swipe listeners
                const scheduleSwipeContainer = document.querySelector('.schedule-swipe-container');
                const schedulePagesWrapper = document.querySelector('.schedule-pages-wrapper');
                let scheduleTouchStartX = 0;
                scheduleSwipeContainer.addEventListener('touchstart', e => {
                    scheduleTouchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                scheduleSwipeContainer.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const swipeDist = touchEndX - scheduleTouchStartX;
                    if (Math.abs(swipeDist) < 50) return;

                    if (swipeDist < 0 && state.schedulePageIndex < 2) { // Swipe left
                        state.schedulePageIndex++;
                    } else if (swipeDist > 0 && state.schedulePageIndex > 0) { // Swipe right
                        state.schedulePageIndex--;
                    }
                    updateSchedulePage();
                });

                // æ—¥è®°æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
                document.getElementById('close-diary-modal').addEventListener('click', () => {
                    document.getElementById('diary-modal').classList.remove('visible');
                });

                document.getElementById('edit-diary-prompt-btn').addEventListener('click', () => {
                    document.getElementById('diary-system-prompt').value = currentDiaryPrompt;
                    document.getElementById('diary-prompt-modal').classList.add('visible');
                });

                document.getElementById('save-diary-prompt').addEventListener('click', async () => {
                    const newPrompt = document.getElementById('diary-system-prompt').value;
                    // ç›´æŽ¥è°ƒç”¨ updateConfig å‡½æ•°ï¼Œå®ƒä¼šåŒæ—¶æ›´æ–° state å’Œæ•°æ®åº“
                    await updateConfig('diaryPrompt', newPrompt);
                    console.log('æç¤ºè¯å·²æ›´æ–°å¹¶å­˜å…¥æ•°æ®åº“:', state.config.diaryPrompt);
                    alert('æç¤ºè¯å·²æˆåŠŸä¿å­˜ï¼');
                    document.getElementById('diary-prompt-modal').classList.remove('visible');
                });



                document.querySelector('#diary-prompt-modal .cancel-btn').addEventListener('click', () => {
                    document.getElementById('diary-prompt-modal').classList.remove('visible');
                });

                document.getElementById('diary-char-select').addEventListener('change', async (e) => {
                    const charId = parseInt(e.target.value);
                    if (charId && state.currentDiaryDate) {
                        state.currentDiaryCharId = charId;
                        await loadDiaryForDate(state.currentDiaryDate, charId);
                    }
                });

                document.getElementById('generate-diary-btn').addEventListener('click', generateDiary);
                document.getElementById('delete-diary-btn').addEventListener('click', deleteDiary);

                // æ—¥è®°ç›¸å…³å‡½æ•°
                async function showDiaryModal(date) {
                    state.currentDiaryDate = date;

                    // è®¾ç½®æ ‡é¢˜
                    const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                    document.getElementById('diary-modal-title').textContent = `${dateStr}çš„æ—¥è®°`;

                    // å¡«å……è§’è‰²é€‰æ‹©å™¨
                    const charSelect = document.getElementById('diary-char-select');
                    charSelect.innerHTML = '<option value="">é€‰æ‹©è§’è‰²</option>';
                    state.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        charSelect.appendChild(option);
                    });

                    // å¦‚æžœæœ‰é»˜è®¤è§’è‰²ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                    if (state.characters.length > 0 && !state.currentDiaryCharId) {
                        state.currentDiaryCharId = state.characters[0].id;
                        charSelect.value = state.currentDiaryCharId;
                    } else if (state.currentDiaryCharId) {
                        charSelect.value = state.currentDiaryCharId;
                    }

                    // åŠ è½½æ—¥è®°
                    if (state.currentDiaryCharId) {
                        await loadDiaryForDate(date, state.currentDiaryCharId);
                    } else {
                        showDiaryEmptyState();
                    }

                    document.getElementById('diary-modal').classList.add('visible');
                }

                async function loadDiaryForDate(date, charId) {
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const diary = state.diaries.find(d => d.date === dateStr && d.charId === charId);

                    if (diary) {
                        showDiaryContent(diary.content);
                    } else {
                        showDiaryEmptyState();
                    }
                }

                function showDiaryContent(content) {
                    document.getElementById('diary-empty-state').style.display = 'none';
                    document.getElementById('diary-loading').style.display = 'none';
                    document.getElementById('diary-display').style.display = 'block';
                    document.getElementById('diary-text').textContent = content;

                    const char = state.characters.find(c => c.id === state.currentDiaryCharId);
                    if (char) {
                        document.getElementById('generate-diary-btn').textContent = `ðŸ“” ç”Ÿæˆ${char.name}çš„æ—¥è®°`;
                    }
                }

                function showDiaryEmptyState() {
                    document.getElementById('diary-display').style.display = 'none';
                    document.getElementById('diary-loading').style.display = 'none';
                    document.getElementById('diary-empty-state').style.display = 'block';

                    const char = state.characters.find(c => c.id === state.currentDiaryCharId);
                    if (char && state.currentDiaryDate) {
                        const dateStr = `${state.currentDiaryDate.getFullYear()}å¹´${state.currentDiaryDate.getMonth() + 1}æœˆ${state.currentDiaryDate.getDate()}æ—¥`;
                        document.getElementById('generate-diary-btn').textContent = `ðŸ“” ç”Ÿæˆ${char.name}${dateStr}çš„æ—¥è®°`;
                    }
                }

                function showDiaryLoading() {
                    document.getElementById('diary-empty-state').style.display = 'none';
                    document.getElementById('diary-display').style.display = 'none';
                    document.getElementById('diary-loading').style.display = 'block';
                }

                setupCharParamListeners();
            }

            function updateSendButtonState() { const hasText = ELS.chatInput.value.trim().length > 0; ELS.sendBtn.disabled = !hasText; }

            async function sendUserMessage() {
                if (ELS.sendBtn.disabled) return;
                const text = ELS.chatInput.value.trim();

                if (text) {
                    const newMsg = { timestamp: Date.now(), role: 'user', content: text, type: 'text' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                    ELS.chatInput.value = '';
                    renderChatMessages();
                    updateSendButtonState();
                }
            }

            async function sendUserImage(event) {
                const file = event.target.files[0];
                if (!file) return;

                // åŽ‹ç¼©å›¾ç‰‡
                const compressedBase64 = await compressImage(file, 800, 0.8);

                const newMsg = { timestamp: Date.now(), role: 'user', content: compressedBase64, type: 'image' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                renderChatMessages();
                event.target.value = '';
            }

            async function compressImage(file, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            let width = img.width;
                            let height = img.height;

                            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                            if (width > maxWidth) {
                                height = (maxWidth / width) * height;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // ç»˜åˆ¶åŽ‹ç¼©åŽçš„å›¾ç‰‡
                            ctx.drawImage(img, 0, 0, width, height);

                            // è½¬æ¢ä¸ºbase64
                            const compressedBase64 = canvas.toDataURL('image/webp', quality);
                            resolve(compressedBase64);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            async function compressEmojiPack(file, maxSize = 400) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            let width = img.width;
                            let height = img.height;

                            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œæœ€é•¿è¾¹ä¸º400px
                            if (width > height && width > maxSize) {
                                height = (maxSize / width) * height;
                                width = maxSize;
                            } else if (height > width && height > maxSize) {
                                width = (maxSize / height) * width;
                                height = maxSize;
                            } else if (width === height && width > maxSize) {
                                width = maxSize;
                                height = maxSize;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            const compressedBase64 = canvas.toDataURL('image/webp', 0.8);
                            resolve(compressedBase64);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            async function triggerAIResponse(character) {
                const proxy = state.proxies.find(p => p.id === character.proxyId);
                const backupProxy = state.proxies.find(p => p.id === character.backupProxyId);
                if (!proxy || !character.model) {
                    alert(`è§’è‰² "${character.name}" æœªé…ç½®ä¸»ç”¨APIæˆ–æ¨¡åž‹ï¼Œæ— æ³•å‘è¨€ã€‚`);
                    return;
                }

                const now = new Date();
                const formattedDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                let userProfileString = '';
                if (state.config.userId || state.config.userGender || state.config.userBio) {
                    userProfileString += "[User Profile]\n";
                    if (state.config.userId) userProfileString += `- ID: ${state.config.userId}\n`;
                    if (state.config.userGender) userProfileString += `- Gender: ${state.config.userGender}\n`;
                    if (state.config.userBio) userProfileString += `- Bio: ${state.config.userBio}\n`;
                    userProfileString += '\n';
                }

                const { sendTime, sendModel, sendRole } = state.config.systemPromptSettings;
                let systemInfo = "[System Info]\n";
                if (sendModel) systemInfo += `- Current Model: ${character.model}\n`;
                if (sendTime) systemInfo += `- Current Time: ${formattedDateTime}\n`;
                if (sendRole) systemInfo += `- Your Role: ${character.name}\n`;
                systemInfo += `\n---\n\n`;

                const systemPrefix = userProfileString + systemInfo;
                const systemPrompt = systemPrefix + `${character.prompt}\n\nä½ çš„ä»»åŠ¡æ˜¯ä½œä¸ºèŠå¤©ä¼™ä¼´å¯¹ç”¨æˆ·çš„è®°è´¦å’ŒèŠå¤©å†…å®¹åšå‡ºå›žåº”ã€‚ä½ çš„å›žåº”éœ€è¦ç¬¦åˆä½ çš„äººè®¾ã€‚å¦‚æžœç”¨æˆ·å‘äº†å›¾ç‰‡æˆ–è¡¨æƒ…åŒ…ï¼Œä½ è¦åƒèƒ½çœ‹åˆ°ä¸€æ ·è¿›è¡Œè¯„è®ºã€‚ä½ ä¹Ÿå¯ä»¥å‘é€è¡¨æƒ…åŒ…ï¼Œæ ¼å¼ä¸º[emoji:è¡¨æƒ…åŒ…åç§°]ï¼Œå½“ä½ å‘é€è¡¨æƒ…åŒ…æ—¶ï¼Œéœ€è¦å•ç‹¬æ¢è¡Œã€‚å¯ç”¨çš„è¡¨æƒ…åŒ…æœ‰ï¼š${state.emojiPacks.map(e => e.name).join('ã€')}ã€‚è¯·è‡ªç„¶åœ°è¿›è¡Œå¯¹è¯ã€‚è§„åˆ™å¦‚ä¸‹ï¼š\n1. å‘é€å¤šæ¡æ¶ˆæ¯è¯·ç”¨æ¢è¡Œç¬¦(\\n)åˆ†éš”ï¼Œè¿™ä¼šåˆ›å»ºå¤šä¸ªèŠå¤©æ°”æ³¡ã€‚\n2. åœ¨å•æ¡æ¶ˆæ¯å†…éƒ¨æ¢è¡Œï¼Œè¯·ç›´æŽ¥ä½¿ç”¨ <br> æ ‡ç­¾ã€‚`; const history = buildContext(state.config.maxTokens || 4096).context;

                // 1. ä¸ºä¸»APIçš„è°ƒç”¨åˆ›å»ºä¸€ä¸ªâ€œæ€è€ƒä¸­â€æ°”æ³¡
                const thinkingBubbleId = addThinkingBubble(character);

                let responseText;
                try {
                    // å°è¯•è°ƒç”¨ä¸»API
                    responseText = await callAPI(proxy, systemPrompt, history, character.model, character);
                    await processAIResponse(responseText, thinkingBubbleId, character);
                } catch (mainError) {
                    console.error("Main API failed:", mainError);

                    // 2. ä¸»APIå¤±è´¥ï¼Œå°†å®ƒçš„â€œæ€è€ƒä¸­â€æ°”æ³¡æ›´æ–°ä¸ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶ã€ä¿ç•™ã€‘å®ƒ
                    await updateThinkingBubble(thinkingBubbleId, `[ä¸»APIé”™è¯¯: ${mainError.message}]`, character.id, true);

                    // 3. æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ç”¨APIï¼Œè¿™é‡Œçš„ if/else ç»“æž„æ˜¯ä¿®å¤è¯­æ³•é”™è¯¯çš„å…³é”®
                    if (backupProxy && character.backupModel) {
                        console.log("Main API failed, trying backup API...");

                        // 4. ä¸ºã€å¤‡ç”¨APIã€‘çš„è°ƒç”¨åˆ›å»ºã€æ–°çš„ã€‘â€œæ€è€ƒä¸­â€æ°”æ³¡
                        const backupBubbleId = addThinkingBubble(character);

                        // å°†è°ƒç”¨å¤‡ç”¨APIçš„é€»è¾‘ã€æ•´ä¸ªã€‘æ”¾å…¥ if å—å†…
                        try {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            let backupSystemInfo = "[System Info]\n";
                            if (sendModel) backupSystemInfo += `- Current Model: ${character.backupModel}\n`;
                            if (sendTime) backupSystemInfo += `- Current Time: ${formattedDateTime}\n`;
                            if (sendRole) backupSystemInfo += `- Your Role: ${character.name}\n`;
                            backupSystemInfo += `\n---\n\n`;
                            const backupSystemPrefix = userProfileString + backupSystemInfo;
                            const backupSystemPrompt = systemPrefix + `${character.prompt}\n\nä½ çš„ä»»åŠ¡æ˜¯ä½œä¸ºèŠå¤©ä¼™ä¼´å¯¹ç”¨æˆ·çš„è®°è´¦å’ŒèŠå¤©å†…å®¹åšå‡ºå›žåº”ã€‚ä½ çš„å›žåº”éœ€è¦ç¬¦åˆä½ çš„äººè®¾ã€‚å¦‚æžœç”¨æˆ·å‘äº†å›¾ç‰‡æˆ–è¡¨æƒ…åŒ…ï¼Œä½ è¦åƒèƒ½çœ‹åˆ°ä¸€æ ·è¿›è¡Œè¯„è®ºã€‚ä½ ä¹Ÿå¯ä»¥å‘é€è¡¨æƒ…åŒ…ï¼Œæ ¼å¼ä¸º[emoji:è¡¨æƒ…åŒ…åç§°]ï¼Œå½“ä½ å‘é€è¡¨æƒ…åŒ…æ—¶ï¼Œéœ€è¦å•ç‹¬æ¢è¡Œã€‚å¯ç”¨çš„è¡¨æƒ…åŒ…æœ‰ï¼š${state.emojiPacks.map(e => e.name).join('ã€')}ã€‚è¯·è‡ªç„¶åœ°è¿›è¡Œå¯¹è¯ã€‚è§„åˆ™å¦‚ä¸‹ï¼š\n1. å‘é€å¤šæ¡æ¶ˆæ¯è¯·ç”¨æ¢è¡Œç¬¦(\\n)åˆ†éš”ï¼Œè¿™ä¼šåˆ›å»ºå¤šä¸ªèŠå¤©æ°”æ³¡ã€‚\n2. åœ¨å•æ¡æ¶ˆæ¯å†…éƒ¨æ¢è¡Œï¼Œè¯·ç›´æŽ¥ä½¿ç”¨ <br> æ ‡ç­¾ã€‚`;
                            // å°è¯•è°ƒç”¨å¤‡ç”¨API
                            responseText = await callAPI(backupProxy, backupSystemPrompt, history, character.backupModel, character);

                            // 5. ã€å…³é”®ä¿®æ”¹ã€‘å¤‡ç”¨APIæˆåŠŸåŽï¼Œç”¨å®ƒçš„ç»“æžœæ›´æ–°ã€å®ƒè‡ªå·±ã€‘çš„â€œæ€è€ƒä¸­â€æ°”æ³¡
                            await processAIResponse(responseText, backupBubbleId, character);

                        } catch (backupError) {
                            console.error("Backup API also failed:", backupError);
                            // 6. ã€å…³é”®ä¿®æ”¹ã€‘å¦‚æžœå¤‡ç”¨APIä¹Ÿå¤±è´¥äº†ï¼Œåˆ™æ›´æ–°ã€å®ƒè‡ªå·±ã€‘çš„â€œæ€è€ƒä¸­â€æ°”æ³¡ä¸ºé”™è¯¯ä¿¡æ¯
                            await updateThinkingBubble(backupBubbleId, `[å¤‡ç”¨APIé”™è¯¯: ${backupError.message}]`, character.id, true);
                        }
                    } else {
                        // è¿™ä¸ª else å—çŽ°åœ¨æ­£ç¡®åœ°è·Ÿåœ¨ if åŽé¢
                        console.log("No backup API configured, stopping.");
                    }
                }
            }

            async function processAIResponse(text, bubbleId, character) {
                const aiReplies = text.split('\n').map(r => r.trim()).filter(Boolean);

                if (aiReplies.length > 0) {
                    for (let i = 0; i < aiReplies.length; i++) {
                        let reply = aiReplies[i];
                        const isFirstMessage = (i === 0);

                        if (!isFirstMessage) {
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 600 + 200));
                        }

                        const emojiRegex = /\[emoji:(.*?)\]/;
                        const emojiMatch = reply.match(emojiRegex);

                        if (emojiMatch) {
                            const emojiName = emojiMatch[1];
                            const emoji = state.emojiPacks.find(e => e.name === emojiName);

                            if (emoji) {
                                if (isFirstMessage) {
                                    await updateThinkingBubbleAsEmoji(bubbleId, emoji, character.id);
                                } else {
                                    await addAIEmojiMessage(emoji, character.id);
                                }
                            }

                            const remainingText = reply.replace(emojiRegex, '').trim();
                            if (remainingText) {
                                await addAIMessage(remainingText, character.id);
                            }
                        } else {
                            if (isFirstMessage) {
                                await updateThinkingBubble(bubbleId, reply, character.id);  // ä¿®å¤ï¼šæ·»åŠ  bubbleId
                            } else {
                                await addAIMessage(reply, character.id);
                            }
                        }
                    }
                } else {
                    await updateThinkingBubble(bubbleId, "[AIæ²¡æœ‰è¿”å›žä»»ä½•å†…å®¹]", character.id, true);  // ä¿®å¤ï¼šæ·»åŠ  bubbleId
                }
            }

            // æ·»åŠ æ–°å‡½æ•°ï¼š
            async function updateThinkingBubbleAsEmoji(bubbleId, emoji, senderId) {
                const newMsgData = {
                    timestamp: Date.now(),
                    role: 'assistant',
                    content: `[emoji:${emoji.name}]`,
                    type: 'emoji_pack',
                    senderId
                };
                const newId = await db.messages.add(newMsgData);
                state.messages.push({ ...newMsgData, id: newId });
                const bubbleWrapper = document.getElementById(bubbleId);
                if (bubbleWrapper) {
                    const newBubble = createMessageElement({ ...newMsgData, id: newId });
                    bubbleWrapper.parentElement.replaceChild(newBubble, bubbleWrapper);
                }
            }

            async function addAIEmojiMessage(emoji, senderId) {
                const newMsg = {
                    timestamp: Date.now(),
                    role: 'assistant',
                    content: `[emoji:${emoji.name}]`,
                    type: 'emoji_pack',
                    senderId
                };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                renderChatMessages();
            }

            function buildContext(maxTokens) {
                let context = [];
                let currentTokens = 0;
                const reversedMessages = [...state.messages].reverse();
                const { systemPromptSettings } = state.config;

                // è¿™ä¸ªå˜é‡çŽ°åœ¨ç”¨æ¥è®°å½•â€œä¸Šä¸€ä¸ªå·²å¤„ç†æ¶ˆæ¯çš„æ—¥æœŸâ€
                let processedDateStr = null;

                for (const msg of reversedMessages) {
                    let content;
                    let msgTokens = 0;
                    const role = msg.role === 'assistant' ? 'assistant' : 'user';

                    // --- è¿™éƒ¨åˆ†è§£æžæ¶ˆæ¯å†…å®¹çš„ä»£ç ä¿æŒä¸å˜ ---
                    if (msg.type === 'transaction') {
                        const t = state.transactions.find(t => t.id === msg.relatedId);
                        if (!t) continue;
                        content = `[è®°è´¦æé†’] æˆ‘${t.type === 'expense' ? 'èŠ±äº†' : 'èµšäº†'} ${t.amount}${t.currency}ï¼Œåˆ†ç±»æ˜¯${CATEGORIES[t.type].find(c => c.id === t.category)?.name || 'æœªçŸ¥'}ï¼Œå¤‡æ³¨æ˜¯ï¼šâ€œ${t.remark}â€`;
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'schedule') {
                        const s = state.schedules.find(s => s.id === msg.relatedId);
                        if (!s) continue;
                        const deadlineStr = s.deadline ? formatDeadline(s.deadline) : 'æ— ';
                        const descriptionText = s.description ? `è¯´æ˜Žæ˜¯"${s.description}"` : "æ— ";
                        const statusText = s.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                        const eventTypeStr = s.eventType === 'long' ? 'é•¿æœŸäº‹ä»¶' : 'å•æ¬¡äº‹ä»¶';
                        content = `[æ—¥ç¨‹æé†’-${eventTypeStr}] æˆ‘å®šäº†ä¸ª${eventTypeStr}ï¼š'${s.title}'ã€‚é‡è¦ç¨‹åº¦æ˜¯ ${s.importance.toFixed(1)}/10ï¼Œæˆªæ­¢æ—¥æœŸæ˜¯ ${deadlineStr}ï¼Œ${descriptionText}ï¼Œå½“å‰çŠ¶æ€ï¼š${statusText}ã€‚`;
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'image') {
                        content = [{ type: "image_url", image_url: { url: msg.content } }];
                        msgTokens = 1000;
                    } else if (msg.type === 'emoji_pack') {
                        const match = msg.content.match(/\[emoji:(.*?)\]/);
                        if (match) {
                            content = `[emoji:${match[1]}]`;
                            msgTokens = content.length * 2;
                        }
                    } else if (msg.type === 'ledger_summary') {
                        const data = JSON.stringify(getFilteredTransactions().filtered);
                        content = (systemPromptSettings.ledger || DEFAULT_SYSTEM_PROMPTS.ledger).replace('{data}', data);
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'schedule_summary') {
                        const data = JSON.stringify(state.schedules);
                        content = (systemPromptSettings.schedule || DEFAULT_SYSTEM_PROMPTS.schedule).replace('{data}', data);
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'pie_chart_summary') {
                        content = (systemPromptSettings.pie || DEFAULT_SYSTEM_PROMPTS.pie).replace('{data}', msg.content);
                        msgTokens = content.length * 2;
                    } else {
                        content = msg.content;
                        msgTokens = content.length * 2;
                    }
                    // --- æ¶ˆæ¯è§£æžç»“æŸ ---

                    // ==================== å…¨æ–°çš„æ™ºèƒ½æ—¶é—´æˆ³é€»è¾‘ ====================
                    const msgDate = new Date(msg.timestamp);
                    const currentMsgDateStr = `${msgDate.getFullYear()}-${String(msgDate.getMonth() + 1).padStart(2, '0')}-${String(msgDate.getDate()).padStart(2, '0')}`;

                    let dateMarkerContent = null;
                    let dateMarkerTokens = 0;

                    // æ£€æŸ¥ï¼šå¦‚æžœè¿™ä¸æ˜¯å¾ªçŽ¯çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”å½“å‰æ¶ˆæ¯çš„æ—¥æœŸä¸Žä¸Šä¸€ä¸ªå¤„ç†çš„æ¶ˆæ¯æ—¥æœŸä¸åŒ
                    if (processedDateStr && currentMsgDateStr !== processedDateStr) {
                        // é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±åœ¨æ­¤æ’å…¥ä¸€ä¸ªåˆ†å‰²çº¿ï¼Œå†…å®¹æ˜¯â€œä¸Šä¸€ä¸ªå¤„ç†çš„æ—¥æœŸâ€
                        const prevDate = new Date(processedDateStr);
                        const month = prevDate.getMonth() + 1;
                        const day = prevDate.getDate();
                        dateMarkerContent = `\nâ€”â€”ä»¥ä¸‹æ˜¯${month}æœˆ${day}æ—¥çš„æ¶ˆæ¯â€”â€”\n`;
                        dateMarkerTokens = dateMarkerContent.length * 2;
                    }

                    // æ£€æŸ¥åŠ ä¸Šåˆ†å‰²çº¿ï¼ˆå¦‚æžœéœ€è¦ï¼‰å’Œæ¶ˆæ¯æœ¬èº«åŽï¼Œæ˜¯å¦ä¼šè¶…å‡ºtokené™åˆ¶
                    if (currentTokens + msgTokens + dateMarkerTokens > maxTokens) {
                        break; // å¦‚æžœç©ºé—´ä¸è¶³ï¼Œåˆ™åœæ­¢æ·»åŠ ä»»ä½•æ–°æ¶ˆæ¯
                    }

                    // å¦‚æžœéœ€è¦æ’å…¥åˆ†å‰²çº¿ï¼Œå…ˆæŠŠå®ƒæ”¾è¿›ä¸Šä¸‹æ–‡æ•°ç»„çš„æœ€å‰é¢
                    if (dateMarkerContent) {
                        context.unshift({ role: 'system', content: dateMarkerContent });
                        currentTokens += dateMarkerTokens;
                    }

                    // æŽ¥ç€ï¼ŒæŠŠå½“å‰è¿™æ¡æ¶ˆæ¯æ”¾è¿›ä¸Šä¸‹æ–‡æ•°ç»„çš„æœ€å‰é¢
                    const finalRole = (msg.type !== 'text' && msg.role === 'user') ? 'user' : role;
                    const messageForContext = { role: finalRole, content };

                    if (finalRole === 'assistant' && msg.senderId) {
                        const character = state.characters.find(c => c.id === msg.senderId);
                        if (character) {
                            messageForContext.name = character.name; // ä½¿ç”¨ name å­—æ®µ
                        }
                    }
                    context.unshift(messageForContext);
                    currentTokens += msgTokens;

                    // æœ€åŽï¼Œæ›´æ–°â€œå·²å¤„ç†æ—¥æœŸâ€ï¼Œä¸ºä¸‹ä¸€æ¬¡å¾ªçŽ¯åšå‡†å¤‡
                    processedDateStr = currentMsgDateStr;
                    // ===============================================================
                }
                return { context, tokens: currentTokens };
            }


            async function callAPI(proxy, systemPrompt, history, model, character) { // <--- å¤šäº†ä¸€ä¸ª character å‚æ•°
                // ä»Žè§’è‰²ä¿¡æ¯é‡Œè¯»å–ä»–çš„ä¸“å±žæ€§æ ¼å‚æ•°ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤é¢„è®¾å€¼
                const params = character.aiParams || PARAM_PRESETS.default;

                const res = await fetch(`${proxy.url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${proxy.apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: systemPrompt }, ...history],

                        // --- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œï¼---
                        // æŠŠä»Žè§’è‰²å¯¹è±¡ä¸­è¯»å–çš„æ€§æ ¼å‚æ•°æ”¾åœ¨è¿™é‡Œ
                        temperature: params.temperature,
                        top_p: params.topP,
                        top_k: params.topK,
                        frequency_penalty: params.frequencyPenalty,
                        presence_penalty: params.presencePenalty
                    })
                });

                // --- å‡½æ•°åŽé¢å·²æœ‰çš„é”™è¯¯å¤„ç†å’Œè¿”å›žæ•°æ®çš„ä»£ç ï¼ˆä¿æŒä¸å˜ï¼‰---
                if (!res.ok) {
                    const errorText = await res.text();
                    let errorMessage = 'æœªçŸ¥APIé”™è¯¯';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error.message || errorText;
                    } catch (e) {
                        errorMessage = errorText;
                    }
                    throw new Error(errorMessage);
                }

                const data = await res.json();
                return data.choices[0].message.content;
            }

            async function addAIMessage(content, senderId = null) {
                const newMsg = { timestamp: Date.now(), role: 'assistant', content, type: 'text', senderId };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                renderChatMessages();
            }

            function addThinkingBubble(character) {
                const bubbleId = `thinking-${Date.now()}`;
                const wrapper = createMessageElement({ id: bubbleId, role: 'assistant', type: 'text', senderId: character.id, content: `<div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>` });
                ELS.chatMessages.appendChild(wrapper); ELS.chatMessages.scrollTop = ELS.chatMessages.scrollHeight;
                return bubbleId;
            }

            async function updateThinkingBubble(bubbleId, content, senderId, isError = false) {
                const newMsgData = { timestamp: Date.now(), role: 'assistant', content, type: 'text', senderId };
                const newId = await db.messages.add(newMsgData);
                state.messages.push({ ...newMsgData, id: newId });
                const bubbleWrapper = document.getElementById(bubbleId);
                if (bubbleWrapper) { const newBubble = createMessageElement({ ...newMsgData, id: newId }, isError); bubbleWrapper.parentElement.replaceChild(newBubble, bubbleWrapper); }
                state.messages = state.messages.filter(m => m.id !== bubbleId);
            }

            function parseSimpleMarkdown(text) {
                if (!text) return '';

                // 1. ã€é¡ºåºè°ƒæ•´ã€‘æˆ‘ä»¬å…ˆå¤„ç†æˆ‘ä»¬ä¿¡ä»»çš„ <br> æ ‡ç­¾ï¼ŒæŠŠå®ƒæ¢æˆä¸€ä¸ªä¸´æ—¶çš„ã€ä¸ä¼šè¢«å½±å“çš„æ¢è¡Œç¬¦
                let processedText = text.replace(/<br\s*\/?>/gi, '\n');

                // 2. ã€å®‰å…¨å‡çº§ã€‘çŽ°åœ¨å†å¯¹å‰©ä½™çš„HTMLç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢ XSS æ”»å‡»
                processedText = processedText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

                // 3.ã€æ ¸å¿ƒæ”¹é€ ã€‘å¤„ç†å¤šè¡Œä»£ç å—ï¼Œç”Ÿæˆæ–°çš„å¸¦å¤´éƒ¨çš„ç»“æž„
                processedText = processedText.replace(/^```([a-z]*)?\n([\s\S]+?)\n```$/gm, (match, lang, code) => {
                    const languageName = lang || 'text';
                    const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    return `<div class="markdown-code-block-wrapper">
                            <div class="code-block-header">
                                <span class="language-name">${languageName}</span>
                                <button class="copy-code-btn" title="å¤åˆ¶">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                            <pre><code>${escapedCode}</code></pre>
                        </div>`;
                });

                // 4. å¤„ç†å…¶ä»–å—çº§å…ƒç´ 
                processedText = processedText.replace(/^(?:---|\*\*\*|___)\s*$/gm, '<hr class="markdown-hr">');
                processedText = processedText.replace(/^### (.*$)/gm, '<h3 class="markdown-h">$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2 class="markdown-h">$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1 class="markdown-h">$1</h1>');
                processedText = processedText.replace(/(?:(?:^[ \t]*[-*+]) .*(?:\n|$))+/gm, (match) => {
                    const listItems = match.trim().split('\n').map(item =>
                        item.replace(/^[ \t]*[-*+] (.*)/, '<li>$1</li>')
                    ).join('');
                    return `<ul class="markdown-ul">${listItems}</ul>`;
                });

                // 5. å¤„ç†è¡Œå†…å…ƒç´ 
                processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                processedText = processedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
                processedText = processedText.replace(/`([^`]+)`/g, '<code class="markdown-code">$1</code>');

                // 6. æœ€åŽå¤„ç†æ¢è¡Œç¬¦ï¼ŒçŽ°åœ¨æˆ‘ä»¬åªéœ€è¦æŠŠä¹‹å‰æ›¿æ¢çš„ \n è½¬æ¢å›ž <br>
                processedText = processedText.replace(/<\/div>|<pre>|<\/h[1-3]>|<\/ul>|<\/hr>/g, (match) => `${match}\n`);
                processedText = processedText.replace(/\n/g, '<br>');

                return processedText;
            }

            function attachCopyCodeListeners(container) {
                const copyButtons = container.querySelectorAll('.copy-code-btn');
                copyButtons.forEach(button => {
                    if (button.dataset.listenerAttached) return;

                    const originalContent = button.innerHTML; // ä¿å­˜åŽŸå§‹çš„ SVG å›¾æ ‡
                    const copiedContent = 'å·²å¤åˆ¶!'; // å®šä¹‰å¤åˆ¶æˆåŠŸåŽçš„æ–‡æœ¬

                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const wrapper = button.closest('.markdown-code-block-wrapper');
                        const codeElement = wrapper.querySelector('pre > code');
                        if (codeElement) {
                            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                                button.innerHTML = copiedContent; // ä¸´æ—¶æ˜¾ç¤ºâ€œå·²å¤åˆ¶â€
                                setTimeout(() => {
                                    button.innerHTML = originalContent; // 2ç§’åŽæ¢å¤å›¾æ ‡
                                }, 2000);
                            }).catch(err => {
                                console.error('æ— æ³•å¤åˆ¶: ', err);
                                button.innerHTML = 'å¤±è´¥';
                                setTimeout(() => {
                                    button.innerHTML = originalContent;
                                }, 2000);
                            });
                        }
                    });
                    button.dataset.listenerAttached = 'true';
                });
            }

            function createMessageElement(msg, isError = false) {
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${msg.role === 'user' ? 'user' : 'ai'}`;
                if (isError) wrapper.classList.add('error');
                wrapper.id = msg.id;
                wrapper.dataset.id = msg.id;

                const checkbox = document.createElement('div');
                checkbox.className = 'message-selection-checkbox';
                checkbox.innerHTML = 'âœ“';
                wrapper.appendChild(checkbox);

                wrapper.addEventListener('click', (e) => {
                    if (state.isSelectionMode) {
                        e.stopPropagation();
                        toggleMessageSelection(msg.id);
                    }
                });

                let character = msg.senderId ? state.characters.find(c => c.id === msg.senderId) : null;

                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                avatar.src = msg.role === 'user' ? (state.config.chatAvatar || DEFAULT_AVATAR) : (character ? character.avatar : DEFAULT_AVATAR);

                const messageBlock = document.createElement('div');
                messageBlock.className = 'message-block';

                if (msg.role === 'assistant' && character) {
                    const senderName = document.createElement('div');
                    senderName.className = 'sender-name';
                    senderName.textContent = character.name;
                    messageBlock.appendChild(senderName);
                }

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.classList.add(msg.type);

                const contentContainer = document.createElement('div');
                contentContainer.className = 'content';

                if (msg.type === 'transaction') {
                    const t = state.transactions.find(t => t.id === msg.relatedId);
                    if (!t) return wrapper;
                    const category = CATEGORIES[t.type].find(c => c.id === t.category);
                    const remarkText = t.remark || 'æ²¡æœ‰å¤‡æ³¨å“¦~';
                    contentContainer.innerHTML = `<div class="transaction-card"><div class="transaction-header ${t.type}"><div class="icon">${category?.icon || 'ðŸ¤”'}</div><div class="category-name">${category?.name || 'æœªçŸ¥åˆ†ç±»'}</div></div><div class="transaction-body"><div class="transaction-amount">${t.type === 'expense' ? '-' : '+'}${t.amount.toFixed(2)}<span class="currency-label">${t.currency}</span></div><div class="transaction-remark"><span class="original-text">${remarkText}</span></div></div></div>`;
                } else if (msg.type === 'schedule') {
                    const s = state.schedules.find(s => s.id === msg.relatedId);
                    if (!s) return wrapper;
                    const deadlineStr = s.deadline ? formatDeadline(s.deadline) : 'æ— ';

                    let statusText = 'æœªå®Œæˆ';
                    let statusClass = 'pending';

                    if (s.eventType === 'once' && s.completed) {
                        statusText = 'å·²å®Œæˆ';
                        statusClass = 'completed';
                    } else if (s.eventType === 'long') {
                        const today = new Date();
                        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        if (s.completedDates && s.completedDates.includes(todayStr)) {
                            statusText = 'å·²å®Œæˆ (ä»Šæ—¥)';
                            statusClass = 'completed';
                        }
                    }

                    contentContainer.innerHTML = `<div class="schedule-card"><div class="schedule-header"><div class="icon">ðŸ·ï¸</div><div class="type-name">${s.eventType === 'long' ? 'é•¿æœŸäº‹ä»¶' : 'å•æ¬¡äº‹ä»¶'}</div></div><div class="schedule-body"><div class="schedule-title">${s.title}</div><div class="schedule-importance">é‡è¦ç¨‹åº¦: ${s.importance.toFixed(1)}</div><div class="schedule-deadline">æˆªæ­¢: ${deadlineStr}</div><div class="schedule-status ${statusClass}">çŠ¶æ€: ${statusText}</div>${s.description ? `<div class="schedule-description"><span class="original-text">${s.description}</span></div>` : ''}</div></div>`;
                } else if (msg.type === 'image') {
                    contentContainer.innerHTML = `<img src="${msg.content}" class="chat-image" alt="ç”¨æˆ·å‘é€çš„å›¾ç‰‡">`;
                } else if (msg.type === 'emoji_pack') {
                    // è§£æžè¡¨æƒ…åŒ…åç§°
                    const match = msg.content.match(/\[emoji:(.*?)\]/);
                    if (match) {
                        const emojiName = match[1];
                        const emoji = state.emojiPacks.find(e => e.name === emojiName);
                        if (emoji) {
                            contentContainer.innerHTML = `<img src="${emoji.image}" class="chat-image" alt="${emojiName}" style="max-width: 150px; max-height: 150px;">`;
                        } else {
                            contentContainer.innerHTML = `<span class="content-text">[è¡¨æƒ…åŒ…: ${emojiName}]</span>`;
                        }
                    }
                } else if (msg.type === 'ledger_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">ðŸ“–</div><div class="type-name">æˆ‘çš„è´¦æœ¬</div></div><div class="summary-body"><div class="text">å·²å°†ç­›é€‰è´¦æœ¬ä¿¡æ¯åŒæ­¥ç»™AI</div></div></div>`;
                } else if (msg.type === 'schedule_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">ðŸ—“ï¸</div><div class="type-name">æˆ‘çš„æ—¥ç¨‹</div></div><div class="summary-body"><div class="text">å·²å°†æœ€æ–°æ—¥ç¨‹ä¿¡æ¯åŒæ­¥ç»™AI</div></div></div>`;
                } else if (msg.type === 'pie_chart_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">ðŸ“Š</div><div class="type-name">è´¦æœ¬å›¾è¡¨</div></div><div class="summary-body"><div class="text">å·²å°†å›¾è¡¨åˆ†æžåŒæ­¥ç»™AI</div></div></div>`;
                } else if (msg.type === 'today_tasks_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">ðŸ“…</div><div class="type-name">ä»Šæ—¥å¾…åŠž</div></div><div class="summary-body"><div class="text">å·²å°†ä»Šæ—¥å¾…åŠžåŒæ­¥ç»™AI</div></div></div>`;
                } else if (msg.type === 'calendar_view_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">ðŸ“†</div><div class="type-name">æ—¥åŽ†è§†å›¾</div></div><div class="summary-body"><div class="text">å·²å°†æœ¬æœˆæ—¥ç¨‹åŒæ­¥ç»™AI</div></div></div>`;
                } else {
                    const contentSpan = document.createElement('span');
                    contentSpan.className = 'content-text';
                    contentSpan.innerHTML = msg.id.toString().startsWith('thinking-') ? msg.content : parseSimpleMarkdown(msg.content);
                    contentContainer.appendChild(contentSpan);
                }

                const metaContainer = document.createElement('div');
                metaContainer.className = 'message-meta';
                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                const menuTrigger = document.createElement('span');
                menuTrigger.className = 'message-actions-trigger';
                menuTrigger.innerHTML = 'â‹®';
                menuTrigger.addEventListener('click', (e) => { e.stopPropagation(); cancelCurrentEdit(); showActionMenu(msg.id); });
                metaContainer.append(timestamp, menuTrigger);

                bubble.append(contentContainer, metaContainer);
                messageBlock.appendChild(bubble);

                if (msg.role === 'user') {
                    wrapper.append(messageBlock, avatar);
                } else {
                    wrapper.append(avatar, messageBlock);
                }

                return wrapper;
            }

            function renderChatMessages(shouldScrollToBottom = true, resetDisplay = false) {
                if (resetDisplay) {
                    state.messagesDisplayed = 50;
                }

                const lastScrollTop = ELS.chatMessages.scrollTop;
                const lastScrollHeight = ELS.chatMessages.scrollHeight;
                const isScrolledToBottom = lastScrollHeight - lastScrollTop - ELS.chatMessages.clientHeight < 1;

                const messagesToShow = state.messages.slice(-state.messagesDisplayed);
                const hasMore = state.messagesDisplayed < state.messages.length;

                ELS.chatMessages.innerHTML = '';

                // æ·»åŠ åŠ è½½æ›´å¤šæç¤º
                if (hasMore) {
                    const loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'load-more-indicator';
                    loadMoreDiv.textContent = 'å‘ä¸Šæ»šåŠ¨åŠ è½½æ›´å¤š...';
                    ELS.chatMessages.appendChild(loadMoreDiv);
                }

                messagesToShow.forEach(msg => {
                    if (!msg.id.toString().startsWith('thinking-')) {
                        ELS.chatMessages.appendChild(createMessageElement(msg));
                    }
                });

                if (shouldScrollToBottom || isScrolledToBottom) {
                    ELS.chatMessages.scrollTop = ELS.chatMessages.scrollHeight;
                } else if (!resetDisplay) {
                    // ä¿æŒç›¸å¯¹ä½ç½®
                    const newScrollHeight = ELS.chatMessages.scrollHeight;
                    const scrollDiff = newScrollHeight - lastScrollHeight;
                    ELS.chatMessages.scrollTop = lastScrollTop + scrollDiff;
                }

                attachCopyCodeListeners(ELS.chatMessages); // ç»‘å®šå¤åˆ¶ä»£ç æŒ‰é’®äº‹ä»¶

            }

            function getFilteredTransactions() {
                const typeFilter = document.getElementById('ledger-type-filter')?.value || 'all';
                const { months, categories, type } = state.ledgerFilters;
                const sort = ELS.ledgerSort.value;
                const displayCurrency = ELS.ledgerCurrency.value;

                const allCurrencies = [{ code: 'RMB', rate: 1 }, ...state.currencies];
                const toRate = allCurrencies.find(c => c.code === displayCurrency)?.rate || 1;

                let transactionsWithDisplayAmount = state.transactions.map(t => {
                    const fromRate = allCurrencies.find(c => c.code === t.currency)?.rate || 1;
                    const amountInRMB = t.amount * fromRate;
                    const displayAmount = amountInRMB / toRate;
                    return { ...t, displayAmount };
                });

                let filtered = transactionsWithDisplayAmount;
                // Filter by type (all/expense/income)
                if (typeFilter !== 'all') {
                    filtered = filtered.filter(t => t.type === typeFilter);
                }

                // Filter by month
                if (months.length > 0) {
                    filtered = filtered.filter(t => {
                        const date = new Date(t.timestamp);
                        const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        return months.includes(monthStr);
                    });
                }

                // Filter by category
                if (categories.length > 0) {
                    filtered = filtered.filter(t => t.type === type && categories.includes(t.category));
                }

                filtered.sort((a, b) => {
                    switch (sort) {
                        case 'time_asc': return a.timestamp - b.timestamp;
                        case 'amount_desc': return b.displayAmount - a.displayAmount;
                        case 'amount_asc': return a.displayAmount - b.displayAmount;
                        default: return b.timestamp - a.timestamp;
                    }
                });

                return { filtered, displayCurrency };
            }

            function renderLedger() {
                const { filtered, displayCurrency } = getFilteredTransactions();

                // Render List
                ELS.ledgerList.innerHTML = '';
                let totalExpense = 0, totalIncome = 0;

                if (filtered.length === 0) {
                    ELS.ledgerList.innerHTML = '<li class="empty-state">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„è®°å½•</li>';
                } else {
                    filtered.forEach(t => {
                        if (t.type === 'expense') totalExpense += t.displayAmount;
                        else totalIncome += t.displayAmount;

                        const category = CATEGORIES[t.type].find(c => c.id === t.category);
                        const li = document.createElement('li');
                        li.className = 'ledger-item';
                        li.dataset.id = t.id;
                        li.innerHTML = `<div class="icon">${category?.icon || 'ðŸ¤”'}</div><div class="details"><div class="remark">${t.remark || category?.name || 'ä¸€ç¬”è´¦'}</div><div class="time">${new Date(t.timestamp).toLocaleString()}</div></div><div class="amount ${t.type}">${t.type === 'expense' ? '-' : '+'}${t.displayAmount.toFixed(2)} ${displayCurrency}</div>`;
                        ELS.ledgerList.appendChild(li);
                    });
                }
                ELS.ledgerSummary.innerHTML = `æ€»æ”¯å‡º (${displayCurrency}): <span style="color:var(--expense-color)">${totalExpense.toFixed(2)}</span> | æ€»æ”¶å…¥ (${displayCurrency}): <span style="color:var(--income-color)">${totalIncome.toFixed(2)}</span>`;

                // Render Charts
                renderPieCharts(filtered, displayCurrency);

                // Update total count
                ELS.ledgerCount.textContent = `å·²è®°è´¦${state.transactions.length}ç¬”ðŸ“ˆ`;
            }

            function generatePieChartSubtitle() {
                const { months, categories, type } = state.ledgerFilters;

                let timeText;
                if (months.length === 0) {
                    timeText = 'å…¨æ—¶é—´';
                } else {
                    const sorted = months.map(m => new Date(m + '-01')).sort((a, b) => a - b);
                    const isContinuous = sorted.every((date, i) => {
                        if (i === 0) return true;
                        const prev = sorted[i - 1];
                        return prev.getFullYear() === date.getFullYear() && prev.getMonth() + 1 === date.getMonth();
                    });

                    if (isContinuous && sorted.length > 1) {
                        const start = sorted[0];
                        const end = sorted[sorted.length - 1];
                        timeText = `${start.getFullYear()}å¹´${start.getMonth() + 1}æœˆ - ${end.getFullYear()}å¹´${end.getMonth() + 1}æœˆ`;
                    } else {
                        timeText = sorted.map(d => `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`).join('ã€');
                    }
                }

                let categoryText;
                const allCategoriesForType = CATEGORIES[type].map(c => c.id);
                if (categories.length === 0 || categories.length === allCategoriesForType.length) {
                    categoryText = 'æ€»å…±';
                } else {
                    categoryText = categories.map(catId => {
                        const cat = CATEGORIES[type].find(c => c.id === catId);
                        return cat ? cat.name : '';
                    }).filter(Boolean).join('ã€');
                }

                return `${timeText} ${categoryText}`;
            }

            function renderPieCharts(transactions, currency) {
                const subtitleText = generatePieChartSubtitle();

                const expenseData = {};
                const incomeData = {};

                transactions.forEach(t => {
                    const data = t.type === 'expense' ? expenseData : incomeData;
                    if (!data[t.category]) {
                        data[t.category] = 0;
                    }
                    data[t.category] += t.displayAmount;
                });

                const totalExpense = Object.values(expenseData).reduce((s, a) => s + a, 0);
                const totalIncome = Object.values(incomeData).reduce((s, a) => s + a, 0);

                document.getElementById('expense-pie-subtitle').innerHTML = `${subtitleText}<br><span style="font-weight: bold; color: var(--text-primary);">${totalExpense.toFixed(2)} ${currency}</span>`;
                document.getElementById('income-pie-subtitle').innerHTML = `${subtitleText}<br><span style="font-weight: bold; color: var(--text-primary);">${totalIncome.toFixed(2)} ${currency}</span>`;

                drawPieChart('expense-pie-chart', 'expense-pie-legend', expenseData, CATEGORIES.expense, currency, totalExpense);
                drawPieChart('income-pie-chart', 'income-pie-legend', incomeData, CATEGORIES.income, currency, totalIncome);
            }

            function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
                const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                return {
                    x: centerX + (radius * Math.cos(angleInRadians)),
                    y: centerY + (radius * Math.sin(angleInRadians))
                };
            }

            function describeArc(x, y, radius, startAngle, endAngle) {
                const start = polarToCartesian(x, y, radius, endAngle);
                const end = polarToCartesian(x, y, radius, startAngle);
                const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
                const d = ["M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y, "L", x, y, "L", start.x, start.y].join(" ");
                return d;
            }

            function drawPieChart(svgId, legendId, data, categoryDefinitions, currency, totalAmount) {
                const svg = document.getElementById(svgId);
                const legend = document.getElementById(legendId);
                svg.innerHTML = '';
                legend.innerHTML = '';
                svg.setAttribute('viewBox', '0 0 250 250');
                const tooltip = document.getElementById('pie-chart-tooltip');

                if (totalAmount === 0) {
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute('x', '50%');
                    text.setAttribute('y', '50%');
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', getComputedStyle(document.body).getPropertyValue('--text-secondary'));
                    text.textContent = 'æ— æ•°æ®';
                    svg.appendChild(text);
                    return;
                }

                const cx = 125, cy = 125, radius = 110;
                const colors = ['#f28b82', '#ffc107', '#8dd4bf', '#87c4f4', '#c58af9', '#f4aab6', '#fbc5a6', '#a1c9f4', '#b2e2a4', '#d6a3d6'];
                let colorIndex = 0;
                let startAngle = 0;

                const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);

                for (const [categoryId, amount] of sortedData) {
                    const percentage = (amount / totalAmount) * 100;
                    const angle = percentage / 100 * 360;
                    const endAngle = startAngle + angle;
                    const categoryInfo = categoryDefinitions.find(c => c.id === categoryId);
                    const categoryName = categoryInfo ? categoryInfo.name : 'æœªçŸ¥';
                    const color = colors[colorIndex++ % colors.length];

                    let chartElement;

                    // BUGFIX: Handle full circle case for single category
                    if (angle > 359.9) { // Use tolerance for float issues
                        chartElement = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        chartElement.setAttribute("cx", cx);
                        chartElement.setAttribute("cy", cy);
                        chartElement.setAttribute("r", radius);
                    } else {
                        chartElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        chartElement.setAttribute("d", describeArc(cx, cy, radius, startAngle, endAngle));
                    }

                    chartElement.setAttribute("fill", color);
                    chartElement.dataset.name = categoryName;
                    chartElement.dataset.amount = amount.toFixed(2);
                    chartElement.dataset.percent = percentage.toFixed(1);

                    chartElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const currentActive = svg.querySelector('.active');
                        if (currentActive && currentActive !== chartElement) currentActive.classList.remove('active');
                        chartElement.classList.toggle('active');

                        if (chartElement.classList.contains('active')) {
                            tooltip.innerHTML = `<strong>${chartElement.dataset.name}</strong><br>${chartElement.dataset.percent}%<br>${chartElement.dataset.amount} ${currency}`;
                            const chartViewRect = document.getElementById('ledger-chart-view').getBoundingClientRect();
                            const x = e.clientX - chartViewRect.left;
                            const y = e.clientY - chartViewRect.top + document.getElementById('ledger-chart-view').scrollTop;
                            tooltip.style.left = `${x}px`;
                            tooltip.style.top = `${y}px`;
                            tooltip.style.display = 'block';
                        } else {
                            tooltip.style.display = 'none';
                        }
                    });
                    svg.appendChild(chartElement);

                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `<span class="legend-color-box" style="background-color: ${color};"></span><span>${categoryName}</span>`;
                    legend.appendChild(legendItem);

                    startAngle = endAngle;
                }
            }

            if (!document.getElementById('ledger-chart-view').dataset.listenerAttached) {
                document.getElementById('ledger-chart-view').addEventListener('click', (e) => {
                    if (e.target.tagName !== 'path' && e.target.tagName !== 'circle') {
                        document.getElementById('pie-chart-tooltip').style.display = 'none';
                        const currentActive = document.querySelector('#ledger-chart-view .active');
                        if (currentActive) currentActive.classList.remove('active');
                    }
                });
                document.getElementById('ledger-chart-view').dataset.listenerAttached = 'true';
            }

            function populateLedgerCurrencyFilter() {
                const select = ELS.ledgerCurrency;
                select.innerHTML = '';
                const allCurrenciesForFilter = [{ code: 'RMB', name: 'äººæ°‘å¸' }, ...state.currencies];
                allCurrenciesForFilter.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.code;
                    option.textContent = `${c.name} (${c.code})`;
                    select.appendChild(option);
                });
                select.value = 'RMB';
            }

            function showActionMenu(msgId) {
                const menu = document.getElementById('message-action-menu');
                const msg = state.messages.find(m => m.id === msgId);
                if (!msg) return;

                document.getElementById('multi-select-btn').onclick = () => { menu.classList.remove('visible'); enterSelectionMode(); };

                const editUserBtn = document.getElementById('edit-message-btn');
                const editAiBtn = document.getElementById('edit-ai-message-btn');
                const copyBtn = document.getElementById('copy-message-btn');
                const deleteBtn = document.getElementById('delete-message-btn');

                const isUserText = msg.role === 'user' && msg.type === 'text';
                const isUserTransaction = msg.role === 'user' && msg.type === 'transaction';
                const isUserSchedule = msg.role === 'user' && msg.type === 'schedule';
                const isAiText = msg.role === 'assistant' && msg.type === 'text';
                const isCopyable = isUserText || isAiText || (isUserTransaction && state.transactions.find(t => t.id === msg.relatedId)?.remark) || (isUserSchedule && state.schedules.find(s => s.id === msg.relatedId)?.description);

                editUserBtn.style.display = (isUserText || isUserTransaction || isUserSchedule) ? 'block' : 'none';
                if (isUserTransaction) editUserBtn.innerHTML = 'âœï¸ ç¼–è¾‘å¤‡æ³¨';
                else if (isUserSchedule) editUserBtn.innerHTML = 'âœï¸ ç¼–è¾‘è¯´æ˜Ž';
                else editUserBtn.innerHTML = 'âœï¸ ç¼–è¾‘';

                editAiBtn.style.display = isAiText ? 'block' : 'none';
                copyBtn.style.display = isCopyable ? 'block' : 'none';

                editUserBtn.onclick = () => { menu.classList.remove('visible'); editMessage(msgId); };
                editAiBtn.onclick = () => { menu.classList.remove('visible'); editMessage(msgId); };
                copyBtn.onclick = () => { menu.classList.remove('visible'); copyMessage(msgId); };
                deleteBtn.onclick = () => { menu.classList.remove('visible'); deleteMessage(msgId); };

                menu.classList.add('visible');
            }

            function cancelCurrentEdit() {
                if (!state.currentlyEditingMsgId) return;
                const msgElement = document.getElementById(state.currentlyEditingMsgId);
                if (msgElement) {
                    const bubble = msgElement.querySelector('.message-bubble');
                    if (bubble) bubble.classList.remove('editing');
                    const editContainer = msgElement.querySelector('.inline-edit-container');
                    if (editContainer) editContainer.remove();
                }
                state.currentlyEditingMsgId = null;
            }

            async function editMessage(msgId) {
                cancelCurrentEdit();
                state.currentlyEditingMsgId = msgId;

                const msgIndex = state.messages.findIndex(m => m.id === msgId);
                if (msgIndex === -1) return;
                const msg = state.messages[msgIndex];

                const msgElement = document.getElementById(msgId);
                if (!msgElement) return;

                const bubble = msgElement.querySelector('.message-bubble');
                let targetContainer, originalText;

                if (msg.type === 'transaction') {
                    targetContainer = msgElement.querySelector('.transaction-remark');
                    originalText = state.transactions.find(t => t.id === msg.relatedId)?.remark || '';
                } else if (msg.type === 'schedule') {
                    targetContainer = msgElement.querySelector('.schedule-description');
                    originalText = state.schedules.find(s => s.id === msg.relatedId)?.description || '';
                } else if (msg.type === 'text') {
                    targetContainer = msgElement.querySelector('.content-text').parentElement;
                    originalText = msg.content;
                } else {
                    return;
                }
                if (!targetContainer) {
                    alert("æ­¤é¡¹ç›®æ²¡æœ‰å¯ç¼–è¾‘çš„æ–‡æœ¬ã€‚");
                    cancelCurrentEdit();
                    return;
                }

                bubble.classList.add('editing');

                const editContainer = document.createElement('div');
                editContainer.className = 'inline-edit-container';

                const textarea = document.createElement('textarea');
                textarea.className = 'inline-edit-textarea';
                textarea.value = originalText.replace(/<br>/g, '\n');

                const autoResizeTextarea = () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                };
                textarea.addEventListener('input', autoResizeTextarea);

                const actions = document.createElement('div');
                actions.className = 'inline-edit-actions';

                const saveBtn = document.createElement('button');
                saveBtn.innerHTML = 'âœ“';
                saveBtn.className = 'save';

                const cancelBtn = document.createElement('button');
                cancelBtn.innerHTML = 'Ã—';
                cancelBtn.className = 'cancel';

                actions.append(saveBtn, cancelBtn);
                editContainer.append(textarea, actions);
                targetContainer.append(editContainer);

                autoResizeTextarea();
                textarea.focus();
                textarea.select();

                cancelBtn.onclick = (e) => { e.stopPropagation(); cancelCurrentEdit(); renderChatMessages(false); };

                saveBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const newText = textarea.value.trim();

                    if (msg.type === 'transaction') {
                        const trans = state.transactions.find(t => t.id === msg.relatedId);
                        if (trans) trans.remark = newText;
                        await db.transactions.update(msg.relatedId, { remark: newText });
                        if (document.getElementById('ledger-screen').classList.contains('active')) renderLedger();
                    } else if (msg.type === 'schedule') {
                        const schedule = state.schedules.find(s => s.id === msg.relatedId);
                        if (schedule) schedule.description = newText;
                        await db.schedules.update(msg.relatedId, { description: newText });
                        if (document.getElementById('schedule-screen').classList.contains('active')) renderSchedules();
                    } else if (msg.type === 'text') {
                        state.messages[msgIndex].content = newText;
                        await db.messages.update(msgId, { content: newText });
                    }

                    state.currentlyEditingMsgId = null;
                    renderChatMessages(false);
                };
            }

            async function deleteMessage(msgId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
                const msg = state.messages.find(m => m.id === msgId);
                if (!msg) return;
                if (msg.type === 'transaction' && msg.relatedId) {
                    await db.transactions.delete(msg.relatedId);
                    state.transactions = state.transactions.filter(t => t.id !== msg.relatedId);
                    renderLedger();
                } else if (msg.type === 'schedule' && msg.relatedId) {
                    await db.schedules.delete(msg.relatedId);
                    state.schedules = state.schedules.filter(s => s.id !== msg.relatedId);
                    renderSchedules();
                }
                await db.messages.delete(msgId);
                state.messages = state.messages.filter(m => m.id !== msgId);
                renderChatMessages(false);
            }
            async function copyMessage(msgId) {
                const msg = state.messages.find(m => m.id === msgId);
                if (!msg) return;

                let textToCopy = '';
                if (msg.type === 'text') {
                    textToCopy = msg.content;
                } else if (msg.type === 'transaction') {
                    textToCopy = state.transactions.find(t => t.id === msg.relatedId)?.remark || '';
                } else if (msg.type === 'schedule') {
                    textToCopy = state.schedules.find(s => s.id === msg.relatedId)?.description || '';
                }

                if (textToCopy && navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        alert('å·²å¤åˆ¶ï¼');
                    } catch (err) {
                        console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬: ', err);
                        alert('å¤åˆ¶å¤±è´¥ï¼');
                    }
                }
            }

            function enterSelectionMode() { cancelCurrentEdit(); state.isSelectionMode = true; document.getElementById('accounting-screen').classList.add('selection-mode-active'); }
            function exitSelectionMode() { state.isSelectionMode = false; document.getElementById('accounting-screen').classList.remove('selection-mode-active'); state.selectedMessages.forEach(id => { document.querySelector(`.message-wrapper[data-id="${id}"]`)?.classList.remove('selected'); }); state.selectedMessages.clear(); }
            function toggleMessageSelection(msgId) { const wrapper = document.querySelector(`.message-wrapper[data-id="${msgId}"]`); if (state.selectedMessages.has(msgId)) { state.selectedMessages.delete(msgId); wrapper?.classList.remove('selected'); } else { state.selectedMessages.add(msgId); wrapper?.classList.add('selected'); } }
            async function deleteSelectedMessages() {
                const count = state.selectedMessages.size;
                if (count === 0) return;
                if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) return;

                const msgIdsToDelete = Array.from(state.selectedMessages);
                const transIdsToDelete = [];
                const scheduleIdsToDelete = [];

                for (const msgId of msgIdsToDelete) {
                    const msg = state.messages.find(m => m.id === msgId);
                    if (msg) {
                        if (msg.type === 'transaction' && msg.relatedId) transIdsToDelete.push(msg.relatedId);
                        if (msg.type === 'schedule' && msg.relatedId) scheduleIdsToDelete.push(msg.relatedId);
                    }
                }

                if (transIdsToDelete.length > 0) await db.transactions.bulkDelete(transIdsToDelete);
                if (scheduleIdsToDelete.length > 0) await db.schedules.bulkDelete(scheduleIdsToDelete);
                await db.messages.bulkDelete(msgIdsToDelete);

                state.transactions = state.transactions.filter(t => !transIdsToDelete.includes(t.id));
                state.schedules = state.schedules.filter(s => !scheduleIdsToDelete.includes(s.id));
                state.messages = state.messages.filter(m => !msgIdsToDelete.includes(m.id));

                exitSelectionMode();
                renderChatMessages(false);
                renderLedger();
                renderSchedules();
            }

            // --- Transaction Panel Logic ---
            function showTransactionPanel(id = null) {
                state.currentlyEditingTransactionId = id;
                const remarkInput = document.getElementById('transaction-remark-input');
                const actionsContainer = document.getElementById('numpad-actions');

                // Remove existing delete button if any
                const existingDeleteBtn = document.getElementById('delete-transaction-btn');
                if (existingDeleteBtn) existingDeleteBtn.remove();

                if (id) {
                    const t = state.transactions.find(t => t.id === id);
                    if (!t) { resetTransactionState(); return; }
                    state.currentTransaction = {
                        type: t.type,
                        category: t.category,
                        amountStr: String(t.amount),
                        currency: t.currency
                    };
                    document.getElementById('transaction-panel-title').textContent = 'ç¼–è¾‘è®°è´¦';
                    remarkInput.value = t.remark || '';

                    // Add delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.id = 'delete-transaction-btn';
                    deleteBtn.className = 'delete-transaction';
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.onclick = async () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°è´¦åŠå…¶èŠå¤©è®°å½•å—ï¼Ÿ')) {
                            const msg = state.messages.find(m => m.relatedId === id && m.type === 'transaction');
                            await db.transactions.delete(id);
                            state.transactions = state.transactions.filter(t => t.id !== id);
                            if (msg) {
                                await db.messages.delete(msg.id);
                                state.messages = state.messages.filter(m => m.id !== msg.id);
                            }
                            hideTransactionPanel();
                            renderLedger();
                            renderChatMessages(false);
                        }
                    };
                    actionsContainer.appendChild(deleteBtn);

                } else {
                    resetTransactionState();
                    document.getElementById('transaction-panel-title').textContent = 'æ–°å»ºè®°è´¦';
                    remarkInput.value = '';
                }

                document.getElementById('currency-selector').textContent = state.currentTransaction.currency;
                updateAmountDisplay();
                switchTransactionType(state.currentTransaction.type, state.currentTransaction.category);

                ELS.transactionPanel.classList.add('visible');
                ELS.app.style.overflow = 'hidden';
            }

            function hideTransactionPanel() {
                ELS.transactionPanel.classList.remove('visible');
                ELS.app.style.overflow = 'initial';
                state.currentlyEditingTransactionId = null;
            }

            function switchTransactionType(type, preselectedCategory = null) {
                state.currentTransaction.type = type;
                document.getElementById('type-expense-btn').classList.toggle('active', type === 'expense');
                document.getElementById('type-income-btn').classList.toggle('active', type === 'income');
                renderCategories(preselectedCategory);
            }

            function renderCategories(preselectedCategory = null) {
                ELS.categorySelector.innerHTML = '';
                const cats = CATEGORIES[state.currentTransaction.type];
                cats.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.dataset.id = cat.id;
                    item.innerHTML = `<div class="icon">${cat.icon}</div><div class="name">${cat.name}</div>`;
                    item.addEventListener('click', () => selectCategory(cat.id));
                    ELS.categorySelector.appendChild(item);
                });
                if (preselectedCategory && cats.some(c => c.id === preselectedCategory)) {
                    selectCategory(preselectedCategory);
                } else if (cats.length > 0) {
                    selectCategory(cats[0].id);
                }
            }

            function selectCategory(catId) { state.currentTransaction.category = catId; document.querySelectorAll('.category-item').forEach(item => item.classList.toggle('selected', item.dataset.id === catId)); }
            function handleNumpad(e) { const key = e.target.dataset.key; if (!key) return; let amount = state.currentTransaction.amountStr; if (key === '.') { if (!amount.includes('.')) amount += '.'; } else { if (amount === '0') amount = key; else if (amount.includes('.') && amount.split('.')[1].length >= 2) return; else amount += key; } state.currentTransaction.amountStr = amount; updateAmountDisplay(); }
            function handleNumpadDelete() { let amount = state.currentTransaction.amountStr; amount = amount.slice(0, -1); if (amount === '') amount = '0'; state.currentTransaction.amountStr = amount; updateAmountDisplay(); }
            function toggleCurrency() { const currencies = ['RMB', ...state.currencies.map(c => c.code)]; const currentIndex = currencies.indexOf(state.currentTransaction.currency); const nextIndex = (currentIndex + 1) % currencies.length; const newCurrency = currencies[nextIndex]; state.currentTransaction.currency = newCurrency; document.getElementById('currency-selector').textContent = newCurrency; if (!state.currentlyEditingTransactionId) localStorage.setItem('lastSelectedCurrency', newCurrency); }
            function updateAmountDisplay() { ELS.amountDisplay.textContent = state.currentTransaction.amountStr; }

            async function confirmTransaction() {
                const amount = parseFloat(state.currentTransaction.amountStr);
                if (amount <= 0) { alert('é‡‘é¢å¿…é¡»å¤§äºŽ0'); return; }

                const remark = document.getElementById('transaction-remark-input').value.trim();

                if (state.currentlyEditingTransactionId) {
                    const transIndex = state.transactions.findIndex(t => t.id === state.currentlyEditingTransactionId);
                    if (transIndex > -1) {
                        const originalTransaction = state.transactions[transIndex];
                        const updatedTransaction = {
                            ...originalTransaction,
                            type: state.currentTransaction.type,
                            category: state.currentTransaction.category,
                            amount: amount,
                            currency: state.currentTransaction.currency,
                            remark: remark
                        };
                        await db.transactions.put(updatedTransaction);
                        state.transactions[transIndex] = updatedTransaction;

                        hideTransactionPanel();
                        renderLedger();
                        renderChatMessages(false);
                    }
                } else {
                    const newTransaction = {
                        timestamp: Date.now(),
                        type: state.currentTransaction.type,
                        category: state.currentTransaction.category,
                        amount: amount,
                        currency: state.currentTransaction.currency,
                        remark: remark
                    };
                    const transId = await db.transactions.add(newTransaction);
                    const msgId = await db.messages.add({
                        timestamp: newTransaction.timestamp,
                        role: 'user',
                        content: ``,
                        type: 'transaction',
                        relatedId: transId
                    });
                    state.transactions.push({ ...newTransaction, id: transId });
                    state.messages.push({ id: msgId, timestamp: newTransaction.timestamp, role: 'user', type: 'transaction', relatedId: transId });

                    hideTransactionPanel();
                    resetTransactionState();
                    renderChatMessages();
                }
            }

            function resetTransactionState() {
                const lastCurrency = localStorage.getItem('lastSelectedCurrency') || 'RMB';
                state.currentTransaction = { type: 'expense', category: null, amountStr: '0', currency: lastCurrency };
                updateAmountDisplay();
                document.getElementById('currency-selector').textContent = lastCurrency;
                document.getElementById('transaction-remark-input').value = '';
            }

            // --- Schedule & Calendar Logic (NEW & UPDATED) ---
            function setupSchedulePanelListeners() {
                document.getElementById('schedule-type-once').addEventListener('click', () => setScheduleType('once'));
                document.getElementById('schedule-type-long').addEventListener('click', () => setScheduleType('long'));
                setupImportanceStars();
                document.getElementById('confirm-schedule-btn').addEventListener('click', confirmSchedule);
                document.getElementById('cancel-schedule-btn').addEventListener('click', hideSchedulePanel);
                document.getElementById('deadline-display-text').addEventListener('click', () => { state.calendarState.mode = 'deadline'; showCalendarModal(); });
                document.getElementById('end-date-display-text').addEventListener('click', () => { state.calendarState.mode = 'endDate'; showCalendarModal(); });

                document.getElementById('recurrence-options').addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (btn) {
                        document.querySelectorAll('#recurrence-options button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderRecurrenceDaySelector(btn.dataset.type);
                    }
                });
            }
            function setupCalendarModalListeners() {
                document.getElementById('close-calendar-btn').addEventListener('click', () => document.getElementById('calendar-modal').classList.remove('visible'));
                document.getElementById('prev-month-btn').addEventListener('click', () => {
                    state.calendarState.month--;
                    if (state.calendarState.month < 0) {
                        state.calendarState.month = 11;
                        state.calendarState.year--;
                    }
                    renderCalendar(state.calendarState.year, state.calendarState.month);
                });
                document.getElementById('next-month-btn').addEventListener('click', () => {
                    state.calendarState.month++;
                    if (state.calendarState.month > 11) {
                        state.calendarState.month = 0;
                        state.calendarState.year++;
                    }
                    renderCalendar(state.calendarState.year, state.calendarState.month);
                });
                document.getElementById('calendar-grid').addEventListener('click', (e) => {
                    const dayEl = e.target.closest('.calendar-day');
                    if (dayEl && !dayEl.classList.contains('other-month')) {
                        const selectedDate = new Date(state.calendarState.year, state.calendarState.month, parseInt(dayEl.textContent));
                        if (state.calendarState.mode === 'deadline') {
                            state.currentSchedule.deadlineDate = selectedDate;
                            updateDeadlineDisplay();
                        } else if (state.calendarState.mode === 'endDate') {
                            state.currentSchedule.endDate = selectedDate;
                            updateEndDateDisplay();
                        }
                        document.getElementById('calendar-modal').classList.remove('visible');
                    }
                });
                document.getElementById('clear-date-btn').addEventListener('click', () => {
                    if (state.calendarState.mode === 'deadline') {
                        state.currentSchedule.deadlineDate = null;
                        updateDeadlineDisplay();
                    } else if (state.calendarState.mode === 'endDate') {
                        state.currentSchedule.endDate = null;
                        updateEndDateDisplay();
                    }
                    document.getElementById('calendar-modal').classList.remove('visible');
                });
            }
            function showSchedulePanel(id = null) {
                const titleEl = document.getElementById('schedule-panel-title');
                titleEl.textContent = id ? 'ç¼–è¾‘æ—¥ç¨‹' : 'æ–°å»ºæ—¥ç¨‹';
                resetScheduleState(id);
                ELS.schedulePanel.classList.add('visible');
                ELS.app.style.overflow = 'hidden';
            }
            function hideSchedulePanel() { ELS.schedulePanel.classList.remove('visible'); ELS.app.style.overflow = 'initial'; state.currentlyEditingScheduleId = null; }

            function setScheduleType(type) {
                const isLong = type === 'long';
                document.getElementById('schedule-type-once').classList.toggle('active', !isLong);
                document.getElementById('schedule-type-long').classList.toggle('active', isLong);
                document.getElementById('recurrence-section').style.display = isLong ? 'block' : 'none';
                document.getElementById('end-date-section').style.display = isLong ? 'block' : 'none';
                document.getElementById('deadline-label').textContent = isLong ? 'å¼€å§‹æ—¥æœŸ' : 'æˆªæ­¢æ—¥æœŸ';
            }

            function renderRecurrenceDaySelector(type) {
                const container = document.getElementById('recurrence-selector-days');
                container.innerHTML = '';
                let options = [];
                if (type === 'weekly') {
                    options = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map((day, i) => ({ value: i, text: `å‘¨${day}` }));
                } else if (type === 'monthly') {
                    for (let i = 1; i <= 31; i++) options.push({ value: i, text: `${i}æ—¥` });
                    options.push({ value: 'last', text: 'æœ€åŽä¸€å¤©' });
                }
                options.forEach(opt => {
                    container.innerHTML += `<label><input type="checkbox" name="recurrence-day" value="${opt.value}"> ${opt.text}</label>`;
                });
            }

            function setupImportanceStars() {
                document.getElementById('importance-stars').addEventListener('click', (e) => {
                    const starEl = e.target.closest('.star');
                    if (!starEl) return;
                    const score = parseFloat(document.getElementById('importance-score').textContent);
                    const starIndex = Array.from(starEl.parentElement.children).indexOf(starEl);
                    const baseScore = starIndex * 2;
                    if (score === baseScore + 2) {
                        updateStarsDisplay(baseScore + 1);
                    } else {
                        updateStarsDisplay(baseScore + 2);
                    }
                });
            }
            function updateStarsDisplay(score) {
                document.getElementById('importance-score').textContent = score.toFixed(1);
                const stars = document.querySelectorAll('#importance-stars .star');
                const halfScore = score / 2;
                stars.forEach((star, index) => {
                    star.classList.remove('filled', 'half');
                    if (halfScore >= index + 1) {
                        star.classList.add('filled');
                    } else if (halfScore > index) {
                        star.classList.add('half');
                    }
                });
            }
            function resetScheduleState(id = null) {
                state.currentlyEditingScheduleId = id;
                let schedule = { eventType: 'once', title: '', description: '', importance: 0, deadline: null, completed: false, recurrence: null, endDate: null, completedDates: [] };
                if (id) {
                    const existing = state.schedules.find(s => s.id === id);
                    if (existing) schedule = JSON.parse(JSON.stringify(existing));
                }

                state.currentSchedule.deadlineDate = schedule.deadline ? new Date(schedule.deadline.year, schedule.deadline.month - 1, schedule.deadline.day) : null;
                state.currentSchedule.endDate = schedule.endDate ? new Date(schedule.endDate) : null;

                setScheduleType(schedule.eventType);
                if (schedule.recurrence) {
                    const btn = document.querySelector(`#recurrence-options button[data-type="${schedule.recurrence.type}"]`);
                    if (btn) btn.click();
                    setTimeout(() => {
                        if (schedule.recurrence.days) {
                            schedule.recurrence.days.forEach(day => {
                                const cb = document.querySelector(`input[name="recurrence-day"][value="${day}"]`);
                                if (cb) cb.checked = true;
                            });
                        }
                    }, 0);
                }

                document.getElementById('schedule-title-input').value = schedule.title;
                updateStarsDisplay(schedule.importance);
                updateDeadlineDisplay();
                updateEndDateDisplay();
                document.getElementById('deadline-hour-input').value = schedule.deadline?.hour ?? '';
                document.getElementById('deadline-minute-input').value = schedule.deadline?.minute ?? '';
                document.getElementById('schedule-description-input').value = schedule.description;
            }
            async function confirmSchedule() {
                const title = document.getElementById('schedule-title-input').value.trim();
                if (!title) { alert('è¯·è¾“å…¥æ—¥ç¨‹æ ‡é¢˜ï¼'); return; }

                const hourVal = document.getElementById('deadline-hour-input').value;
                const minuteVal = document.getElementById('deadline-minute-input').value;
                const hour = (hourVal !== '' && !isNaN(parseInt(hourVal))) ? parseInt(hourVal) : null;
                const minute = (minuteVal !== '' && !isNaN(parseInt(minuteVal))) ? parseInt(minuteVal) : null;

                const deadline = state.currentSchedule.deadlineDate ? {
                    year: state.currentSchedule.deadlineDate.getFullYear(),
                    month: state.currentSchedule.deadlineDate.getMonth() + 1,
                    day: state.currentSchedule.deadlineDate.getDate(),
                    hour: (hour >= 0 && hour <= 23) ? hour : null,
                    minute: (minute >= 0 && minute <= 59) ? minute : null,
                } : null;

                const isLongTerm = document.getElementById('schedule-type-long').classList.contains('active');
                let recurrence = null;
                if (isLongTerm) {
                    const activeBtn = document.querySelector('#recurrence-options button.active');
                    if (activeBtn) {
                        const type = activeBtn.dataset.type;
                        let days = [];
                        if (type === 'daily') {
                            recurrence = { type: 'daily' };
                        } else {
                            document.querySelectorAll('input[name="recurrence-day"]:checked').forEach(cb => {
                                days.push(isNaN(parseInt(cb.value)) ? cb.value : parseInt(cb.value));
                            });
                            if (days.length > 0) recurrence = { type, days };
                        }
                    }
                }

                const scheduleData = {
                    timestamp: Date.now(),
                    eventType: isLongTerm ? 'long' : 'once',
                    title: title,
                    importance: parseFloat(document.getElementById('importance-score').textContent),
                    deadline: deadline,
                    description: document.getElementById('schedule-description-input').value.trim(),
                    completed: false,
                    recurrence: recurrence,
                    endDate: state.currentSchedule.endDate ? state.currentSchedule.endDate.toISOString() : null,
                    completedDates: [],
                };

                if (state.currentlyEditingScheduleId) {
                    const existing = state.schedules.find(s => s.id === state.currentlyEditingScheduleId);
                    scheduleData.id = state.currentlyEditingScheduleId;
                    scheduleData.completed = existing.completed;
                    scheduleData.timestamp = existing.timestamp;
                    scheduleData.completedDates = existing.completedDates || [];
                    await db.schedules.put(scheduleData);
                    const index = state.schedules.findIndex(s => s.id === scheduleData.id);
                    state.schedules[index] = scheduleData;
                } else {
                    const id = await db.schedules.add(scheduleData);
                    scheduleData.id = id;
                    state.schedules.push(scheduleData);
                    const msgId = await db.messages.add({ timestamp: scheduleData.timestamp, role: 'user', content: ``, type: 'schedule', relatedId: id });
                    state.messages.push({ id: msgId, timestamp: scheduleData.timestamp, role: 'user', type: 'schedule', relatedId: id });
                }

                hideSchedulePanel();
                renderSchedules();
                renderChatMessages();
            }
            function classifySchedule(schedule) {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const threeDaysLater = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
                let isUrgent = false;

                if (schedule.eventType !== 'long' && schedule.deadline) {
                    const deadlineDate = new Date(schedule.deadline.year, schedule.deadline.month - 1, schedule.deadline.day);
                    if (deadlineDate <= threeDaysLater) isUrgent = true;
                }

                const isImportant = schedule.importance >= 7;
                if (isImportant && isUrgent) return 1;
                if (isImportant && !isUrgent) return 2;
                if (!isImportant && isUrgent) return 3;
                return 4;
            }

            // --- NEW: Schedule Page Rendering ---
            function updateSchedulePage() {
                const wrapper = document.querySelector('.schedule-pages-wrapper');
                const dots = document.querySelectorAll('.schedule-page-dots .dot');
                const titles = ['ä»Šæ—¥å¾…åŠž', 'æ‰€æœ‰æ—¥ç¨‹', 'æ—¥åŽ†è§†å›¾'];

                wrapper.style.transform = `translateX(-${state.schedulePageIndex * 33.333}%)`;
                dots.forEach((dot, i) => dot.classList.toggle('active', i === state.schedulePageIndex));
                document.getElementById('schedule-page-title').textContent = titles[state.schedulePageIndex];
            }

            function renderSchedules() {
                renderTodayTasks();
                renderQuadrantView();
                renderCalendarView();

                let completedCount = state.schedules.filter(s => s.eventType === 'once' && s.completed).length;
                state.schedules.forEach(s => {
                    if (s.eventType === 'long' && Array.isArray(s.completedDates)) {
                        completedCount += s.completedDates.length;
                    }
                });
                document.getElementById('schedule-count').textContent = `å·²å®Œæˆ${completedCount}é¡¹äº‹ä»¶ðŸŒŸ`;
            }

            function renderTodayTasks() {
                const container = document.getElementById('today-tasks-content');
                container.innerHTML = ''; // è¿™ä¸€è¡Œä¿æŒä¸å˜ï¼Œç”¨äºŽæ¸…ç©º
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const todayIncomplete = [];
                const todayCompleted = [];

                // è¿™éƒ¨åˆ†ç­›é€‰é€»è¾‘ä¿æŒä¸å˜
                state.schedules.forEach(s => {
                    let isTodayTask = false;
                    if (s.eventType === 'once') {
                        if (s.deadline) {
                            const deadlineDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            if (deadlineDate.getTime() === today.getTime()) isTodayTask = true;
                        }
                    } else if (s.eventType === 'long' && s.recurrence) {
                        if (s.endDate && new Date(s.endDate) < today) return;
                        if (s.deadline) {
                            const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            if (startDate > today) return;
                        }

                        const dayOfWeek = today.getDay();
                        const dayOfMonth = today.getDate();

                        switch (s.recurrence.type) {
                            case 'daily': isTodayTask = true; break;
                            case 'weekly': isTodayTask = s.recurrence.days.includes(dayOfWeek); break;
                            case 'monthly':
                                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                                if (s.recurrence.days.includes('last') && dayOfMonth === daysInMonth) isTodayTask = true;
                                else isTodayTask = s.recurrence.days.includes(dayOfMonth);
                                break;
                        }
                    }

                    if (isTodayTask) {
                        let isCompleted = (s.eventType === 'once') ? s.completed : (s.completedDates && s.completedDates.includes(todayStr));
                        if (isCompleted) todayCompleted.push(s);
                        else todayIncomplete.push(s);
                    }
                });

                todayIncomplete.sort((a, b) => b.importance - a.importance);
                todayCompleted.sort((a, b) => b.timestamp - a.timestamp);

                // --- è¿™æ˜¯å”¯ä¸€çš„ä¿®æ”¹ä¹‹å¤„ ---
                if (todayIncomplete.length > 0) {
                    // ã€ä¿®å¤ã€‘ä¸å†ä½¿ç”¨ innerHTML +=ï¼Œè€Œæ˜¯ä½¿ç”¨ appendChild
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'schedule-section-title';
                    titleDiv.textContent = 'å¾…å®Œæˆ';
                    container.appendChild(titleDiv);

                    todayIncomplete.forEach(s => container.appendChild(createTodayTaskItem(s, todayStr)));
                }

                if (todayCompleted.length > 0) {
                    // ã€ä¿®å¤ã€‘ä¸å†ä½¿ç”¨ innerHTML +=ï¼Œè€Œæ˜¯ä½¿ç”¨ appendChild
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'schedule-section-title';
                    titleDiv.textContent = 'å·²å®Œæˆ';
                    if (todayIncomplete.length > 0) {
                        titleDiv.style.marginTop = '20px';
                    }
                    container.appendChild(titleDiv);

                    todayCompleted.forEach(s => container.appendChild(createTodayTaskItem(s, todayStr)));
                }
                // --- ä¿®æ”¹ç»“æŸ ---

                if (todayIncomplete.length === 0 && todayCompleted.length === 0) {
                    container.innerHTML = '<div class="empty-state">ä»Šå¤©æ²¡æœ‰å¾…åŠžäº‹é¡¹ï¼Œè½»æ¾ä¸€ä¸‹å§ï¼</div>';
                }
            }

            function createTodayTaskItem(s, todayStr) {
                const item = document.createElement('div');
                item.className = 'today-task-item';
                if (s.importance >= 7) item.classList.add('important');

                let isCompleted = (s.eventType === 'once') ? s.completed : (s.completedDates && s.completedDates.includes(todayStr));
                if (isCompleted) item.classList.add('completed');

                item.innerHTML = `<div class="title">${s.title}</div><div class="checkbox"></div>`;
                item.querySelector('.checkbox').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (s.eventType === 'once') {
                        s.completed = !s.completed;
                        await db.schedules.update(s.id, { completed: s.completed });
                    } else if (s.eventType === 'long') {
                        if (!s.completedDates) s.completedDates = [];
                        if (isCompleted) {
                            s.completedDates = s.completedDates.filter(d => d !== todayStr);
                        } else {
                            s.completedDates.push(todayStr);
                        }
                        await db.schedules.update(s.id, { completedDates: s.completedDates });
                    }
                    renderSchedules();
                    renderChatMessages(false);
                });
                item.addEventListener('click', () => showScheduleDetailModal(s.id));
                return item;
            }

            function renderQuadrantView() {
                const quadrants = { 1: [], 2: [], 3: [], 4: [] };
                const completedOnce = [];
                const completedLong = [];

                state.schedules.forEach(s => {
                    // è¿™ä¸ªåˆ†ç±»é€»è¾‘ä¿æŒä¸å˜
                    if (s.eventType === 'once') {
                        if (s.completed) {
                            completedOnce.push(s);
                        } else {
                            quadrants[classifySchedule(s)].push(s);
                        }
                    } else if (s.eventType === 'long' && s.completedDates && s.completedDates.length > 0) {
                        completedLong.push(s);
                    }
                });

                for (let i = 1; i <= 4; i++) {
                    const container = document.getElementById(`quadrant-${i}-items`);
                    container.innerHTML = '';

                    if (quadrants[i].length > 0) {
                        // --- è¿™é‡Œæ˜¯ä¿®æ”¹çš„æ ¸å¿ƒ ---
                        quadrants[i].sort((a, b) => {
                            // 1. æŒ‰é‡è¦æ€§é™åºæŽ’åˆ— (å€¼è¶Šå¤§è¶Šé å‰)
                            const importanceDiff = b.importance - a.importance;
                            if (importanceDiff !== 0) {
                                return importanceDiff;
                            }

                            // 2. å¦‚æžœé‡è¦æ€§ç›¸åŒï¼Œåˆ™æŒ‰æˆªæ­¢æ—¥æœŸå‡åºæŽ’åˆ— (æ—¥æœŸè¶Šæ—©è¶Šé å‰)
                            // å°† deadline å¯¹è±¡è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼Œæ²¡æœ‰ deadline çš„è§†ä¸ºæ— ç©·å¤§ï¼ŒæŽ’åœ¨æœ€åŽ
                            const aDdlTime = a.deadline ? new Date(a.deadline.year, a.deadline.month - 1, a.deadline.day, a.deadline.hour || 0, a.deadline.minute || 0).getTime() : Infinity;
                            const bDdlTime = b.deadline ? new Date(b.deadline.year, b.deadline.month - 1, b.deadline.day, b.deadline.hour || 0, b.deadline.minute || 0).getTime() : Infinity;

                            return aDdlTime - bDdlTime;

                        }).forEach(s => container.appendChild(createScheduleItemElement(s)));
                    } else {
                        container.innerHTML = `<div class="empty-state">æ— </div>`;
                    }
                }

                // ä¸‹é¢çš„å·²å®Œæˆéƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜
                const completedContainer = document.getElementById('completed-items');
                completedContainer.innerHTML = '';

                completedOnce.sort((a, b) => b.timestamp - a.timestamp);
                completedLong.sort((a, b) => b.timestamp - a.timestamp);

                const allCompleted = [...completedOnce, ...completedLong];

                if (allCompleted.length > 0) {
                    allCompleted.forEach(s => completedContainer.appendChild(createScheduleItemElement(s)));
                } else {
                    completedContainer.innerHTML = `<div class="empty-state">è¿˜æ²¡æœ‰å·²å®Œæˆçš„æ—¥ç¨‹</div>`;
                }
            }

            function renderCalendarView() {
                const now = new Date();
                renderMonthCalendarForView(now.getFullYear(), now.getMonth());
                document.getElementById('calendar-event-list').innerHTML = ''; // Clear event list on initial render
            }

            function renderMonthCalendarForView(year, month) {
                const container = document.getElementById('month-calendar-view');
                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const eventsByDate = {};

                for (let day = 1; day <= daysInMonth; day++) {
                    const checkDate = new Date(year, month, day);
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    eventsByDate[dateStr] = [];

                    state.schedules.forEach(s => {
                        let isTaskForThisDay = false;
                        if (s.eventType === 'once' && s.deadline) {
                            const deadlineDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            if (deadlineDate.getTime() === checkDate.getTime()) isTaskForThisDay = true;
                        } else if (s.eventType === 'long' && s.recurrence) {
                            if (s.endDate && new Date(s.endDate) < checkDate) return;
                            if (s.deadline) {
                                const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                if (startDate > checkDate) return;
                            }

                            if (s.recurrence.type === 'daily') isTaskForThisDay = true;
                            else if (s.recurrence.type === 'weekly') isTaskForThisDay = s.recurrence.days.includes(checkDate.getDay());
                            else if (s.recurrence.type === 'monthly') {
                                if (s.recurrence.days.includes('last') && day === daysInMonth) isTaskForThisDay = true;
                                else isTaskForThisDay = s.recurrence.days.includes(day);
                            }
                        }
                        if (isTaskForThisDay) eventsByDate[dateStr].push(s);
                    });
                }

                const header = `<div class="calendar-header"><span class="calendar-month-year">${year}å¹´ ${month + 1}æœˆ</span></div><div class="calendar-weekdays"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div>`;
                const firstDay = new Date(year, month, 1).getDay();

                for (let i = 0; i < firstDay; i++) { grid.insertAdjacentHTML('beforeend', `<div></div>`); }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

                    if (eventsByDate[dateStr] && eventsByDate[dateStr].length > 0) {
                        const hasImportant = eventsByDate[dateStr].some(s => s.importance >= 7);
                        const dot = document.createElement('div');
                        dot.className = `event-dot ${hasImportant ? 'important' : 'normal'}`;
                        dayEl.appendChild(dot);
                    }

                    if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        dayEl.classList.add('today');
                    }
                    dayEl.addEventListener('click', () => renderEventsForDate(dateStr, eventsByDate[dateStr]));
                    grid.appendChild(dayEl);
                }
                container.innerHTML = header;
                container.appendChild(grid);
            }

            function renderEventsForDate(dateStr, events) {
                const listContainer = document.getElementById('calendar-event-list');
                listContainer.innerHTML = ''; // æ¸…ç©º

                // --- äº‹ä»¶æ˜¾ç¤ºéƒ¨åˆ† (å’ŒåŽŸæ¥ä¸€æ ·) ---
                const parts = dateStr.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                const formattedDate = `${year}å¹´${month}æœˆ${day}æ—¥`;

                const titleDiv = document.createElement('div');
                titleDiv.className = 'schedule-section-title';
                titleDiv.textContent = `${formattedDate} çš„äº‹ä»¶`;
                listContainer.appendChild(titleDiv);

                if (!events || events.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-state';
                    emptyDiv.textContent = 'å½“å¤©æ²¡æœ‰äº‹ä»¶';
                    listContainer.appendChild(emptyDiv);
                } else {
                    events.sort((a, b) => b.importance - a.importance).forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'event-item';
                        let timeStr = '';
                        if (s.deadline && s.deadline.hour !== null && s.deadline.minute !== null) {
                            timeStr = `${String(s.deadline.hour).padStart(2, '0')}:${String(s.deadline.minute).padStart(2, '0')}`;
                        }
                        item.innerHTML = `<div class="event-title">${s.title}</div><div class="event-time">${timeStr}</div>`;
                        listContainer.appendChild(item);
                    });
                }

                // --- æ–°å¢žï¼šæ—¥è®°åŠŸèƒ½åŒº ---
                const hr = document.createElement('hr'); // æ·»åŠ ä¸€æ¡åˆ†å‰²çº¿
                hr.style.cssText = "border: none; border-top: 1px solid var(--border-color); margin: 20px 0;";
                listContainer.appendChild(hr);

                const diaryContainer = document.createElement('div');
                diaryContainer.id = 'diary-section-container';
                listContainer.appendChild(diaryContainer);

                // æ›´æ–° state ä¸­çš„å½“å‰æ—¥æœŸ
                state.currentDiaryDate = new Date(year, month - 1, day);

                // è°ƒç”¨è¾…åŠ©å‡½æ•°æ¥æ¸²æŸ“æ—¥è®°UI
                renderDiarySection(diaryContainer, state.currentDiaryDate);
            }

            // è¾…åŠ©å‡½æ•°1ï¼šæ¸²æŸ“æ•´ä¸ªæ—¥è®°åŒºåŸŸ
            function renderDiarySection(container, date) {
                const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

                // åˆ›å»ºæ—¥è®°åŒºåŸŸçš„ HTML ç»“æž„
                container.innerHTML = `
        <div class="schedule-section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>${dateStr} çš„æ—¥è®°</span>
            <button id="edit-diary-prompt-btn-inline" style="padding: 4px 8px; font-size: 12px; border-radius: 6px; background: var(--bg-soft); border: none; cursor: pointer;">ç¼–è¾‘æç¤ºè¯</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
            <label style="flex-shrink: 0;">è§’è‰²ï¼š</label>
            <select id="diary-char-select-inline" style="flex-grow: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary);"></select>
        </div>
        <div id="diary-content-area-inline">
            <!-- æ—¥è®°å†…å®¹æˆ–ç”ŸæˆæŒ‰é’®ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>
    `;

                // å¡«å……è§’è‰²é€‰æ‹©å™¨
                const charSelect = container.querySelector('#diary-char-select-inline');
                if (state.characters.length > 0) {
                    state.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        charSelect.appendChild(option);
                    });
                    // é»˜è®¤é€‰ä¸­å½“å‰è§’è‰²æˆ–ç¬¬ä¸€ä¸ªè§’è‰²
                    if (state.currentDiaryCharId && state.characters.some(c => c.id === state.currentDiaryCharId)) {
                        charSelect.value = state.currentDiaryCharId;
                    } else {
                        state.currentDiaryCharId = state.characters[0].id;
                        charSelect.value = state.currentDiaryCharId;
                    }
                }

                // --- ç»‘å®šäº‹ä»¶ç›‘å¬ ---

                // 1. ç»‘å®šè§’è‰²é€‰æ‹©å™¨çš„åˆ‡æ¢äº‹ä»¶
                charSelect.addEventListener('change', (e) => {
                    state.currentDiaryCharId = parseInt(e.target.value);
                    updateDiaryContentArea(date); // åˆ‡æ¢è§’è‰²åŽæ›´æ–°æ—¥è®°å†…å®¹
                });

                // 2. ç»‘å®šâ€œç¼–è¾‘æç¤ºè¯â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                container.querySelector('#edit-diary-prompt-btn-inline').addEventListener('click', () => {
                    // æ¯æ¬¡ç‚¹å‡»æ—¶ï¼Œéƒ½ä»Ž state.configä¸­è¯»å–æœ€æ–°çš„æç¤ºè¯
                    document.getElementById('diary-system-prompt').value = state.config.diaryPrompt;

                    // å¼¹å‡ºç¼–è¾‘æ¨¡æ€æ¡†
                    document.getElementById('diary-prompt-modal').classList.add('visible');
                });

                // åˆå§‹åŠ è½½æ—¥è®°å†…å®¹
                updateDiaryContentArea(date);
            }


            // è¾…åŠ©å‡½æ•°2ï¼šæ›´æ–°æ—¥è®°å†…å®¹åŒºåŸŸï¼ˆæ˜¾ç¤ºæ—¥è®°ã€ç”ŸæˆæŒ‰é’®æˆ–åŠ è½½ä¸­ï¼‰
            async function updateDiaryContentArea(date) {
                const contentArea = document.getElementById('diary-content-area-inline');
                if (!contentArea) return;

                const dateStrForDB = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const diary = state.diaries.find(d => d.date === dateStrForDB && d.charId === state.currentDiaryCharId);
                const character = state.characters.find(c => c.id === state.currentDiaryCharId);

                if (diary) {
                    // å¦‚æžœæœ‰æ—¥è®°ï¼Œæ˜¾ç¤ºæ—¥è®°å†…å®¹å’Œåˆ é™¤æŒ‰é’®
                    contentArea.innerHTML = `
            <div id="diary-text-inline" style="background: var(--bg-soft); border-radius: 12px; padding: 20px; white-space: pre-wrap; line-height: 1.8; font-size: 15px; max-height: 400px; overflow-y: auto;"></div>
            <button id="delete-diary-btn-inline" class="form-button" style="margin-top: 15px; background-color: var(--expense-color);">åˆ é™¤æ—¥è®°</button>
        `;
                    contentArea.querySelector('#diary-text-inline').textContent = diary.content;
                    contentArea.querySelector('#delete-diary-btn-inline').addEventListener('click', deleteDiary);
                } else {
                    // å¦‚æžœæ²¡æœ‰æ—¥è®°ï¼Œæ˜¾ç¤ºç”ŸæˆæŒ‰é’®
                    const btnText = character ? `ðŸ“” ç”Ÿæˆ${character.name}çš„æ—¥è®°` : 'ðŸ“” ç”Ÿæˆæ—¥è®°';
                    contentArea.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <p>æš‚æ— æ—¥è®°</p>
                <button id="generate-diary-btn-inline" class="form-button" style="margin-top: 10px;">${btnText}</button>
            </div>
        `;
                    contentArea.querySelector('#generate-diary-btn-inline').addEventListener('click', async () => {
                        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                        contentArea.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; padding: 40px; flex-direction: column;">
                    <div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>
                    <p style="margin-top: 15px; color: var(--text-secondary);">æ­£åœ¨ç”Ÿæˆæ—¥è®°...</p>
                </div>
            `;
                        await generateDiary(); // è°ƒç”¨ç”Ÿæˆæ—¥è®°çš„å‡½æ•°
                        updateDiaryContentArea(date); // ç”ŸæˆåŽå†æ¬¡æ›´æ–°ç•Œé¢
                    });
                }
            }

            function createScheduleItemElement(schedule) {
                const item = document.createElement('div');
                item.className = 'schedule-item';

                let isCompleted = schedule.completed;
                if (schedule.eventType === 'long') {
                    isCompleted = false; // In "All Schedules" view, long-term tasks are not shown as completable
                }
                if (isCompleted) item.classList.add('completed');

                item.dataset.id = schedule.id;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'schedule-item-details';
                detailsDiv.innerHTML = `<div class="title">${schedule.title}</div>`;

                if (schedule.deadline) {
                    const ddl = document.createElement('div');
                    ddl.className = 'ddl';
                    const label = schedule.eventType === 'long' ? 'å¼€å§‹' : 'DDL';
                    ddl.textContent = `${label}: ${formatDeadline(schedule.deadline)}`;
                    detailsDiv.appendChild(ddl);
                }

                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox';
                if (schedule.eventType === 'long') {
                    checkbox.style.display = 'none'; // Don't show checkbox for long term in this view
                }

                item.appendChild(detailsDiv);
                item.appendChild(checkbox);

                checkbox.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (schedule.eventType === 'once') {
                        schedule.completed = !schedule.completed;
                        await db.schedules.update(schedule.id, { completed: schedule.completed });
                        renderSchedules();
                        renderChatMessages(false);
                    }
                });
                item.addEventListener('click', () => showScheduleDetailModal(schedule.id));
                return item;
            }
            function showScheduleDetailModal(id) {
                const schedule = state.schedules.find(s => s.id === id);
                if (!schedule) return;
                state.currentlyEditingScheduleId = id;
                const modal = document.getElementById('schedule-detail-modal');
                document.getElementById('detail-title').textContent = schedule.title;
                document.getElementById('detail-description').textContent = schedule.description || 'æ— ';
                document.getElementById('detail-importance').textContent = `${schedule.importance.toFixed(1)} / 10.0`;
                document.getElementById('detail-deadline').textContent = schedule.deadline ? formatDeadline(schedule.deadline) : 'æ— ';
                document.getElementById('detail-type').textContent = schedule.eventType === 'long' ? 'é•¿æœŸäº‹ä»¶' : 'å•æ¬¡äº‹ä»¶';
                modal.classList.add('visible');
            }
            function handleEditScheduleFromModal() {
                document.getElementById('schedule-detail-modal').classList.remove('visible');
                showSchedulePanel(state.currentlyEditingScheduleId);
            }
            async function handleDeleteScheduleFromModal() {
                if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ—¥ç¨‹åŠå…¶èŠå¤©è®°å½•å—ï¼Ÿ')) return;
                const id = state.currentlyEditingScheduleId;
                const msg = state.messages.find(m => m.relatedId === id && m.type === 'schedule');

                await db.schedules.delete(id);
                state.schedules = state.schedules.filter(s => s.id !== id);
                if (msg) {
                    await db.messages.delete(msg.id);
                    state.messages = state.messages.filter(m => m.id !== msg.id);
                }

                document.getElementById('schedule-detail-modal').classList.remove('visible');
                renderSchedules();
                renderChatMessages(false);
                state.currentlyEditingScheduleId = null;
            }
            function formatDeadline(deadlineObj) {
                if (!deadlineObj) return 'æ— ';
                const { year, month, day, hour, minute } = deadlineObj;
                let str = '';
                if (year && month && day) str += `${year}å¹´${month}æœˆ${day}æ—¥`;

                if (hour != null && minute != null) {
                    if (str) str += ' ';
                    str += `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                }
                return str.trim() || 'æ— ';
            }
            function showCalendarModal() {
                const now = new Date();
                let initialDate = now;
                if (state.calendarState.mode === 'deadline' && state.currentSchedule.deadlineDate) {
                    initialDate = state.currentSchedule.deadlineDate;
                } else if (state.calendarState.mode === 'endDate' && state.currentSchedule.endDate) {
                    initialDate = state.currentSchedule.endDate;
                }

                state.calendarState.year = initialDate.getFullYear();
                state.calendarState.month = initialDate.getMonth();
                renderCalendar(state.calendarState.year, state.calendarState.month);
                document.getElementById('calendar-modal').classList.add('visible');
            }
            function renderCalendar(year, month) {
                const grid = document.getElementById('calendar-grid');
                document.getElementById('calendar-month-year').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                grid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDay; i++) {
                    grid.insertAdjacentHTML('beforeend', `<div></div>`);
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;
                    if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        dayEl.classList.add('today');
                    }

                    let dateToCheck = null;
                    if (state.calendarState.mode === 'deadline') dateToCheck = state.currentSchedule.deadlineDate;
                    else if (state.calendarState.mode === 'endDate') dateToCheck = state.currentSchedule.endDate;

                    if (dateToCheck && year === dateToCheck.getFullYear() && month === dateToCheck.getMonth() && i === dateToCheck.getDate()) {
                        dayEl.classList.add('selected');
                    }
                    grid.appendChild(dayEl);
                }
            }
            function updateDeadlineDisplay() {
                const textEl = document.getElementById('deadline-display-text');
                if (state.currentSchedule.deadlineDate) {
                    textEl.textContent = formatDeadline({
                        year: state.currentSchedule.deadlineDate.getFullYear(),
                        month: state.currentSchedule.deadlineDate.getMonth() + 1,
                        day: state.currentSchedule.deadlineDate.getDate()
                    });
                    textEl.style.color = 'var(--text-primary)';
                } else {
                    textEl.textContent = 'é€‰æ‹©æ—¥æœŸ';
                    textEl.style.color = 'var(--text-secondary)';
                    document.getElementById('deadline-hour-input').value = '';
                    document.getElementById('deadline-minute-input').value = '';
                }
            }
            function updateEndDateDisplay() {
                const textEl = document.getElementById('end-date-display-text');
                if (state.currentSchedule.endDate) {
                    textEl.textContent = formatDeadline({
                        year: state.currentSchedule.endDate.getFullYear(),
                        month: state.currentSchedule.endDate.getMonth() + 1,
                        day: state.currentSchedule.endDate.getDate()
                    });
                    textEl.style.color = 'var(--text-primary)';
                } else {
                    textEl.textContent = 'æ°¸ä¸ç»“æŸ';
                    textEl.style.color = 'var(--text-secondary)';
                }
            }

            // --- Forward to Chat ---
            async function forwardLedgerToChat() {
                const { filtered, displayCurrency } = getFilteredTransactions();
                const isChartView = document.getElementById('ledger-view-wrapper').style.transform === 'translateX(-50%)';

                if (isChartView) {
                    // Sync pie chart data
                    const expenseData = {};
                    const incomeData = {};
                    filtered.forEach(t => {
                        const data = t.type === 'expense' ? expenseData : incomeData;
                        if (!data[t.category]) data[t.category] = 0;
                        data[t.category] += t.displayAmount;
                    });

                    const totalExpense = Object.values(expenseData).reduce((s, a) => s + a, 0);
                    const totalIncome = Object.values(incomeData).reduce((s, a) => s + a, 0);

                    const summaryData = {
                        title: `${generatePieChartSubtitle()}çš„è´¦å•æ€»ç»“`,
                        totalExpense,
                        totalIncome,
                        expenseDetails: Object.entries(expenseData).map(([catId, amount]) => ({
                            id: catId,
                            name: CATEGORIES.expense.find(c => c.id === catId)?.name || 'æœªçŸ¥',
                            amount,
                            percentage: totalExpense > 0 ? (amount / totalExpense * 100) : 0
                        })),
                        incomeDetails: Object.entries(incomeData).map(([catId, amount]) => ({
                            id: catId,
                            name: CATEGORIES.income.find(c => c.id === catId)?.name || 'æœªçŸ¥',
                            amount,
                            percentage: totalIncome > 0 ? (amount / totalIncome * 100) : 0
                        })),
                        currency: displayCurrency
                    };

                    if (totalExpense === 0 && totalIncome === 0) { alert('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ•°æ®å¯åŒæ­¥'); return; }
                    if (!confirm('è¦å°†å½“å‰å›¾è¡¨åˆ†æžåŒæ­¥åˆ°èŠå¤©ä¸­å—ï¼Ÿ')) return;

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'pie_chart_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                } else {
                    // Sync list data
                    if (filtered.length === 0) { alert('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ•°æ®å¯åŒæ­¥'); return; }
                    if (!confirm('è¦å°†å½“å‰ç­›é€‰çš„è´¦æœ¬åˆ—è¡¨åŒæ­¥åˆ°èŠå¤©ä¸­å—ï¼Ÿ')) return;

                    const summaryData = filtered.map(t => ({
                        type: t.type,
                        amount: t.amount,
                        currency: t.currency,
                        category: CATEGORIES[t.type].find(c => c.id === t.category)?.name || 'æœªçŸ¥',
                        remark: t.remark
                    }));

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'ledger_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                }
                navigateTo('accounting-screen');
                renderChatMessages(true, true);
            }
            async function forwardScheduleToChat() {
                if (!confirm('è¦å°†å®Œæ•´çš„æ—¥ç¨‹ä¿¡æ¯åŒæ­¥åˆ°èŠå¤©ä¸­å—ï¼Ÿ')) return;

                const summaryData = state.schedules.map(s => ({
                    title: s.title,
                    eventType: s.eventType,
                    importance: s.importance,
                    deadline: s.deadline ? formatDeadline(s.deadline) : 'æ— ',
                    description: s.description,
                    completed: s.completed
                }));

                const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'schedule_summary' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                navigateTo('accounting-screen');
                renderChatMessages(true, true);
            }

            // --- Ledger Filter Modals ---
            function openMonthFilterModal() {
                const modal = document.getElementById('ledger-month-filter-modal');
                const list = document.getElementById('month-filter-list');
                list.innerHTML = '';

                const availableMonths = [...new Set(state.transactions.map(t => {
                    const d = new Date(t.timestamp);
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                }))].sort().reverse();

                availableMonths.forEach(monthStr => {
                    const item = document.createElement('div');
                    item.className = 'filter-item';
                    const isChecked = state.ledgerFilters.months.includes(monthStr);
                    item.innerHTML = `
                    <input type="checkbox" id="month-${monthStr}" value="${monthStr}" ${isChecked ? 'checked' : ''}>
                    <label for="month-${monthStr}">${monthStr.replace('-', 'å¹´')}æœˆ</label>
                `;
                    list.appendChild(item);
                });
                modal.classList.add('visible');
            }

            function openCategoryFilterModal() {
                const modal = document.getElementById('ledger-category-filter-modal');
                const renderList = (type) => {
                    const list = document.getElementById('category-filter-list');
                    list.innerHTML = '';
                    CATEGORIES[type].forEach(cat => {
                        const item = document.createElement('div');
                        item.className = 'filter-item';
                        const isChecked = state.ledgerFilters.type === type && state.ledgerFilters.categories.includes(cat.id);
                        item.innerHTML = `
                        <input type="checkbox" id="cat-${cat.id}" value="${cat.id}" ${isChecked ? 'checked' : ''}>
                        <label for="cat-${cat.id}">${cat.name}</label>
                    `;
                        list.appendChild(item);
                    });
                };

                const tabs = modal.querySelectorAll('.filter-tab');
                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.type === state.ledgerFilters.type);
                    tab.onclick = () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        renderList(tab.dataset.type);
                    };
                });

                renderList(state.ledgerFilters.type);
                modal.classList.add('visible');
            }

            function applyLedgerFilters() {
                // Month filter
                const monthModal = document.getElementById('ledger-month-filter-modal');
                const selectedMonths = [];
                monthModal.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    selectedMonths.push(cb.value);
                });
                state.ledgerFilters.months = selectedMonths;

                // Category filter
                const categoryModal = document.getElementById('ledger-category-filter-modal');
                const activeTab = categoryModal.querySelector('.filter-tab.active');
                if (activeTab) {
                    state.ledgerFilters.type = activeTab.dataset.type;
                    const selectedCategories = [];
                    categoryModal.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        selectedCategories.push(cb.value);
                    });
                    state.ledgerFilters.categories = selectedCategories;
                }

                renderLedger();
            }

            // --- General & Utility Functions ---
            function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }

            let cropper = null;
            function handleAvatarUpload(event, callback) {
                const file = event.target.files[0];
                if (!file) return;

                const modal = document.getElementById('cropper-modal');
                const image = document.getElementById('cropper-image');
                const saveBtn = modal.querySelector('.save-btn');

                const reader = new FileReader();
                reader.onload = (e) => {
                    image.src = e.target.result;
                    modal.classList.add('visible');

                    if (cropper) cropper.destroy();
                    cropper = new Cropper(image, {
                        aspectRatio: 1,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 0.8,
                    });

                    saveBtn.onclick = () => {
                        const canvas = cropper.getCroppedCanvas({ width: 256, height: 256, });
                        const croppedBase64 = canvas.toDataURL('image/png');
                        callback(croppedBase64);
                        modal.classList.remove('visible');
                        cropper.destroy();
                        cropper = null;
                    };
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            function download(filename, text, mimeType = 'text/plain') {
                const blob = new Blob(['\uFEFF' + text], { type: `${mimeType};charset=utf-8` });
                const element = document.createElement('a');
                element.href = URL.createObjectURL(blob);
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                URL.revokeObjectURL(element.href);
            }

            async function exportAsJSON() {
                const dataToExport = {
                    appConfig: await db.appConfig.toArray(),
                    transactions: await db.transactions.toArray(),
                    messages: await db.messages.toArray(),
                    apiProxies: await db.apiProxies.toArray(),
                    aiCharacters: await db.aiCharacters.toArray(),
                    currencies: await db.currencies.toArray(),
                    schedules: await db.schedules.toArray(),
                    emojiPacks: await db.emojiPacks.toArray()
                };
                download('Cava-Backup.json', JSON.stringify(dataToExport, null, 2), 'application/json');
            }
            async function importFromJSON(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–çŽ°æœ‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        await db.delete();
                        await db.open();
                        if (data.appConfig) await db.appConfig.bulkPut(data.appConfig);
                        if (data.transactions) await db.transactions.bulkPut(data.transactions);
                        if (data.messages) await db.messages.bulkPut(data.messages);
                        if (data.apiProxies) await db.apiProxies.bulkPut(data.apiProxies);
                        if (data.aiCharacters) await db.aiCharacters.bulkPut(data.aiCharacters);
                        if (data.currencies) await db.currencies.bulkPut(data.currencies);
                        if (data.schedules) await db.schedules.bulkPut(data.schedules);
                        if (data.emojiPacks) await db.emojiPacks.bulkPut(data.emojiPacks);
                        alert('å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                        location.reload();
                    } catch (err) { alert(`å¯¼å…¥å¤±è´¥: ${err.message}`); }
                };
                reader.readAsText(file);
            }

            async function exportAsTXT() {
                let content = `=== ${state.config.chatName} å¯¼å‡ºè®°å½• ===\n`;
                content += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n`;

                state.messages.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleString();
                    let text = '';

                    if (msg.type === 'text') {
                        text = msg.content;
                    } else if (msg.type === 'transaction') {
                        const t = state.transactions.find(t => t.id === msg.relatedId);
                        if (t) {
                            const category = CATEGORIES[t.type].find(c => c.id === t.category);
                            text = `[è®°è´¦] ${t.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'} ${t.amount}${t.currency} - ${category?.name || 'æœªçŸ¥'} - å¤‡æ³¨: ${t.remark || 'æ— '}`;
                        }
                    } else if (msg.type === 'schedule') {
                        const s = state.schedules.find(s => s.id === msg.relatedId);
                        if (s) {
                            const deadlineStr = s.deadline ? formatDeadline(s.deadline) : 'æ— ';
                            const eventTypeStr = s.eventType === 'long' ? 'é•¿æœŸäº‹ä»¶' : 'å•æ¬¡äº‹ä»¶';
                            text = `[æ—¥ç¨‹-${eventTypeStr}] ${s.title} - é‡è¦åº¦: ${s.importance.toFixed(1)} - æˆªæ­¢: ${deadlineStr} - è¯´æ˜Ž: ${s.description || 'æ— '} - çŠ¶æ€: ${s.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}`;
                        }
                    } else if (msg.type === 'image') {
                        text = '[å›¾ç‰‡]';
                    } else if (msg.type === 'ledger_summary') {
                        if (!msg.content) {
                            text = '[è´¦æœ¬æ‘˜è¦åŒæ­¥]';
                        } else {
                            try {
                                const data = JSON.parse(msg.content);
                                text = `[è´¦æœ¬æ‘˜è¦åŒæ­¥] å…±${data.length}æ¡è®°å½•\n`;
                                text += data.map(t => `  - ${t.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'} ${t.amount}${t.currency} (${t.category}): ${t.remark || 'æ— '}`).join('\n');
                            } catch (e) {
                                text = '[è´¦æœ¬æ‘˜è¦åŒæ­¥] (æ•°æ®æ ¼å¼é”™è¯¯)';
                            }
                        }
                    } else if (msg.type === 'schedule_summary') {
                        if (!msg.content) {
                            text = '[æ—¥ç¨‹æ‘˜è¦åŒæ­¥]';
                        } else {
                            try {
                                const data = JSON.parse(msg.content);
                                text = `[æ—¥ç¨‹æ‘˜è¦åŒæ­¥] å…±${data.length}ä¸ªæ—¥ç¨‹\n`;
                                text += data.map(s => `  - [${s.eventType}] ${s.title} (é‡è¦åº¦: ${s.importance})`).join('\n');
                            } catch (e) {
                                text = '[æ—¥ç¨‹æ‘˜è¦åŒæ­¥] (æ•°æ®æ ¼å¼é”™è¯¯)';
                            }
                        }
                    } else if (msg.type === 'pie_chart_summary') {
                        if (!msg.content) {
                            text = '[å›¾è¡¨åˆ†æžåŒæ­¥]';
                        } else {
                            try {
                                const data = JSON.parse(msg.content);
                                text = `[å›¾è¡¨åˆ†æžåŒæ­¥] ${data.title}\n`;
                                if (data.totalExpense > 0) {
                                    text += `  æ€»æ”¯å‡º: ${data.totalExpense.toFixed(2)} ${data.currency}\n`;
                                    text += data.expenseDetails.map(d => `    - ${d.name}: ${d.amount.toFixed(2)} (${d.percentage.toFixed(1)}%)`).join('\n');
                                }
                                if (data.totalIncome > 0) {
                                    text += `\n  æ€»æ”¶å…¥: ${data.totalIncome.toFixed(2)} ${data.currency}\n`;
                                    text += data.incomeDetails.map(d => `    - ${d.name}: ${d.amount.toFixed(2)} (${d.percentage.toFixed(1)}%)`).join('\n');
                                }
                            } catch (e) {
                                text = `[å›¾è¡¨åˆ†æžåŒæ­¥] (æ•°æ®æ ¼å¼é”™è¯¯)`;
                            }
                        }
                    } else if (msg.type === 'today_tasks_summary') {
                        const data = JSON.parse(msg.content);
                        text = `[ä»Šæ—¥å¾…åŠžåŒæ­¥] å¾…å®Œæˆ${data.pending.length}é¡¹ï¼Œå·²å®Œæˆ${data.completed.length}é¡¹`;
                    } else if (msg.type === 'calendar_view_summary') {
                        const data = JSON.parse(msg.content);
                        const totalEvents = Object.values(data.events).flat().length;
                        text = `[æ—¥åŽ†è§†å›¾åŒæ­¥] ${data.year}å¹´${data.month}æœˆå…±${totalEvents}ä¸ªæ—¥ç¨‹äº‹é¡¹`;
                    }

                    let sender = msg.role === 'user' ? 'æˆ‘' : 'AI';
                    if (msg.role === 'assistant' && msg.senderId) {
                        const character = state.characters.find(c => c.id === msg.senderId);
                        if (character) sender = character.name;
                    }

                    content += `[${time}] ${sender}: ${text}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.config.chatName}_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            function toggleSidebar() { ELS.sidebar.classList.toggle('visible'); ELS.sidebarOverlay.classList.toggle('visible'); }
            async function toggleContextPreview() { if (ELS.sidebarPreviewContent.style.display === 'block') { ELS.sidebarPreviewContent.style.display = 'none'; return; } const { context, tokens } = buildContext(state.config.maxTokens); ELS.sidebarTokenCount.textContent = tokens; ELS.sidebarPreviewContent.textContent = JSON.stringify(context, null, 2); ELS.sidebarPreviewContent.style.display = 'block'; }

            // --- Modal Helpers ---
            function setupModal(triggerId, modalId, closeId, onOpen) {
                const modal = document.getElementById(modalId);
                if (triggerId) { document.getElementById(triggerId).addEventListener('click', () => { if (onOpen) onOpen(); modal.classList.add('visible'); }); }
                if (closeId) { document.getElementById(closeId).addEventListener('click', () => modal.classList.remove('visible')); }
            }
            function setupEditorModal(modalId, onSave) {
                const modal = document.getElementById(modalId);
                modal.querySelector('.save-btn')?.addEventListener('click', () => { if (onSave) onSave(); });
                modal.querySelector('.cancel-btn')?.addEventListener('click', () => modal.classList.remove('visible'));
            }

            // --- RESTORED SETTINGS FUNCTIONS ---
            let editingProxyId = null;
            function renderProxyList() { const list = document.getElementById('proxy-list'); list.innerHTML = ''; if (state.proxies.length === 0) { list.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åä»£ï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</p>'; } state.proxies.forEach(p => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div class="name">${p.name || 'æœªå‘½ååä»£'}</div><div class="details">URL: ${p.url}</div><div class="list-item-actions"><button class="edit-proxy" data-id="${p.id}">âœï¸</button><button class="delete-proxy" data-id="${p.id}">ðŸ—‘ï¸</button></div>`; item.querySelector('.edit-proxy').addEventListener('click', () => openProxyEditor(p.id)); item.querySelector('.delete-proxy').addEventListener('click', () => deleteProxy(p.id)); list.appendChild(item); }); }
            function openProxyEditor(id = null) { editingProxyId = id; const modal = document.getElementById('proxy-editor-modal'); const title = document.getElementById('proxy-editor-title'); const name = document.getElementById('proxy-editor-name'); const url = document.getElementById('proxy-editor-url'); const apikey = document.getElementById('proxy-editor-apikey'); const models = document.getElementById('proxy-editor-models'); if (id) { const proxy = state.proxies.find(p => p.id === id); title.textContent = "ç¼–è¾‘åä»£"; name.value = proxy.name || ''; url.value = proxy.url; apikey.value = proxy.apiKey; models.value = proxy.models ? proxy.models.split(',').join('\n') : ''; } else { title.textContent = "æ·»åŠ æ–°åä»£"; name.value = ''; url.value = ''; apikey.value = ''; models.value = ''; } modal.classList.add('visible'); }
            async function saveProxy() { const modelsValue = document.getElementById('proxy-editor-models').value.trim().split('\n').map(m => m.trim()).filter(Boolean).join(','); const proxyData = { name: document.getElementById('proxy-editor-name').value.trim(), url: document.getElementById('proxy-editor-url').value.trim(), apiKey: document.getElementById('proxy-editor-apikey').value.trim(), models: modelsValue }; if (editingProxyId) { proxyData.id = editingProxyId; await db.apiProxies.put(proxyData); const index = state.proxies.findIndex(p => p.id === editingProxyId); state.proxies[index] = proxyData; } else { const id = await db.apiProxies.add(proxyData); state.proxies.push({ ...proxyData, id }); } renderProxyList(); document.getElementById('proxy-editor-modal').classList.remove('visible'); }
            async function deleteProxy(id) { if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåä»£å—ï¼Ÿ')) { await db.apiProxies.delete(id); state.proxies = state.proxies.filter(p => p.id !== id); renderProxyList(); } }

            let editingCharId = null;
            function renderCharacterList() { const list = document.getElementById('character-list'); list.innerHTML = ''; if (state.characters.length === 0) { list.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•è§’è‰²ï¼Œå¿«åˆ›å»ºä¸€ä¸ªå§ï¼</p>'; } state.characters.forEach(c => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><img src="${c.avatar || DEFAULT_AVATAR}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;"><span class="name">${c.name}</span></div><div class="list-item-actions"><button class="edit-char" data-id="${c.id}">âœï¸</button><button class="delete-char" data-id="${c.id}">ðŸ—‘ï¸</button></div>`; item.querySelector('.edit-char').addEventListener('click', () => openCharacterEditor(c.id)); item.querySelector('.delete-char').addEventListener('click', () => deleteCharacter(c.id)); list.appendChild(item); }); }
            function populateModelsForProxy(proxySelectId, modelSelectId, selectedProxyId, selectedModel) { const modelSelect = document.getElementById(modelSelectId); modelSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰API --</option>'; if (!selectedProxyId) return; const proxy = state.proxies.find(p => p.id === parseInt(selectedProxyId)); if (proxy && proxy.models) { modelSelect.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡åž‹ --</option>'; const models = proxy.models.split(',').map(m => m.trim()).filter(Boolean); models.forEach(modelName => { const option = document.createElement('option'); option.value = modelName; option.textContent = modelName; if (modelName === selectedModel) { option.selected = true; } modelSelect.appendChild(option); }); } }
            function openCharacterEditor(id = null) {
                editingCharId = id;
                const modal = document.getElementById('character-editor-modal');
                const title = document.getElementById('character-editor-title');
                const name = document.getElementById('character-editor-name');
                const avatarPreview = document.getElementById('character-editor-avatar-preview');
                const prompt = document.getElementById('character-editor-prompt');
                const proxySelect = document.getElementById('character-editor-proxy');
                const backupProxySelect = document.getElementById('character-editor-backup-proxy');
                const modelSelect = document.getElementById('character-editor-model');
                const backupModelSelect = document.getElementById('character-editor-backup-model');

                proxySelect.innerHTML = '<option value="">-- é€‰æ‹©ä¸»ç”¨API --</option>';
                backupProxySelect.innerHTML = '<option value="">-- é€‰æ‹©å¤‡ç”¨API --</option>';
                state.proxies.forEach(p => { const optionText = p.name || p.url; const option = `<option value="${p.id}">${optionText}</option>`; proxySelect.innerHTML += option; backupProxySelect.innerHTML += option; });
                proxySelect.onchange = () => populateModelsForProxy('character-editor-proxy', 'character-editor-model', proxySelect.value, null);
                backupProxySelect.onchange = () => populateModelsForProxy('character-editor-backup-proxy', 'character-editor-backup-model', backupProxySelect.value, null);

                document.getElementById('upload-char-avatar-btn').onclick = () => document.getElementById('character-editor-avatar-input').click();
                document.getElementById('character-editor-avatar-input').onchange = (e) => {
                    handleAvatarUpload(e, (base64) => { avatarPreview.src = base64; });
                };

                if (id) {
                    const char = state.characters.find(c => c.id === id);
                    title.textContent = "ç¼–è¾‘è§’è‰²"; name.value = char.name;
                    avatarPreview.src = char.avatar || DEFAULT_AVATAR;
                    prompt.value = char.prompt;
                    proxySelect.value = char.proxyId;
                    populateModelsForProxy('character-editor-proxy', 'character-editor-model', char.proxyId, char.model);
                    backupProxySelect.value = char.backupProxyId;
                    populateModelsForProxy('character-editor-backup-proxy', 'character-editor-backup-model', char.backupProxyId, char.backupModel);
                    applyCharParamsToEditor(char.aiParams);
                } else {
                    title.textContent = "æ·»åŠ æ–°è§’è‰²";
                    name.value = '';
                    avatarPreview.src = DEFAULT_AVATAR;
                    prompt.value = '';
                    proxySelect.value = '';
                    backupProxySelect.value = '';
                    modelSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰API --</option>';
                    backupModelSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰API --</option>';
                    applyCharParamsToEditor(null);
                }
                modal.classList.add('visible');
            }
            async function saveCharacter() {
                const characterData = {
                    name: document.getElementById('character-editor-name').value.trim(),
                    avatar: document.getElementById('character-editor-avatar-preview').src,
                    prompt: document.getElementById('character-editor-prompt').value.trim(),
                    proxyId: parseInt(document.getElementById('character-editor-proxy').value) || null,
                    model: document.getElementById('character-editor-model').value,
                    backupProxyId: parseInt(document.getElementById('character-editor-backup-proxy').value) || null,
                    backupModel: document.getElementById('character-editor-backup-model').value,
                    aiParams: collectCharParamsFromEditor()
                };

                if (editingCharId) {
                    await db.aiCharacters.update(editingCharId, characterData);

                    const index = state.characters.findIndex(c => c.id === editingCharId);
                    if (index !== -1) {
                        state.characters[index] = { ...state.characters[index], ...characterData };
                    }
                } else {
                    const id = await db.aiCharacters.add(characterData);
                    state.characters.push({ ...characterData, id });
                }

                // 3. æ”¶å°¾å·¥ä½œï¼ˆè¿™éƒ¨åˆ†ä¹Ÿæ˜¯æ­£ç¡®çš„ï¼‰
                renderCharacterList();
                renderChatMessages();
                document.getElementById('character-editor-modal').classList.remove('visible');
                editingCharId = null; // æ¸…ç©ºæ­£åœ¨ç¼–è¾‘çš„ID
            }
            async function deleteCharacter(id) { if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿ')) { await db.aiCharacters.delete(id); state.characters = state.characters.filter(c => c.id !== id); renderCharacterList(); renderChatMessages(); } }

            let currentlyEditingCurrencyCode = null;
            function openCurrencyEditor(curr = null) {
                const modal = document.getElementById('currency-editor-modal');
                currentlyEditingCurrencyCode = curr ? curr.code : null;
                document.getElementById('currency-editor-title').textContent = curr ? 'ç¼–è¾‘å¸ç§' : 'æ–°å»ºå¸ç§';
                document.getElementById('currency-editor-code').value = curr ? curr.code : '';
                document.getElementById('currency-editor-code').disabled = !!curr;
                document.getElementById('currency-editor-name').value = curr ? curr.name : '';
                document.getElementById('currency-editor-rate').value = curr ? curr.rate : '';
                modal.classList.add('visible');
            }

            async function saveCurrency() {
                const code = document.getElementById('currency-editor-code').value.trim().toUpperCase();
                const name = document.getElementById('currency-editor-name').value.trim();
                const rate = parseFloat(document.getElementById('currency-editor-rate').value);

                if (!code || !name || isNaN(rate)) { alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ'); return; }
                if (code.length !== 3) { alert('å¸ç§ä»£ç å¿…é¡»æ˜¯3ä½å­—æ¯'); return; }

                const currencyData = { code, name, rate };
                await db.currencies.put(currencyData);

                state.currencies = await db.currencies.toArray();
                renderCurrencyList();
                populateLedgerCurrencyFilter();
                document.getElementById('currency-editor-modal').classList.remove('visible');
            }

            function renderCurrencyList() {
                const listEl = document.getElementById('currency-list');
                listEl.innerHTML = '';
                const allCurrencies = [{ code: 'RMB', name: 'äººæ°‘å¸', rate: 1, isBase: true }, ...state.currencies];

                allCurrencies.forEach(curr => {
                    const item = document.createElement('div');
                    item.className = 'list-item-setting';
                    item.innerHTML = `<div class="name">${curr.name} (${curr.code})</div><div class="details">1 ${curr.code} â‰ˆ ${curr.rate} RMB</div>`;

                    if (!curr.isBase) {
                        const actions = document.createElement('div');
                        actions.className = 'list-item-actions';

                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = 'âœï¸';
                        editBtn.onclick = () => openCurrencyEditor(curr);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = 'ðŸ—‘ï¸';
                        deleteBtn.onclick = async () => {
                            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${curr.name}" å—ï¼Ÿ`)) {
                                await db.currencies.delete(curr.code);
                                state.currencies = state.currencies.filter(c => c.code !== curr.code);
                                renderCurrencyList();
                                populateLedgerCurrencyFilter();
                            }
                        };

                        actions.append(editBtn, deleteBtn);
                        item.appendChild(actions);
                    }
                    listEl.appendChild(item);
                });
            }

            function openSystemPromptsEditor() {
                const settings = state.config.systemPromptSettings || DEFAULT_SYSTEM_PROMPTS;
                document.getElementById('system-prompt-send-time').checked = settings.sendTime;
                document.getElementById('system-prompt-send-model').checked = settings.sendModel;
                document.getElementById('system-prompt-send-role').checked = settings.sendRole;
                document.getElementById('system-prompt-ledger').value = settings.ledger;
                document.getElementById('system-prompt-schedule').value = settings.schedule;
                document.getElementById('system-prompt-pie').value = settings.pie;
                document.getElementById('system-prompts-modal').classList.add('visible');
            }

            async function saveSystemPrompts() {
                const newSettings = {
                    sendTime: document.getElementById('system-prompt-send-time').checked,
                    sendModel: document.getElementById('system-prompt-send-model').checked,
                    sendRole: document.getElementById('system-prompt-send-role').checked,
                    ledger: document.getElementById('system-prompt-ledger').value.trim() || DEFAULT_SYSTEM_PROMPTS.ledger,
                    schedule: document.getElementById('system-prompt-schedule').value.trim() || DEFAULT_SYSTEM_PROMPTS.schedule,
                    pie: document.getElementById('system-prompt-pie').value.trim() || DEFAULT_SYSTEM_PROMPTS.pie,
                };
                await updateConfig('systemPromptSettings', newSettings);
                document.getElementById('system-prompts-modal').classList.remove('visible');
            }

            function showAICharacterSelector() {
                const selector = document.getElementById('ai-character-selector');
                selector.innerHTML = '';
                if (state.characters.length === 0) {
                    alert('è¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­æ·»åŠ AIè§’è‰²');
                    return;
                }
                state.characters.forEach(char => {
                    const item = document.createElement('div');
                    item.className = 'character-item';
                    item.innerHTML = `<img src="${char.avatar || DEFAULT_AVATAR}" alt="${char.name}"><div class="name">${char.name}</div>`;
                    item.onclick = () => {
                        document.getElementById('ai-character-selector-modal').classList.remove('visible');
                        triggerAIResponse(char);
                    };
                    selector.appendChild(item);
                });
                document.getElementById('ai-character-selector-modal').classList.add('visible');
            }

            // --- Emoji Pack Management ---
            function renderEmojiPackList() {
                const listEl = document.getElementById('emoji-pack-list');
                if (!listEl) return;

                if (state.emojiPacks.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">è¿˜æ²¡æœ‰ä¸Šä¼ è¡¨æƒ…åŒ…</div>';
                    return;
                }

                listEl.innerHTML = state.emojiPacks.map(emoji => `
                <div class="list-item-setting" style="display: flex; align-items: center; gap: 10px;">
                    <img src="${emoji.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;">
                    <div style="flex-grow: 1;">
                        <div class="name">${emoji.name}</div>
                        <div class="details">ç”¨äºŽèŠå¤©: [emoji:${emoji.name}]</div>
                    </div>
                    <div class="list-item-actions">
                        <button data-id="${emoji.id}" class="delete-emoji-btn">Ã—</button>
                    </div>
                </div>
            `).join('');

                listEl.querySelectorAll('.delete-emoji-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = parseInt(e.target.dataset.id);
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ')) {
                            await db.emojiPacks.delete(id);
                            state.emojiPacks = state.emojiPacks.filter(e => e.id !== id);
                            renderEmojiPackList();
                        }
                    });
                });
            }

            async function openEmojiPackManager() {
                const modal = document.getElementById('emoji-pack-modal');
                if (!modal) {
                    const modalHTML = `
                    <div id="emoji-pack-modal" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">ç®¡ç†æˆ‘çš„è¡¨æƒ…åŒ…</div>
                            <div class="modal-body">
                                <div id="emoji-pack-list"></div>
                                <button class="form-button" id="add-emoji-pack-btn">ï¼‹ æ·»åŠ æ–°è¡¨æƒ…åŒ…</button>
                                <input type="file" id="emoji-pack-file-input" accept="image/*" style="display:none;">
                            </div>
                            <div class="modal-footer">
                                <button class="cancel-btn" id="close-emoji-pack-modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);

                    document.getElementById('add-emoji-pack-btn').addEventListener('click', () => {
                        document.getElementById('emoji-pack-file-input').click();
                    });

                    document.getElementById('emoji-pack-file-input').addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const name = prompt('è¯·è¾“å…¥è¡¨æƒ…åŒ…åç§°ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€ç”Ÿæ°”ã€ç–‘æƒ‘ï¼‰ï¼š');
                        if (!name) return;
                        const compressedImage = await compressEmojiPack(file);
                        const newEmoji = { name: name, image: compressedImage, timestamp: Date.now() };
                        const id = await db.emojiPacks.add(newEmoji);
                        state.emojiPacks.push({ ...newEmoji, id });
                        renderEmojiPackList();
                        e.target.value = '';
                    });

                    document.getElementById('close-emoji-pack-modal').addEventListener('click', () => {
                        document.getElementById('emoji-pack-modal').classList.remove('visible');
                    });
                }

                renderEmojiPackList();
                document.getElementById('emoji-pack-modal').classList.add('visible');
            }

            document.getElementById('manage-emoji-packs-btn').addEventListener('click', openEmojiPackManager);

            function showEmojiPackSelector() {
                if (state.emojiPacks.length === 0) {
                    alert('è¿˜æ²¡æœ‰ä¸Šä¼ è¡¨æƒ…åŒ…å‘¢ï¼è¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ è¡¨æƒ…åŒ…ã€‚');
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'modal-overlay visible';
                modal.innerHTML = `
        <div class="modal-content" style="max-width: 320px;">
            <div class="modal-header">é€‰æ‹©è¡¨æƒ…åŒ…</div>
            <div class="modal-body" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px;">
                ${state.emojiPacks.map(emoji => `
                    <div class="emoji-pack-item" data-id="${emoji.id}" style="cursor: pointer; text-align: center;">
                        <img src="${emoji.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <div style="font-size: 10px; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${emoji.name}</div>
                    </div>
                `).join('')}
            </div>
            <div class="modal-footer">
                <button class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    `;

                document.body.appendChild(modal);

                modal.querySelectorAll('.emoji-pack-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const emojiId = parseInt(item.dataset.id);
                        const emoji = state.emojiPacks.find(e => e.id === emojiId);
                        if (emoji) {
                            // å‘é€è¡¨æƒ…åŒ…åç§°ä½œä¸ºæ¶ˆæ¯å†…å®¹ï¼Œä½†ç±»åž‹æ ‡è®°ä¸ºemoji_pack
                            const newMsg = {
                                timestamp: Date.now(),
                                role: 'user',
                                content: `[emoji:${emoji.name}]`,  // ç‰¹æ®Šæ ¼å¼å­˜å‚¨
                                type: 'emoji_pack'
                            };
                            const id = await db.messages.add(newMsg);
                            state.messages.push({ ...newMsg, id });
                            renderChatMessages();
                        }
                        modal.remove();
                    });
                });

                modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }
            // Call init
            init();
        });
    </script>
    <!-- æ—¥è®°æ¨¡æ€æ¡† -->
    <div id="diary-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="diary-modal-title">æ—¥è®°</span>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="diary-character-selector" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <label style="flex-shrink: 0;">è§’è‰²ï¼š</label>
                    <select id="diary-char-select" style="flex-grow: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary);"></select>
                    <button id="edit-diary-prompt-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--bg-soft); border: none; cursor: pointer;">ç¼–è¾‘æç¤ºè¯</button>
                </div>
                <div id="diary-content-area">
                    <div id="diary-empty-state" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <p>æš‚æ— æ—¥è®°</p>
                        <button id="generate-diary-btn" class="form-button" style="margin-top: 20px;">ðŸ“” ç”Ÿæˆæ—¥è®°</button>
                    </div>
                    <div id="diary-display" style="display: none;">
                        <div id="diary-text" style="background: var(--bg-soft); border-radius: 12px; padding: 20px; white-space: pre-wrap; line-height: 1.8; font-size: 15px; max-height: 400px; overflow-y: auto;">
                        </div>
                        <button id="delete-diary-btn" class="form-button" style="margin-top: 15px; background-color: var(--expense-color);">åˆ é™¤æ—¥è®°</button>
                    </div>
                    <div id="diary-loading" style="display: none; text-align: center; padding: 40px;">
                        <div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>
                        <p style="margin-top: 15px; color: var(--text-secondary);">æ­£åœ¨ç”Ÿæˆæ—¥è®°...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="close-diary-modal">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ—¥è®°æç¤ºè¯æ¨¡æ€æ¡† -->
    <div id="diary-prompt-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘æ—¥è®°ç”Ÿæˆæç¤ºè¯</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="diary-system-prompt" rows="10" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary);">è¯·ä½ å†™ä¸€ç¯‡{char}çš„è§†è§’ä¸­ä¸Ž{user}åœ¨{date}çš„è¿™ä¸€å¤©é«˜åº¦ç›¸å…³çš„æ—¥è®°ï¼Œä¸»è¦æ˜¯ä½ åœ¨è¿™ä¸€å¤©çš„å¯¹è¯ä¸­ï¼Œå¯¹{user}è¡Œä¸ºçš„å¿ƒç†æ´»åŠ¨ç»è¿‡å’Œæƒ…æ„Ÿå˜åŒ–ï¼Œç»“åˆè¿‡å¾€å¯¹è¯è®°å½•æ¥å†™ã€‚æ—¥è®°å†™ä½œé£Žæ ¼éœ€è¦æŒ‰ç…§ä¾ç…§{char}çš„æ€§æ ¼ç‰¹ç‚¹ã€‚ä½ åœ¨å†™æ—¥è®°æ—¶ï¼Œå¯¹{char}ç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸€äººç§°ã€Œæˆ‘ã€ï¼ˆå¦‚â€œæˆ‘æ”¶åˆ°äº†å¥¹çš„æ¶ˆæ¯â€ï¼‰ï¼Œå¯¹{user}åˆ™ä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼ˆå¦‚â€œå¥¹ä»Šå¤©ä¹°å¥¶èŒ¶èŠ±äº†äºŒåå—â€ï¼‰ï¼Œä½†å¶å°”æ’å…¥å¯¹{user}ç¬¬äºŒäººç§°ç›´ç™½çš„è¯ï¼ˆå¦‚â€œæˆ‘æƒ³è®©ä½ çŸ¥é“â€ï¼‰ï¼ŒåŠ å¼ºæƒ…æ„Ÿå†²å‡»ã€‚ç›´æŽ¥ä»¥â€œ{date}ï¼Œè®°å½•è€…ï¼š{char}â€å¼€å¤´ï¼Œ2000å­—å·¦å³~</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn">å–æ¶ˆ</button>
                <button class="save-btn" id="save-diary-prompt">ä¿å­˜</button>
            </div>
        </div>
    </div>



</body></html>
