<!DOCTYPE html>
<!-- saved from url=(0040)https://cava111.github.io/CavaDailyNote/ -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cava记事本1.3.5beta</title>
    <script src="./Cava记事本1.3.5beta_files/dexie.js.下载"></script>
    <script src="./Cava记事本1.3.5beta_files/cropper.min.js.下载"></script>
    <link rel="stylesheet" href="./Cava记事本1.3.5beta_files/cropper.min.css">
    <style>
        :root {
            --bg-main: #FDF0E9;
            --bg-secondary: #FFFFFF;
            --bg-soft: #FAE1D5;
            --accent-primary: #E6C8B4;
            --accent-secondary: #FFB6A3;
            --text-primary: #8C7B73;
            --text-secondary: #B4A29B;
            --text-primary-rgb: 140, 123, 115;
            --text-secondary-rgb: 180, 162, 155;
            --text-light: #FFFFFF;
            --error-bg: #FADADD;
            --error-text: #8C2323;
            --border-color: #F5EBE4;
            --expense-color: #F28B82;
            --income-color: #8DD4BF;
            --shadow-light: rgba(140, 123, 115, 0.1);
            --shadow-medium: rgba(140, 123, 115, 0.15);
            /* Schedule colors */
            --schedule-urgent-important: #FFE5E5;
            --schedule-urgent-not-important: #FFF5E5;
            --schedule-not-urgent-important: #E5F0FF;
            --schedule-not-urgent-not-important: #F0F0F0;
            --schedule-important-text: #8B4513;
            /* 红褐色字体 for important tasks */
        }

        body[data-theme="blue"] {
            --bg-main: #EAF6FF;
            --bg-secondary: #FFFFFF;
            --bg-soft: #D4E9F7;
            --accent-primary: #B0D4EC;
            --accent-secondary: #87C4F4;
            --text-primary: #5A7C94;
            --text-secondary: #9AB7CC;
            --text-primary-rgb: 90, 124, 148;
            --text-secondary-rgb: 154, 183, 204;
            --border-color: #E0F0FF;
            --shadow-light: rgba(90, 124, 148, 0.1);
            --shadow-medium: rgba(90, 124, 148, 0.15);
            --schedule-important-text: #0056b3;
        }

        body[data-theme="green"] {
            --bg-main: #EFF8F2;
            --bg-secondary: #FFFFFF;
            --bg-soft: #DCEEE2;
            --accent-primary: #B9DCD0;
            --accent-secondary: #96CDBC;
            --text-primary: #5E8071;
            --text-secondary: #9EBAAF;
            --text-primary-rgb: 94, 128, 113;
            --text-secondary-rgb: 158, 186, 175;
            --border-color: #E5F1E9;
            --shadow-light: rgba(94, 128, 113, 0.1);
            --shadow-medium: rgba(94, 128, 113, 0.15);
            --schedule-important-text: #285c3f;
        }

        body[data-theme="purple"] {
            --bg-main: #F6F2FF;
            --bg-secondary: #FFFFFF;
            --bg-soft: #EAE0F7;
            --accent-primary: #D4C2E8;
            --accent-secondary: #C0A9E0;
            --text-primary: #7C6B8F;
            --text-secondary: #A99CB8;
            --text-primary-rgb: 124, 107, 143;
            --text-secondary-rgb: 169, 156, 184;
            --border-color: #F0EBFA;
            --shadow-light: rgba(124, 107, 143, 0.1);
            --shadow-medium: rgba(124, 107, 143, 0.15);
            --schedule-important-text: #563d7c;
        }

        body[data-theme="pink"] {
            --bg-main: #FFF0F5;
            --bg-secondary: #FFFFFF;
            --bg-soft: #FFE2EC;
            --accent-primary: #F8C4D8;
            --accent-secondary: #F4AAB6;
            --text-primary: #9A6A74;
            --text-secondary: #C7A5AD;
            --text-primary-rgb: 154, 106, 116;
            --text-secondary-rgb: 199, 165, 173;
            --border-color: #FAEBF0;
            --shadow-light: rgba(154, 106, 116, 0.1);
            --shadow-medium: rgba(154, 106, 116, 0.15);
            --schedule-important-text: #8c1c44;
        }

        body[data-theme="gray"] {
            --bg-main: #F5F5F5;
            --bg-secondary: #FFFFFF;
            --bg-soft: #EAEAEA;
            --accent-primary: #D1D1D1;
            --accent-secondary: #B0B0B0;
            --text-primary: #616161;
            --text-secondary: #9E9E9E;
            --text-primary-rgb: 97, 97, 97;
            --text-secondary-rgb: 158, 158, 158;
            --border-color: #EEEEEE;
            --shadow-light: rgba(97, 97, 97, 0.1);
            --shadow-medium: rgba(97, 97, 97, 0.15);
            --schedule-important-text: #333;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 430px;
            margin: 0 auto;
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px var(--shadow-medium);
            transition: background-color 0.3s ease;
            overflow: hidden;
        }

        .main-content {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-main);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease;
        }

        .page.active {
            opacity: 1;
            visibility: visible;
            z-index: 1;
        }

        /* Header */
        .header {
            flex-shrink: 0;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
            background-color: rgba(253, 240, 233, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            z-index: 10;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
        }

        body[data-theme="blue"] .header {
            background-color: rgba(234, 246, 255, 0.8);
        }

        body[data-theme="green"] .header {
            background-color: rgba(239, 248, 242, 0.8);
        }

        body[data-theme="purple"] .header {
            background-color: rgba(246, 242, 255, 0.8);
        }

        body[data-theme="pink"] .header {
            background-color: rgba(255, 240, 245, 0.8);
        }

        body[data-theme="gray"] .header {
            background-color: rgba(245, 245, 245, 0.8);
        }

        .header .action-btn {
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            text-align: center;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .header .action-btn:active {
            background-color: var(--border-color);
        }

        .header .back-btn {
            font-size: 22px;
            font-weight: bold;
        }

        .header .left-action {
            flex: 1 1 0;
            display: flex;
            justify-content: flex-start;
        }

        .header .right-action {
            flex: 1 1 0;
            display: flex;
            justify-content: flex-end;
        }

        .header .center-title {
            flex: 2 1 0;
            text-align: center;
        }

        /* Bottom Navigation */
        #bottom-nav {
            flex-shrink: 0;
            display: flex;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            transition: background-color 0.3s ease, border-top-color 0.3s ease;
        }

        body[data-theme="blue"] #bottom-nav,
        body[data-theme="green"] #bottom-nav,
        body[data-theme="purple"] #bottom-nav,
        body[data-theme="pink"] #bottom-nav,
        body[data-theme="gray"] #bottom-nav {
            background-color: rgba(255, 255, 255, 0.7);
        }

        .nav-item {
            flex: 1;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .nav-item .icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .nav-item .label {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--accent-secondary);
        }

        /* --- Chat Page Styles --- */
        #accounting-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-wrapper {
            display: flex;
            gap: 8px;
            max-width: 85%;
            position: relative;
            align-items: flex-start;
            /* Aligns top of avatar with top of message-block */
        }

        .message-wrapper.user {
            align-self: flex-end;
        }

        .message-wrapper.ai {
            align-self: flex-start;
        }

        .message-wrapper .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .message-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
            min-width: 0;
            /* Prevents flexbox overflow issues */
        }

        .message-wrapper.user .message-block {
            align-items: flex-end;
        }

        .sender-name {
            font-size: 12px;
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            margin-bottom: 4px;
        }

        .message-bubble {
            display: flex;
            width: fit-content;
            max-width: 100%;
            align-items: flex-end;
            /* Aligns bubble content with meta info */
            gap: 4px;
        }

        .message-bubble .content {
            padding: 10px 14px;
            word-break: break-word;
            line-height: 1.5;
            font-size: 16px;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background-color 0.3s, color 0.3s;
        }

        .message-bubble .content strong {
            font-weight: bold;
        }

        .message-bubble .content em {
            font-style: italic;
        }

        .message-wrapper.user .message-bubble .content {
            background-color: var(--bg-soft);
            color: var(--text-primary);
            border-radius: 18px 8px 18px 18px;
        }

        .message-wrapper.ai .message-bubble .content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px 18px 18px 18px;
        }

        .message-wrapper.error .message-bubble .content {
            background-color: var(--error-bg);
            color: var(--error-text);
        }

        .message-meta {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            margin-bottom: 4px;
            /* Minor adjustment for better visual alignment */
        }

        .message-wrapper:hover .message-meta {
            opacity: 1;
        }

        .timestamp {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .message-actions-trigger {
            font-family: 'Segoe UI Symbol', sans-serif;
            font-size: 16px;
            color: #FFFFFF;
            background-color: rgba(var(--text-secondary-rgb), 0.5);
            cursor: pointer;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding-bottom: 2px;
        }

        .message-wrapper.user .message-bubble {
            flex-direction: row-reverse;
        }

        .selection-mode-active .message-meta,
        .message-bubble.editing .message-meta {
            display: none;
        }

        .message-bubble.image .content {
            padding: 5px;
            border-radius: 18px;
        }

        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 13px;
            display: block;
            cursor: pointer;
        }

        @keyframes typing {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        .typing-indicator span {
            animation: typing 1.5s infinite;
            display: inline-block;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        #chat-input-area {
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background-color: rgba(253, 240, 233, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            /* 改为纵向排列 */
            gap: 8px;
            /* 两个横条之间的间隙 */
            transition: background-color 0.3s ease, border-top-color 0.3s ease, transform 0.3s ease;
        }

        #chat-actions-bar {
            display: flex;
            justify-content: space-around;
            /* 让按钮均匀分布 */
            width: 100%;
        }

        #chat-text-input-bar {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            width: 100%;
        }

        /* 调整一下按钮，让它们在手机上更好看 */
        .chat-action-btn {
            font-size: 24px;
            /* 稍微增大图标 */
        }

        .selection-mode-active #chat-input-area {
            transform: translateY(100%);
        }

        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 1px 3px var(--shadow-light);
            transition: transform 0.2s, background-color 0.3s;
        }

        .chat-action-btn:active {
            transform: scale(0.9);
            background-color: var(--bg-soft);
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            padding: 10px 15px;
            border-radius: 18px;
            background-color: var(--bg-secondary);
            font-size: 16px;
            max-height: 100px;
            resize: none;
            box-shadow: 0 1px 3px var(--shadow-light);
            transition: background-color 0.3s;
        }

        #chat-input:focus {
            outline: none;
        }

        #send-btn {
            background-color: var(--accent-secondary);
            color: var(--text-light);
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            height: 36px;
            padding: 0 15px;
            border-radius: 18px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #send-btn:disabled {
            background-color: var(--accent-primary);
            cursor: not-allowed;
        }

        /* Selection Mode */
        #selection-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background-color: rgba(253, 240, 233, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 15;
            box-sizing: border-box;
        }

        .selection-mode-active #selection-action-bar {
            display: flex;
        }

        #selection-action-bar button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 18px;
            border: none;
            cursor: pointer;
        }

        #delete-selected-btn {
            background-color: var(--error-bg);
            color: var(--error-text);
        }

        #cancel-selection-btn {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .message-selection-checkbox {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            background-color: var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 14px;
            z-index: 5;
        }

        .selection-mode-active .message-selection-checkbox {
            display: flex;
        }

        .message-wrapper.user .message-selection-checkbox {
            left: -30px;
        }

        .message-wrapper.ai .message-selection-checkbox {
            right: -30px;
        }

        .message-wrapper.selected .message-selection-checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .selection-mode-active #chat-messages {
            padding-left: 40px;
            padding-right: 40px;
        }

        /* Transaction, Schedule & Summary Message Cards */
        .message-bubble.transaction .content,
        .message-bubble.schedule .content,
        .message-bubble.ledger_summary .content,
        .message-bubble.schedule_summary .content,
        .message-bubble.pie_chart_summary .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
        }

        .transaction-card,
        .schedule-card,
        .summary-card {
            width: 220px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-medium);
            background: var(--bg-secondary);
        }

        .transaction-header,
        .schedule-header,
        .summary-header {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .transaction-header.expense {
            background-color: var(--expense-color);
        }

        .transaction-header.income {
            background-color: var(--income-color);
        }

        .schedule-header {
            background-color: var(--accent-secondary);
        }

        .summary-header {
            background-color: var(--accent-primary);
        }

        .transaction-header .icon,
        .schedule-header .icon,
        .summary-header .icon {
            font-size: 24px;
        }

        .transaction-header .category-name,
        .schedule-header .type-name,
        .summary-header .type-name {
            font-size: 16px;
            font-weight: bold;
        }

        .transaction-body,
        .schedule-body,
        .summary-body {
            padding: 15px;
            text-align: center;
        }

        .transaction-amount {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .transaction-amount .currency-label {
            font-size: 0.5em;
        }

        .transaction-remark {
            font-size: 14px;
            color: var(--text-secondary);
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
            word-break: break-all;
            position: relative;
        }

        .transaction-remark:before {
            content: '📝 ';
        }

        .schedule-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .schedule-importance,
        .schedule-deadline,
        .schedule-status {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .schedule-status.completed {
            color: var(--income-color);
            font-weight: 500;
        }

        .schedule-description {
            font-size: 14px;
            color: var(--text-secondary);
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
            word-break: break-all;
        }

        .summary-body .text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Inline Edit Styles */
        .inline-edit-container {
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 10px 14px;
            box-sizing: border-box;
        }

        .message-bubble.editing .content-text,
        .message-bubble.editing .transaction-remark .original-text,
        .message-bubble.editing .schedule-description .original-text {
            display: none;
        }

        .message-bubble.editing .transaction-remark::before,
        .message-bubble.editing .schedule-description::before {
            display: none;
        }

        .message-bubble.editing .inline-edit-container {
            display: flex;
        }

        .message-bubble.editing.text .content {
            padding: 0;
        }

        .message-bubble.editing.transaction .transaction-remark,
        .message-bubble.editing.schedule .schedule-description {
            padding-top: 0;
            border-top: none;
        }

        .transaction-card .inline-edit-container,
        .schedule-card .inline-edit-container {
            padding: 8px 0 0 0;
        }

        .inline-edit-textarea {
            width: 100%;
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 16px;
            padding: 10px 14px;
            box-sizing: border-box;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            resize: none;
            min-height: 40px;
            font-family: inherit;
            line-height: 1.5;
            overflow-y: hidden;
        }

        .transaction-card .inline-edit-textarea,
        .schedule-card .inline-edit-textarea {
            font-size: 14px;
            padding: 8px;
            line-height: 1.4;
        }

        .inline-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .inline-edit-actions button {
            border: none;
            background-color: var(--bg-soft);
            color: var(--text-primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .inline-edit-actions button:active {
            transform: scale(0.9);
        }

        .inline-edit-actions .save {
            background-color: var(--income-color);
            color: white;
        }

        .inline-edit-actions .cancel {
            background-color: var(--expense-color);
            color: white;
        }

        /* Transaction Input Panel */
        #transaction-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-main);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-medium);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
            visibility: hidden;
        }

        #transaction-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }

        .panel-header {
            padding: 8px 15px;
            text-align: center;
            font-weight: 600;
            position: relative;
        }

        .panel-header .close-btn {
            position: absolute;
            left: 15px;
            top: 8px;
            font-size: 18px;
            line-height: 1;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .type-selector {
            display: flex;
            padding: 0 15px;
            margin-bottom: 15px;
        }

        .type-selector button {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
        }

        .type-selector button.active {
            color: var(--text-primary);
            font-weight: bold;
        }

        .type-selector button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background-color: var(--accent-secondary);
            border-radius: 2px;
        }

        #category-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .category-item.selected {
            background-color: var(--bg-soft);
        }

        .category-item .icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .category-item .name {
            font-size: 12px;
        }

        /* New Transaction Remark Section Styles */
        .transaction-remark-section {
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        #transaction-remark-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }

        #transaction-remark-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        #transaction-remark-input::placeholder {
            color: var(--text-secondary);
        }

        #numpad-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            background-color: var(--bg-secondary);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }

        .numpad button {
            padding: 20px 0;
            font-size: 24px;
            border: none;
            background: transparent;
            border-top: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-primary);
        }

        .numpad button:active {
            background-color: var(--bg-soft);
        }

        .numpad .zero {
            grid-column: 1 / 3;
        }

        .numpad-actions {
            display: flex;
            flex-direction: column;
        }

        .numpad-actions button {
            flex: 1;
            font-size: 22px;
            border: none;
            background: transparent;
            border-top: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-primary);
        }

        .numpad-actions button:active {
            background-color: var(--bg-soft);
        }

        .numpad-actions .confirm {
            background-color: var(--accent-secondary);
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .numpad-actions .delete-transaction {
            background-color: var(--error-bg);
            color: var(--error-text);
            font-weight: bold;
            font-size: 18px;
        }

        #amount-display-container {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        #currency-selector {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-secondary);
            padding: 5px;
            cursor: pointer;
        }

        #amount-display {
            font-size: 32px;
            font-weight: bold;
            text-align: right;
            flex-grow: 1;
        }

        /* Schedule Input Panel */
        #schedule-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-main);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-medium);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
            visibility: hidden;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        #schedule-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }

        .schedule-form {
            padding: 15px;
            overflow-y: auto;
        }

        .schedule-form-section {
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .schedule-form-section label {
            display: block;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .schedule-form-section.red {
            background-color: #F8D7DA;
        }

        .schedule-form-section.pink {
            background-color: #F8C4D8;
        }

        .schedule-form-section.purple {
            background-color: #EAE0F7;
        }

        .schedule-form-section.blue {
            background-color: #D4E9F7;
        }

        .schedule-form-section.green {
            background-color: #DCEEE2;
        }

        .event-type-toggle {
            display: flex;
            gap: 10px;
            background: var(--bg-secondary);
            padding: 5px;
            border-radius: 8px;
        }

        .event-type-toggle button {
            flex: 1;
            padding: 8px;
            border: 1px solid transparent;
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-type-toggle button.active {
            background-color: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        /* Recurrence Section */
        #recurrence-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        #recurrence-options button {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        #recurrence-options button.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        #recurrence-selector-days {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #recurrence-selector-days label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-secondary);
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
        }

        #recurrence-selector-days input {
            accent-color: var(--accent-secondary);
        }

        .importance-stars {
            display: flex;
            gap: 5px;
            align-items: center;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: var(--border-color);
            transition: color 0.2s;
            user-select: none;
        }

        .star.filled {
            color: #FFB800;
        }

        .star.half {
            position: relative;
            color: var(--border-color);
        }

        .star.half::before {
            content: '★';
            position: absolute;
            left: 0;
            width: 50%;
            overflow: hidden;
            color: #FFB800;
        }

        .importance-score {
            margin-left: auto;
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .deadline-inputs {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            padding: 5px 12px;
            border-radius: 8px;
        }

        #deadline-display-text,
        #end-date-display-text {
            flex-grow: 1;
            text-align: left;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 8px 5px;
        }

        .time-input-part {
            display: flex;
            align-items: center;
        }

        .time-input {
            width: 35px;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 16px;
            color: var(--text-primary);
            padding: 8px 0;
        }

        .time-input::-webkit-outer-spin-button,
        .time-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .time-input[type=number] {
            -moz-appearance: textfield;
            -webkit-appearance: none;
            appearance: none;
        }

        .time-input:focus {
            outline: none;
        }

        .time-input::placeholder {
            color: var(--text-secondary);
        }

        .time-separator {
            color: var(--text-primary);
            padding: 0 2px;
            font-size: 16px;
        }

        #schedule-title-input,
        #schedule-description-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }

        #schedule-description-input {
            min-height: 60px;
            resize: vertical;
        }

        .schedule-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .schedule-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .schedule-actions .cancel-btn {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .schedule-actions .confirm-btn {
            background-color: var(--accent-secondary);
            color: white;
        }

        /* Calendar Modal */
        #calendar-modal .modal-content {
            max-width: 320px;
        }

        #calendar-modal .modal-body {
            padding: 5px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .calendar-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .calendar-month-year {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            padding-bottom: 5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .calendar-day:not(.other-month):hover {
            background-color: var(--bg-soft);
        }

        .calendar-day.today {
            font-weight: bold;
            border: 1px solid var(--accent-primary);
        }

        .calendar-day.selected {
            background-color: var(--accent-secondary);
            color: white;
        }

        .calendar-day .event-dot {
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .calendar-day .event-dot.important {
            background-color: #E53935;
        }

        .calendar-day .event-dot.normal {
            background-color: #B0BEC5;
        }

        #calendar-modal .modal-footer {
            justify-content: space-between;
        }

        #clear-date-btn {
            background-color: var(--error-bg);
            color: var(--error-text);
        }


        /* --- NEW: Schedule Page Swipe Styles --- */
        #schedule-screen {
            display: flex;
            flex-direction: column;
        }

        #schedule-screen .page-content {
            padding: 15px;
            box-sizing: border-box;
        }

        .schedule-swipe-container {
            flex-grow: 1;
            overflow: hidden;
            width: 100%;
        }

        .schedule-pages-wrapper {
            display: flex;
            height: 100%;
            width: 300%;
            /* 3 pages */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .schedule-page {
            width: 33.333%;
            height: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .schedule-page>.page-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        .schedule-page-dots {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            padding: 8px 0;
            gap: 8px;
        }

        .schedule-page-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.3s;
        }

        .schedule-page-dots .dot.active {
            background-color: var(--accent-secondary);
        }

        #schedule-count {
            flex-shrink: 0;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
        }

        /* Today's Tasks styling */
        .today-task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            margin-bottom: 8px;
            cursor: pointer;
        }

        .today-task-item.important {
            background-color: var(--schedule-urgent-important);
            color: var(--schedule-important-text);
        }

        .today-task-item .title {
            flex-grow: 1;
            font-size: 16px;
        }

        .today-task-item.completed .title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .today-task-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .today-task-item.completed .checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .today-task-item.completed .checkbox::after {
            content: '✓';
            color: white;
            font-weight: bold;
        }

        /* Schedule Main Page (original) */
        .schedule-section {
            margin-bottom: 30px;
        }

        .schedule-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .schedule-quadrant {
            margin-bottom: 20px;
        }

        .quadrant-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .quadrant-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #quadrant-1 .quadrant-header {
            background-color: var(--schedule-urgent-important);
        }

        #quadrant-2 .quadrant-header {
            background-color: var(--schedule-not-urgent-important);
        }

        #quadrant-3 .quadrant-header {
            background-color: var(--schedule-urgent-not-important);
        }

        #quadrant-4 .quadrant-header {
            background-color: var(--schedule-not-urgent-not-important);
        }

        .schedule-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .schedule-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .schedule-item:active {
            transform: scale(0.98);
        }

        .schedule-item-details {
            flex-grow: 1;
        }

        .schedule-item .title {
            font-size: 16px;
            color: var(--text-primary);
        }

        .schedule-item .ddl {
            font-size: 11px;
            color: rgba(var(--text-primary-rgb), 0.7);
            margin-top: 4px;
        }

        .schedule-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .schedule-item.completed .checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .schedule-item.completed .checkbox::after {
            content: '✓';
            color: white;
            font-weight: bold;
        }

        .schedule-item.completed .title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        /* Schedule Calendar Page */
        #month-calendar-view {
            padding: 10px;
        }

        #calendar-event-list {
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }

        #calendar-event-list .event-item {
            margin-bottom: 8px;
        }

        #calendar-event-list .event-title {
            font-weight: 500;
        }

        #calendar-event-list .event-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Ledger Page */
        #ledger-screen .page-content {
            flex-grow: 1;
            overflow: hidden;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .ledger-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 15px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ledger-controls .filter-btn {
            border: 1px solid var(--accent-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
            flex-grow: 1;
            cursor: pointer;
        }

        .ledger-controls select {
            border: 1px solid var(--accent-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
            flex-grow: 1;
        }

        /* --- NEW: Ledger Footer Controls --- */
        .ledger-footer-controls {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            gap: 15px;
            border-top: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        #ledger-currency {
            border: 1px solid var(--accent-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
        }

        #toggle-ledger-view-btn {
            border: none;
            background: var(--bg-soft);
            color: var(--text-primary);
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        #toggle-ledger-view-btn:active {
            transform: scale(0.95);
        }

        #ledger-count {
            margin-left: auto;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        #ledger-view-wrapper {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-grow: 1;
        }

        #ledger-list-view,
        #ledger-chart-view {
            width: 50%;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        #ledger-list-view {
            padding: 15px 15px 0;
        }

        #ledger-chart-view {
            padding: 15px 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .pie-chart-area {
            width: 100%;
        }

        .pie-chart-title-wrapper {
            text-align: center;
            margin: 0 0 10px 0;
        }

        .pie-chart-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: normal;
            margin: 0;
            line-height: 1.4;
        }

        .pie-chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .pie-chart-area svg {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            display: block;
            aspect-ratio: 1;
        }

        .pie-chart-area svg path,
        .pie-chart-area svg circle {
            stroke: var(--bg-main);
            stroke-width: 2px;
            cursor: pointer;
            transition: transform 0.2s ease-out;
            transform-origin: center center;
        }

        .pie-chart-area svg path.active,
        .pie-chart-area svg circle.active {
            transform: scale(1.05);
        }

        #pie-chart-tooltip {
            position: absolute;
            display: none;
            background: rgba(var(--text-primary-rgb, 0, 0, 0), 0.85);
            color: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            pointer-events: none;
            z-index: 10;
            transform: translate(-50%, -110%);
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #pie-chart-tooltip strong {
            font-weight: bold;
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px 15px;
            padding: 10px;
            margin-top: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--text-primary);
        }

        .legend-color-box {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 6px;
        }

        #ledger-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ledger-item {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow-light);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .ledger-item:active {
            transform: scale(0.98);
        }

        .ledger-item .icon {
            font-size: 28px;
            margin-right: 15px;
        }

        .ledger-item .details {
            flex-grow: 1;
            min-width: 0;
        }

        .ledger-item .details .remark {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ledger-item .details .time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .ledger-item .amount {
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
            white-space: nowrap;
        }

        .ledger-item .amount.expense {
            color: var(--expense-color);
        }

        .ledger-item .amount.income {
            color: var(--income-color);
        }

        #ledger-summary {
            text-align: center;
            padding: 20px 0 0 0;
            color: var(--text-secondary);
        }

        /* More/Settings Page */
        #more-screen .page-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-button {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .form-button.secondary {
            background-color: var(--accent-primary);
        }

        .list-item-setting {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px var(--shadow-light);
            position: relative;
        }

        .list-item-setting .name {
            font-weight: 500;
        }

        .list-item-setting .details {
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .list-item-actions {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .list-item-actions button {
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar-upload img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--border-color);
        }

        .avatar-upload button {
            padding: 8px 12px;
            border: 1px solid var(--accent-primary);
            background-color: transparent;
            color: var(--text-primary);
            border-radius: 5px;
            cursor: pointer;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        /* Theme Selector */
        .theme-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .theme-option {
            cursor: pointer;
            text-align: center;
        }

        .theme-option .swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: border-color 0.2s;
        }

        .theme-option .swatch.default {
            background-color: #FAE1D5;
        }

        .theme-option .swatch.blue {
            background-color: #D4E9F7;
        }

        .theme-option .swatch.green {
            background-color: #DCEEE2;
        }

        .theme-option .swatch.purple {
            background-color: #EAE0F7;
        }

        .theme-option .swatch.pink {
            background-color: #FFE2EC;
        }

        .theme-option .swatch.gray {
            background-color: #EAEAEA;
        }

        .theme-option input {
            display: none;
        }

        .theme-option input:checked+.swatch {
            border-color: var(--accent-secondary);
        }

        .theme-option input:checked+.swatch::after {
            content: '✓';
            color: var(--accent-secondary);
            font-weight: bold;
        }

        .theme-option .label {
            font-size: 12px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-width: 350px;
            background-color: var(--bg-main);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px var(--shadow-medium);
        }

        .modal-header {
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .modal-footer .save-btn {
            background-color: var(--accent-secondary);
            color: white;
        }

        .modal-footer .cancel-btn {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        #ai-character-selector .character-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        #ai-character-selector .character-item:hover {
            background-color: var(--bg-soft);
        }

        #ai-character-selector .character-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        #ai-character-selector .character-item .name {
            font-weight: bold;
        }

        #message-action-menu {
            z-index: 1100;
        }

        #message-action-menu .modal-content {
            width: 200px;
        }

        #message-action-menu .modal-body {
            padding: 0;
        }

        #message-action-menu button {
            width: 100%;
            display: block;
            padding: 15px;
            background: none;
            border: none;
            border-bottom: 1px solid var(--border-color);
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }

        #message-action-menu button:last-child {
            border-bottom: none;
        }

        #message-action-menu button.danger {
            color: var(--error-text);
        }

        /* 替换为这段 */
        .modal-body .detail-row {
            margin-bottom: 15px;
        }

        .modal-body .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .modal-body .detail-value {
            font-size: 16px;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Cropper Modal */
        #cropper-modal .modal-body {
            padding: 0;
        }

        #cropper-image-container {
            max-height: 60vh;
        }

        #cropper-image-container img {
            max-width: 100%;
        }

        /* Sidebar */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 198;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #sidebar-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #chat-sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 75%;
            max-width: 300px;
            height: 100%;
            background-color: var(--bg-main);
            box-shadow: 2px 0 15px var(--shadow-medium);
            z-index: 199;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        #chat-sidebar.visible {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top));
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-item {
            margin-bottom: 20px;
        }

        .sidebar-item label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .sidebar-item .value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-secondary);
        }

        #sidebar-preview-content {
            background-color: var(--bg-soft);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 40vh;
            overflow-y: auto;
            margin-top: 10px;
            display: none;
        }

        /* System Prompt Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .toggle-switch label {
            font-size: 16px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--accent-primary);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-secondary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Ledger Filter Modals */
        #ledger-month-filter-modal .modal-body,
        #ledger-category-filter-modal .modal-body {
            padding: 0;
        }

        .filter-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .filter-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .filter-item:last-child {
            border-bottom: none;
        }

        .filter-item input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-secondary);
        }

        .filter-item label {
            flex-grow: 1;
        }

        .filter-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background-color: var(--bg-soft);
            color: var(--text-secondary);
        }

        .filter-tab.active {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-weight: bold;
        }

        /* 新增这段CSS */
        .load-more-indicator {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: white;
            font-style: italic;
            /* 加一点文字阴影，防止背景也是浅色时看不清 */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* --- NEW: Markdown Formatting Styles --- */
        .message-bubble .content .markdown-h {
            margin: 10px 0 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-bubble .content h1.markdown-h {
            font-size: 1.4em;
        }

        .message-bubble .content h2.markdown-h {
            font-size: 1.2em;
        }

        .message-bubble .content h3.markdown-h {
            font-size: 1.1em;
        }

        .message-bubble .content .markdown-hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 12px 0;
        }

        .message-bubble .content .markdown-code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: var(--bg-soft);
            color: var(--accent-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* --- Markdown Formatting Styles --- */

        /* === 标题和横线样式 (Headers & HR) === */
        .message-bubble .content .markdown-h {
            margin: 10px 0 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-bubble .content h1.markdown-h {
            font-size: 1.4em;
        }

        .message-bubble .content h2.markdown-h {
            font-size: 1.2em;
        }

        .message-bubble .content h3.markdown-h {
            font-size: 1.1em;
        }

        .message-bubble .content .markdown-hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 12px 0;
        }

        /* === 列表样式 (List) === */
        .markdown-ul {
            list-style: none;
            padding-left: 20px;
            margin: 10px 0;
        }

        .markdown-ul li {
            position: relative;
            margin-bottom: 5px;
        }

        .markdown-ul li::before {
            content: '•';
            position: absolute;
            left: -15px;
            top: 0;
            color: var(--accent-secondary);
            font-size: 1.2em;
            line-height: 1;
        }

        /* === 行内代码样式 (Inline Code) === */
        .message-bubble .content .markdown-code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: var(--border-color);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* === 【核心】代码块样式 (Code Block) === */
        .markdown-code-block-wrapper {
            border-radius: 8px;
            /* 给整个容器加圆角 */
            overflow: hidden;
            /* 确保内部元素不会超出圆角 */
            margin: 10px 0;
            background-color: var(--text-primary);
            /* 使用主文字颜色作为背景！ */
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            /* 顶栏的内边距 */
            background-color: rgba(0, 0, 0, 0.1);
            /* 在深色背景上加一层淡淡的黑色，增加层次感 */
        }

        .language-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            /* 语言名称用半透明白色 */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        .copy-code-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: white;
            /* 让“已复制”等文字也是白色 */
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-code-btn svg {
            stroke: rgba(255, 255, 255, 0.7);
            /* 图标颜色 */
            transition: stroke 0.2s;
        }

        .copy-code-btn:hover svg {
            stroke: white;
            /* 悬停时图标变亮 */
        }

        .markdown-code-block-wrapper pre {
            margin: 0;
            /* 移除 pre 标签的默认外边距 */
            padding: 10px;
            /* 减少内边距，让文字更贴近边框 */
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .markdown-code-block-wrapper pre code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            color: white;
            /* 代码文字全部为白色 */
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
<script id="cyxy-subtitles-inject" src="chrome-extension://abbgboelhkajgikdbjclaecchkneaoma/dist/video-subtitle.js"></script></head>

<body data-theme="default">
    <div id="app-container">
        <div id="sidebar-overlay"></div>
        <div id="chat-sidebar">
            <div class="sidebar-header">聊天助手</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <label>当前上下文 Tokens</label>
                    <div id="sidebar-token-count" class="value">0</div>
                </div>
                <button class="form-button secondary" id="preview-context-btn">预览上下文</button>
                <pre id="sidebar-preview-content"></pre>
            </div>
        </div>

        <div class="main-content">
            <!-- Page 1: Accounting (Chat) -->
            <div id="accounting-screen" class="page active" style="background-image: none;">
                <div class="header">
                    <div class="left-action"><span class="action-btn" id="chat-settings-btn">≡</span></div>
                    <div class="center-title"><span id="chat-header-title">我的记事本</span></div>
                    <div class="right-action"></div>
                </div>
                <div id="chat-messages"></div>
                <div id="selection-action-bar">
                    <button id="delete-selected-btn">删除</button>
                    <button id="cancel-selection-btn">取消</button>
                </div>
                <div id="chat-input-area">
                    <div id="chat-actions-bar">
                        <button class="chat-action-btn" id="chat-add-transaction-btn" title="记一笔">💰</button>
                        <button class="chat-action-btn" id="chat-add-schedule-btn" title="定个事">📝</button>
                        <button class="chat-action-btn" id="image-upload-btn" title="发图片">🖼️</button>
                        <button class="chat-action-btn" id="emoji-pack-btn" title="发表情">😃</button>
                        <button class="chat-action-btn" id="ai-trigger-btn" title="获得回应">🤖</button>
                    </div>
                    <div id="chat-text-input-bar">
                        <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
                        <textarea id="chat-input" rows="1" placeholder="说点什么..."></textarea>
                        <button id="send-btn" disabled="">发送</button>
                    </div>
                </div>
            </div>

            <!-- Page 2: Ledger -->
            <div id="ledger-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>我的账本</span></div>
                    <div class="right-action"><span class="action-btn" id="forward-ledger-btn">➣</span></div>
                </div>
                <div class="ledger-controls">
                    <button class="filter-btn" id="ledger-month-filter-btn">月份筛选</button>
                    <button class="filter-btn" id="ledger-category-filter-btn">分类筛选</button>
                    <select id="ledger-type-filter" style="border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); border-radius: 8px; padding: 6px 10px; font-size: 14px; flex-grow: 1;">
                        <option value="all">全部</option>
                        <option value="expense">只看支出</option>
                        <option value="income">只看收入</option>
                    </select>
                    <select id="ledger-sort">
                        <option value="time_desc">时间倒序</option>
                        <option value="time_asc">时间正序</option>
                        <option value="amount_desc">金额倒序</option>
                        <option value="amount_asc">金额正序</option>
                    </select>
                </div>
                <div class="page-content" id="ledger-page-content">
                    <div id="ledger-view-wrapper">
                        <div id="ledger-list-view">
                            <ul id="ledger-list"><li class="empty-state">没有符合筛选条件的记录</li></ul>
                            <div id="ledger-summary">总支出 (): <span style="color:var(--expense-color)">0.00</span> | 总收入 (): <span style="color:var(--income-color)">0.00</span></div>
                        </div>
                        <div id="ledger-chart-view" data-listener-attached="true">
                            <div id="pie-chart-tooltip"></div>
                            <div class="pie-chart-area">
                                <div class="pie-chart-title-wrapper">
                                    <h3 class="pie-chart-title">支出</h3>
                                    <p class="pie-chart-subtitle" id="expense-pie-subtitle">全时间 总共<br><span style="font-weight: bold; color: var(--text-primary);">0.00 </span></p>
                                </div>
                                <svg id="expense-pie-chart" viewBox="0 0 250 250"><text x="50%" y="50%" text-anchor="middle" fill="#B4A29B">无数据</text></svg>
                                <div class="pie-legend" id="expense-pie-legend"></div>
                            </div>
                            <div class="pie-chart-area">
                                <div class="pie-chart-title-wrapper">
                                    <h3 class="pie-chart-title">收入</h3>
                                    <p class="pie-chart-subtitle" id="income-pie-subtitle">全时间 总共<br><span style="font-weight: bold; color: var(--text-primary);">0.00 </span></p>
                                </div>
                                <svg id="income-pie-chart" viewBox="0 0 250 250"><text x="50%" y="50%" text-anchor="middle" fill="#B4A29B">无数据</text></svg>
                                <div class="pie-legend" id="income-pie-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ledger-footer-controls">
                    <select id="ledger-currency"><option value="RMB">人民币 (RMB)</option><option value="HKD">港币 (HKD)</option></select>
                    <button id="toggle-ledger-view-btn">图表 📊</button>
                    <div id="ledger-count" class="ledger-count">已记账0笔📈</div>
                </div>
            </div>

            <!-- Page 3: Schedule (NEW SWIPE LAYOUT) -->
            <div id="schedule-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span id="schedule-page-title">今日待办</span></div>
                    <div class="right-action">
                        <select id="schedule-forward-select" style="border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); border-radius: 8px; padding: 4px 8px; font-size: 14px;">
                            <option value="">同步选项</option>
                            <option value="today">今日待办</option>
                            <option value="calendar">日历视图</option>
                            <option value="all">全部日程</option>
                        </select>
                    </div>
                </div>
                <div class="schedule-swipe-container">
                    <div class="schedule-pages-wrapper">
                        <!-- Page 1: 今日待办 -->
                        <div class="schedule-page" id="schedule-today-page">
                            <div class="page-content" id="today-tasks-content"><div class="empty-state">今天没有待办事项，轻松一下吧！</div></div>
                        </div>
                        <!-- Page 2: 原日程四象限页面 -->
                        <div class="schedule-page" id="schedule-main-page">
                            <div class="page-content">
                                <div class="schedule-section">
                                    <div class="schedule-section-title">待完成</div>
                                    <div class="schedule-quadrant" id="quadrant-1">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">重要且紧急</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-1-items"><div class="empty-state">无</div></div>
                                    </div>
                                    <div class="schedule-quadrant" id="quadrant-2">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">重要不紧急</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-2-items"><div class="empty-state">无</div></div>
                                    </div>
                                    <div class="schedule-quadrant" id="quadrant-3">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">紧急不重要</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-3-items"><div class="empty-state">无</div></div>
                                    </div>
                                    <div class="schedule-quadrant" id="quadrant-4">
                                        <div class="quadrant-header">
                                            <div class="quadrant-title">不紧急不重要</div>
                                        </div>
                                        <div class="schedule-items" id="quadrant-4-items"><div class="empty-state">无</div></div>
                                    </div>
                                </div>
                                <div class="schedule-section">
                                    <div class="schedule-section-title">已完成</div>
                                    <div class="schedule-items" id="completed-items"><div class="empty-state">还没有已完成的日程</div></div>
                                </div>
                            </div>
                        </div>
                        <!-- Page 3: 月历 -->
                        <div class="schedule-page" id="schedule-calendar-page">
                            <div class="page-content">
                                <div id="month-calendar-view"><div class="calendar-header"><span class="calendar-month-year">2025年 9月</span></div><div class="calendar-weekdays"><span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span></div><div class="calendar-grid"><div></div><div class="calendar-day">1</div><div class="calendar-day">2</div><div class="calendar-day">3</div><div class="calendar-day">4</div><div class="calendar-day">5</div><div class="calendar-day">6</div><div class="calendar-day">7</div><div class="calendar-day">8</div><div class="calendar-day">9</div><div class="calendar-day">10</div><div class="calendar-day">11</div><div class="calendar-day">12</div><div class="calendar-day">13</div><div class="calendar-day">14</div><div class="calendar-day">15</div><div class="calendar-day">16</div><div class="calendar-day">17</div><div class="calendar-day">18</div><div class="calendar-day">19</div><div class="calendar-day">20</div><div class="calendar-day">21</div><div class="calendar-day">22</div><div class="calendar-day">23</div><div class="calendar-day">24</div><div class="calendar-day">25</div><div class="calendar-day">26</div><div class="calendar-day">27</div><div class="calendar-day today">28</div><div class="calendar-day">29</div><div class="calendar-day">30</div></div></div>
                                <div id="calendar-event-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="schedule-page-dots">
                    <span class="dot active" data-index="0"></span>
                    <span class="dot" data-index="1"></span>
                    <span class="dot" data-index="2"></span>
                </div>
                <div id="schedule-count" class="schedule-count">已完成0项事件🌟</div>
            </div>

            <!-- Page 4: More/Settings -->
            <div id="more-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>设置</span></div>
                    <div class="right-action"></div>
                </div>
                <div class="page-content">
                    <div class="setting-group">
                        <div class="setting-group-title">外观设置</div>
                        <div class="form-group">
                            <label>主题选择</label>
                            <div class="theme-selector">
                                <label class="theme-option"><input type="radio" name="theme" value="default" checked="">
                                    <div class="swatch default"></div><span class="label">暖阳甜杏</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="blue">
                                    <div class="swatch blue"></div><span class="label">晴空苏打</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="green">
                                    <div class="swatch green"></div><span class="label">薄荷微风</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="purple">
                                    <div class="swatch purple"></div><span class="label">紫藤幻梦</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="pink">
                                    <div class="swatch pink"></div><span class="label">樱落星辰</span>
                                </label>
                                <label class="theme-option"><input type="radio" name="theme" value="gray">
                                    <div class="swatch gray"></div><span class="label">静谧书影</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group"><label>聊天背景</label>
                            <div class="avatar-upload"><button onclick="document.getElementById(&#39;setting-chat-bg-input&#39;).click()">上传</button><button id="remove-bg-btn" style="background-color: var(--expense-color); color: white;">移除背景</button><input type="file" id="setting-chat-bg-input" accept="image/*"></div>
                        </div>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">我的资料</div>
                        <div class="form-group"><label>群聊名称</label><input type="text" id="setting-chat-name"></div>
                        <div class="form-group"><label>头像</label>
                            <div class="avatar-upload"><img id="setting-chat-avatar-preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNGQUUxRDUiLz48cGF0aCBkPSJNNzIgMzVBNiA2IDAgMSAwIDYwIDM1IDYgNiAwIDAgMCA3MiAzNW0tNDQgMEE2IDYgMCAxIDAgMTYgMzUgNiA2IDAgMCAwIDI4IDM1TTMzIDYwYTQwIDQwIDAgMCAwIDM0IDBjLTEuNS05LTcuNS0xNS0xNy0xNVMzNC41IDUxIDMzIDYwWiIgZmlsbD0iIzhDN0I3MyIvPjwvc3ZnPg=="><button id="upload-user-avatar-btn">上传</button><input type="file" id="setting-chat-avatar-input" accept="image/*"></div>
                        </div>
                        <div class="form-group"><label>ID</label><input type="text" id="setting-user-id" placeholder="可选填"></div>
                        <div class="form-group"><label>性别</label><select id="setting-user-gender">
                                <option value="">未设置</option>
                                <option value="male">男</option>
                                <option value="female">女</option>
                            </select></div>
                        <div class="form-group"><label>个人说明</label><textarea id="setting-user-bio" placeholder="可选填"></textarea></div>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">AI 设置</div>
                        <div class="form-group"><label for="max-tokens-input">最大上下文长度 (Token)</label><input type="number" id="max-tokens-input" placeholder="建议 4000-8000"></div>
                        <p style="font-size:12px; color: var(--text-secondary); margin-top:-10px; margin-bottom: 15px;">
                            此设置用于限制发送给AI的聊天记录长度，防止超出模型限制。1个汉字约等于2个Token。</p>
                        <button class="form-button secondary" id="manage-system-prompts-btn">管理系统提示词</button>
                        <button class="form-button secondary" id="manage-proxies-btn">管理API反代</button>
                        <button class="form-button secondary" id="manage-characters-btn">管理AI角色</button>
                        <button class="form-button secondary" id="manage-emoji-packs-btn">管理我的表情包</button>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">币种设置</div>
                        <button class="form-button secondary" id="manage-currencies-btn">管理币种和汇率</button>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">记录管理</div>
                        <button class="form-button secondary" id="export-json-btn">导出为 JSON</button>
                        <button class="form-button secondary" id="import-json-btn">从 JSON 导入</button>
                        <input type="file" id="import-json-input" accept=".json" style="display:none;">
                        <button class="form-button secondary" id="export-txt-btn">导出为 TXT</button>
                    </div>
                    <p style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
                        Technical support from Cava, Claude &amp; Gemini</p>
                </div>
            </div>
        </div>

        <!-- Transaction Input Panel -->
        <div id="transaction-panel">
            <div class="panel-header">
                <span class="close-btn" id="close-transaction-panel">×</span>
                <span style="font-weight: 600;" id="transaction-panel-title">新建记账</span>
                <span id="template-dropdown-btn" style="margin-left: 5px; color: var(--text-secondary); cursor: pointer; font-size: 12px;">ˇ</span>
                <div id="template-menu" style="display: none; position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: var(--bg-secondary); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-medium); padding: 8px; z-index: 201; min-width: 200px;">
                    <div id="template-list"></div>
                    <button style="width: 100%; padding: 8px; border: none; background: var(--bg-soft); border-radius: 6px; margin-top: 8px;" id="save-as-template-btn">保存为模板</button>
                </div>
            </div>
            <div id="amount-display-container"><span id="currency-selector">RMB</span>
                <div id="amount-display">0.00</div>
            </div>
            <div class="type-selector"><button id="type-expense-btn" class="active">支出</button><button id="type-income-btn">收入</button></div>
            <div id="category-selector"></div>
            <div class="transaction-remark-section">
                <input type="text" id="transaction-remark-input" placeholder="添加备注（可选）">
            </div>
            <div id="numpad-container">
                <div class="numpad"><button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="zero" data-key="0">0</button><button data-key=".">.</button></div>
                <div class="numpad-actions" id="numpad-actions"><button id="numpad-delete">⌫</button><button id="numpad-confirm" class="confirm">完成</button></div>
            </div>
        </div>

        <!-- Schedule Input Panel -->
        <div id="schedule-panel">
            <div class="panel-header">
                <span class="close-btn" id="close-schedule-panel">×</span>
                <span style="font-weight: 600;" id="schedule-panel-title">新建日程</span>
            </div>
            <div class="schedule-form">
                <div class="schedule-form-section red">
                    <label>事项类别</label>
                    <div class="event-type-toggle">
                        <button id="schedule-type-once" class="active">单次事件</button>
                        <button id="schedule-type-long">长期事件</button>
                    </div>
                </div>
                <div class="schedule-form-section green" id="recurrence-section" style="display: none;">
                    <label>重复周期</label>
                    <div id="recurrence-options">
                        <button data-type="daily">每天</button>
                        <button data-type="weekly">每周</button>
                        <button data-type="monthly">每月</button>
                    </div>
                    <div id="recurrence-selector-days" style="margin-top: 10px;"></div>
                </div>
                <div class="schedule-form-section blue">
                    <label>标题</label>
                    <input type="text" id="schedule-title-input" placeholder="输入事件标题">
                </div>
                <div class="schedule-form-section pink">
                    <label>重要程度</label>
                    <div class="importance-stars" id="importance-stars">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                        <span class="importance-score" id="importance-score">0.0</span>
                    </div>
                </div>
                <div class="schedule-form-section purple">
                    <label id="deadline-label">截止日期</label>
                    <div class="deadline-inputs">
                        <span id="deadline-display-text">选择日期</span>
                        <div class="time-input-part">
                            <input type="number" id="deadline-hour-input" class="time-input" placeholder="时">
                            <span class="time-separator">:</span>
                            <input type="number" id="deadline-minute-input" class="time-input" placeholder="分">
                        </div>
                    </div>
                </div>
                <div class="schedule-form-section purple" id="end-date-section" style="display: none;">
                    <label>结束日期</label>
                    <div class="deadline-inputs">
                        <span id="end-date-display-text">永不结束</span>
                    </div>
                </div>
                <div class="schedule-form-section blue">
                    <label>具体说明</label>
                    <textarea id="schedule-description-input" placeholder="输入具体说明（可选）"></textarea>
                </div>
            </div>
            <div class="schedule-actions">
                <button class="cancel-btn" id="cancel-schedule-btn">取消</button>
                <button class="confirm-btn" id="confirm-schedule-btn">确定</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div id="bottom-nav">
            <div class="nav-item active" data-page="accounting-screen">
                <div class="icon">💬</div>
                <div class="label">记事</div>
            </div>
            <div class="nav-item" data-page="ledger-screen">
                <div class="icon">📖</div>
                <div class="label">账本</div>
            </div>
            <div class="nav-item" data-page="schedule-screen">
                <div class="icon">🗓️</div>
                <div class="label">日程</div>
            </div>
            <div class="nav-item" data-page="more-screen">
                <div class="icon">⚙️</div>
                <div class="label">设置</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="calendar-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-body">
                <div class="calendar-header"><button id="prev-month-btn">&lt;</button><span id="calendar-month-year" class="calendar-month-year"></span><button id="next-month-btn">&gt;</button></div>
                <div class="calendar-weekdays">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="clear-date-btn">清除日期</button><button class="cancel-btn" id="close-calendar-btn">关闭</button></div>
        </div>
    </div>
    <div id="api-proxy-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">管理API反代</div>
            <div class="modal-body">
                <div id="proxy-list"></div><button class="form-button" id="add-proxy-btn">＋ 添加新反代</button>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="close-proxy-modal">关闭</button></div>
        </div>
    </div>
    <div id="proxy-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="proxy-editor-title">编辑反代</div>
            <div class="modal-body">
                <div class="form-group"><label>自定义名称</label><input type="text" id="proxy-editor-name" placeholder="如 Cava的API"></div>
                <div class="form-group"><label>URL (无需 /v1)</label><input type="text" id="proxy-editor-url"></div>
                <div class="form-group"><label>API Key</label><input type="password" id="proxy-editor-apikey"></div>
                <div class="form-group"><label>Model(s) (换行分隔)</label><textarea id="proxy-editor-models" rows="3" placeholder="gpt-4o
claude-3-opus-20240229"></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">保存</button></div>
        </div>
    </div>
    <div id="ai-character-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">管理AI角色</div>
            <div class="modal-body">
                <div id="character-list"></div><button class="form-button" id="add-character-btn">＋ 添加新角色</button>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="close-character-modal">关闭</button></div>
        </div>
    </div>
    <div id="character-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="character-editor-title">编辑角色</div>
            <div class="modal-body">
                <div class="form-group"><label>角色名称</label><input type="text" id="character-editor-name"></div>
                <div class="form-group"><label>角色头像</label>
                    <div class="avatar-upload"><img id="character-editor-avatar-preview"><button id="upload-char-avatar-btn">上传</button><input type="file" id="character-editor-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label>Prompt (人设)</label><textarea id="character-editor-prompt" rows="5"></textarea></div>
                <div class="form-group"><label>主用API</label><select id="character-editor-proxy"></select></div>
                <div class="form-group"><label>主用模型</label><select id="character-editor-model"></select></div>
                <div class="form-group"><label>备用API (可选)</label><select id="character-editor-backup-proxy"></select>
                </div>
                <div class="form-group"><label>备用模型</label><select id="character-editor-backup-model"></select></div>
                <div class="form-group" style="margin-top:20px; border-top: 1px dashed var(--border-color); padding-top:15px;">
                    <label id="toggle-advanced-settings-btn" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>高级参数设置</span>
                        <span id="char-advanced-arrow" style="font-size: 18px; font-weight: bold;">▼</span>
                    </label>
                </div>

                <div id="character-advanced-settings" style="display: none; padding-left: 10px; padding-right: 10px; border-left: 2px solid var(--accent-primary);">

                    <div class="form-group">
                        <label>参数预设模式</label>
                        <select id="character-param-mode" style="width:100%; padding: 8px; border-radius: 5px; border: 1px solid var(--accent-primary);">
                            <option value="default">默认 (均衡)</option>
                            <option value="assist">协助模式 (精准稳定)</option>
                            <option value="companion">陪伴模式 (创意发散)</option>
                            <option value="custom">自定义参数</option>
                        </select>
                    </div>

                    <div id="character-custom-params" style="display: none;">
                        <div class="form-group">
                            <label>温度 (Temperature): <span id="char-temp-value">0.8</span></label>
                            <input type="range" id="char-temperature" min="0" max="2" step="0.1" value="0.8" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>Top P: <span id="char-topp-value">0.95</span></label>
                            <input type="range" id="char-top-p" min="0" max="1" step="0.05" value="0.95" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>Top K: <span id="char-topk-value">0</span></label>
                            <input type="range" id="char-top-k" min="0" max="100" step="1" value="0" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>频率惩罚 (Frequency): <span id="char-freq-value">0</span></label>
                            <input type="range" id="char-freq-penalty" min="-2" max="2" step="0.1" value="0" class="ai-slider">
                        </div>

                        <div class="form-group">
                            <label>存在惩罚 (Presence): <span id="char-pres-value">0</span></label>
                            <input type="range" id="char-presence-penalty" min="-2" max="2" step="0.1" value="0" class="ai-slider">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">保存</button></div>
        </div>
    </div>
    <div id="ai-character-selector-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">选择发言角色</div>
            <div class="modal-body" id="ai-character-selector"></div>
            <div class="modal-footer"><button class="cancel-btn">取消</button></div>
        </div>
    </div>
    <div id="message-action-menu" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-body"><button id="multi-select-btn">☑️ 多选</button><button id="edit-message-btn">✏️
                    编辑</button><button id="edit-ai-message-btn">✏️ 编辑</button><button id="copy-message-btn">📋
                    复制</button><button id="delete-message-btn" class="danger">🗑️ 删除</button></div>
            <div class="modal-footer" style="padding-top:0;"><button class="cancel-btn" style="width:100%;">取消</button>
            </div>
        </div>
    </div>
    <div id="schedule-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">日程详情</div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">标题</div>
                    <div class="detail-value" id="detail-title"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">说明</div>
                    <div class="detail-value" id="detail-description"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">重要程度</div>
                    <div class="detail-value" id="detail-importance"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">截止日期</div>
                    <div class="detail-value" id="detail-deadline"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">事件类型</div>
                    <div class="detail-value" id="detail-type"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="edit-schedule-btn">编辑</button><button class="cancel-btn" style="background-color: var(--expense-color); color: white;" id="delete-schedule-btn">删除</button><button class="cancel-btn" id="close-schedule-detail-modal">关闭</button></div>
        </div>
    </div>
    <div id="cropper-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">裁剪头像</div>
            <div class="modal-body">
                <div id="cropper-image-container"><img id="cropper-image"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">确定</button></div>
        </div>
    </div>
    <div id="currency-list-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">管理币种</div>
            <div class="modal-body">
                <div id="currency-list"></div><button class="form-button" id="add-currency-btn">＋ 添加新币种</button>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="close-currency-list-modal">关闭</button></div>
        </div>
    </div>
    <div id="currency-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="currency-editor-title">编辑币种</div>
            <div class="modal-body">
                <div class="form-group"><label>币种代码 (3位大写字母)</label><input type="text" id="currency-editor-code" placeholder="例如: HKD, USD" maxlength="3" style="text-transform:uppercase;"></div>
                <div class="form-group"><label>币种名称</label><input type="text" id="currency-editor-name" placeholder="例如: 港币, 美元"></div>
                <div class="form-group"><label>对 RMB 的汇率 (1 币种 = ? RMB)</label><input type="number" id="currency-editor-rate" placeholder="例如: 0.92"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">保存</button></div>
        </div>
    </div>
    <div id="system-prompts-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">管理系统提示词</div>
            <div class="modal-body">
                <div class="setting-group" style="margin-bottom: 15px;">
                    <div class="setting-group-title" style="margin-bottom: 10px;">附加信息</div>
                    <div class="toggle-switch"><label for="system-prompt-send-time">发送当前时间</label><label class="switch"><input type="checkbox" id="system-prompt-send-time"><span class="slider"></span></label></div>
                    <div class="toggle-switch"><label for="system-prompt-send-model">发送当前模型</label><label class="switch"><input type="checkbox" id="system-prompt-send-model"><span class="slider"></span></label></div>
                    <div class="toggle-switch"><label for="system-prompt-send-role">发送AI角色名</label><label class="switch"><input type="checkbox" id="system-prompt-send-role"><span class="slider"></span></label></div>
                </div>
                <div class="setting-group">
                    <div class="setting-group-title">同步提示词模板</div>
                    <div class="form-group" style="margin-bottom: 10px;"><label for="system-prompt-ledger">同步账本</label><textarea id="system-prompt-ledger" rows="2"></textarea></div>
                    <div class="form-group" style="margin-bottom: 10px;"><label for="system-prompt-schedule">同步日程</label><textarea id="system-prompt-schedule" rows="2"></textarea></div>
                    <div class="form-group"><label for="system-prompt-pie">同步图表</label><textarea id="system-prompt-pie" rows="2"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">保存</button></div>
        </div>
    </div>
    <div id="ledger-month-filter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">选择月份</div>
            <div class="modal-body">
                <div class="filter-list" id="month-filter-list"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">确定</button></div>
        </div>
    </div>
    <div id="ledger-category-filter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">选择分类</div>
            <div class="modal-body">
                <div class="filter-tabs">
                    <div class="filter-tab active" data-type="expense">支出</div>
                    <div class="filter-tab" data-type="income">收入</div>
                </div>
                <div class="filter-list" id="category-filter-list"></div>
            </div>
            <div class="modal-footer"><button class="cancel-btn">取消</button><button class="save-btn">确定</button></div>
        </div>
    </div>
    <!-- 替换为这段 -->
    <div id="ledger-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">记账详情</div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">类型</div>
                    <div class="detail-value" id="ledger-detail-type"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">分类</div>
                    <div class="detail-value" id="ledger-detail-category"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">金额</div>
                    <div class="detail-value" id="ledger-detail-amount"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">备注</div>
                    <div class="detail-value" id="ledger-detail-remark"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">时间</div>
                    <div class="detail-value" id="ledger-detail-time"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel-btn" id="edit-ledger-btn">编辑</button><button class="cancel-btn" style="background-color: var(--expense-color); color: white;" id="delete-ledger-btn">删除</button><button class="cancel-btn" id="close-ledger-detail-modal">关闭</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            async function generateDiary() {
                if (!state.currentDiaryCharId || !state.currentDiaryDate) {
                    alert('请先选择角色');
                    return;
                }

                const character = state.characters.find(c => c.id === state.currentDiaryCharId);
                if (!character) {
                    alert('未找到选中的角色');
                    return;
                }

                const proxy = state.proxies.find(p => p.id === character.proxyId);
                if (!proxy || !character.model) {
                    alert(`角色 "${character.name}" 未配置API或模型`);
                    return;
                }

                // 显示加载状态
                const contentArea = document.getElementById('diary-content-area-inline');
                if (contentArea) {
                    contentArea.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; padding: 40px; flex-direction: column;">
                <div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>
                <p style="margin-top: 15px; color: var(--text-secondary);">正在生成日记...</p>
            </div>
        `;
                }

                try {
                    // 1. 准备所有需要替换的变量
                    // 这里的 state.currentDiaryDate 就是你日历上点击的那一天，是正确的！
                    const dateStr = `${state.currentDiaryDate.getFullYear()}年${state.currentDiaryDate.getMonth() + 1}月${state.currentDiaryDate.getDate()}日`;
                    const userId = state.config.userId || '用户';
                    const charName = character.name;

                    // 2. 构建用户信息字符串
                    let userProfileString = '';
                    if (state.config.userId || state.config.userGender || state.config.userBio) {
                        userProfileString += "[用户信息]\n";
                        if (state.config.userId) userProfileString += `- ID: ${state.config.userId}\n`;
                        if (state.config.userGender) userProfileString += `- 性别: ${state.config.userGender}\n`;
                        if (state.config.userBio) userProfileString += `- 简介: ${state.config.userBio}\n`;
                        userProfileString += '\n';
                    }

                    // --- 核心修改：拆分提示词 ---

                    // 3. 准备【系统提示词】，只包含不变的角色设定和用户信息
                    const systemPromptForAPI = `${character.prompt}\n\n${userProfileString}`;

                    // 4. 准备【最后的用户指令】，包含具体的写日记任务
                    const latestDiaryPromptTemplate = state.config.diaryPrompt; // 从数据库获取最新的模板
                    const finalInstruction = latestDiaryPromptTemplate
                        .replace(/{char}/g, charName)
                        .replace(/{user}/g, userId)
                        .replace(/{date}/g, dateStr);

                    const history = buildContext(8000).context;


                    const params = character.aiParams || {
                        temperature: 0.9, topP: 0.95, topK: 0, frequencyPenalty: 0, presencePenalty: 0
                    };

                    console.log('正在调用日记生成API...');

                    const messagesForAPI = [
                        { role: 'system', content: systemPromptForAPI }, 
                        ...history,                                     // 中间的对话历史
                        { role: 'user', content: finalInstruction }      // 结尾的最终指令！
                    ];

                    const response = await fetch(`${proxy.url}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${proxy.apiKey}`
                        },
                        body: JSON.stringify({
                            model: character.model,
                            messages: messagesForAPI, 
                            temperature: params.temperature,
                            top_p: params.topP,
                            top_k: params.topK,
                            frequency_penalty: params.frequencyPenalty,
                            presence_penalty: params.presencePenalty,
                            max_tokens: 3000
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(await response.text());
                    }

                    const data = await response.json();
                    const diaryContent = data.choices[0].message.content;
                    console.log('日记生成成功！');

                    const dateStrForDB = `${state.currentDiaryDate.getFullYear()}-${String(state.currentDiaryDate.getMonth() + 1).padStart(2, '0')}-${String(state.currentDiaryDate.getDate()).padStart(2, '0')}`;
                    const existingDiary = state.diaries.find(d => d.date === dateStrForDB && d.charId === state.currentDiaryCharId);

                    if (existingDiary) {
                        existingDiary.content = diaryContent;
                        existingDiary.timestamp = Date.now();
                        await db.diaries.put(existingDiary);
                    } else {
                        const newDiary = {
                            date: dateStrForDB,
                            charId: state.currentDiaryCharId,
                            content: diaryContent,
                            timestamp: Date.now()
                        };
                        const id = await db.diaries.add(newDiary);
                        state.diaries.push({ ...newDiary, id });
                    }

                    updateDiaryContentArea(state.currentDiaryDate);

                } catch (error) {
                    console.error('生成日记失败:', error);
                    alert('生成日记失败：' + error.message);
                    updateDiaryContentArea(state.currentDiaryDate);
                }
            }



            async function deleteDiary() {
                if (!confirm('确定要删除这篇日记吗？')) {
                    return;
                }

                const dateStr = `${state.currentDiaryDate.getFullYear()}-${String(state.currentDiaryDate.getMonth() + 1).padStart(2, '0')}-${String(state.currentDiaryDate.getDate()).padStart(2, '0')}`;
                const diary = state.diaries.find(d =>
                    d.date === dateStr && d.charId === state.currentDiaryCharId
                );

                if (diary) {
                    await db.diaries.delete(diary.id);
                    state.diaries = state.diaries.filter(d => d.id !== diary.id);
                    // 删除后，刷新日记区域
                    updateDiaryContentArea(state.currentDiaryDate);
                }
            }

            const db = new Dexie('WarmBookkeepingDB_v10'); // Upped version for schema change
            db.version(10).stores({
                appConfig: 'id',
                transactions: '++id, timestamp, type, category, amount, currency, remark',
                messages: '++id, timestamp, role, content, type, senderId, relatedId',
                apiProxies: '++id, name, url, apiKey, models',
                aiCharacters: '++id, name, prompt, avatar, proxyId, model, backupProxyId, backupModel',
                currencies: 'code, name, rate',
                transactionTemplates: '++id, name, type, category, amount, currency, remark',
                schedules: '++id, timestamp, title, description, importance, deadline, eventType, completed, recurrence, endDate, completedDates',
                emojiPacks: '++id, name, image, timestamp',
                diaries: '++id, date, charId, content, timestamp'
            });

            const DEFAULT_SYSTEM_PROMPTS = {
                sendTime: true,
                sendModel: true,
                sendRole: true,
                ledger: '这是我的记账条目数据，请你帮我分析一下：{data}',
                schedule: '这是我的日程数据，请你帮我分析一下：{data}',
                pie: '这是我账本图表数据，请你帮我分析一下：{data}'
            };

            let state = {
                config: {}, proxies: [], characters: [], messages: [], transactions: [], currencies: [], schedules: [], emojiPacks: [], diaries: [],
                currentTransaction: { type: 'expense', category: null, amountStr: '0', currency: 'RMB' },
                currentSchedule: {},
                calendarState: { year: new Date().getFullYear(), month: new Date().getMonth(), selectedDate: null, mode: 'deadline' },
                ledgerFilters: { months: [], type: 'expense', categories: [] },
                isSelectionMode: false,
                selectedMessages: new Set(),
                currentlyEditingMsgId: null,
                currentlyEditingTransactionId: null,
                currentlyEditingScheduleId: null,
                schedulePageIndex: 0,
                messagesDisplayed: 50,
                isLoadingMore: false,
                currentDiaryCharId: null,
                currentDiaryDate: null
            };

            const ELS = {
                body: document.body,
                app: document.getElementById('app-container'), pages: document.querySelectorAll('.page'), navItems: document.querySelectorAll('.nav-item'),
                chatHeaderTitle: document.getElementById('chat-header-title'), chatAvatar: document.getElementById('setting-chat-avatar-preview'),
                chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('send-btn'),
                accountingScreen: document.getElementById('accounting-screen'), transactionPanel: document.getElementById('transaction-panel'),
                schedulePanel: document.getElementById('schedule-panel'),
                amountDisplay: document.getElementById('amount-display'), categorySelector: document.getElementById('category-selector'),
                ledgerList: document.getElementById('ledger-list'), ledgerSummary: document.getElementById('ledger-summary'),
                ledgerSort: document.getElementById('ledger-sort'),
                ledgerCurrency: document.getElementById('ledger-currency'),
                ledgerCount: document.getElementById('ledger-count'),
                themeSelectors: document.querySelectorAll('input[name="theme"]'),
                sidebar: document.getElementById('chat-sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                chatSettingsBtn: document.getElementById('chat-settings-btn'),
                sidebarTokenCount: document.getElementById('sidebar-token-count'),
                previewContextBtn: document.getElementById('preview-context-btn'),
                sidebarPreviewContent: document.getElementById('sidebar-preview-content'),
            };

            const CATEGORIES = {
                expense: [{ id: 'food', name: '餐饮美食', icon: '🍔' }, { id: 'shopping', name: '购物消费', icon: '🛍️' }, { id: 'transport', name: '交通出行', icon: '🚌' }, { id: 'entertainment', name: '文化娱乐', icon: '🎬' }, { id: 'games', name: '游戏相关', icon: '🎮' }, { id: 'housing', name: '居家生活', icon: '🏠' }, { id: 'medical', name: '医疗健康', icon: '💊' }, { id: 'social', name: '人情往来', icon: '🎁' }, { id: 'study', name: '学习提升', icon: '📚' }, { id: 'other', name: '其他支出', icon: '💸' },],
                income: [{ id: 'salary', name: '工资', icon: '💼' }, { id: 'bonus', name: '奖金', icon: '🧧' }, { id: 'investment', name: '理财', icon: '📈' }, { id: 'part-time', name: '兼职', icon: '💪' }, { id: 'other', name: '其他收入', icon: '💰' },]
            };
            const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNGQUUxRDUiLz48cGF0aCBkPSJNNzIgMzVBNiA2IDAgMSAwIDYwIDM1IDYgNiAwIDAgMCA3MiAzNW0tNDQgMEE2IDYgMCAxIDAgMTYgMzUgNiA2IDAgMCAwIDI4IDM1TTMzIDYwYTQwIDQwIDAgMCAwIDM0IDBjLTEuNS05LTcuNS0xNS0xNy0xNVMzNC41IDUxIDMzIDYwWiIgZmlsbD0iIzhDN0I3MyIvPjwvc3ZnPg==';

            async function init() {
                await loadDataFromDB();
                setupEventListeners();
                navigateTo('accounting-screen');
                renderChatMessages();
                renderLedger();
                renderSchedules();
                applyConfigToUI();
                updateSendButtonState();
                populateLedgerCurrencyFilter();
            }


            async function loadDataFromDB() {
                const [config, proxies, characters, messages, transactions, currencies, schedules, emojiPacks, diaries] = await Promise.all([
                    db.appConfig.get('main'),
                    db.apiProxies.toArray(),
                    db.aiCharacters.toArray(),
                    db.messages.orderBy('timestamp').toArray(),
                    db.transactions.orderBy('timestamp').toArray(),
                    db.currencies.toArray(),
                    db.schedules.toArray(),
                    db.emojiPacks.toArray(),
                    db.diaries.toArray()
                ]);

                const defaultDiaryPrompt = `请你写一篇{char}的视角中与{user}在{date}的这一天高度相关的日记，主要是你在这一天的对话中，对{user}行为的心理活动经过和情感变化，结合过往对话记录来写。日记写作风格需要按照依照{char}的性格特点。你在写日记时，对{char}统一使用第一人称「我」（如“我收到了她的消息”），对{user}则一般使用第三人称（如“她今天买奶茶花了二十块”），但偶尔插入对{user}第二人称直白的话（如“我想让你知道”），加强情感冲击。直接以“{date}，记录者：{char}”开头，2000字左右~`;

                const baseConfig = {
                    id: 'main',
                    chatName: '我的记事本',
                    chatAvatar: DEFAULT_AVATAR,
                    maxTokens: 4096,
                    background: '',
                    theme: 'default',
                    userId: '',
                    userGender: '',
                    userBio: '',
                    systemPromptSettings: DEFAULT_SYSTEM_PROMPTS,
                    diaryPrompt: defaultDiaryPrompt // <--- 新增这一行
                };

                state.config = { ...baseConfig, ...config, systemPromptSettings: { ...DEFAULT_SYSTEM_PROMPTS, ...(config ? config.systemPromptSettings : {}) } };

                // 从数据库加载日记提示词，如果不存在则使用默认值
                currentDiaryPrompt = state.config.diaryPrompt || defaultDiaryPrompt;

                state.characters = characters.map(char => ({
                    ...char,
                    aiParams: char.aiParams || {
                        mode: 'default',
                        temperature: 0.8,
                        topP: 0.95,
                        topK: 0,
                        frequencyPenalty: 0,
                        presencePenalty: 0,
                    }
                }));

                state.proxies = proxies;
                state.messages = messages;
                state.transactions = transactions;
                state.schedules = schedules || [];
                state.emojiPacks = emojiPacks || [];
                state.diaries = diaries || [];

                if (currencies.length === 0) {
                    const preset = { code: 'HKD', name: '港币', rate: 0.92 };
                    await db.currencies.put(preset);
                    state.currencies = [preset];
                } else {
                    state.currencies = currencies;
                }
            }

            function applyConfigToUI() {
                ELS.chatHeaderTitle.textContent = state.config.chatName;
                document.getElementById('setting-chat-name').value = state.config.chatName;
                ELS.chatAvatar.src = state.config.chatAvatar || DEFAULT_AVATAR;
                document.getElementById('max-tokens-input').value = state.config.maxTokens;
                ELS.body.dataset.theme = state.config.theme || 'default';
                const themeRadio = document.querySelector(`input[name="theme"][value="${state.config.theme || 'default'}"]`);
                if (themeRadio) themeRadio.checked = true;
                ELS.accountingScreen.style.backgroundImage = state.config.background ? `url(${state.config.background})` : 'none';
                document.getElementById('setting-user-id').value = state.config.userId || '';
                document.getElementById('setting-user-gender').value = state.config.userGender || '';
                document.getElementById('setting-user-bio').value = state.config.userBio || '';
            }

            async function updateConfig(key, value) {
                state.config[key] = value;
                await db.appConfig.put(state.config);
                applyConfigToUI();
            }

            function navigateTo(pageId) {
                ELS.pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                ELS.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
                if (pageId === 'ledger-screen') renderLedger();
                if (pageId === 'schedule-screen') renderSchedules();
            }

            // 这个函数用来展开和收起“高级设置”
            function toggleCharacterAdvancedSettings() {
                const settingsDiv = document.getElementById('character-advanced-settings');
                const arrowSpan = document.getElementById('char-advanced-arrow');
                if (settingsDiv.style.display === 'none') {
                    settingsDiv.style.display = 'block';
                    arrowSpan.textContent = '▲';
                } else {
                    settingsDiv.style.display = 'none';
                    arrowSpan.textContent = '▼';
                }
            }

            // 这里存放我们定义好的三种模式的参数
            const PARAM_PRESETS = {
                default: { temperature: 0.8, topP: 0.95, topK: 0, frequencyPenalty: 0, presencePenalty: 0 },
                assist: { temperature: 0.4, topP: 0.3, topK: 10, frequencyPenalty: 0.2, presencePenalty: 0.2 },
                companion: { temperature: 0.9, topP: 0.9, topK: 0, frequencyPenalty: 0, presencePenalty: 0 }
            };

            // 这个函数用来把一个角色的性格参数，显示到滑杆和开关上
            function applyCharParamsToEditor(params) {
                params = params || PARAM_PRESETS.default; // 如果没有参数，就用默认的
                const modeSelect = document.getElementById('character-param-mode');
                const customParamsDiv = document.getElementById('character-custom-params');

                modeSelect.value = params.mode || 'default';

                const currentValues = (params.mode === 'custom') ? params : (PARAM_PRESETS[params.mode] || PARAM_PRESETS.default);

                // 更新所有滑杆和数值显示
                document.getElementById('char-temperature').value = currentValues.temperature;
                document.getElementById('char-temp-value').textContent = currentValues.temperature.toFixed(2);
                document.getElementById('char-top-p').value = currentValues.topP;
                document.getElementById('char-topp-value').textContent = currentValues.topP.toFixed(2);
                document.getElementById('char-top-k').value = currentValues.topK;
                document.getElementById('char-topk-value').textContent = currentValues.topK;
                document.getElementById('char-freq-penalty').value = currentValues.frequencyPenalty;
                document.getElementById('char-freq-value').textContent = currentValues.frequencyPenalty.toFixed(2);
                document.getElementById('char-presence-penalty').value = currentValues.presencePenalty;
                document.getElementById('char-pres-value').textContent = currentValues.presencePenalty.toFixed(2);

                if (params.mode === 'custom') {
                    customParamsDiv.style.display = 'block';
                } else {
                    customParamsDiv.style.display = 'none';
                }
            }

            // 这个函数用来把滑杆和开关上的设置，收集起来准备保存
            function collectCharParamsFromEditor() {
                const mode = document.getElementById('character-param-mode').value;
                const aiParams = { mode: mode };

                if (mode === 'custom') {
                    aiParams.temperature = parseFloat(document.getElementById('char-temperature').value);
                    aiParams.topP = parseFloat(document.getElementById('char-top-p').value);
                    aiParams.topK = parseInt(document.getElementById('char-top-k').value);
                    aiParams.frequencyPenalty = parseFloat(document.getElementById('char-freq-penalty').value);
                    aiParams.presencePenalty = parseFloat(document.getElementById('char-presence-penalty').value);
                } else {
                    // 如果不是自定义，就把预设的参数也存一份进去，方便调用
                    Object.assign(aiParams, PARAM_PRESETS[mode] || PARAM_PRESETS.default);
                }
                return aiParams;
            }

            // 绑定所有事件！
            function setupCharParamListeners() {
                const advancedSettingsBtn = document.getElementById('toggle-advanced-settings-btn');
                if (advancedSettingsBtn) {
                    advancedSettingsBtn.addEventListener('click', toggleCharacterAdvancedSettings);
                }
                // 监听模式下拉菜单的变化
                document.getElementById('character-param-mode').addEventListener('change', (e) => {
                    const mode = e.target.value;
                    const customParamsDiv = document.getElementById('character-custom-params');
                    if (mode === 'custom') {
                        customParamsDiv.style.display = 'block';
                    } else {
                        customParamsDiv.style.display = 'none';
                        // 如果切换到预设模式，就立刻把预设值应用到界面上
                        applyCharParamsToEditor({ mode: mode, ...PARAM_PRESETS[mode] });
                    }
                });

                // 监听所有滑杆的拖动
                ['char-temperature', 'char-top-p', 'char-top-k', 'char-freq-penalty', 'char-presence-penalty'].forEach(id => {
                    const slider = document.getElementById(id);
                    if (slider) {
                        slider.addEventListener('input', (e) => {
                            const valueId = id.replace('char-temperature', 'char-temp-value')
                                .replace('char-top-p', 'char-topp-value')
                                .replace('char-top-k', 'char-topk-value')
                                .replace('char-freq-penalty', 'char-freq-value')
                                .replace('char-presence-penalty', 'char-pres-value');
                            const valueDisplay = document.getElementById(valueId);
                            if (valueDisplay) {
                                valueDisplay.textContent = parseFloat(e.target.value).toFixed(2);
                            }
                        });
                    }
                });
            }

            function setupEventListeners() {
                ELS.navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));

                // Auto-saving settings
                document.getElementById('setting-chat-name').addEventListener('input', e => updateConfig('chatName', e.target.value));
                document.getElementById('setting-user-id').addEventListener('input', e => updateConfig('userId', e.target.value));
                document.getElementById('setting-user-gender').addEventListener('change', e => updateConfig('userGender', e.target.value));
                document.getElementById('setting-user-bio').addEventListener('input', e => updateConfig('userBio', e.target.value));
                document.getElementById('max-tokens-input').addEventListener('change', e => updateConfig('maxTokens', parseInt(e.target.value) || 4096));
                ELS.themeSelectors.forEach(radio => radio.addEventListener('change', (e) => {
                    ELS.body.dataset.theme = e.target.value;
                    updateConfig('theme', e.target.value);
                }));

                document.getElementById('upload-user-avatar-btn').addEventListener('click', () => document.getElementById('setting-chat-avatar-input').click());
                document.getElementById('setting-chat-avatar-input').addEventListener('change', (e) => {
                    handleAvatarUpload(e, (base64) => { ELS.chatAvatar.src = base64; updateConfig('chatAvatar', base64); });
                });

                document.getElementById('setting-chat-bg-input').addEventListener('change', async (e) => { if (!e.target.files[0]) return; const base64 = await fileToBase64(e.target.files[0]); updateConfig('background', base64); });
                document.getElementById('remove-bg-btn').addEventListener('click', async () => { updateConfig('background', ''); });

                ELS.chatInput.addEventListener('input', updateSendButtonState);
                ELS.sendBtn.addEventListener('click', sendUserMessage);
                ELS.chatMessages.addEventListener('scroll', () => {
                    if (state.isLoadingMore) return;
                    if (ELS.chatMessages.scrollTop < 100 && state.messagesDisplayed < state.messages.length) {
                        state.isLoadingMore = true;
                        state.messagesDisplayed = Math.min(state.messagesDisplayed + 50, state.messages.length);
                        renderChatMessages(false, false);
                        setTimeout(() => { state.isLoadingMore = false; }, 100);
                    }
                });

                document.getElementById('ai-trigger-btn').addEventListener('click', showAICharacterSelector);
                document.getElementById('image-upload-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
                document.getElementById('chat-add-transaction-btn').addEventListener('click', () => showTransactionPanel());
                document.getElementById('chat-add-schedule-btn').addEventListener('click', () => showSchedulePanel());
                document.getElementById('manage-emoji-packs-btn').addEventListener('click', openEmojiPackManager);
                document.getElementById('emoji-pack-btn').addEventListener('click', showEmojiPackSelector);
                document.getElementById('image-upload-input').addEventListener('change', sendUserImage);
                document.getElementById('close-transaction-panel').addEventListener('click', hideTransactionPanel);
                document.getElementById('close-schedule-panel').addEventListener('click', hideSchedulePanel);
                document.getElementById('type-expense-btn').addEventListener('click', () => switchTransactionType('expense'));
                document.getElementById('type-income-btn').addEventListener('click', () => switchTransactionType('income'));
                document.querySelector('.numpad').addEventListener('click', handleNumpad);
                document.getElementById('numpad-delete').addEventListener('click', handleNumpadDelete);
                document.getElementById('numpad-confirm').addEventListener('click', confirmTransaction);
                document.getElementById('currency-selector').addEventListener('click', toggleCurrency);
                // Template functionality
                document.getElementById('template-dropdown-btn').addEventListener('click', toggleTemplateMenu);
                document.getElementById('save-as-template-btn').addEventListener('click', saveAsTemplate);

                async function toggleTemplateMenu() {
                    const menu = document.getElementById('template-menu');
                    if (menu.style.display === 'none') {
                        await loadTemplates();
                        menu.style.display = 'block';
                    } else {
                        menu.style.display = 'none';
                    }
                }

                async function loadTemplates() {
                    const templates = await db.transactionTemplates.toArray();
                    const listEl = document.getElementById('template-list');
                    listEl.innerHTML = '';

                    if (templates.length === 0) {
                        listEl.innerHTML = '<div style="padding: 8px; color: var(--text-secondary); font-size: 14px;">暂无模板</div>';
                    } else {
                        templates.forEach(template => {
                            const item = document.createElement('div');
                            item.style.cssText = 'padding: 8px; cursor: pointer; border-radius: 6px; margin-bottom: 4px; background: var(--bg-main); display: flex; justify-content: space-between; align-items: center;';
                            item.innerHTML = `
                <span>${template.name}</span>
                <span style="font-size: 20px; color: var(--text-secondary);" data-id="${template.id}" class="delete-template">×</span>
            `;
                            item.addEventListener('click', (e) => {
                                if (!e.target.classList.contains('delete-template')) {
                                    applyTemplate(template);
                                }
                            });
                            listEl.appendChild(item);
                        });

                        // Add delete listeners
                        listEl.querySelectorAll('.delete-template').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                if (confirm('删除此模板？')) {
                                    await db.transactionTemplates.delete(parseInt(e.target.dataset.id));
                                    await loadTemplates();
                                }
                            });
                        });
                    }
                }

                function applyTemplate(template) {
                    state.currentTransaction = {
                        type: template.type,
                        category: template.category,
                        amountStr: String(template.amount),
                        currency: template.currency
                    };
                    document.getElementById('transaction-remark-input').value = template.remark || '';
                    document.getElementById('currency-selector').textContent = template.currency;
                    updateAmountDisplay();
                    switchTransactionType(template.type, template.category);
                    document.getElementById('template-menu').style.display = 'none';
                }

                async function saveAsTemplate() {
                    const name = prompt('模板名称：');
                    if (!name) return;

                    const template = {
                        name,
                        type: state.currentTransaction.type,
                        category: state.currentTransaction.category,
                        amount: parseFloat(state.currentTransaction.amountStr) || 0,
                        currency: state.currentTransaction.currency,
                        remark: document.getElementById('transaction-remark-input').value
                    };

                    await db.transactionTemplates.add(template);
                    alert('模板已保存！');
                    document.getElementById('template-menu').style.display = 'none';
                }

                setupSchedulePanelListeners();
                setupCalendarModalListeners();

                // Ledger page listeners
                document.getElementById('ledger-month-filter-btn').addEventListener('click', openMonthFilterModal);
                document.getElementById('ledger-category-filter-btn').addEventListener('click', openCategoryFilterModal);
                ELS.ledgerSort.addEventListener('change', renderLedger);
                document.getElementById('ledger-type-filter').addEventListener('change', renderLedger);
                ELS.ledgerCurrency.addEventListener('change', renderLedger);
                document.getElementById('forward-ledger-btn').addEventListener('click', forwardLedgerToChat);
                document.getElementById('schedule-forward-select').addEventListener('change', async (e) => {
                    const type = e.target.value;
                    if (!type) return;

                    if (type === 'today') {
                        await forwardTodayTasksToChat();
                    } else if (type === 'calendar') {
                        await forwardCalendarViewToChat();
                    } else if (type === 'all') {
                        await forwardScheduleToChat();
                    }

                    e.target.value = ''; // Reset select
                });

                async function forwardTodayTasksToChat() {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    const todayTasks = state.schedules.filter(s => {
                        if (s.eventType === 'once') {
                            if (!s.deadline) return false;
                            const dDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            dDate.setHours(0, 0, 0, 0);
                            return dDate.getTime() === today.getTime();
                        } else if (s.eventType === 'long') {
                            if (!s.recurrence) return false;
                            if (s.endDate && new Date(s.endDate) < today) return false;
                            if (s.deadline) {
                                const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                if (startDate > today) return false;
                            }

                            if (s.recurrence.type === 'daily') return true;
                            if (s.recurrence.type === 'weekly') {
                                return s.recurrence.days && s.recurrence.days.includes(today.getDay());
                            }
                            if (s.recurrence.type === 'monthly') {
                                const dayOfMonth = today.getDate();
                                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                                return s.recurrence.days && (s.recurrence.days.includes(dayOfMonth) ||
                                    (s.recurrence.days.includes('last') && dayOfMonth === lastDay));
                            }
                        }
                        return false;
                    });

                    const pending = [];
                    const completed = [];

                    todayTasks.forEach(task => {
                        const isCompleted = task.eventType === 'once' ? task.completed :
                            (task.completedDates && task.completedDates.includes(todayStr));
                        if (isCompleted) completed.push(task);
                        else pending.push(task);
                    });

                    const summaryData = { pending, completed, date: todayStr };

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'today_tasks_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                    navigateTo('accounting-screen');
                    renderChatMessages(true, true);
                }

                async function forwardCalendarViewToChat() {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = today.getMonth();
                    const monthDays = new Date(year, month + 1, 0).getDate();

                    const monthEvents = {};

                    for (let day = 1; day <= monthDays; day++) {
                        const date = new Date(year, month, day);
                        const events = state.schedules.filter(s => {
                            if (s.eventType === 'once') {
                                if (!s.deadline) return false;
                                const dDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                return dDate.getFullYear() === year && dDate.getMonth() === month && dDate.getDate() === day;
                            } else if (s.eventType === 'long') {
                                if (!s.recurrence) return false;
                                if (s.endDate && new Date(s.endDate) < date) return false;
                                if (s.deadline) {
                                    const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                    if (startDate > date) return false;
                                }

                                if (s.recurrence.type === 'daily') return true;
                                if (s.recurrence.type === 'weekly') {
                                    return s.recurrence.days && s.recurrence.days.includes(date.getDay());
                                }
                                if (s.recurrence.type === 'monthly') {
                                    const lastDay = new Date(year, month + 1, 0).getDate();
                                    return s.recurrence.days && (s.recurrence.days.includes(day) ||
                                        (s.recurrence.days.includes('last') && day === lastDay));
                                }
                            }
                            return false;
                        });

                        if (events.length > 0) {
                            monthEvents[day] = events.map(e => ({ title: e.title, type: e.eventType }));
                        }
                    }

                    const summaryData = { year, month: month + 1, events: monthEvents };

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'calendar_view_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                    navigateTo('accounting-screen');
                    renderChatMessages(true, true);
                }

                setupModal('manage-proxies-btn', 'api-proxy-modal', 'close-proxy-modal', renderProxyList);
                setupModal('manage-characters-btn', 'ai-character-modal', 'close-character-modal', renderCharacterList);
                setupModal('manage-currencies-btn', 'currency-list-modal', 'close-currency-list-modal', renderCurrencyList);
                setupModal('manage-system-prompts-btn', 'system-prompts-modal', null, openSystemPromptsEditor);
                document.getElementById('add-proxy-btn').addEventListener('click', () => openProxyEditor());
                document.getElementById('add-character-btn').addEventListener('click', () => openCharacterEditor());
                document.getElementById('add-currency-btn').addEventListener('click', () => openCurrencyEditor());
                setupEditorModal('proxy-editor-modal', saveProxy);
                setupEditorModal('character-editor-modal', saveCharacter);
                setupEditorModal('currency-editor-modal', saveCurrency);
                setupEditorModal('system-prompts-modal', saveSystemPrompts);
                setupEditorModal('ledger-month-filter-modal', () => { applyLedgerFilters(); document.getElementById('ledger-month-filter-modal').classList.remove('visible'); });
                setupEditorModal('ledger-category-filter-modal', () => { applyLedgerFilters(); document.getElementById('ledger-category-filter-modal').classList.remove('visible'); });
                setupEditorModal('cropper-modal', null);
                setupModal(null, 'ai-character-selector-modal', null, null);
                document.querySelector('#ai-character-selector-modal .cancel-btn').addEventListener('click', () => {
                    document.getElementById('ai-character-selector-modal').classList.remove('visible');
                });

                // 在你的 <script> 标签里找到这一行:
                setupModal(null, 'message-action-menu', null);

                // 把下面这段代码粘贴到它的后面
                // Fix message action menu close
                document.getElementById('message-action-menu').addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        document.getElementById('message-action-menu').classList.remove('visible');
                    }
                });
                // 新增这段，专门处理“取消”按钮的点击
                document.querySelector('#message-action-menu .cancel-btn').addEventListener('click', () => {
                    document.getElementById('message-action-menu').classList.remove('visible');
                });

                const scheduleDetailModal = document.getElementById('schedule-detail-modal');
                scheduleDetailModal.querySelector('#close-schedule-detail-modal').addEventListener('click', () => scheduleDetailModal.classList.remove('visible'));
                scheduleDetailModal.querySelector('#edit-schedule-btn').addEventListener('click', handleEditScheduleFromModal);
                scheduleDetailModal.querySelector('#delete-schedule-btn').addEventListener('click', handleDeleteScheduleFromModal);

                document.getElementById('export-json-btn').addEventListener('click', exportAsJSON);
                document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
                document.getElementById('import-json-input').addEventListener('change', importFromJSON);
                document.getElementById('export-txt-btn').addEventListener('click', exportAsTXT);

                ELS.chatSettingsBtn.addEventListener('click', toggleSidebar);
                ELS.sidebarOverlay.addEventListener('click', toggleSidebar);
                ELS.previewContextBtn.addEventListener('click', toggleContextPreview);

                document.getElementById('cancel-selection-btn').addEventListener('click', exitSelectionMode);
                document.getElementById('delete-selected-btn').addEventListener('click', deleteSelectedMessages);

                // --- NEW: Ledger view swipe logic ---
                let ledgerTouchStartX = 0;
                let ledgerViewIndex = 0; // 0 for list, 1 for chart

                function updateLedgerView() {
                    const wrapper = document.getElementById('ledger-view-wrapper');
                    wrapper.style.transform = `translateX(-${ledgerViewIndex * 50}%)`;
                    document.getElementById('toggle-ledger-view-btn').textContent = ledgerViewIndex === 0 ? '图表 📊' : '列表 📄';
                }

                document.getElementById('ledger-page-content').addEventListener('touchstart', e => {
                    ledgerTouchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                document.getElementById('ledger-page-content').addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const swipeDist = touchEndX - ledgerTouchStartX;
                    if (Math.abs(swipeDist) < 50) return;

                    if (swipeDist < 0 && ledgerViewIndex === 0) { // Swipe left
                        ledgerViewIndex = 1;
                        updateLedgerView();
                    } else if (swipeDist > 0 && ledgerViewIndex === 1) { // Swipe right
                        ledgerViewIndex = 0;
                        updateLedgerView();
                    }
                });

                document.getElementById('toggle-ledger-view-btn').addEventListener('click', () => {
                    ledgerViewIndex = ledgerViewIndex === 0 ? 1 : 0;
                    updateLedgerView();
                });

                // Ledger list item click for editing
                ELS.ledgerList.addEventListener('click', (e) => {
                    const item = e.target.closest('.ledger-item');
                    if (item && item.dataset.id) {
                        showLedgerDetail(parseInt(item.dataset.id));
                    }
                });

                function showLedgerDetail(id) {
                    const t = state.transactions.find(t => t.id === id);
                    if (!t) return;

                    const category = CATEGORIES[t.type].find(c => c.id === t.category);

                    document.getElementById('ledger-detail-type').textContent = t.type === 'expense' ? '支出' : '收入';
                    document.getElementById('ledger-detail-category').textContent = `${category?.icon || '🤔'} ${category?.name || '未知'}`;
                    document.getElementById('ledger-detail-amount').textContent = `${t.amount.toFixed(2)} ${t.currency}`;
                    document.getElementById('ledger-detail-remark').textContent = t.remark || '无备注';
                    document.getElementById('ledger-detail-time').textContent = new Date(t.timestamp).toLocaleString();

                    const modal = document.getElementById('ledger-detail-modal');

                    document.getElementById('edit-ledger-btn').onclick = () => {
                        modal.classList.remove('visible');
                        showTransactionPanel(id);
                    };

                    document.getElementById('delete-ledger-btn').onclick = async () => {
                        if (confirm('确定要删除这条记账及其聊天记录吗？')) {
                            const msg = state.messages.find(m => m.relatedId === id && m.type === 'transaction');
                            await db.transactions.delete(id);
                            state.transactions = state.transactions.filter(t => t.id !== id);
                            if (msg) {
                                await db.messages.delete(msg.id);
                                state.messages = state.messages.filter(m => m.id !== msg.id);
                            }
                            modal.classList.remove('visible');
                            renderLedger();
                            renderChatMessages(false, true);
                        }
                    };

                    document.getElementById('close-ledger-detail-modal').onclick = () => {
                        modal.classList.remove('visible');
                    };

                    modal.classList.add('visible');
                }

                // NEW: Schedule page swipe listeners
                const scheduleSwipeContainer = document.querySelector('.schedule-swipe-container');
                const schedulePagesWrapper = document.querySelector('.schedule-pages-wrapper');
                let scheduleTouchStartX = 0;
                scheduleSwipeContainer.addEventListener('touchstart', e => {
                    scheduleTouchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                scheduleSwipeContainer.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const swipeDist = touchEndX - scheduleTouchStartX;
                    if (Math.abs(swipeDist) < 50) return;

                    if (swipeDist < 0 && state.schedulePageIndex < 2) { // Swipe left
                        state.schedulePageIndex++;
                    } else if (swipeDist > 0 && state.schedulePageIndex > 0) { // Swipe right
                        state.schedulePageIndex--;
                    }
                    updateSchedulePage();
                });

                // 日记模态框事件监听
                document.getElementById('close-diary-modal').addEventListener('click', () => {
                    document.getElementById('diary-modal').classList.remove('visible');
                });

                document.getElementById('edit-diary-prompt-btn').addEventListener('click', () => {
                    document.getElementById('diary-system-prompt').value = currentDiaryPrompt;
                    document.getElementById('diary-prompt-modal').classList.add('visible');
                });

                document.getElementById('save-diary-prompt').addEventListener('click', async () => {
                    const newPrompt = document.getElementById('diary-system-prompt').value;
                    // 直接调用 updateConfig 函数，它会同时更新 state 和数据库
                    await updateConfig('diaryPrompt', newPrompt);
                    console.log('提示词已更新并存入数据库:', state.config.diaryPrompt);
                    alert('提示词已成功保存！');
                    document.getElementById('diary-prompt-modal').classList.remove('visible');
                });



                document.querySelector('#diary-prompt-modal .cancel-btn').addEventListener('click', () => {
                    document.getElementById('diary-prompt-modal').classList.remove('visible');
                });

                document.getElementById('diary-char-select').addEventListener('change', async (e) => {
                    const charId = parseInt(e.target.value);
                    if (charId && state.currentDiaryDate) {
                        state.currentDiaryCharId = charId;
                        await loadDiaryForDate(state.currentDiaryDate, charId);
                    }
                });

                document.getElementById('generate-diary-btn').addEventListener('click', generateDiary);
                document.getElementById('delete-diary-btn').addEventListener('click', deleteDiary);

                // 日记相关函数
                async function showDiaryModal(date) {
                    state.currentDiaryDate = date;

                    // 设置标题
                    const dateStr = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                    document.getElementById('diary-modal-title').textContent = `${dateStr}的日记`;

                    // 填充角色选择器
                    const charSelect = document.getElementById('diary-char-select');
                    charSelect.innerHTML = '<option value="">选择角色</option>';
                    state.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        charSelect.appendChild(option);
                    });

                    // 如果有默认角色，选择第一个
                    if (state.characters.length > 0 && !state.currentDiaryCharId) {
                        state.currentDiaryCharId = state.characters[0].id;
                        charSelect.value = state.currentDiaryCharId;
                    } else if (state.currentDiaryCharId) {
                        charSelect.value = state.currentDiaryCharId;
                    }

                    // 加载日记
                    if (state.currentDiaryCharId) {
                        await loadDiaryForDate(date, state.currentDiaryCharId);
                    } else {
                        showDiaryEmptyState();
                    }

                    document.getElementById('diary-modal').classList.add('visible');
                }

                async function loadDiaryForDate(date, charId) {
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const diary = state.diaries.find(d => d.date === dateStr && d.charId === charId);

                    if (diary) {
                        showDiaryContent(diary.content);
                    } else {
                        showDiaryEmptyState();
                    }
                }

                function showDiaryContent(content) {
                    document.getElementById('diary-empty-state').style.display = 'none';
                    document.getElementById('diary-loading').style.display = 'none';
                    document.getElementById('diary-display').style.display = 'block';
                    document.getElementById('diary-text').textContent = content;

                    const char = state.characters.find(c => c.id === state.currentDiaryCharId);
                    if (char) {
                        document.getElementById('generate-diary-btn').textContent = `📔 生成${char.name}的日记`;
                    }
                }

                function showDiaryEmptyState() {
                    document.getElementById('diary-display').style.display = 'none';
                    document.getElementById('diary-loading').style.display = 'none';
                    document.getElementById('diary-empty-state').style.display = 'block';

                    const char = state.characters.find(c => c.id === state.currentDiaryCharId);
                    if (char && state.currentDiaryDate) {
                        const dateStr = `${state.currentDiaryDate.getFullYear()}年${state.currentDiaryDate.getMonth() + 1}月${state.currentDiaryDate.getDate()}日`;
                        document.getElementById('generate-diary-btn').textContent = `📔 生成${char.name}${dateStr}的日记`;
                    }
                }

                function showDiaryLoading() {
                    document.getElementById('diary-empty-state').style.display = 'none';
                    document.getElementById('diary-display').style.display = 'none';
                    document.getElementById('diary-loading').style.display = 'block';
                }

                setupCharParamListeners();
            }

            function updateSendButtonState() { const hasText = ELS.chatInput.value.trim().length > 0; ELS.sendBtn.disabled = !hasText; }

            async function sendUserMessage() {
                if (ELS.sendBtn.disabled) return;
                const text = ELS.chatInput.value.trim();

                if (text) {
                    const newMsg = { timestamp: Date.now(), role: 'user', content: text, type: 'text' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                    ELS.chatInput.value = '';
                    renderChatMessages();
                    updateSendButtonState();
                }
            }

            async function sendUserImage(event) {
                const file = event.target.files[0];
                if (!file) return;

                // 压缩图片
                const compressedBase64 = await compressImage(file, 800, 0.8);

                const newMsg = { timestamp: Date.now(), role: 'user', content: compressedBase64, type: 'image' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                renderChatMessages();
                event.target.value = '';
            }

            async function compressImage(file, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            let width = img.width;
                            let height = img.height;

                            // 计算缩放比例
                            if (width > maxWidth) {
                                height = (maxWidth / width) * height;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // 绘制压缩后的图片
                            ctx.drawImage(img, 0, 0, width, height);

                            // 转换为base64
                            const compressedBase64 = canvas.toDataURL('image/webp', quality);
                            resolve(compressedBase64);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            async function compressEmojiPack(file, maxSize = 400) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            let width = img.width;
                            let height = img.height;

                            // 计算缩放比例，最长边为400px
                            if (width > height && width > maxSize) {
                                height = (maxSize / width) * height;
                                width = maxSize;
                            } else if (height > width && height > maxSize) {
                                width = (maxSize / height) * width;
                                height = maxSize;
                            } else if (width === height && width > maxSize) {
                                width = maxSize;
                                height = maxSize;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            const compressedBase64 = canvas.toDataURL('image/webp', 0.8);
                            resolve(compressedBase64);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            async function triggerAIResponse(character) {
                const proxy = state.proxies.find(p => p.id === character.proxyId);
                const backupProxy = state.proxies.find(p => p.id === character.backupProxyId);
                if (!proxy || !character.model) {
                    alert(`角色 "${character.name}" 未配置主用API或模型，无法发言。`);
                    return;
                }

                const now = new Date();
                const formattedDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                let userProfileString = '';
                if (state.config.userId || state.config.userGender || state.config.userBio) {
                    userProfileString += "[User Profile]\n";
                    if (state.config.userId) userProfileString += `- ID: ${state.config.userId}\n`;
                    if (state.config.userGender) userProfileString += `- Gender: ${state.config.userGender}\n`;
                    if (state.config.userBio) userProfileString += `- Bio: ${state.config.userBio}\n`;
                    userProfileString += '\n';
                }

                const { sendTime, sendModel, sendRole } = state.config.systemPromptSettings;
                let systemInfo = "[System Info]\n";
                if (sendModel) systemInfo += `- Current Model: ${character.model}\n`;
                if (sendTime) systemInfo += `- Current Time: ${formattedDateTime}\n`;
                if (sendRole) systemInfo += `- Your Role: ${character.name}\n`;
                systemInfo += `\n---\n\n`;

                const systemPrefix = userProfileString + systemInfo;
                const systemPrompt = systemPrefix + `${character.prompt}\n\n你的任务是作为聊天伙伴对用户的记账和聊天内容做出回应。你的回应需要符合你的人设。如果用户发了图片或表情包，你要像能看到一样进行评论。你也可以发送表情包，格式为[emoji:表情包名称]，当你发送表情包时，需要单独换行。可用的表情包有：${state.emojiPacks.map(e => e.name).join('、')}。请自然地进行对话。规则如下：\n1. 发送多条消息请用换行符(\\n)分隔，这会创建多个聊天气泡。\n2. 在单条消息内部换行，请直接使用 <br> 标签。`; const history = buildContext(state.config.maxTokens || 4096).context;

                // 1. 为主API的调用创建一个“思考中”气泡
                const thinkingBubbleId = addThinkingBubble(character);

                let responseText;
                try {
                    // 尝试调用主API
                    responseText = await callAPI(proxy, systemPrompt, history, character.model, character);
                    await processAIResponse(responseText, thinkingBubbleId, character);
                } catch (mainError) {
                    console.error("Main API failed:", mainError);

                    // 2. 主API失败，将它的“思考中”气泡更新为错误信息，并【保留】它
                    await updateThinkingBubble(thinkingBubbleId, `[主API错误: ${mainError.message}]`, character.id, true);

                    // 3. 检查是否有备用API，这里的 if/else 结构是修复语法错误的关键
                    if (backupProxy && character.backupModel) {
                        console.log("Main API failed, trying backup API...");

                        // 4. 为【备用API】的调用创建【新的】“思考中”气泡
                        const backupBubbleId = addThinkingBubble(character);

                        // 将调用备用API的逻辑【整个】放入 if 块内
                        try {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            let backupSystemInfo = "[System Info]\n";
                            if (sendModel) backupSystemInfo += `- Current Model: ${character.backupModel}\n`;
                            if (sendTime) backupSystemInfo += `- Current Time: ${formattedDateTime}\n`;
                            if (sendRole) backupSystemInfo += `- Your Role: ${character.name}\n`;
                            backupSystemInfo += `\n---\n\n`;
                            const backupSystemPrefix = userProfileString + backupSystemInfo;
                            const backupSystemPrompt = systemPrefix + `${character.prompt}\n\n你的任务是作为聊天伙伴对用户的记账和聊天内容做出回应。你的回应需要符合你的人设。如果用户发了图片或表情包，你要像能看到一样进行评论。你也可以发送表情包，格式为[emoji:表情包名称]，当你发送表情包时，需要单独换行。可用的表情包有：${state.emojiPacks.map(e => e.name).join('、')}。请自然地进行对话。规则如下：\n1. 发送多条消息请用换行符(\\n)分隔，这会创建多个聊天气泡。\n2. 在单条消息内部换行，请直接使用 <br> 标签。`;
                            // 尝试调用备用API
                            responseText = await callAPI(backupProxy, backupSystemPrompt, history, character.backupModel, character);

                            // 5. 【关键修改】备用API成功后，用它的结果更新【它自己】的“思考中”气泡
                            await processAIResponse(responseText, backupBubbleId, character);

                        } catch (backupError) {
                            console.error("Backup API also failed:", backupError);
                            // 6. 【关键修改】如果备用API也失败了，则更新【它自己】的“思考中”气泡为错误信息
                            await updateThinkingBubble(backupBubbleId, `[备用API错误: ${backupError.message}]`, character.id, true);
                        }
                    } else {
                        // 这个 else 块现在正确地跟在 if 后面
                        console.log("No backup API configured, stopping.");
                    }
                }
            }

            async function processAIResponse(text, bubbleId, character) {
                const aiReplies = text.split('\n').map(r => r.trim()).filter(Boolean);

                if (aiReplies.length > 0) {
                    for (let i = 0; i < aiReplies.length; i++) {
                        let reply = aiReplies[i];
                        const isFirstMessage = (i === 0);

                        if (!isFirstMessage) {
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 600 + 200));
                        }

                        const emojiRegex = /\[emoji:(.*?)\]/;
                        const emojiMatch = reply.match(emojiRegex);

                        if (emojiMatch) {
                            const emojiName = emojiMatch[1];
                            const emoji = state.emojiPacks.find(e => e.name === emojiName);

                            if (emoji) {
                                if (isFirstMessage) {
                                    await updateThinkingBubbleAsEmoji(bubbleId, emoji, character.id);
                                } else {
                                    await addAIEmojiMessage(emoji, character.id);
                                }
                            }

                            const remainingText = reply.replace(emojiRegex, '').trim();
                            if (remainingText) {
                                await addAIMessage(remainingText, character.id);
                            }
                        } else {
                            if (isFirstMessage) {
                                await updateThinkingBubble(bubbleId, reply, character.id);  // 修复：添加 bubbleId
                            } else {
                                await addAIMessage(reply, character.id);
                            }
                        }
                    }
                } else {
                    await updateThinkingBubble(bubbleId, "[AI没有返回任何内容]", character.id, true);  // 修复：添加 bubbleId
                }
            }

            // 添加新函数：
            async function updateThinkingBubbleAsEmoji(bubbleId, emoji, senderId) {
                const newMsgData = {
                    timestamp: Date.now(),
                    role: 'assistant',
                    content: `[emoji:${emoji.name}]`,
                    type: 'emoji_pack',
                    senderId
                };
                const newId = await db.messages.add(newMsgData);
                state.messages.push({ ...newMsgData, id: newId });
                const bubbleWrapper = document.getElementById(bubbleId);
                if (bubbleWrapper) {
                    const newBubble = createMessageElement({ ...newMsgData, id: newId });
                    bubbleWrapper.parentElement.replaceChild(newBubble, bubbleWrapper);
                }
            }

            async function addAIEmojiMessage(emoji, senderId) {
                const newMsg = {
                    timestamp: Date.now(),
                    role: 'assistant',
                    content: `[emoji:${emoji.name}]`,
                    type: 'emoji_pack',
                    senderId
                };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                renderChatMessages();
            }

            function buildContext(maxTokens) {
                let context = [];
                let currentTokens = 0;
                const reversedMessages = [...state.messages].reverse();
                const { systemPromptSettings } = state.config;

                // 这个变量现在用来记录“上一个已处理消息的日期”
                let processedDateStr = null;

                for (const msg of reversedMessages) {
                    let content;
                    let msgTokens = 0;
                    const role = msg.role === 'assistant' ? 'assistant' : 'user';

                    // --- 这部分解析消息内容的代码保持不变 ---
                    if (msg.type === 'transaction') {
                        const t = state.transactions.find(t => t.id === msg.relatedId);
                        if (!t) continue;
                        content = `[记账提醒] 我${t.type === 'expense' ? '花了' : '赚了'} ${t.amount}${t.currency}，分类是${CATEGORIES[t.type].find(c => c.id === t.category)?.name || '未知'}，备注是：“${t.remark}”`;
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'schedule') {
                        const s = state.schedules.find(s => s.id === msg.relatedId);
                        if (!s) continue;
                        const deadlineStr = s.deadline ? formatDeadline(s.deadline) : '无';
                        const descriptionText = s.description ? `说明是"${s.description}"` : "无";
                        const statusText = s.completed ? '已完成' : '未完成';
                        const eventTypeStr = s.eventType === 'long' ? '长期事件' : '单次事件';
                        content = `[日程提醒-${eventTypeStr}] 我定了个${eventTypeStr}：'${s.title}'。重要程度是 ${s.importance.toFixed(1)}/10，截止日期是 ${deadlineStr}，${descriptionText}，当前状态：${statusText}。`;
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'image') {
                        content = [{ type: "image_url", image_url: { url: msg.content } }];
                        msgTokens = 1000;
                    } else if (msg.type === 'emoji_pack') {
                        const match = msg.content.match(/\[emoji:(.*?)\]/);
                        if (match) {
                            content = `[emoji:${match[1]}]`;
                            msgTokens = content.length * 2;
                        }
                    } else if (msg.type === 'ledger_summary') {
                        const data = JSON.stringify(getFilteredTransactions().filtered);
                        content = (systemPromptSettings.ledger || DEFAULT_SYSTEM_PROMPTS.ledger).replace('{data}', data);
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'schedule_summary') {
                        const data = JSON.stringify(state.schedules);
                        content = (systemPromptSettings.schedule || DEFAULT_SYSTEM_PROMPTS.schedule).replace('{data}', data);
                        msgTokens = content.length * 2;
                    } else if (msg.type === 'pie_chart_summary') {
                        content = (systemPromptSettings.pie || DEFAULT_SYSTEM_PROMPTS.pie).replace('{data}', msg.content);
                        msgTokens = content.length * 2;
                    } else {
                        content = msg.content;
                        msgTokens = content.length * 2;
                    }
                    // --- 消息解析结束 ---

                    // ==================== 全新的智能时间戳逻辑 ====================
                    const msgDate = new Date(msg.timestamp);
                    const currentMsgDateStr = `${msgDate.getFullYear()}-${String(msgDate.getMonth() + 1).padStart(2, '0')}-${String(msgDate.getDate()).padStart(2, '0')}`;

                    let dateMarkerContent = null;
                    let dateMarkerTokens = 0;

                    // 检查：如果这不是循环的第一个消息，并且当前消息的日期与上一个处理的消息日期不同
                    if (processedDateStr && currentMsgDateStr !== processedDateStr) {
                        // 那么，我们就在此插入一个分割线，内容是“上一个处理的日期”
                        const prevDate = new Date(processedDateStr);
                        const month = prevDate.getMonth() + 1;
                        const day = prevDate.getDate();
                        dateMarkerContent = `\n——以下是${month}月${day}日的消息——\n`;
                        dateMarkerTokens = dateMarkerContent.length * 2;
                    }

                    // 检查加上分割线（如果需要）和消息本身后，是否会超出token限制
                    if (currentTokens + msgTokens + dateMarkerTokens > maxTokens) {
                        break; // 如果空间不足，则停止添加任何新消息
                    }

                    // 如果需要插入分割线，先把它放进上下文数组的最前面
                    if (dateMarkerContent) {
                        context.unshift({ role: 'system', content: dateMarkerContent });
                        currentTokens += dateMarkerTokens;
                    }

                    // 接着，把当前这条消息放进上下文数组的最前面
                    const finalRole = (msg.type !== 'text' && msg.role === 'user') ? 'user' : role;
                    const messageForContext = { role: finalRole, content };

                    if (finalRole === 'assistant' && msg.senderId) {
                        const character = state.characters.find(c => c.id === msg.senderId);
                        if (character) {
                            messageForContext.name = character.name; // 使用 name 字段
                        }
                    }
                    context.unshift(messageForContext);
                    currentTokens += msgTokens;

                    // 最后，更新“已处理日期”，为下一次循环做准备
                    processedDateStr = currentMsgDateStr;
                    // ===============================================================
                }
                return { context, tokens: currentTokens };
            }


            async function callAPI(proxy, systemPrompt, history, model, character) { // <--- 多了一个 character 参数
                // 从角色信息里读取他的专属性格参数，如果不存在则使用默认预设值
                const params = character.aiParams || PARAM_PRESETS.default;

                const res = await fetch(`${proxy.url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${proxy.apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: systemPrompt }, ...history],

                        // --- 核心修改在这里！---
                        // 把从角色对象中读取的性格参数放在这里
                        temperature: params.temperature,
                        top_p: params.topP,
                        top_k: params.topK,
                        frequency_penalty: params.frequencyPenalty,
                        presence_penalty: params.presencePenalty
                    })
                });

                // --- 函数后面已有的错误处理和返回数据的代码（保持不变）---
                if (!res.ok) {
                    const errorText = await res.text();
                    let errorMessage = '未知API错误';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error.message || errorText;
                    } catch (e) {
                        errorMessage = errorText;
                    }
                    throw new Error(errorMessage);
                }

                const data = await res.json();
                return data.choices[0].message.content;
            }

            async function addAIMessage(content, senderId = null) {
                const newMsg = { timestamp: Date.now(), role: 'assistant', content, type: 'text', senderId };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                renderChatMessages();
            }

            function addThinkingBubble(character) {
                const bubbleId = `thinking-${Date.now()}`;
                const wrapper = createMessageElement({ id: bubbleId, role: 'assistant', type: 'text', senderId: character.id, content: `<div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>` });
                ELS.chatMessages.appendChild(wrapper); ELS.chatMessages.scrollTop = ELS.chatMessages.scrollHeight;
                return bubbleId;
            }

            async function updateThinkingBubble(bubbleId, content, senderId, isError = false) {
                const newMsgData = { timestamp: Date.now(), role: 'assistant', content, type: 'text', senderId };
                const newId = await db.messages.add(newMsgData);
                state.messages.push({ ...newMsgData, id: newId });
                const bubbleWrapper = document.getElementById(bubbleId);
                if (bubbleWrapper) { const newBubble = createMessageElement({ ...newMsgData, id: newId }, isError); bubbleWrapper.parentElement.replaceChild(newBubble, bubbleWrapper); }
                state.messages = state.messages.filter(m => m.id !== bubbleId);
            }

            function parseSimpleMarkdown(text) {
                if (!text) return '';

                // 1. 【顺序调整】我们先处理我们信任的 <br> 标签，把它换成一个临时的、不会被影响的换行符
                let processedText = text.replace(/<br\s*\/?>/gi, '\n');

                // 2. 【安全升级】现在再对剩余的HTML特殊字符进行转义，防止 XSS 攻击
                processedText = processedText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

                // 3.【核心改造】处理多行代码块，生成新的带头部的结构
                processedText = processedText.replace(/^```([a-z]*)?\n([\s\S]+?)\n```$/gm, (match, lang, code) => {
                    const languageName = lang || 'text';
                    const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    return `<div class="markdown-code-block-wrapper">
                            <div class="code-block-header">
                                <span class="language-name">${languageName}</span>
                                <button class="copy-code-btn" title="复制">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                            <pre><code>${escapedCode}</code></pre>
                        </div>`;
                });

                // 4. 处理其他块级元素
                processedText = processedText.replace(/^(?:---|\*\*\*|___)\s*$/gm, '<hr class="markdown-hr">');
                processedText = processedText.replace(/^### (.*$)/gm, '<h3 class="markdown-h">$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2 class="markdown-h">$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1 class="markdown-h">$1</h1>');
                processedText = processedText.replace(/(?:(?:^[ \t]*[-*+]) .*(?:\n|$))+/gm, (match) => {
                    const listItems = match.trim().split('\n').map(item =>
                        item.replace(/^[ \t]*[-*+] (.*)/, '<li>$1</li>')
                    ).join('');
                    return `<ul class="markdown-ul">${listItems}</ul>`;
                });

                // 5. 处理行内元素
                processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                processedText = processedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
                processedText = processedText.replace(/`([^`]+)`/g, '<code class="markdown-code">$1</code>');

                // 6. 最后处理换行符，现在我们只需要把之前替换的 \n 转换回 <br>
                processedText = processedText.replace(/<\/div>|<pre>|<\/h[1-3]>|<\/ul>|<\/hr>/g, (match) => `${match}\n`);
                processedText = processedText.replace(/\n/g, '<br>');

                return processedText;
            }

            function attachCopyCodeListeners(container) {
                const copyButtons = container.querySelectorAll('.copy-code-btn');
                copyButtons.forEach(button => {
                    if (button.dataset.listenerAttached) return;

                    const originalContent = button.innerHTML; // 保存原始的 SVG 图标
                    const copiedContent = '已复制!'; // 定义复制成功后的文本

                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const wrapper = button.closest('.markdown-code-block-wrapper');
                        const codeElement = wrapper.querySelector('pre > code');
                        if (codeElement) {
                            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                                button.innerHTML = copiedContent; // 临时显示“已复制”
                                setTimeout(() => {
                                    button.innerHTML = originalContent; // 2秒后恢复图标
                                }, 2000);
                            }).catch(err => {
                                console.error('无法复制: ', err);
                                button.innerHTML = '失败';
                                setTimeout(() => {
                                    button.innerHTML = originalContent;
                                }, 2000);
                            });
                        }
                    });
                    button.dataset.listenerAttached = 'true';
                });
            }

            function createMessageElement(msg, isError = false) {
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${msg.role === 'user' ? 'user' : 'ai'}`;
                if (isError) wrapper.classList.add('error');
                wrapper.id = msg.id;
                wrapper.dataset.id = msg.id;

                const checkbox = document.createElement('div');
                checkbox.className = 'message-selection-checkbox';
                checkbox.innerHTML = '✓';
                wrapper.appendChild(checkbox);

                wrapper.addEventListener('click', (e) => {
                    if (state.isSelectionMode) {
                        e.stopPropagation();
                        toggleMessageSelection(msg.id);
                    }
                });

                let character = msg.senderId ? state.characters.find(c => c.id === msg.senderId) : null;

                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                avatar.src = msg.role === 'user' ? (state.config.chatAvatar || DEFAULT_AVATAR) : (character ? character.avatar : DEFAULT_AVATAR);

                const messageBlock = document.createElement('div');
                messageBlock.className = 'message-block';

                if (msg.role === 'assistant' && character) {
                    const senderName = document.createElement('div');
                    senderName.className = 'sender-name';
                    senderName.textContent = character.name;
                    messageBlock.appendChild(senderName);
                }

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.classList.add(msg.type);

                const contentContainer = document.createElement('div');
                contentContainer.className = 'content';

                if (msg.type === 'transaction') {
                    const t = state.transactions.find(t => t.id === msg.relatedId);
                    if (!t) return wrapper;
                    const category = CATEGORIES[t.type].find(c => c.id === t.category);
                    const remarkText = t.remark || '没有备注哦~';
                    contentContainer.innerHTML = `<div class="transaction-card"><div class="transaction-header ${t.type}"><div class="icon">${category?.icon || '🤔'}</div><div class="category-name">${category?.name || '未知分类'}</div></div><div class="transaction-body"><div class="transaction-amount">${t.type === 'expense' ? '-' : '+'}${t.amount.toFixed(2)}<span class="currency-label">${t.currency}</span></div><div class="transaction-remark"><span class="original-text">${remarkText}</span></div></div></div>`;
                } else if (msg.type === 'schedule') {
                    const s = state.schedules.find(s => s.id === msg.relatedId);
                    if (!s) return wrapper;
                    const deadlineStr = s.deadline ? formatDeadline(s.deadline) : '无';

                    let statusText = '未完成';
                    let statusClass = 'pending';

                    if (s.eventType === 'once' && s.completed) {
                        statusText = '已完成';
                        statusClass = 'completed';
                    } else if (s.eventType === 'long') {
                        const today = new Date();
                        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        if (s.completedDates && s.completedDates.includes(todayStr)) {
                            statusText = '已完成 (今日)';
                            statusClass = 'completed';
                        }
                    }

                    contentContainer.innerHTML = `<div class="schedule-card"><div class="schedule-header"><div class="icon">🏷️</div><div class="type-name">${s.eventType === 'long' ? '长期事件' : '单次事件'}</div></div><div class="schedule-body"><div class="schedule-title">${s.title}</div><div class="schedule-importance">重要程度: ${s.importance.toFixed(1)}</div><div class="schedule-deadline">截止: ${deadlineStr}</div><div class="schedule-status ${statusClass}">状态: ${statusText}</div>${s.description ? `<div class="schedule-description"><span class="original-text">${s.description}</span></div>` : ''}</div></div>`;
                } else if (msg.type === 'image') {
                    contentContainer.innerHTML = `<img src="${msg.content}" class="chat-image" alt="用户发送的图片">`;
                } else if (msg.type === 'emoji_pack') {
                    // 解析表情包名称
                    const match = msg.content.match(/\[emoji:(.*?)\]/);
                    if (match) {
                        const emojiName = match[1];
                        const emoji = state.emojiPacks.find(e => e.name === emojiName);
                        if (emoji) {
                            contentContainer.innerHTML = `<img src="${emoji.image}" class="chat-image" alt="${emojiName}" style="max-width: 150px; max-height: 150px;">`;
                        } else {
                            contentContainer.innerHTML = `<span class="content-text">[表情包: ${emojiName}]</span>`;
                        }
                    }
                } else if (msg.type === 'ledger_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">📖</div><div class="type-name">我的账本</div></div><div class="summary-body"><div class="text">已将筛选账本信息同步给AI</div></div></div>`;
                } else if (msg.type === 'schedule_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">🗓️</div><div class="type-name">我的日程</div></div><div class="summary-body"><div class="text">已将最新日程信息同步给AI</div></div></div>`;
                } else if (msg.type === 'pie_chart_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">📊</div><div class="type-name">账本图表</div></div><div class="summary-body"><div class="text">已将图表分析同步给AI</div></div></div>`;
                } else if (msg.type === 'today_tasks_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">📅</div><div class="type-name">今日待办</div></div><div class="summary-body"><div class="text">已将今日待办同步给AI</div></div></div>`;
                } else if (msg.type === 'calendar_view_summary') {
                    contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">📆</div><div class="type-name">日历视图</div></div><div class="summary-body"><div class="text">已将本月日程同步给AI</div></div></div>`;
                } else {
                    const contentSpan = document.createElement('span');
                    contentSpan.className = 'content-text';
                    contentSpan.innerHTML = msg.id.toString().startsWith('thinking-') ? msg.content : parseSimpleMarkdown(msg.content);
                    contentContainer.appendChild(contentSpan);
                }

                const metaContainer = document.createElement('div');
                metaContainer.className = 'message-meta';
                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                const menuTrigger = document.createElement('span');
                menuTrigger.className = 'message-actions-trigger';
                menuTrigger.innerHTML = '⋮';
                menuTrigger.addEventListener('click', (e) => { e.stopPropagation(); cancelCurrentEdit(); showActionMenu(msg.id); });
                metaContainer.append(timestamp, menuTrigger);

                bubble.append(contentContainer, metaContainer);
                messageBlock.appendChild(bubble);

                if (msg.role === 'user') {
                    wrapper.append(messageBlock, avatar);
                } else {
                    wrapper.append(avatar, messageBlock);
                }

                return wrapper;
            }

            function renderChatMessages(shouldScrollToBottom = true, resetDisplay = false) {
                if (resetDisplay) {
                    state.messagesDisplayed = 50;
                }

                const lastScrollTop = ELS.chatMessages.scrollTop;
                const lastScrollHeight = ELS.chatMessages.scrollHeight;
                const isScrolledToBottom = lastScrollHeight - lastScrollTop - ELS.chatMessages.clientHeight < 1;

                const messagesToShow = state.messages.slice(-state.messagesDisplayed);
                const hasMore = state.messagesDisplayed < state.messages.length;

                ELS.chatMessages.innerHTML = '';

                // 添加加载更多提示
                if (hasMore) {
                    const loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'load-more-indicator';
                    loadMoreDiv.textContent = '向上滚动加载更多...';
                    ELS.chatMessages.appendChild(loadMoreDiv);
                }

                messagesToShow.forEach(msg => {
                    if (!msg.id.toString().startsWith('thinking-')) {
                        ELS.chatMessages.appendChild(createMessageElement(msg));
                    }
                });

                if (shouldScrollToBottom || isScrolledToBottom) {
                    ELS.chatMessages.scrollTop = ELS.chatMessages.scrollHeight;
                } else if (!resetDisplay) {
                    // 保持相对位置
                    const newScrollHeight = ELS.chatMessages.scrollHeight;
                    const scrollDiff = newScrollHeight - lastScrollHeight;
                    ELS.chatMessages.scrollTop = lastScrollTop + scrollDiff;
                }

                attachCopyCodeListeners(ELS.chatMessages); // 绑定复制代码按钮事件

            }

            function getFilteredTransactions() {
                const typeFilter = document.getElementById('ledger-type-filter')?.value || 'all';
                const { months, categories, type } = state.ledgerFilters;
                const sort = ELS.ledgerSort.value;
                const displayCurrency = ELS.ledgerCurrency.value;

                const allCurrencies = [{ code: 'RMB', rate: 1 }, ...state.currencies];
                const toRate = allCurrencies.find(c => c.code === displayCurrency)?.rate || 1;

                let transactionsWithDisplayAmount = state.transactions.map(t => {
                    const fromRate = allCurrencies.find(c => c.code === t.currency)?.rate || 1;
                    const amountInRMB = t.amount * fromRate;
                    const displayAmount = amountInRMB / toRate;
                    return { ...t, displayAmount };
                });

                let filtered = transactionsWithDisplayAmount;
                // Filter by type (all/expense/income)
                if (typeFilter !== 'all') {
                    filtered = filtered.filter(t => t.type === typeFilter);
                }

                // Filter by month
                if (months.length > 0) {
                    filtered = filtered.filter(t => {
                        const date = new Date(t.timestamp);
                        const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        return months.includes(monthStr);
                    });
                }

                // Filter by category
                if (categories.length > 0) {
                    filtered = filtered.filter(t => t.type === type && categories.includes(t.category));
                }

                filtered.sort((a, b) => {
                    switch (sort) {
                        case 'time_asc': return a.timestamp - b.timestamp;
                        case 'amount_desc': return b.displayAmount - a.displayAmount;
                        case 'amount_asc': return a.displayAmount - b.displayAmount;
                        default: return b.timestamp - a.timestamp;
                    }
                });

                return { filtered, displayCurrency };
            }

            function renderLedger() {
                const { filtered, displayCurrency } = getFilteredTransactions();

                // Render List
                ELS.ledgerList.innerHTML = '';
                let totalExpense = 0, totalIncome = 0;

                if (filtered.length === 0) {
                    ELS.ledgerList.innerHTML = '<li class="empty-state">没有符合筛选条件的记录</li>';
                } else {
                    filtered.forEach(t => {
                        if (t.type === 'expense') totalExpense += t.displayAmount;
                        else totalIncome += t.displayAmount;

                        const category = CATEGORIES[t.type].find(c => c.id === t.category);
                        const li = document.createElement('li');
                        li.className = 'ledger-item';
                        li.dataset.id = t.id;
                        li.innerHTML = `<div class="icon">${category?.icon || '🤔'}</div><div class="details"><div class="remark">${t.remark || category?.name || '一笔账'}</div><div class="time">${new Date(t.timestamp).toLocaleString()}</div></div><div class="amount ${t.type}">${t.type === 'expense' ? '-' : '+'}${t.displayAmount.toFixed(2)} ${displayCurrency}</div>`;
                        ELS.ledgerList.appendChild(li);
                    });
                }
                ELS.ledgerSummary.innerHTML = `总支出 (${displayCurrency}): <span style="color:var(--expense-color)">${totalExpense.toFixed(2)}</span> | 总收入 (${displayCurrency}): <span style="color:var(--income-color)">${totalIncome.toFixed(2)}</span>`;

                // Render Charts
                renderPieCharts(filtered, displayCurrency);

                // Update total count
                ELS.ledgerCount.textContent = `已记账${state.transactions.length}笔📈`;
            }

            function generatePieChartSubtitle() {
                const { months, categories, type } = state.ledgerFilters;

                let timeText;
                if (months.length === 0) {
                    timeText = '全时间';
                } else {
                    const sorted = months.map(m => new Date(m + '-01')).sort((a, b) => a - b);
                    const isContinuous = sorted.every((date, i) => {
                        if (i === 0) return true;
                        const prev = sorted[i - 1];
                        return prev.getFullYear() === date.getFullYear() && prev.getMonth() + 1 === date.getMonth();
                    });

                    if (isContinuous && sorted.length > 1) {
                        const start = sorted[0];
                        const end = sorted[sorted.length - 1];
                        timeText = `${start.getFullYear()}年${start.getMonth() + 1}月 - ${end.getFullYear()}年${end.getMonth() + 1}月`;
                    } else {
                        timeText = sorted.map(d => `${d.getFullYear()}年${d.getMonth() + 1}月`).join('、');
                    }
                }

                let categoryText;
                const allCategoriesForType = CATEGORIES[type].map(c => c.id);
                if (categories.length === 0 || categories.length === allCategoriesForType.length) {
                    categoryText = '总共';
                } else {
                    categoryText = categories.map(catId => {
                        const cat = CATEGORIES[type].find(c => c.id === catId);
                        return cat ? cat.name : '';
                    }).filter(Boolean).join('、');
                }

                return `${timeText} ${categoryText}`;
            }

            function renderPieCharts(transactions, currency) {
                const subtitleText = generatePieChartSubtitle();

                const expenseData = {};
                const incomeData = {};

                transactions.forEach(t => {
                    const data = t.type === 'expense' ? expenseData : incomeData;
                    if (!data[t.category]) {
                        data[t.category] = 0;
                    }
                    data[t.category] += t.displayAmount;
                });

                const totalExpense = Object.values(expenseData).reduce((s, a) => s + a, 0);
                const totalIncome = Object.values(incomeData).reduce((s, a) => s + a, 0);

                document.getElementById('expense-pie-subtitle').innerHTML = `${subtitleText}<br><span style="font-weight: bold; color: var(--text-primary);">${totalExpense.toFixed(2)} ${currency}</span>`;
                document.getElementById('income-pie-subtitle').innerHTML = `${subtitleText}<br><span style="font-weight: bold; color: var(--text-primary);">${totalIncome.toFixed(2)} ${currency}</span>`;

                drawPieChart('expense-pie-chart', 'expense-pie-legend', expenseData, CATEGORIES.expense, currency, totalExpense);
                drawPieChart('income-pie-chart', 'income-pie-legend', incomeData, CATEGORIES.income, currency, totalIncome);
            }

            function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
                const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                return {
                    x: centerX + (radius * Math.cos(angleInRadians)),
                    y: centerY + (radius * Math.sin(angleInRadians))
                };
            }

            function describeArc(x, y, radius, startAngle, endAngle) {
                const start = polarToCartesian(x, y, radius, endAngle);
                const end = polarToCartesian(x, y, radius, startAngle);
                const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
                const d = ["M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y, "L", x, y, "L", start.x, start.y].join(" ");
                return d;
            }

            function drawPieChart(svgId, legendId, data, categoryDefinitions, currency, totalAmount) {
                const svg = document.getElementById(svgId);
                const legend = document.getElementById(legendId);
                svg.innerHTML = '';
                legend.innerHTML = '';
                svg.setAttribute('viewBox', '0 0 250 250');
                const tooltip = document.getElementById('pie-chart-tooltip');

                if (totalAmount === 0) {
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute('x', '50%');
                    text.setAttribute('y', '50%');
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', getComputedStyle(document.body).getPropertyValue('--text-secondary'));
                    text.textContent = '无数据';
                    svg.appendChild(text);
                    return;
                }

                const cx = 125, cy = 125, radius = 110;
                const colors = ['#f28b82', '#ffc107', '#8dd4bf', '#87c4f4', '#c58af9', '#f4aab6', '#fbc5a6', '#a1c9f4', '#b2e2a4', '#d6a3d6'];
                let colorIndex = 0;
                let startAngle = 0;

                const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);

                for (const [categoryId, amount] of sortedData) {
                    const percentage = (amount / totalAmount) * 100;
                    const angle = percentage / 100 * 360;
                    const endAngle = startAngle + angle;
                    const categoryInfo = categoryDefinitions.find(c => c.id === categoryId);
                    const categoryName = categoryInfo ? categoryInfo.name : '未知';
                    const color = colors[colorIndex++ % colors.length];

                    let chartElement;

                    // BUGFIX: Handle full circle case for single category
                    if (angle > 359.9) { // Use tolerance for float issues
                        chartElement = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        chartElement.setAttribute("cx", cx);
                        chartElement.setAttribute("cy", cy);
                        chartElement.setAttribute("r", radius);
                    } else {
                        chartElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        chartElement.setAttribute("d", describeArc(cx, cy, radius, startAngle, endAngle));
                    }

                    chartElement.setAttribute("fill", color);
                    chartElement.dataset.name = categoryName;
                    chartElement.dataset.amount = amount.toFixed(2);
                    chartElement.dataset.percent = percentage.toFixed(1);

                    chartElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const currentActive = svg.querySelector('.active');
                        if (currentActive && currentActive !== chartElement) currentActive.classList.remove('active');
                        chartElement.classList.toggle('active');

                        if (chartElement.classList.contains('active')) {
                            tooltip.innerHTML = `<strong>${chartElement.dataset.name}</strong><br>${chartElement.dataset.percent}%<br>${chartElement.dataset.amount} ${currency}`;
                            const chartViewRect = document.getElementById('ledger-chart-view').getBoundingClientRect();
                            const x = e.clientX - chartViewRect.left;
                            const y = e.clientY - chartViewRect.top + document.getElementById('ledger-chart-view').scrollTop;
                            tooltip.style.left = `${x}px`;
                            tooltip.style.top = `${y}px`;
                            tooltip.style.display = 'block';
                        } else {
                            tooltip.style.display = 'none';
                        }
                    });
                    svg.appendChild(chartElement);

                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `<span class="legend-color-box" style="background-color: ${color};"></span><span>${categoryName}</span>`;
                    legend.appendChild(legendItem);

                    startAngle = endAngle;
                }
            }

            if (!document.getElementById('ledger-chart-view').dataset.listenerAttached) {
                document.getElementById('ledger-chart-view').addEventListener('click', (e) => {
                    if (e.target.tagName !== 'path' && e.target.tagName !== 'circle') {
                        document.getElementById('pie-chart-tooltip').style.display = 'none';
                        const currentActive = document.querySelector('#ledger-chart-view .active');
                        if (currentActive) currentActive.classList.remove('active');
                    }
                });
                document.getElementById('ledger-chart-view').dataset.listenerAttached = 'true';
            }

            function populateLedgerCurrencyFilter() {
                const select = ELS.ledgerCurrency;
                select.innerHTML = '';
                const allCurrenciesForFilter = [{ code: 'RMB', name: '人民币' }, ...state.currencies];
                allCurrenciesForFilter.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.code;
                    option.textContent = `${c.name} (${c.code})`;
                    select.appendChild(option);
                });
                select.value = 'RMB';
            }

            function showActionMenu(msgId) {
                const menu = document.getElementById('message-action-menu');
                const msg = state.messages.find(m => m.id === msgId);
                if (!msg) return;

                document.getElementById('multi-select-btn').onclick = () => { menu.classList.remove('visible'); enterSelectionMode(); };

                const editUserBtn = document.getElementById('edit-message-btn');
                const editAiBtn = document.getElementById('edit-ai-message-btn');
                const copyBtn = document.getElementById('copy-message-btn');
                const deleteBtn = document.getElementById('delete-message-btn');

                const isUserText = msg.role === 'user' && msg.type === 'text';
                const isUserTransaction = msg.role === 'user' && msg.type === 'transaction';
                const isUserSchedule = msg.role === 'user' && msg.type === 'schedule';
                const isAiText = msg.role === 'assistant' && msg.type === 'text';
                const isCopyable = isUserText || isAiText || (isUserTransaction && state.transactions.find(t => t.id === msg.relatedId)?.remark) || (isUserSchedule && state.schedules.find(s => s.id === msg.relatedId)?.description);

                editUserBtn.style.display = (isUserText || isUserTransaction || isUserSchedule) ? 'block' : 'none';
                if (isUserTransaction) editUserBtn.innerHTML = '✏️ 编辑备注';
                else if (isUserSchedule) editUserBtn.innerHTML = '✏️ 编辑说明';
                else editUserBtn.innerHTML = '✏️ 编辑';

                editAiBtn.style.display = isAiText ? 'block' : 'none';
                copyBtn.style.display = isCopyable ? 'block' : 'none';

                editUserBtn.onclick = () => { menu.classList.remove('visible'); editMessage(msgId); };
                editAiBtn.onclick = () => { menu.classList.remove('visible'); editMessage(msgId); };
                copyBtn.onclick = () => { menu.classList.remove('visible'); copyMessage(msgId); };
                deleteBtn.onclick = () => { menu.classList.remove('visible'); deleteMessage(msgId); };

                menu.classList.add('visible');
            }

            function cancelCurrentEdit() {
                if (!state.currentlyEditingMsgId) return;
                const msgElement = document.getElementById(state.currentlyEditingMsgId);
                if (msgElement) {
                    const bubble = msgElement.querySelector('.message-bubble');
                    if (bubble) bubble.classList.remove('editing');
                    const editContainer = msgElement.querySelector('.inline-edit-container');
                    if (editContainer) editContainer.remove();
                }
                state.currentlyEditingMsgId = null;
            }

            async function editMessage(msgId) {
                cancelCurrentEdit();
                state.currentlyEditingMsgId = msgId;

                const msgIndex = state.messages.findIndex(m => m.id === msgId);
                if (msgIndex === -1) return;
                const msg = state.messages[msgIndex];

                const msgElement = document.getElementById(msgId);
                if (!msgElement) return;

                const bubble = msgElement.querySelector('.message-bubble');
                let targetContainer, originalText;

                if (msg.type === 'transaction') {
                    targetContainer = msgElement.querySelector('.transaction-remark');
                    originalText = state.transactions.find(t => t.id === msg.relatedId)?.remark || '';
                } else if (msg.type === 'schedule') {
                    targetContainer = msgElement.querySelector('.schedule-description');
                    originalText = state.schedules.find(s => s.id === msg.relatedId)?.description || '';
                } else if (msg.type === 'text') {
                    targetContainer = msgElement.querySelector('.content-text').parentElement;
                    originalText = msg.content;
                } else {
                    return;
                }
                if (!targetContainer) {
                    alert("此项目没有可编辑的文本。");
                    cancelCurrentEdit();
                    return;
                }

                bubble.classList.add('editing');

                const editContainer = document.createElement('div');
                editContainer.className = 'inline-edit-container';

                const textarea = document.createElement('textarea');
                textarea.className = 'inline-edit-textarea';
                textarea.value = originalText.replace(/<br>/g, '\n');

                const autoResizeTextarea = () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                };
                textarea.addEventListener('input', autoResizeTextarea);

                const actions = document.createElement('div');
                actions.className = 'inline-edit-actions';

                const saveBtn = document.createElement('button');
                saveBtn.innerHTML = '✓';
                saveBtn.className = 'save';

                const cancelBtn = document.createElement('button');
                cancelBtn.innerHTML = '×';
                cancelBtn.className = 'cancel';

                actions.append(saveBtn, cancelBtn);
                editContainer.append(textarea, actions);
                targetContainer.append(editContainer);

                autoResizeTextarea();
                textarea.focus();
                textarea.select();

                cancelBtn.onclick = (e) => { e.stopPropagation(); cancelCurrentEdit(); renderChatMessages(false); };

                saveBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const newText = textarea.value.trim();

                    if (msg.type === 'transaction') {
                        const trans = state.transactions.find(t => t.id === msg.relatedId);
                        if (trans) trans.remark = newText;
                        await db.transactions.update(msg.relatedId, { remark: newText });
                        if (document.getElementById('ledger-screen').classList.contains('active')) renderLedger();
                    } else if (msg.type === 'schedule') {
                        const schedule = state.schedules.find(s => s.id === msg.relatedId);
                        if (schedule) schedule.description = newText;
                        await db.schedules.update(msg.relatedId, { description: newText });
                        if (document.getElementById('schedule-screen').classList.contains('active')) renderSchedules();
                    } else if (msg.type === 'text') {
                        state.messages[msgIndex].content = newText;
                        await db.messages.update(msgId, { content: newText });
                    }

                    state.currentlyEditingMsgId = null;
                    renderChatMessages(false);
                };
            }

            async function deleteMessage(msgId) {
                if (!confirm('确定要删除这条消息吗？')) return;
                const msg = state.messages.find(m => m.id === msgId);
                if (!msg) return;
                if (msg.type === 'transaction' && msg.relatedId) {
                    await db.transactions.delete(msg.relatedId);
                    state.transactions = state.transactions.filter(t => t.id !== msg.relatedId);
                    renderLedger();
                } else if (msg.type === 'schedule' && msg.relatedId) {
                    await db.schedules.delete(msg.relatedId);
                    state.schedules = state.schedules.filter(s => s.id !== msg.relatedId);
                    renderSchedules();
                }
                await db.messages.delete(msgId);
                state.messages = state.messages.filter(m => m.id !== msgId);
                renderChatMessages(false);
            }
            async function copyMessage(msgId) {
                const msg = state.messages.find(m => m.id === msgId);
                if (!msg) return;

                let textToCopy = '';
                if (msg.type === 'text') {
                    textToCopy = msg.content;
                } else if (msg.type === 'transaction') {
                    textToCopy = state.transactions.find(t => t.id === msg.relatedId)?.remark || '';
                } else if (msg.type === 'schedule') {
                    textToCopy = state.schedules.find(s => s.id === msg.relatedId)?.description || '';
                }

                if (textToCopy && navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        alert('已复制！');
                    } catch (err) {
                        console.error('无法复制文本: ', err);
                        alert('复制失败！');
                    }
                }
            }

            function enterSelectionMode() { cancelCurrentEdit(); state.isSelectionMode = true; document.getElementById('accounting-screen').classList.add('selection-mode-active'); }
            function exitSelectionMode() { state.isSelectionMode = false; document.getElementById('accounting-screen').classList.remove('selection-mode-active'); state.selectedMessages.forEach(id => { document.querySelector(`.message-wrapper[data-id="${id}"]`)?.classList.remove('selected'); }); state.selectedMessages.clear(); }
            function toggleMessageSelection(msgId) { const wrapper = document.querySelector(`.message-wrapper[data-id="${msgId}"]`); if (state.selectedMessages.has(msgId)) { state.selectedMessages.delete(msgId); wrapper?.classList.remove('selected'); } else { state.selectedMessages.add(msgId); wrapper?.classList.add('selected'); } }
            async function deleteSelectedMessages() {
                const count = state.selectedMessages.size;
                if (count === 0) return;
                if (!confirm(`确定要删除选中的 ${count} 条消息吗？`)) return;

                const msgIdsToDelete = Array.from(state.selectedMessages);
                const transIdsToDelete = [];
                const scheduleIdsToDelete = [];

                for (const msgId of msgIdsToDelete) {
                    const msg = state.messages.find(m => m.id === msgId);
                    if (msg) {
                        if (msg.type === 'transaction' && msg.relatedId) transIdsToDelete.push(msg.relatedId);
                        if (msg.type === 'schedule' && msg.relatedId) scheduleIdsToDelete.push(msg.relatedId);
                    }
                }

                if (transIdsToDelete.length > 0) await db.transactions.bulkDelete(transIdsToDelete);
                if (scheduleIdsToDelete.length > 0) await db.schedules.bulkDelete(scheduleIdsToDelete);
                await db.messages.bulkDelete(msgIdsToDelete);

                state.transactions = state.transactions.filter(t => !transIdsToDelete.includes(t.id));
                state.schedules = state.schedules.filter(s => !scheduleIdsToDelete.includes(s.id));
                state.messages = state.messages.filter(m => !msgIdsToDelete.includes(m.id));

                exitSelectionMode();
                renderChatMessages(false);
                renderLedger();
                renderSchedules();
            }

            // --- Transaction Panel Logic ---
            function showTransactionPanel(id = null) {
                state.currentlyEditingTransactionId = id;
                const remarkInput = document.getElementById('transaction-remark-input');
                const actionsContainer = document.getElementById('numpad-actions');

                // Remove existing delete button if any
                const existingDeleteBtn = document.getElementById('delete-transaction-btn');
                if (existingDeleteBtn) existingDeleteBtn.remove();

                if (id) {
                    const t = state.transactions.find(t => t.id === id);
                    if (!t) { resetTransactionState(); return; }
                    state.currentTransaction = {
                        type: t.type,
                        category: t.category,
                        amountStr: String(t.amount),
                        currency: t.currency
                    };
                    document.getElementById('transaction-panel-title').textContent = '编辑记账';
                    remarkInput.value = t.remark || '';

                    // Add delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.id = 'delete-transaction-btn';
                    deleteBtn.className = 'delete-transaction';
                    deleteBtn.textContent = '删除';
                    deleteBtn.onclick = async () => {
                        if (confirm('确定要删除这条记账及其聊天记录吗？')) {
                            const msg = state.messages.find(m => m.relatedId === id && m.type === 'transaction');
                            await db.transactions.delete(id);
                            state.transactions = state.transactions.filter(t => t.id !== id);
                            if (msg) {
                                await db.messages.delete(msg.id);
                                state.messages = state.messages.filter(m => m.id !== msg.id);
                            }
                            hideTransactionPanel();
                            renderLedger();
                            renderChatMessages(false);
                        }
                    };
                    actionsContainer.appendChild(deleteBtn);

                } else {
                    resetTransactionState();
                    document.getElementById('transaction-panel-title').textContent = '新建记账';
                    remarkInput.value = '';
                }

                document.getElementById('currency-selector').textContent = state.currentTransaction.currency;
                updateAmountDisplay();
                switchTransactionType(state.currentTransaction.type, state.currentTransaction.category);

                ELS.transactionPanel.classList.add('visible');
                ELS.app.style.overflow = 'hidden';
            }

            function hideTransactionPanel() {
                ELS.transactionPanel.classList.remove('visible');
                ELS.app.style.overflow = 'initial';
                state.currentlyEditingTransactionId = null;
            }

            function switchTransactionType(type, preselectedCategory = null) {
                state.currentTransaction.type = type;
                document.getElementById('type-expense-btn').classList.toggle('active', type === 'expense');
                document.getElementById('type-income-btn').classList.toggle('active', type === 'income');
                renderCategories(preselectedCategory);
            }

            function renderCategories(preselectedCategory = null) {
                ELS.categorySelector.innerHTML = '';
                const cats = CATEGORIES[state.currentTransaction.type];
                cats.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.dataset.id = cat.id;
                    item.innerHTML = `<div class="icon">${cat.icon}</div><div class="name">${cat.name}</div>`;
                    item.addEventListener('click', () => selectCategory(cat.id));
                    ELS.categorySelector.appendChild(item);
                });
                if (preselectedCategory && cats.some(c => c.id === preselectedCategory)) {
                    selectCategory(preselectedCategory);
                } else if (cats.length > 0) {
                    selectCategory(cats[0].id);
                }
            }

            function selectCategory(catId) { state.currentTransaction.category = catId; document.querySelectorAll('.category-item').forEach(item => item.classList.toggle('selected', item.dataset.id === catId)); }
            function handleNumpad(e) { const key = e.target.dataset.key; if (!key) return; let amount = state.currentTransaction.amountStr; if (key === '.') { if (!amount.includes('.')) amount += '.'; } else { if (amount === '0') amount = key; else if (amount.includes('.') && amount.split('.')[1].length >= 2) return; else amount += key; } state.currentTransaction.amountStr = amount; updateAmountDisplay(); }
            function handleNumpadDelete() { let amount = state.currentTransaction.amountStr; amount = amount.slice(0, -1); if (amount === '') amount = '0'; state.currentTransaction.amountStr = amount; updateAmountDisplay(); }
            function toggleCurrency() { const currencies = ['RMB', ...state.currencies.map(c => c.code)]; const currentIndex = currencies.indexOf(state.currentTransaction.currency); const nextIndex = (currentIndex + 1) % currencies.length; const newCurrency = currencies[nextIndex]; state.currentTransaction.currency = newCurrency; document.getElementById('currency-selector').textContent = newCurrency; if (!state.currentlyEditingTransactionId) localStorage.setItem('lastSelectedCurrency', newCurrency); }
            function updateAmountDisplay() { ELS.amountDisplay.textContent = state.currentTransaction.amountStr; }

            async function confirmTransaction() {
                const amount = parseFloat(state.currentTransaction.amountStr);
                if (amount <= 0) { alert('金额必须大于0'); return; }

                const remark = document.getElementById('transaction-remark-input').value.trim();

                if (state.currentlyEditingTransactionId) {
                    const transIndex = state.transactions.findIndex(t => t.id === state.currentlyEditingTransactionId);
                    if (transIndex > -1) {
                        const originalTransaction = state.transactions[transIndex];
                        const updatedTransaction = {
                            ...originalTransaction,
                            type: state.currentTransaction.type,
                            category: state.currentTransaction.category,
                            amount: amount,
                            currency: state.currentTransaction.currency,
                            remark: remark
                        };
                        await db.transactions.put(updatedTransaction);
                        state.transactions[transIndex] = updatedTransaction;

                        hideTransactionPanel();
                        renderLedger();
                        renderChatMessages(false);
                    }
                } else {
                    const newTransaction = {
                        timestamp: Date.now(),
                        type: state.currentTransaction.type,
                        category: state.currentTransaction.category,
                        amount: amount,
                        currency: state.currentTransaction.currency,
                        remark: remark
                    };
                    const transId = await db.transactions.add(newTransaction);
                    const msgId = await db.messages.add({
                        timestamp: newTransaction.timestamp,
                        role: 'user',
                        content: ``,
                        type: 'transaction',
                        relatedId: transId
                    });
                    state.transactions.push({ ...newTransaction, id: transId });
                    state.messages.push({ id: msgId, timestamp: newTransaction.timestamp, role: 'user', type: 'transaction', relatedId: transId });

                    hideTransactionPanel();
                    resetTransactionState();
                    renderChatMessages();
                }
            }

            function resetTransactionState() {
                const lastCurrency = localStorage.getItem('lastSelectedCurrency') || 'RMB';
                state.currentTransaction = { type: 'expense', category: null, amountStr: '0', currency: lastCurrency };
                updateAmountDisplay();
                document.getElementById('currency-selector').textContent = lastCurrency;
                document.getElementById('transaction-remark-input').value = '';
            }

            // --- Schedule & Calendar Logic (NEW & UPDATED) ---
            function setupSchedulePanelListeners() {
                document.getElementById('schedule-type-once').addEventListener('click', () => setScheduleType('once'));
                document.getElementById('schedule-type-long').addEventListener('click', () => setScheduleType('long'));
                setupImportanceStars();
                document.getElementById('confirm-schedule-btn').addEventListener('click', confirmSchedule);
                document.getElementById('cancel-schedule-btn').addEventListener('click', hideSchedulePanel);
                document.getElementById('deadline-display-text').addEventListener('click', () => { state.calendarState.mode = 'deadline'; showCalendarModal(); });
                document.getElementById('end-date-display-text').addEventListener('click', () => { state.calendarState.mode = 'endDate'; showCalendarModal(); });

                document.getElementById('recurrence-options').addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (btn) {
                        document.querySelectorAll('#recurrence-options button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderRecurrenceDaySelector(btn.dataset.type);
                    }
                });
            }
            function setupCalendarModalListeners() {
                document.getElementById('close-calendar-btn').addEventListener('click', () => document.getElementById('calendar-modal').classList.remove('visible'));
                document.getElementById('prev-month-btn').addEventListener('click', () => {
                    state.calendarState.month--;
                    if (state.calendarState.month < 0) {
                        state.calendarState.month = 11;
                        state.calendarState.year--;
                    }
                    renderCalendar(state.calendarState.year, state.calendarState.month);
                });
                document.getElementById('next-month-btn').addEventListener('click', () => {
                    state.calendarState.month++;
                    if (state.calendarState.month > 11) {
                        state.calendarState.month = 0;
                        state.calendarState.year++;
                    }
                    renderCalendar(state.calendarState.year, state.calendarState.month);
                });
                document.getElementById('calendar-grid').addEventListener('click', (e) => {
                    const dayEl = e.target.closest('.calendar-day');
                    if (dayEl && !dayEl.classList.contains('other-month')) {
                        const selectedDate = new Date(state.calendarState.year, state.calendarState.month, parseInt(dayEl.textContent));
                        if (state.calendarState.mode === 'deadline') {
                            state.currentSchedule.deadlineDate = selectedDate;
                            updateDeadlineDisplay();
                        } else if (state.calendarState.mode === 'endDate') {
                            state.currentSchedule.endDate = selectedDate;
                            updateEndDateDisplay();
                        }
                        document.getElementById('calendar-modal').classList.remove('visible');
                    }
                });
                document.getElementById('clear-date-btn').addEventListener('click', () => {
                    if (state.calendarState.mode === 'deadline') {
                        state.currentSchedule.deadlineDate = null;
                        updateDeadlineDisplay();
                    } else if (state.calendarState.mode === 'endDate') {
                        state.currentSchedule.endDate = null;
                        updateEndDateDisplay();
                    }
                    document.getElementById('calendar-modal').classList.remove('visible');
                });
            }
            function showSchedulePanel(id = null) {
                const titleEl = document.getElementById('schedule-panel-title');
                titleEl.textContent = id ? '编辑日程' : '新建日程';
                resetScheduleState(id);
                ELS.schedulePanel.classList.add('visible');
                ELS.app.style.overflow = 'hidden';
            }
            function hideSchedulePanel() { ELS.schedulePanel.classList.remove('visible'); ELS.app.style.overflow = 'initial'; state.currentlyEditingScheduleId = null; }

            function setScheduleType(type) {
                const isLong = type === 'long';
                document.getElementById('schedule-type-once').classList.toggle('active', !isLong);
                document.getElementById('schedule-type-long').classList.toggle('active', isLong);
                document.getElementById('recurrence-section').style.display = isLong ? 'block' : 'none';
                document.getElementById('end-date-section').style.display = isLong ? 'block' : 'none';
                document.getElementById('deadline-label').textContent = isLong ? '开始日期' : '截止日期';
            }

            function renderRecurrenceDaySelector(type) {
                const container = document.getElementById('recurrence-selector-days');
                container.innerHTML = '';
                let options = [];
                if (type === 'weekly') {
                    options = ['日', '一', '二', '三', '四', '五', '六'].map((day, i) => ({ value: i, text: `周${day}` }));
                } else if (type === 'monthly') {
                    for (let i = 1; i <= 31; i++) options.push({ value: i, text: `${i}日` });
                    options.push({ value: 'last', text: '最后一天' });
                }
                options.forEach(opt => {
                    container.innerHTML += `<label><input type="checkbox" name="recurrence-day" value="${opt.value}"> ${opt.text}</label>`;
                });
            }

            function setupImportanceStars() {
                document.getElementById('importance-stars').addEventListener('click', (e) => {
                    const starEl = e.target.closest('.star');
                    if (!starEl) return;
                    const score = parseFloat(document.getElementById('importance-score').textContent);
                    const starIndex = Array.from(starEl.parentElement.children).indexOf(starEl);
                    const baseScore = starIndex * 2;
                    if (score === baseScore + 2) {
                        updateStarsDisplay(baseScore + 1);
                    } else {
                        updateStarsDisplay(baseScore + 2);
                    }
                });
            }
            function updateStarsDisplay(score) {
                document.getElementById('importance-score').textContent = score.toFixed(1);
                const stars = document.querySelectorAll('#importance-stars .star');
                const halfScore = score / 2;
                stars.forEach((star, index) => {
                    star.classList.remove('filled', 'half');
                    if (halfScore >= index + 1) {
                        star.classList.add('filled');
                    } else if (halfScore > index) {
                        star.classList.add('half');
                    }
                });
            }
            function resetScheduleState(id = null) {
                state.currentlyEditingScheduleId = id;
                let schedule = { eventType: 'once', title: '', description: '', importance: 0, deadline: null, completed: false, recurrence: null, endDate: null, completedDates: [] };
                if (id) {
                    const existing = state.schedules.find(s => s.id === id);
                    if (existing) schedule = JSON.parse(JSON.stringify(existing));
                }

                state.currentSchedule.deadlineDate = schedule.deadline ? new Date(schedule.deadline.year, schedule.deadline.month - 1, schedule.deadline.day) : null;
                state.currentSchedule.endDate = schedule.endDate ? new Date(schedule.endDate) : null;

                setScheduleType(schedule.eventType);
                if (schedule.recurrence) {
                    const btn = document.querySelector(`#recurrence-options button[data-type="${schedule.recurrence.type}"]`);
                    if (btn) btn.click();
                    setTimeout(() => {
                        if (schedule.recurrence.days) {
                            schedule.recurrence.days.forEach(day => {
                                const cb = document.querySelector(`input[name="recurrence-day"][value="${day}"]`);
                                if (cb) cb.checked = true;
                            });
                        }
                    }, 0);
                }

                document.getElementById('schedule-title-input').value = schedule.title;
                updateStarsDisplay(schedule.importance);
                updateDeadlineDisplay();
                updateEndDateDisplay();
                document.getElementById('deadline-hour-input').value = schedule.deadline?.hour ?? '';
                document.getElementById('deadline-minute-input').value = schedule.deadline?.minute ?? '';
                document.getElementById('schedule-description-input').value = schedule.description;
            }
            async function confirmSchedule() {
                const title = document.getElementById('schedule-title-input').value.trim();
                if (!title) { alert('请输入日程标题！'); return; }

                const hourVal = document.getElementById('deadline-hour-input').value;
                const minuteVal = document.getElementById('deadline-minute-input').value;
                const hour = (hourVal !== '' && !isNaN(parseInt(hourVal))) ? parseInt(hourVal) : null;
                const minute = (minuteVal !== '' && !isNaN(parseInt(minuteVal))) ? parseInt(minuteVal) : null;

                const deadline = state.currentSchedule.deadlineDate ? {
                    year: state.currentSchedule.deadlineDate.getFullYear(),
                    month: state.currentSchedule.deadlineDate.getMonth() + 1,
                    day: state.currentSchedule.deadlineDate.getDate(),
                    hour: (hour >= 0 && hour <= 23) ? hour : null,
                    minute: (minute >= 0 && minute <= 59) ? minute : null,
                } : null;

                const isLongTerm = document.getElementById('schedule-type-long').classList.contains('active');
                let recurrence = null;
                if (isLongTerm) {
                    const activeBtn = document.querySelector('#recurrence-options button.active');
                    if (activeBtn) {
                        const type = activeBtn.dataset.type;
                        let days = [];
                        if (type === 'daily') {
                            recurrence = { type: 'daily' };
                        } else {
                            document.querySelectorAll('input[name="recurrence-day"]:checked').forEach(cb => {
                                days.push(isNaN(parseInt(cb.value)) ? cb.value : parseInt(cb.value));
                            });
                            if (days.length > 0) recurrence = { type, days };
                        }
                    }
                }

                const scheduleData = {
                    timestamp: Date.now(),
                    eventType: isLongTerm ? 'long' : 'once',
                    title: title,
                    importance: parseFloat(document.getElementById('importance-score').textContent),
                    deadline: deadline,
                    description: document.getElementById('schedule-description-input').value.trim(),
                    completed: false,
                    recurrence: recurrence,
                    endDate: state.currentSchedule.endDate ? state.currentSchedule.endDate.toISOString() : null,
                    completedDates: [],
                };

                if (state.currentlyEditingScheduleId) {
                    const existing = state.schedules.find(s => s.id === state.currentlyEditingScheduleId);
                    scheduleData.id = state.currentlyEditingScheduleId;
                    scheduleData.completed = existing.completed;
                    scheduleData.timestamp = existing.timestamp;
                    scheduleData.completedDates = existing.completedDates || [];
                    await db.schedules.put(scheduleData);
                    const index = state.schedules.findIndex(s => s.id === scheduleData.id);
                    state.schedules[index] = scheduleData;
                } else {
                    const id = await db.schedules.add(scheduleData);
                    scheduleData.id = id;
                    state.schedules.push(scheduleData);
                    const msgId = await db.messages.add({ timestamp: scheduleData.timestamp, role: 'user', content: ``, type: 'schedule', relatedId: id });
                    state.messages.push({ id: msgId, timestamp: scheduleData.timestamp, role: 'user', type: 'schedule', relatedId: id });
                }

                hideSchedulePanel();
                renderSchedules();
                renderChatMessages();
            }
            function classifySchedule(schedule) {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const threeDaysLater = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
                let isUrgent = false;

                if (schedule.eventType !== 'long' && schedule.deadline) {
                    const deadlineDate = new Date(schedule.deadline.year, schedule.deadline.month - 1, schedule.deadline.day);
                    if (deadlineDate <= threeDaysLater) isUrgent = true;
                }

                const isImportant = schedule.importance >= 7;
                if (isImportant && isUrgent) return 1;
                if (isImportant && !isUrgent) return 2;
                if (!isImportant && isUrgent) return 3;
                return 4;
            }

            // --- NEW: Schedule Page Rendering ---
            function updateSchedulePage() {
                const wrapper = document.querySelector('.schedule-pages-wrapper');
                const dots = document.querySelectorAll('.schedule-page-dots .dot');
                const titles = ['今日待办', '所有日程', '日历视图'];

                wrapper.style.transform = `translateX(-${state.schedulePageIndex * 33.333}%)`;
                dots.forEach((dot, i) => dot.classList.toggle('active', i === state.schedulePageIndex));
                document.getElementById('schedule-page-title').textContent = titles[state.schedulePageIndex];
            }

            function renderSchedules() {
                renderTodayTasks();
                renderQuadrantView();
                renderCalendarView();

                let completedCount = state.schedules.filter(s => s.eventType === 'once' && s.completed).length;
                state.schedules.forEach(s => {
                    if (s.eventType === 'long' && Array.isArray(s.completedDates)) {
                        completedCount += s.completedDates.length;
                    }
                });
                document.getElementById('schedule-count').textContent = `已完成${completedCount}项事件🌟`;
            }

            function renderTodayTasks() {
                const container = document.getElementById('today-tasks-content');
                container.innerHTML = ''; // 这一行保持不变，用于清空
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const todayIncomplete = [];
                const todayCompleted = [];

                // 这部分筛选逻辑保持不变
                state.schedules.forEach(s => {
                    let isTodayTask = false;
                    if (s.eventType === 'once') {
                        if (s.deadline) {
                            const deadlineDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            if (deadlineDate.getTime() === today.getTime()) isTodayTask = true;
                        }
                    } else if (s.eventType === 'long' && s.recurrence) {
                        if (s.endDate && new Date(s.endDate) < today) return;
                        if (s.deadline) {
                            const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            if (startDate > today) return;
                        }

                        const dayOfWeek = today.getDay();
                        const dayOfMonth = today.getDate();

                        switch (s.recurrence.type) {
                            case 'daily': isTodayTask = true; break;
                            case 'weekly': isTodayTask = s.recurrence.days.includes(dayOfWeek); break;
                            case 'monthly':
                                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                                if (s.recurrence.days.includes('last') && dayOfMonth === daysInMonth) isTodayTask = true;
                                else isTodayTask = s.recurrence.days.includes(dayOfMonth);
                                break;
                        }
                    }

                    if (isTodayTask) {
                        let isCompleted = (s.eventType === 'once') ? s.completed : (s.completedDates && s.completedDates.includes(todayStr));
                        if (isCompleted) todayCompleted.push(s);
                        else todayIncomplete.push(s);
                    }
                });

                todayIncomplete.sort((a, b) => b.importance - a.importance);
                todayCompleted.sort((a, b) => b.timestamp - a.timestamp);

                // --- 这是唯一的修改之处 ---
                if (todayIncomplete.length > 0) {
                    // 【修复】不再使用 innerHTML +=，而是使用 appendChild
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'schedule-section-title';
                    titleDiv.textContent = '待完成';
                    container.appendChild(titleDiv);

                    todayIncomplete.forEach(s => container.appendChild(createTodayTaskItem(s, todayStr)));
                }

                if (todayCompleted.length > 0) {
                    // 【修复】不再使用 innerHTML +=，而是使用 appendChild
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'schedule-section-title';
                    titleDiv.textContent = '已完成';
                    if (todayIncomplete.length > 0) {
                        titleDiv.style.marginTop = '20px';
                    }
                    container.appendChild(titleDiv);

                    todayCompleted.forEach(s => container.appendChild(createTodayTaskItem(s, todayStr)));
                }
                // --- 修改结束 ---

                if (todayIncomplete.length === 0 && todayCompleted.length === 0) {
                    container.innerHTML = '<div class="empty-state">今天没有待办事项，轻松一下吧！</div>';
                }
            }

            function createTodayTaskItem(s, todayStr) {
                const item = document.createElement('div');
                item.className = 'today-task-item';
                if (s.importance >= 7) item.classList.add('important');

                let isCompleted = (s.eventType === 'once') ? s.completed : (s.completedDates && s.completedDates.includes(todayStr));
                if (isCompleted) item.classList.add('completed');

                item.innerHTML = `<div class="title">${s.title}</div><div class="checkbox"></div>`;
                item.querySelector('.checkbox').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (s.eventType === 'once') {
                        s.completed = !s.completed;
                        await db.schedules.update(s.id, { completed: s.completed });
                    } else if (s.eventType === 'long') {
                        if (!s.completedDates) s.completedDates = [];
                        if (isCompleted) {
                            s.completedDates = s.completedDates.filter(d => d !== todayStr);
                        } else {
                            s.completedDates.push(todayStr);
                        }
                        await db.schedules.update(s.id, { completedDates: s.completedDates });
                    }
                    renderSchedules();
                    renderChatMessages(false);
                });
                item.addEventListener('click', () => showScheduleDetailModal(s.id));
                return item;
            }

            function renderQuadrantView() {
                const quadrants = { 1: [], 2: [], 3: [], 4: [] };
                const completedOnce = [];
                const completedLong = [];

                state.schedules.forEach(s => {
                    // 这个分类逻辑保持不变
                    if (s.eventType === 'once') {
                        if (s.completed) {
                            completedOnce.push(s);
                        } else {
                            quadrants[classifySchedule(s)].push(s);
                        }
                    } else if (s.eventType === 'long' && s.completedDates && s.completedDates.length > 0) {
                        completedLong.push(s);
                    }
                });

                for (let i = 1; i <= 4; i++) {
                    const container = document.getElementById(`quadrant-${i}-items`);
                    container.innerHTML = '';

                    if (quadrants[i].length > 0) {
                        // --- 这里是修改的核心 ---
                        quadrants[i].sort((a, b) => {
                            // 1. 按重要性降序排列 (值越大越靠前)
                            const importanceDiff = b.importance - a.importance;
                            if (importanceDiff !== 0) {
                                return importanceDiff;
                            }

                            // 2. 如果重要性相同，则按截止日期升序排列 (日期越早越靠前)
                            // 将 deadline 对象转换为时间戳，没有 deadline 的视为无穷大，排在最后
                            const aDdlTime = a.deadline ? new Date(a.deadline.year, a.deadline.month - 1, a.deadline.day, a.deadline.hour || 0, a.deadline.minute || 0).getTime() : Infinity;
                            const bDdlTime = b.deadline ? new Date(b.deadline.year, b.deadline.month - 1, b.deadline.day, b.deadline.hour || 0, b.deadline.minute || 0).getTime() : Infinity;

                            return aDdlTime - bDdlTime;

                        }).forEach(s => container.appendChild(createScheduleItemElement(s)));
                    } else {
                        container.innerHTML = `<div class="empty-state">无</div>`;
                    }
                }

                // 下面的已完成部分逻辑保持不变
                const completedContainer = document.getElementById('completed-items');
                completedContainer.innerHTML = '';

                completedOnce.sort((a, b) => b.timestamp - a.timestamp);
                completedLong.sort((a, b) => b.timestamp - a.timestamp);

                const allCompleted = [...completedOnce, ...completedLong];

                if (allCompleted.length > 0) {
                    allCompleted.forEach(s => completedContainer.appendChild(createScheduleItemElement(s)));
                } else {
                    completedContainer.innerHTML = `<div class="empty-state">还没有已完成的日程</div>`;
                }
            }

            function renderCalendarView() {
                const now = new Date();
                renderMonthCalendarForView(now.getFullYear(), now.getMonth());
                document.getElementById('calendar-event-list').innerHTML = ''; // Clear event list on initial render
            }

            function renderMonthCalendarForView(year, month) {
                const container = document.getElementById('month-calendar-view');
                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const eventsByDate = {};

                for (let day = 1; day <= daysInMonth; day++) {
                    const checkDate = new Date(year, month, day);
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    eventsByDate[dateStr] = [];

                    state.schedules.forEach(s => {
                        let isTaskForThisDay = false;
                        if (s.eventType === 'once' && s.deadline) {
                            const deadlineDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                            if (deadlineDate.getTime() === checkDate.getTime()) isTaskForThisDay = true;
                        } else if (s.eventType === 'long' && s.recurrence) {
                            if (s.endDate && new Date(s.endDate) < checkDate) return;
                            if (s.deadline) {
                                const startDate = new Date(s.deadline.year, s.deadline.month - 1, s.deadline.day);
                                if (startDate > checkDate) return;
                            }

                            if (s.recurrence.type === 'daily') isTaskForThisDay = true;
                            else if (s.recurrence.type === 'weekly') isTaskForThisDay = s.recurrence.days.includes(checkDate.getDay());
                            else if (s.recurrence.type === 'monthly') {
                                if (s.recurrence.days.includes('last') && day === daysInMonth) isTaskForThisDay = true;
                                else isTaskForThisDay = s.recurrence.days.includes(day);
                            }
                        }
                        if (isTaskForThisDay) eventsByDate[dateStr].push(s);
                    });
                }

                const header = `<div class="calendar-header"><span class="calendar-month-year">${year}年 ${month + 1}月</span></div><div class="calendar-weekdays"><span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span></div>`;
                const firstDay = new Date(year, month, 1).getDay();

                for (let i = 0; i < firstDay; i++) { grid.insertAdjacentHTML('beforeend', `<div></div>`); }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

                    if (eventsByDate[dateStr] && eventsByDate[dateStr].length > 0) {
                        const hasImportant = eventsByDate[dateStr].some(s => s.importance >= 7);
                        const dot = document.createElement('div');
                        dot.className = `event-dot ${hasImportant ? 'important' : 'normal'}`;
                        dayEl.appendChild(dot);
                    }

                    if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        dayEl.classList.add('today');
                    }
                    dayEl.addEventListener('click', () => renderEventsForDate(dateStr, eventsByDate[dateStr]));
                    grid.appendChild(dayEl);
                }
                container.innerHTML = header;
                container.appendChild(grid);
            }

            function renderEventsForDate(dateStr, events) {
                const listContainer = document.getElementById('calendar-event-list');
                listContainer.innerHTML = ''; // 清空

                // --- 事件显示部分 (和原来一样) ---
                const parts = dateStr.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                const formattedDate = `${year}年${month}月${day}日`;

                const titleDiv = document.createElement('div');
                titleDiv.className = 'schedule-section-title';
                titleDiv.textContent = `${formattedDate} 的事件`;
                listContainer.appendChild(titleDiv);

                if (!events || events.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-state';
                    emptyDiv.textContent = '当天没有事件';
                    listContainer.appendChild(emptyDiv);
                } else {
                    events.sort((a, b) => b.importance - a.importance).forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'event-item';
                        let timeStr = '';
                        if (s.deadline && s.deadline.hour !== null && s.deadline.minute !== null) {
                            timeStr = `${String(s.deadline.hour).padStart(2, '0')}:${String(s.deadline.minute).padStart(2, '0')}`;
                        }
                        item.innerHTML = `<div class="event-title">${s.title}</div><div class="event-time">${timeStr}</div>`;
                        listContainer.appendChild(item);
                    });
                }

                // --- 新增：日记功能区 ---
                const hr = document.createElement('hr'); // 添加一条分割线
                hr.style.cssText = "border: none; border-top: 1px solid var(--border-color); margin: 20px 0;";
                listContainer.appendChild(hr);

                const diaryContainer = document.createElement('div');
                diaryContainer.id = 'diary-section-container';
                listContainer.appendChild(diaryContainer);

                // 更新 state 中的当前日期
                state.currentDiaryDate = new Date(year, month - 1, day);

                // 调用辅助函数来渲染日记UI
                renderDiarySection(diaryContainer, state.currentDiaryDate);
            }

            // 辅助函数1：渲染整个日记区域
            function renderDiarySection(container, date) {
                const dateStr = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;

                // 创建日记区域的 HTML 结构
                container.innerHTML = `
        <div class="schedule-section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>${dateStr} 的日记</span>
            <button id="edit-diary-prompt-btn-inline" style="padding: 4px 8px; font-size: 12px; border-radius: 6px; background: var(--bg-soft); border: none; cursor: pointer;">编辑提示词</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
            <label style="flex-shrink: 0;">角色：</label>
            <select id="diary-char-select-inline" style="flex-grow: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary);"></select>
        </div>
        <div id="diary-content-area-inline">
            <!-- 日记内容或生成按钮会在这里动态添加 -->
        </div>
    `;

                // 填充角色选择器
                const charSelect = container.querySelector('#diary-char-select-inline');
                if (state.characters.length > 0) {
                    state.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        charSelect.appendChild(option);
                    });
                    // 默认选中当前角色或第一个角色
                    if (state.currentDiaryCharId && state.characters.some(c => c.id === state.currentDiaryCharId)) {
                        charSelect.value = state.currentDiaryCharId;
                    } else {
                        state.currentDiaryCharId = state.characters[0].id;
                        charSelect.value = state.currentDiaryCharId;
                    }
                }

                // --- 绑定事件监听 ---

                // 1. 绑定角色选择器的切换事件
                charSelect.addEventListener('change', (e) => {
                    state.currentDiaryCharId = parseInt(e.target.value);
                    updateDiaryContentArea(date); // 切换角色后更新日记内容
                });

                // 2. 绑定“编辑提示词”按钮的点击事件
                container.querySelector('#edit-diary-prompt-btn-inline').addEventListener('click', () => {
                    // 每次点击时，都从 state.config中读取最新的提示词
                    document.getElementById('diary-system-prompt').value = state.config.diaryPrompt;

                    // 弹出编辑模态框
                    document.getElementById('diary-prompt-modal').classList.add('visible');
                });

                // 初始加载日记内容
                updateDiaryContentArea(date);
            }


            // 辅助函数2：更新日记内容区域（显示日记、生成按钮或加载中）
            async function updateDiaryContentArea(date) {
                const contentArea = document.getElementById('diary-content-area-inline');
                if (!contentArea) return;

                const dateStrForDB = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const diary = state.diaries.find(d => d.date === dateStrForDB && d.charId === state.currentDiaryCharId);
                const character = state.characters.find(c => c.id === state.currentDiaryCharId);

                if (diary) {
                    // 如果有日记，显示日记内容和删除按钮
                    contentArea.innerHTML = `
            <div id="diary-text-inline" style="background: var(--bg-soft); border-radius: 12px; padding: 20px; white-space: pre-wrap; line-height: 1.8; font-size: 15px; max-height: 400px; overflow-y: auto;"></div>
            <button id="delete-diary-btn-inline" class="form-button" style="margin-top: 15px; background-color: var(--expense-color);">删除日记</button>
        `;
                    contentArea.querySelector('#diary-text-inline').textContent = diary.content;
                    contentArea.querySelector('#delete-diary-btn-inline').addEventListener('click', deleteDiary);
                } else {
                    // 如果没有日记，显示生成按钮
                    const btnText = character ? `📔 生成${character.name}的日记` : '📔 生成日记';
                    contentArea.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <p>暂无日记</p>
                <button id="generate-diary-btn-inline" class="form-button" style="margin-top: 10px;">${btnText}</button>
            </div>
        `;
                    contentArea.querySelector('#generate-diary-btn-inline').addEventListener('click', async () => {
                        // 显示加载动画
                        contentArea.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; padding: 40px; flex-direction: column;">
                    <div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>
                    <p style="margin-top: 15px; color: var(--text-secondary);">正在生成日记...</p>
                </div>
            `;
                        await generateDiary(); // 调用生成日记的函数
                        updateDiaryContentArea(date); // 生成后再次更新界面
                    });
                }
            }

            function createScheduleItemElement(schedule) {
                const item = document.createElement('div');
                item.className = 'schedule-item';

                let isCompleted = schedule.completed;
                if (schedule.eventType === 'long') {
                    isCompleted = false; // In "All Schedules" view, long-term tasks are not shown as completable
                }
                if (isCompleted) item.classList.add('completed');

                item.dataset.id = schedule.id;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'schedule-item-details';
                detailsDiv.innerHTML = `<div class="title">${schedule.title}</div>`;

                if (schedule.deadline) {
                    const ddl = document.createElement('div');
                    ddl.className = 'ddl';
                    const label = schedule.eventType === 'long' ? '开始' : 'DDL';
                    ddl.textContent = `${label}: ${formatDeadline(schedule.deadline)}`;
                    detailsDiv.appendChild(ddl);
                }

                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox';
                if (schedule.eventType === 'long') {
                    checkbox.style.display = 'none'; // Don't show checkbox for long term in this view
                }

                item.appendChild(detailsDiv);
                item.appendChild(checkbox);

                checkbox.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (schedule.eventType === 'once') {
                        schedule.completed = !schedule.completed;
                        await db.schedules.update(schedule.id, { completed: schedule.completed });
                        renderSchedules();
                        renderChatMessages(false);
                    }
                });
                item.addEventListener('click', () => showScheduleDetailModal(schedule.id));
                return item;
            }
            function showScheduleDetailModal(id) {
                const schedule = state.schedules.find(s => s.id === id);
                if (!schedule) return;
                state.currentlyEditingScheduleId = id;
                const modal = document.getElementById('schedule-detail-modal');
                document.getElementById('detail-title').textContent = schedule.title;
                document.getElementById('detail-description').textContent = schedule.description || '无';
                document.getElementById('detail-importance').textContent = `${schedule.importance.toFixed(1)} / 10.0`;
                document.getElementById('detail-deadline').textContent = schedule.deadline ? formatDeadline(schedule.deadline) : '无';
                document.getElementById('detail-type').textContent = schedule.eventType === 'long' ? '长期事件' : '单次事件';
                modal.classList.add('visible');
            }
            function handleEditScheduleFromModal() {
                document.getElementById('schedule-detail-modal').classList.remove('visible');
                showSchedulePanel(state.currentlyEditingScheduleId);
            }
            async function handleDeleteScheduleFromModal() {
                if (!confirm('确定要删除此日程及其聊天记录吗？')) return;
                const id = state.currentlyEditingScheduleId;
                const msg = state.messages.find(m => m.relatedId === id && m.type === 'schedule');

                await db.schedules.delete(id);
                state.schedules = state.schedules.filter(s => s.id !== id);
                if (msg) {
                    await db.messages.delete(msg.id);
                    state.messages = state.messages.filter(m => m.id !== msg.id);
                }

                document.getElementById('schedule-detail-modal').classList.remove('visible');
                renderSchedules();
                renderChatMessages(false);
                state.currentlyEditingScheduleId = null;
            }
            function formatDeadline(deadlineObj) {
                if (!deadlineObj) return '无';
                const { year, month, day, hour, minute } = deadlineObj;
                let str = '';
                if (year && month && day) str += `${year}年${month}月${day}日`;

                if (hour != null && minute != null) {
                    if (str) str += ' ';
                    str += `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                }
                return str.trim() || '无';
            }
            function showCalendarModal() {
                const now = new Date();
                let initialDate = now;
                if (state.calendarState.mode === 'deadline' && state.currentSchedule.deadlineDate) {
                    initialDate = state.currentSchedule.deadlineDate;
                } else if (state.calendarState.mode === 'endDate' && state.currentSchedule.endDate) {
                    initialDate = state.currentSchedule.endDate;
                }

                state.calendarState.year = initialDate.getFullYear();
                state.calendarState.month = initialDate.getMonth();
                renderCalendar(state.calendarState.year, state.calendarState.month);
                document.getElementById('calendar-modal').classList.add('visible');
            }
            function renderCalendar(year, month) {
                const grid = document.getElementById('calendar-grid');
                document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`;
                grid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDay; i++) {
                    grid.insertAdjacentHTML('beforeend', `<div></div>`);
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;
                    if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        dayEl.classList.add('today');
                    }

                    let dateToCheck = null;
                    if (state.calendarState.mode === 'deadline') dateToCheck = state.currentSchedule.deadlineDate;
                    else if (state.calendarState.mode === 'endDate') dateToCheck = state.currentSchedule.endDate;

                    if (dateToCheck && year === dateToCheck.getFullYear() && month === dateToCheck.getMonth() && i === dateToCheck.getDate()) {
                        dayEl.classList.add('selected');
                    }
                    grid.appendChild(dayEl);
                }
            }
            function updateDeadlineDisplay() {
                const textEl = document.getElementById('deadline-display-text');
                if (state.currentSchedule.deadlineDate) {
                    textEl.textContent = formatDeadline({
                        year: state.currentSchedule.deadlineDate.getFullYear(),
                        month: state.currentSchedule.deadlineDate.getMonth() + 1,
                        day: state.currentSchedule.deadlineDate.getDate()
                    });
                    textEl.style.color = 'var(--text-primary)';
                } else {
                    textEl.textContent = '选择日期';
                    textEl.style.color = 'var(--text-secondary)';
                    document.getElementById('deadline-hour-input').value = '';
                    document.getElementById('deadline-minute-input').value = '';
                }
            }
            function updateEndDateDisplay() {
                const textEl = document.getElementById('end-date-display-text');
                if (state.currentSchedule.endDate) {
                    textEl.textContent = formatDeadline({
                        year: state.currentSchedule.endDate.getFullYear(),
                        month: state.currentSchedule.endDate.getMonth() + 1,
                        day: state.currentSchedule.endDate.getDate()
                    });
                    textEl.style.color = 'var(--text-primary)';
                } else {
                    textEl.textContent = '永不结束';
                    textEl.style.color = 'var(--text-secondary)';
                }
            }

            // --- Forward to Chat ---
            async function forwardLedgerToChat() {
                const { filtered, displayCurrency } = getFilteredTransactions();
                const isChartView = document.getElementById('ledger-view-wrapper').style.transform === 'translateX(-50%)';

                if (isChartView) {
                    // Sync pie chart data
                    const expenseData = {};
                    const incomeData = {};
                    filtered.forEach(t => {
                        const data = t.type === 'expense' ? expenseData : incomeData;
                        if (!data[t.category]) data[t.category] = 0;
                        data[t.category] += t.displayAmount;
                    });

                    const totalExpense = Object.values(expenseData).reduce((s, a) => s + a, 0);
                    const totalIncome = Object.values(incomeData).reduce((s, a) => s + a, 0);

                    const summaryData = {
                        title: `${generatePieChartSubtitle()}的账单总结`,
                        totalExpense,
                        totalIncome,
                        expenseDetails: Object.entries(expenseData).map(([catId, amount]) => ({
                            id: catId,
                            name: CATEGORIES.expense.find(c => c.id === catId)?.name || '未知',
                            amount,
                            percentage: totalExpense > 0 ? (amount / totalExpense * 100) : 0
                        })),
                        incomeDetails: Object.entries(incomeData).map(([catId, amount]) => ({
                            id: catId,
                            name: CATEGORIES.income.find(c => c.id === catId)?.name || '未知',
                            amount,
                            percentage: totalIncome > 0 ? (amount / totalIncome * 100) : 0
                        })),
                        currency: displayCurrency
                    };

                    if (totalExpense === 0 && totalIncome === 0) { alert('当前筛选条件下没有数据可同步'); return; }
                    if (!confirm('要将当前图表分析同步到聊天中吗？')) return;

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'pie_chart_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                } else {
                    // Sync list data
                    if (filtered.length === 0) { alert('当前筛选条件下没有数据可同步'); return; }
                    if (!confirm('要将当前筛选的账本列表同步到聊天中吗？')) return;

                    const summaryData = filtered.map(t => ({
                        type: t.type,
                        amount: t.amount,
                        currency: t.currency,
                        category: CATEGORIES[t.type].find(c => c.id === t.category)?.name || '未知',
                        remark: t.remark
                    }));

                    const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'ledger_summary' };
                    const id = await db.messages.add(newMsg);
                    state.messages.push({ ...newMsg, id });
                }
                navigateTo('accounting-screen');
                renderChatMessages(true, true);
            }
            async function forwardScheduleToChat() {
                if (!confirm('要将完整的日程信息同步到聊天中吗？')) return;

                const summaryData = state.schedules.map(s => ({
                    title: s.title,
                    eventType: s.eventType,
                    importance: s.importance,
                    deadline: s.deadline ? formatDeadline(s.deadline) : '无',
                    description: s.description,
                    completed: s.completed
                }));

                const newMsg = { timestamp: Date.now(), role: 'user', content: JSON.stringify(summaryData), type: 'schedule_summary' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
                navigateTo('accounting-screen');
                renderChatMessages(true, true);
            }

            // --- Ledger Filter Modals ---
            function openMonthFilterModal() {
                const modal = document.getElementById('ledger-month-filter-modal');
                const list = document.getElementById('month-filter-list');
                list.innerHTML = '';

                const availableMonths = [...new Set(state.transactions.map(t => {
                    const d = new Date(t.timestamp);
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                }))].sort().reverse();

                availableMonths.forEach(monthStr => {
                    const item = document.createElement('div');
                    item.className = 'filter-item';
                    const isChecked = state.ledgerFilters.months.includes(monthStr);
                    item.innerHTML = `
                    <input type="checkbox" id="month-${monthStr}" value="${monthStr}" ${isChecked ? 'checked' : ''}>
                    <label for="month-${monthStr}">${monthStr.replace('-', '年')}月</label>
                `;
                    list.appendChild(item);
                });
                modal.classList.add('visible');
            }

            function openCategoryFilterModal() {
                const modal = document.getElementById('ledger-category-filter-modal');
                const renderList = (type) => {
                    const list = document.getElementById('category-filter-list');
                    list.innerHTML = '';
                    CATEGORIES[type].forEach(cat => {
                        const item = document.createElement('div');
                        item.className = 'filter-item';
                        const isChecked = state.ledgerFilters.type === type && state.ledgerFilters.categories.includes(cat.id);
                        item.innerHTML = `
                        <input type="checkbox" id="cat-${cat.id}" value="${cat.id}" ${isChecked ? 'checked' : ''}>
                        <label for="cat-${cat.id}">${cat.name}</label>
                    `;
                        list.appendChild(item);
                    });
                };

                const tabs = modal.querySelectorAll('.filter-tab');
                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.type === state.ledgerFilters.type);
                    tab.onclick = () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        renderList(tab.dataset.type);
                    };
                });

                renderList(state.ledgerFilters.type);
                modal.classList.add('visible');
            }

            function applyLedgerFilters() {
                // Month filter
                const monthModal = document.getElementById('ledger-month-filter-modal');
                const selectedMonths = [];
                monthModal.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    selectedMonths.push(cb.value);
                });
                state.ledgerFilters.months = selectedMonths;

                // Category filter
                const categoryModal = document.getElementById('ledger-category-filter-modal');
                const activeTab = categoryModal.querySelector('.filter-tab.active');
                if (activeTab) {
                    state.ledgerFilters.type = activeTab.dataset.type;
                    const selectedCategories = [];
                    categoryModal.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        selectedCategories.push(cb.value);
                    });
                    state.ledgerFilters.categories = selectedCategories;
                }

                renderLedger();
            }

            // --- General & Utility Functions ---
            function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }

            let cropper = null;
            function handleAvatarUpload(event, callback) {
                const file = event.target.files[0];
                if (!file) return;

                const modal = document.getElementById('cropper-modal');
                const image = document.getElementById('cropper-image');
                const saveBtn = modal.querySelector('.save-btn');

                const reader = new FileReader();
                reader.onload = (e) => {
                    image.src = e.target.result;
                    modal.classList.add('visible');

                    if (cropper) cropper.destroy();
                    cropper = new Cropper(image, {
                        aspectRatio: 1,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 0.8,
                    });

                    saveBtn.onclick = () => {
                        const canvas = cropper.getCroppedCanvas({ width: 256, height: 256, });
                        const croppedBase64 = canvas.toDataURL('image/png');
                        callback(croppedBase64);
                        modal.classList.remove('visible');
                        cropper.destroy();
                        cropper = null;
                    };
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            function download(filename, text, mimeType = 'text/plain') {
                const blob = new Blob(['\uFEFF' + text], { type: `${mimeType};charset=utf-8` });
                const element = document.createElement('a');
                element.href = URL.createObjectURL(blob);
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                URL.revokeObjectURL(element.href);
            }

            async function exportAsJSON() {
                const dataToExport = {
                    appConfig: await db.appConfig.toArray(),
                    transactions: await db.transactions.toArray(),
                    messages: await db.messages.toArray(),
                    apiProxies: await db.apiProxies.toArray(),
                    aiCharacters: await db.aiCharacters.toArray(),
                    currencies: await db.currencies.toArray(),
                    schedules: await db.schedules.toArray(),
                    emojiPacks: await db.emojiPacks.toArray()
                };
                download('Cava-Backup.json', JSON.stringify(dataToExport, null, 2), 'application/json');
            }
            async function importFromJSON(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!confirm('导入数据将覆盖现有所有数据，确定要继续吗？')) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        await db.delete();
                        await db.open();
                        if (data.appConfig) await db.appConfig.bulkPut(data.appConfig);
                        if (data.transactions) await db.transactions.bulkPut(data.transactions);
                        if (data.messages) await db.messages.bulkPut(data.messages);
                        if (data.apiProxies) await db.apiProxies.bulkPut(data.apiProxies);
                        if (data.aiCharacters) await db.aiCharacters.bulkPut(data.aiCharacters);
                        if (data.currencies) await db.currencies.bulkPut(data.currencies);
                        if (data.schedules) await db.schedules.bulkPut(data.schedules);
                        if (data.emojiPacks) await db.emojiPacks.bulkPut(data.emojiPacks);
                        alert('导入成功！页面将刷新。');
                        location.reload();
                    } catch (err) { alert(`导入失败: ${err.message}`); }
                };
                reader.readAsText(file);
            }

            async function exportAsTXT() {
                let content = `=== ${state.config.chatName} 导出记录 ===\n`;
                content += `导出时间: ${new Date().toLocaleString()}\n\n`;

                state.messages.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleString();
                    let text = '';

                    if (msg.type === 'text') {
                        text = msg.content;
                    } else if (msg.type === 'transaction') {
                        const t = state.transactions.find(t => t.id === msg.relatedId);
                        if (t) {
                            const category = CATEGORIES[t.type].find(c => c.id === t.category);
                            text = `[记账] ${t.type === 'expense' ? '支出' : '收入'} ${t.amount}${t.currency} - ${category?.name || '未知'} - 备注: ${t.remark || '无'}`;
                        }
                    } else if (msg.type === 'schedule') {
                        const s = state.schedules.find(s => s.id === msg.relatedId);
                        if (s) {
                            const deadlineStr = s.deadline ? formatDeadline(s.deadline) : '无';
                            const eventTypeStr = s.eventType === 'long' ? '长期事件' : '单次事件';
                            text = `[日程-${eventTypeStr}] ${s.title} - 重要度: ${s.importance.toFixed(1)} - 截止: ${deadlineStr} - 说明: ${s.description || '无'} - 状态: ${s.completed ? '已完成' : '未完成'}`;
                        }
                    } else if (msg.type === 'image') {
                        text = '[图片]';
                    } else if (msg.type === 'ledger_summary') {
                        if (!msg.content) {
                            text = '[账本摘要同步]';
                        } else {
                            try {
                                const data = JSON.parse(msg.content);
                                text = `[账本摘要同步] 共${data.length}条记录\n`;
                                text += data.map(t => `  - ${t.type === 'expense' ? '支出' : '收入'} ${t.amount}${t.currency} (${t.category}): ${t.remark || '无'}`).join('\n');
                            } catch (e) {
                                text = '[账本摘要同步] (数据格式错误)';
                            }
                        }
                    } else if (msg.type === 'schedule_summary') {
                        if (!msg.content) {
                            text = '[日程摘要同步]';
                        } else {
                            try {
                                const data = JSON.parse(msg.content);
                                text = `[日程摘要同步] 共${data.length}个日程\n`;
                                text += data.map(s => `  - [${s.eventType}] ${s.title} (重要度: ${s.importance})`).join('\n');
                            } catch (e) {
                                text = '[日程摘要同步] (数据格式错误)';
                            }
                        }
                    } else if (msg.type === 'pie_chart_summary') {
                        if (!msg.content) {
                            text = '[图表分析同步]';
                        } else {
                            try {
                                const data = JSON.parse(msg.content);
                                text = `[图表分析同步] ${data.title}\n`;
                                if (data.totalExpense > 0) {
                                    text += `  总支出: ${data.totalExpense.toFixed(2)} ${data.currency}\n`;
                                    text += data.expenseDetails.map(d => `    - ${d.name}: ${d.amount.toFixed(2)} (${d.percentage.toFixed(1)}%)`).join('\n');
                                }
                                if (data.totalIncome > 0) {
                                    text += `\n  总收入: ${data.totalIncome.toFixed(2)} ${data.currency}\n`;
                                    text += data.incomeDetails.map(d => `    - ${d.name}: ${d.amount.toFixed(2)} (${d.percentage.toFixed(1)}%)`).join('\n');
                                }
                            } catch (e) {
                                text = `[图表分析同步] (数据格式错误)`;
                            }
                        }
                    } else if (msg.type === 'today_tasks_summary') {
                        const data = JSON.parse(msg.content);
                        text = `[今日待办同步] 待完成${data.pending.length}项，已完成${data.completed.length}项`;
                    } else if (msg.type === 'calendar_view_summary') {
                        const data = JSON.parse(msg.content);
                        const totalEvents = Object.values(data.events).flat().length;
                        text = `[日历视图同步] ${data.year}年${data.month}月共${totalEvents}个日程事项`;
                    }

                    let sender = msg.role === 'user' ? '我' : 'AI';
                    if (msg.role === 'assistant' && msg.senderId) {
                        const character = state.characters.find(c => c.id === msg.senderId);
                        if (character) sender = character.name;
                    }

                    content += `[${time}] ${sender}: ${text}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.config.chatName}_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            function toggleSidebar() { ELS.sidebar.classList.toggle('visible'); ELS.sidebarOverlay.classList.toggle('visible'); }
            async function toggleContextPreview() { if (ELS.sidebarPreviewContent.style.display === 'block') { ELS.sidebarPreviewContent.style.display = 'none'; return; } const { context, tokens } = buildContext(state.config.maxTokens); ELS.sidebarTokenCount.textContent = tokens; ELS.sidebarPreviewContent.textContent = JSON.stringify(context, null, 2); ELS.sidebarPreviewContent.style.display = 'block'; }

            // --- Modal Helpers ---
            function setupModal(triggerId, modalId, closeId, onOpen) {
                const modal = document.getElementById(modalId);
                if (triggerId) { document.getElementById(triggerId).addEventListener('click', () => { if (onOpen) onOpen(); modal.classList.add('visible'); }); }
                if (closeId) { document.getElementById(closeId).addEventListener('click', () => modal.classList.remove('visible')); }
            }
            function setupEditorModal(modalId, onSave) {
                const modal = document.getElementById(modalId);
                modal.querySelector('.save-btn')?.addEventListener('click', () => { if (onSave) onSave(); });
                modal.querySelector('.cancel-btn')?.addEventListener('click', () => modal.classList.remove('visible'));
            }

            // --- RESTORED SETTINGS FUNCTIONS ---
            let editingProxyId = null;
            function renderProxyList() { const list = document.getElementById('proxy-list'); list.innerHTML = ''; if (state.proxies.length === 0) { list.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">还没有任何反代，快添加一个吧！</p>'; } state.proxies.forEach(p => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div class="name">${p.name || '未命名反代'}</div><div class="details">URL: ${p.url}</div><div class="list-item-actions"><button class="edit-proxy" data-id="${p.id}">✏️</button><button class="delete-proxy" data-id="${p.id}">🗑️</button></div>`; item.querySelector('.edit-proxy').addEventListener('click', () => openProxyEditor(p.id)); item.querySelector('.delete-proxy').addEventListener('click', () => deleteProxy(p.id)); list.appendChild(item); }); }
            function openProxyEditor(id = null) { editingProxyId = id; const modal = document.getElementById('proxy-editor-modal'); const title = document.getElementById('proxy-editor-title'); const name = document.getElementById('proxy-editor-name'); const url = document.getElementById('proxy-editor-url'); const apikey = document.getElementById('proxy-editor-apikey'); const models = document.getElementById('proxy-editor-models'); if (id) { const proxy = state.proxies.find(p => p.id === id); title.textContent = "编辑反代"; name.value = proxy.name || ''; url.value = proxy.url; apikey.value = proxy.apiKey; models.value = proxy.models ? proxy.models.split(',').join('\n') : ''; } else { title.textContent = "添加新反代"; name.value = ''; url.value = ''; apikey.value = ''; models.value = ''; } modal.classList.add('visible'); }
            async function saveProxy() { const modelsValue = document.getElementById('proxy-editor-models').value.trim().split('\n').map(m => m.trim()).filter(Boolean).join(','); const proxyData = { name: document.getElementById('proxy-editor-name').value.trim(), url: document.getElementById('proxy-editor-url').value.trim(), apiKey: document.getElementById('proxy-editor-apikey').value.trim(), models: modelsValue }; if (editingProxyId) { proxyData.id = editingProxyId; await db.apiProxies.put(proxyData); const index = state.proxies.findIndex(p => p.id === editingProxyId); state.proxies[index] = proxyData; } else { const id = await db.apiProxies.add(proxyData); state.proxies.push({ ...proxyData, id }); } renderProxyList(); document.getElementById('proxy-editor-modal').classList.remove('visible'); }
            async function deleteProxy(id) { if (confirm('确定要删除这个反代吗？')) { await db.apiProxies.delete(id); state.proxies = state.proxies.filter(p => p.id !== id); renderProxyList(); } }

            let editingCharId = null;
            function renderCharacterList() { const list = document.getElementById('character-list'); list.innerHTML = ''; if (state.characters.length === 0) { list.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">还没有任何角色，快创建一个吧！</p>'; } state.characters.forEach(c => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><img src="${c.avatar || DEFAULT_AVATAR}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;"><span class="name">${c.name}</span></div><div class="list-item-actions"><button class="edit-char" data-id="${c.id}">✏️</button><button class="delete-char" data-id="${c.id}">🗑️</button></div>`; item.querySelector('.edit-char').addEventListener('click', () => openCharacterEditor(c.id)); item.querySelector('.delete-char').addEventListener('click', () => deleteCharacter(c.id)); list.appendChild(item); }); }
            function populateModelsForProxy(proxySelectId, modelSelectId, selectedProxyId, selectedModel) { const modelSelect = document.getElementById(modelSelectId); modelSelect.innerHTML = '<option value="">-- 请先选API --</option>'; if (!selectedProxyId) return; const proxy = state.proxies.find(p => p.id === parseInt(selectedProxyId)); if (proxy && proxy.models) { modelSelect.innerHTML = '<option value="">-- 选择模型 --</option>'; const models = proxy.models.split(',').map(m => m.trim()).filter(Boolean); models.forEach(modelName => { const option = document.createElement('option'); option.value = modelName; option.textContent = modelName; if (modelName === selectedModel) { option.selected = true; } modelSelect.appendChild(option); }); } }
            function openCharacterEditor(id = null) {
                editingCharId = id;
                const modal = document.getElementById('character-editor-modal');
                const title = document.getElementById('character-editor-title');
                const name = document.getElementById('character-editor-name');
                const avatarPreview = document.getElementById('character-editor-avatar-preview');
                const prompt = document.getElementById('character-editor-prompt');
                const proxySelect = document.getElementById('character-editor-proxy');
                const backupProxySelect = document.getElementById('character-editor-backup-proxy');
                const modelSelect = document.getElementById('character-editor-model');
                const backupModelSelect = document.getElementById('character-editor-backup-model');

                proxySelect.innerHTML = '<option value="">-- 选择主用API --</option>';
                backupProxySelect.innerHTML = '<option value="">-- 选择备用API --</option>';
                state.proxies.forEach(p => { const optionText = p.name || p.url; const option = `<option value="${p.id}">${optionText}</option>`; proxySelect.innerHTML += option; backupProxySelect.innerHTML += option; });
                proxySelect.onchange = () => populateModelsForProxy('character-editor-proxy', 'character-editor-model', proxySelect.value, null);
                backupProxySelect.onchange = () => populateModelsForProxy('character-editor-backup-proxy', 'character-editor-backup-model', backupProxySelect.value, null);

                document.getElementById('upload-char-avatar-btn').onclick = () => document.getElementById('character-editor-avatar-input').click();
                document.getElementById('character-editor-avatar-input').onchange = (e) => {
                    handleAvatarUpload(e, (base64) => { avatarPreview.src = base64; });
                };

                if (id) {
                    const char = state.characters.find(c => c.id === id);
                    title.textContent = "编辑角色"; name.value = char.name;
                    avatarPreview.src = char.avatar || DEFAULT_AVATAR;
                    prompt.value = char.prompt;
                    proxySelect.value = char.proxyId;
                    populateModelsForProxy('character-editor-proxy', 'character-editor-model', char.proxyId, char.model);
                    backupProxySelect.value = char.backupProxyId;
                    populateModelsForProxy('character-editor-backup-proxy', 'character-editor-backup-model', char.backupProxyId, char.backupModel);
                    applyCharParamsToEditor(char.aiParams);
                } else {
                    title.textContent = "添加新角色";
                    name.value = '';
                    avatarPreview.src = DEFAULT_AVATAR;
                    prompt.value = '';
                    proxySelect.value = '';
                    backupProxySelect.value = '';
                    modelSelect.innerHTML = '<option value="">-- 请先选API --</option>';
                    backupModelSelect.innerHTML = '<option value="">-- 请先选API --</option>';
                    applyCharParamsToEditor(null);
                }
                modal.classList.add('visible');
            }
            async function saveCharacter() {
                const characterData = {
                    name: document.getElementById('character-editor-name').value.trim(),
                    avatar: document.getElementById('character-editor-avatar-preview').src,
                    prompt: document.getElementById('character-editor-prompt').value.trim(),
                    proxyId: parseInt(document.getElementById('character-editor-proxy').value) || null,
                    model: document.getElementById('character-editor-model').value,
                    backupProxyId: parseInt(document.getElementById('character-editor-backup-proxy').value) || null,
                    backupModel: document.getElementById('character-editor-backup-model').value,
                    aiParams: collectCharParamsFromEditor()
                };

                if (editingCharId) {
                    await db.aiCharacters.update(editingCharId, characterData);

                    const index = state.characters.findIndex(c => c.id === editingCharId);
                    if (index !== -1) {
                        state.characters[index] = { ...state.characters[index], ...characterData };
                    }
                } else {
                    const id = await db.aiCharacters.add(characterData);
                    state.characters.push({ ...characterData, id });
                }

                // 3. 收尾工作（这部分也是正确的）
                renderCharacterList();
                renderChatMessages();
                document.getElementById('character-editor-modal').classList.remove('visible');
                editingCharId = null; // 清空正在编辑的ID
            }
            async function deleteCharacter(id) { if (confirm('确定要删除这个角色吗？')) { await db.aiCharacters.delete(id); state.characters = state.characters.filter(c => c.id !== id); renderCharacterList(); renderChatMessages(); } }

            let currentlyEditingCurrencyCode = null;
            function openCurrencyEditor(curr = null) {
                const modal = document.getElementById('currency-editor-modal');
                currentlyEditingCurrencyCode = curr ? curr.code : null;
                document.getElementById('currency-editor-title').textContent = curr ? '编辑币种' : '新建币种';
                document.getElementById('currency-editor-code').value = curr ? curr.code : '';
                document.getElementById('currency-editor-code').disabled = !!curr;
                document.getElementById('currency-editor-name').value = curr ? curr.name : '';
                document.getElementById('currency-editor-rate').value = curr ? curr.rate : '';
                modal.classList.add('visible');
            }

            async function saveCurrency() {
                const code = document.getElementById('currency-editor-code').value.trim().toUpperCase();
                const name = document.getElementById('currency-editor-name').value.trim();
                const rate = parseFloat(document.getElementById('currency-editor-rate').value);

                if (!code || !name || isNaN(rate)) { alert('请填写所有字段'); return; }
                if (code.length !== 3) { alert('币种代码必须是3位字母'); return; }

                const currencyData = { code, name, rate };
                await db.currencies.put(currencyData);

                state.currencies = await db.currencies.toArray();
                renderCurrencyList();
                populateLedgerCurrencyFilter();
                document.getElementById('currency-editor-modal').classList.remove('visible');
            }

            function renderCurrencyList() {
                const listEl = document.getElementById('currency-list');
                listEl.innerHTML = '';
                const allCurrencies = [{ code: 'RMB', name: '人民币', rate: 1, isBase: true }, ...state.currencies];

                allCurrencies.forEach(curr => {
                    const item = document.createElement('div');
                    item.className = 'list-item-setting';
                    item.innerHTML = `<div class="name">${curr.name} (${curr.code})</div><div class="details">1 ${curr.code} ≈ ${curr.rate} RMB</div>`;

                    if (!curr.isBase) {
                        const actions = document.createElement('div');
                        actions.className = 'list-item-actions';

                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '✏️';
                        editBtn.onclick = () => openCurrencyEditor(curr);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '🗑️';
                        deleteBtn.onclick = async () => {
                            if (confirm(`确定要删除 "${curr.name}" 吗？`)) {
                                await db.currencies.delete(curr.code);
                                state.currencies = state.currencies.filter(c => c.code !== curr.code);
                                renderCurrencyList();
                                populateLedgerCurrencyFilter();
                            }
                        };

                        actions.append(editBtn, deleteBtn);
                        item.appendChild(actions);
                    }
                    listEl.appendChild(item);
                });
            }

            function openSystemPromptsEditor() {
                const settings = state.config.systemPromptSettings || DEFAULT_SYSTEM_PROMPTS;
                document.getElementById('system-prompt-send-time').checked = settings.sendTime;
                document.getElementById('system-prompt-send-model').checked = settings.sendModel;
                document.getElementById('system-prompt-send-role').checked = settings.sendRole;
                document.getElementById('system-prompt-ledger').value = settings.ledger;
                document.getElementById('system-prompt-schedule').value = settings.schedule;
                document.getElementById('system-prompt-pie').value = settings.pie;
                document.getElementById('system-prompts-modal').classList.add('visible');
            }

            async function saveSystemPrompts() {
                const newSettings = {
                    sendTime: document.getElementById('system-prompt-send-time').checked,
                    sendModel: document.getElementById('system-prompt-send-model').checked,
                    sendRole: document.getElementById('system-prompt-send-role').checked,
                    ledger: document.getElementById('system-prompt-ledger').value.trim() || DEFAULT_SYSTEM_PROMPTS.ledger,
                    schedule: document.getElementById('system-prompt-schedule').value.trim() || DEFAULT_SYSTEM_PROMPTS.schedule,
                    pie: document.getElementById('system-prompt-pie').value.trim() || DEFAULT_SYSTEM_PROMPTS.pie,
                };
                await updateConfig('systemPromptSettings', newSettings);
                document.getElementById('system-prompts-modal').classList.remove('visible');
            }

            function showAICharacterSelector() {
                const selector = document.getElementById('ai-character-selector');
                selector.innerHTML = '';
                if (state.characters.length === 0) {
                    alert('请先在“设置”中添加AI角色');
                    return;
                }
                state.characters.forEach(char => {
                    const item = document.createElement('div');
                    item.className = 'character-item';
                    item.innerHTML = `<img src="${char.avatar || DEFAULT_AVATAR}" alt="${char.name}"><div class="name">${char.name}</div>`;
                    item.onclick = () => {
                        document.getElementById('ai-character-selector-modal').classList.remove('visible');
                        triggerAIResponse(char);
                    };
                    selector.appendChild(item);
                });
                document.getElementById('ai-character-selector-modal').classList.add('visible');
            }

            // --- Emoji Pack Management ---
            function renderEmojiPackList() {
                const listEl = document.getElementById('emoji-pack-list');
                if (!listEl) return;

                if (state.emojiPacks.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">还没有上传表情包</div>';
                    return;
                }

                listEl.innerHTML = state.emojiPacks.map(emoji => `
                <div class="list-item-setting" style="display: flex; align-items: center; gap: 10px;">
                    <img src="${emoji.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;">
                    <div style="flex-grow: 1;">
                        <div class="name">${emoji.name}</div>
                        <div class="details">用于聊天: [emoji:${emoji.name}]</div>
                    </div>
                    <div class="list-item-actions">
                        <button data-id="${emoji.id}" class="delete-emoji-btn">×</button>
                    </div>
                </div>
            `).join('');

                listEl.querySelectorAll('.delete-emoji-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = parseInt(e.target.dataset.id);
                        if (confirm('确定要删除这个表情包吗？')) {
                            await db.emojiPacks.delete(id);
                            state.emojiPacks = state.emojiPacks.filter(e => e.id !== id);
                            renderEmojiPackList();
                        }
                    });
                });
            }

            async function openEmojiPackManager() {
                const modal = document.getElementById('emoji-pack-modal');
                if (!modal) {
                    const modalHTML = `
                    <div id="emoji-pack-modal" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">管理我的表情包</div>
                            <div class="modal-body">
                                <div id="emoji-pack-list"></div>
                                <button class="form-button" id="add-emoji-pack-btn">＋ 添加新表情包</button>
                                <input type="file" id="emoji-pack-file-input" accept="image/*" style="display:none;">
                            </div>
                            <div class="modal-footer">
                                <button class="cancel-btn" id="close-emoji-pack-modal">关闭</button>
                            </div>
                        </div>
                    </div>
                `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);

                    document.getElementById('add-emoji-pack-btn').addEventListener('click', () => {
                        document.getElementById('emoji-pack-file-input').click();
                    });

                    document.getElementById('emoji-pack-file-input').addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const name = prompt('请输入表情包名称（例如：开心、生气、疑惑）：');
                        if (!name) return;
                        const compressedImage = await compressEmojiPack(file);
                        const newEmoji = { name: name, image: compressedImage, timestamp: Date.now() };
                        const id = await db.emojiPacks.add(newEmoji);
                        state.emojiPacks.push({ ...newEmoji, id });
                        renderEmojiPackList();
                        e.target.value = '';
                    });

                    document.getElementById('close-emoji-pack-modal').addEventListener('click', () => {
                        document.getElementById('emoji-pack-modal').classList.remove('visible');
                    });
                }

                renderEmojiPackList();
                document.getElementById('emoji-pack-modal').classList.add('visible');
            }

            document.getElementById('manage-emoji-packs-btn').addEventListener('click', openEmojiPackManager);

            function showEmojiPackSelector() {
                if (state.emojiPacks.length === 0) {
                    alert('还没有上传表情包呢！请先在设置中添加表情包。');
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'modal-overlay visible';
                modal.innerHTML = `
        <div class="modal-content" style="max-width: 320px;">
            <div class="modal-header">选择表情包</div>
            <div class="modal-body" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px;">
                ${state.emojiPacks.map(emoji => `
                    <div class="emoji-pack-item" data-id="${emoji.id}" style="cursor: pointer; text-align: center;">
                        <img src="${emoji.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <div style="font-size: 10px; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${emoji.name}</div>
                    </div>
                `).join('')}
            </div>
            <div class="modal-footer">
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    `;

                document.body.appendChild(modal);

                modal.querySelectorAll('.emoji-pack-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const emojiId = parseInt(item.dataset.id);
                        const emoji = state.emojiPacks.find(e => e.id === emojiId);
                        if (emoji) {
                            // 发送表情包名称作为消息内容，但类型标记为emoji_pack
                            const newMsg = {
                                timestamp: Date.now(),
                                role: 'user',
                                content: `[emoji:${emoji.name}]`,  // 特殊格式存储
                                type: 'emoji_pack'
                            };
                            const id = await db.messages.add(newMsg);
                            state.messages.push({ ...newMsg, id });
                            renderChatMessages();
                        }
                        modal.remove();
                    });
                });

                modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }
            // Call init
            init();
        });
    </script>
    <!-- 日记模态框 -->
    <div id="diary-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="diary-modal-title">日记</span>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="diary-character-selector" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <label style="flex-shrink: 0;">角色：</label>
                    <select id="diary-char-select" style="flex-grow: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary);"></select>
                    <button id="edit-diary-prompt-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--bg-soft); border: none; cursor: pointer;">编辑提示词</button>
                </div>
                <div id="diary-content-area">
                    <div id="diary-empty-state" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <p>暂无日记</p>
                        <button id="generate-diary-btn" class="form-button" style="margin-top: 20px;">📔 生成日记</button>
                    </div>
                    <div id="diary-display" style="display: none;">
                        <div id="diary-text" style="background: var(--bg-soft); border-radius: 12px; padding: 20px; white-space: pre-wrap; line-height: 1.8; font-size: 15px; max-height: 400px; overflow-y: auto;">
                        </div>
                        <button id="delete-diary-btn" class="form-button" style="margin-top: 15px; background-color: var(--expense-color);">删除日记</button>
                    </div>
                    <div id="diary-loading" style="display: none; text-align: center; padding: 40px;">
                        <div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>
                        <p style="margin-top: 15px; color: var(--text-secondary);">正在生成日记...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="close-diary-modal">关闭</button>
            </div>
        </div>
    </div>

    <!-- 编辑日记提示词模态框 -->
    <div id="diary-prompt-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">编辑日记生成提示词</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>系统提示词</label>
                    <textarea id="diary-system-prompt" rows="10" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary);">请你写一篇{char}的视角中与{user}在{date}的这一天高度相关的日记，主要是你在这一天的对话中，对{user}行为的心理活动经过和情感变化，结合过往对话记录来写。日记写作风格需要按照依照{char}的性格特点。你在写日记时，对{char}统一使用第一人称「我」（如“我收到了她的消息”），对{user}则一般使用第三人称（如“她今天买奶茶花了二十块”），但偶尔插入对{user}第二人称直白的话（如“我想让你知道”），加强情感冲击。直接以“{date}，记录者：{char}”开头，2000字左右~</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn">取消</button>
                <button class="save-btn" id="save-diary-prompt">保存</button>
            </div>
        </div>
    </div>



</body></html>
